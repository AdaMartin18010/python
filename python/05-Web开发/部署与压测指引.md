# 部署与压测指引（FastAPI 最小应用）

## 1. 部署（单机）

- 开发：

```bash
uvicorn app:app --reload --host 0.0.0.0 --port 8000
```

- 生产（Gunicorn + UvicornWorkers）：

```bash
gunicorn app:app \
  -k uvicorn.workers.UvicornWorker \
  -w 2 --threads 4 \
  -b 0.0.0.0:8000 --timeout 60
```

- 环境变量（示例）：
  - `APP_ENV=prod`、`APP_APP_NAME=fastapi-min`、`APP_DEBUG=false`

## 2. 反向代理（Nginx 示例）

```nginx
location / {
    proxy_pass http://127.0.0.1:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
```

## 3. 压测

- hey：

```bash
hey -n 2000 -c 100 http://127.0.0.1:8000/health
```

- wrk：

```bash
wrk -t4 -c100 -d30s http://127.0.0.1:8000/health
```

## 4. 性能与稳定性建议

- workers/threads：结合 CPU 核心与 IO 比例调优
- 连接池：数据库/外部依赖建议池化与超时
- 超时与重试：上游与客户端均需设定
- 观测：接入结构化日志与指标（如 Prometheus）

## 5. Prometheus 抓取

- 在应用已暴露 `/metrics` 后，Prometheus `scrape_configs` 示例：

```yaml
scrape_configs:
  - job_name: fastapi-min
    static_configs:
      - targets: ["127.0.0.1:8000"]
    metrics_path: /metrics
```

---

- 返回目录：[@SUMMARY](../SUMMARY.md)
- 上级主题：[05-Web开发/README](./README.md)
