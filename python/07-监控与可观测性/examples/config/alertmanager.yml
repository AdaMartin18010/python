# Alertmanager é…ç½®æ–‡ä»¶
# ç”¨äºå‘Šè­¦è·¯ç”±å’Œé€šçŸ¥

global:
  # å…¨å±€é…ç½®
  resolve_timeout: 5m
  
  # SMTPé…ç½®ï¼ˆé‚®ä»¶é€šçŸ¥ï¼‰
  smtp_from: 'alertmanager@example.com'
  smtp_smarthost: 'smtp.example.com:587'
  smtp_auth_username: 'alertmanager@example.com'
  smtp_auth_password: 'password'
  smtp_require_tls: true

# è·¯ç”±é…ç½®
route:
  # é»˜è®¤æ¥æ”¶è€…
  receiver: 'default'
  
  # åˆ†ç»„é…ç½®
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  
  # å­è·¯ç”±
  routes:
    # ä¸¥é‡å‘Šè­¦ï¼šç«‹å³é€šçŸ¥
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      group_interval: 5m
      repeat_interval: 1h
      continue: true
    
    # è­¦å‘Šçº§åˆ«ï¼šæ‰¹é‡é€šçŸ¥
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      group_interval: 10m
      repeat_interval: 4h
    
    # æ•°æ®åº“å‘Šè­¦
    - match_re:
        service: '(postgres|mysql|redis)'
      receiver: 'database-team'
      group_by: ['alertname', 'instance']
    
    # åº”ç”¨å‘Šè­¦
    - match:
        category: availability
      receiver: 'oncall-team'
      group_interval: 5m
    
    # æ€§èƒ½å‘Šè­¦
    - match:
        category: performance
      receiver: 'performance-team'
      group_interval: 15m

# å‘Šè­¦æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # å¦‚æœæœåŠ¡ä¸‹çº¿ï¼ŒæŠ‘åˆ¶è¯¥æœåŠ¡çš„å…¶ä»–å‘Šè­¦
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      alertname: '(HighErrorRate|HighLatency|HighMemoryUsage)'
    equal: ['job', 'instance']
  
  # å¦‚æœèŠ‚ç‚¹ä¸‹çº¿ï¼ŒæŠ‘åˆ¶èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰å‘Šè­¦
  - source_match:
      alertname: 'NodeDown'
    target_match_re:
      alertname: '.*'
    equal: ['instance']
  
  # å¦‚æœæœ‰ä¸¥é‡å‘Šè­¦ï¼ŒæŠ‘åˆ¶åŒä¸€æœåŠ¡çš„è­¦å‘Šå‘Šè­¦
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service']

# æ¥æ”¶è€…é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶è€…
  - name: 'default'
    webhook_configs:
      - url: 'http://localhost:5001/webhook'
        send_resolved: true
  
  # ä¸¥é‡å‘Šè­¦æ¥æ”¶è€…
  - name: 'critical-alerts'
    # é‚®ä»¶é€šçŸ¥
    email_configs:
      - to: 'oncall@example.com'
        headers:
          Subject: 'ğŸš¨ CRITICAL: {{ .GroupLabels.alertname }}'
        html: |
          <h2>Critical Alert</h2>
          <p><strong>Alert:</strong> {{ .GroupLabels.alertname }}</p>
          <p><strong>Severity:</strong> {{ .CommonLabels.severity }}</p>
          <p><strong>Summary:</strong> {{ .CommonAnnotations.summary }}</p>
          <p><strong>Description:</strong> {{ .CommonAnnotations.description }}</p>
          <p><strong>Time:</strong> {{ .StartsAt }}</p>
    
    # Slacké€šçŸ¥
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#alerts-critical'
        title: 'ğŸš¨ {{ .GroupLabels.alertname }}'
        text: |
          *Severity:* {{ .CommonLabels.severity }}
          *Summary:* {{ .CommonAnnotations.summary }}
          *Description:* {{ .CommonAnnotations.description }}
        send_resolved: true
    
    # PagerDutyé€šçŸ¥
    pagerduty_configs:
      - service_key: 'YOUR_PAGERDUTY_SERVICE_KEY'
        description: '{{ .CommonAnnotations.summary }}'
  
  # è­¦å‘Šå‘Šè­¦æ¥æ”¶è€…
  - name: 'warning-alerts'
    email_configs:
      - to: 'team@example.com'
        headers:
          Subject: 'âš ï¸ WARNING: {{ .GroupLabels.alertname }}'
    
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
        channel: '#alerts-warning'
        title: 'âš ï¸ {{ .GroupLabels.alertname }}'
        text: '{{ .CommonAnnotations.summary }}'
  
  # æ•°æ®åº“å›¢é˜Ÿ
  - name: 'database-team'
    email_configs:
      - to: 'database-team@example.com'
        headers:
          Subject: 'Database Alert: {{ .GroupLabels.alertname }}'
  
  # å€¼ç­å›¢é˜Ÿ
  - name: 'oncall-team'
    pagerduty_configs:
      - service_key: 'ONCALL_PAGERDUTY_KEY'
        description: '{{ .CommonAnnotations.summary }}'
  
  # æ€§èƒ½å›¢é˜Ÿ
  - name: 'performance-team'
    email_configs:
      - to: 'performance@example.com'
        headers:
          Subject: 'Performance Alert: {{ .GroupLabels.alertname }}'

# æ¨¡æ¿
templates:
  - '/etc/alertmanager/templates/*.tmpl'

