# 构建与打包

## 1. 现代Python包管理

### 1.1 PEP 517/518 标准

```toml
# pyproject.toml - 现代Python项目配置
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "my-package"
version = "0.1.0"
description = "我的Python包"
readme = "README.md"
requires-python = ">=3.8"
license = {text = "MIT"}
authors = [
    {name = "作者姓名", email = "author@example.com"},
]
keywords = ["python", "package"]
classifiers = [
    "Development Status :: 4 - Beta",
    "Intended Audience :: Developers",
    "License :: OSI Approved :: MIT License",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.8",
    "Programming Language :: Python :: 3.9",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
]
dependencies = [
    "requests>=2.25.0",
    "click>=8.0.0",
]

[project.optional-dependencies]
dev = [
    "pytest>=6.0",
    "pytest-cov",
    "black",
    "isort",
    "mypy",
]
test = [
    "pytest>=6.0",
    "pytest-cov",
    "pytest-mock",
]

[project.urls]
Homepage = "https://github.com/user/my-package"
Documentation = "https://my-package.readthedocs.io"
Repository = "https://github.com/user/my-package.git"
"Bug Tracker" = "https://github.com/user/my-package/issues"

[project.scripts]
my-command = "my_package.cli:main"

[project.gui-scripts]
my-gui = "my_package.gui:main"
```

### 1.2 包结构规范

```text
my-package/
├── pyproject.toml          # 项目配置
├── README.md               # 项目说明
├── LICENSE                 # 许可证
├── CHANGELOG.md            # 变更日志
├── src/                    # 源码目录
│   └── my_package/
│       ├── __init__.py
│       ├── core.py
│       ├── cli.py
│       └── gui.py
├── tests/                  # 测试目录
│   ├── __init__.py
│   ├── test_core.py
│   └── test_cli.py
├── docs/                   # 文档目录
│   ├── conf.py
│   ├── index.rst
│   └── api/
├── examples/               # 示例目录
│   └── basic_usage.py
└── .github/                # GitHub配置
    └── workflows/
        └── ci.yml
```

## 2. 构建工具对比

### 2.1 主流构建工具

| 工具 | 特点 | 适用场景 | 性能 |
|------|------|----------|------|
| setuptools | 传统标准 | 简单项目 | 中等 |
| poetry | 依赖管理强 | 应用开发 | 较慢 |
| hatchling | 现代快速 | 库开发 | 快 |
| flit | 简单轻量 | 纯Python包 | 快 |
| pdm | 现代工具链 | 混合项目 | 快 |

### 2.2 hatchling 配置示例

```toml
# pyproject.toml with hatchling
[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[tool.hatch.build.targets.wheel]
packages = ["src/my_package"]

[tool.hatch.build.targets.sdist]
include = [
    "/src",
    "/tests",
    "/README.md",
    "/LICENSE",
    "/CHANGELOG.md",
]

[tool.hatch.version]
path = "src/my_package/__init__.py"

[tool.hatch.build.hooks.version]
source = "src/my_package/__init__.py"
```

## 3. 版本管理策略

### 3.1 语义化版本控制

```python
# src/my_package/__init__.py
"""
版本管理示例
"""
__version__ = "1.2.3"

# 版本号格式：MAJOR.MINOR.PATCH
# MAJOR: 不兼容的API修改
# MINOR: 向后兼容的功能性新增
# PATCH: 向后兼容的问题修正
```

### 3.2 自动版本管理

```toml
# pyproject.toml - 自动版本配置
[tool.hatch.version]
path = "src/my_package/__init__.py"

[tool.hatch.build.hooks.version]
source = "src/my_package/__init__.py"

# 或者使用动态版本
[tool.hatch.version]
source = "regex"
pattern = "__version__ = ['\"](?P<version>[^'\"]*)['\"]"
```

### 3.3 变更日志管理

```markdown
# CHANGELOG.md
# Changelog

All notable changes to this project will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [Unreleased]

### Added
- 新功能描述

### Changed
- 变更描述

### Deprecated
- 废弃功能描述

### Removed
- 移除功能描述

### Fixed
- 修复问题描述

### Security
- 安全修复描述

## [1.2.3] - 2024-01-15

### Added
- 添加了新的API接口
- 支持Python 3.12

### Fixed
- 修复了内存泄漏问题
- 解决了并发访问的竞态条件

## [1.2.2] - 2024-01-01

### Fixed
- 修复了Windows下的路径问题
```

## 4. 依赖管理

### 4.1 依赖分类

```toml
# pyproject.toml - 依赖分类
[project]
dependencies = [
    "requests>=2.25.0,<3.0.0",
    "click>=8.0.0,<9.0.0",
]

[project.optional-dependencies]
# 开发依赖
dev = [
    "pytest>=6.0",
    "pytest-cov",
    "black",
    "isort",
    "mypy",
    "pre-commit",
]

# 测试依赖
test = [
    "pytest>=6.0",
    "pytest-cov",
    "pytest-mock",
    "pytest-xdist",
]

# 文档依赖
docs = [
    "sphinx>=4.0",
    "sphinx-rtd-theme",
    "myst-parser",
]

# 性能测试依赖
perf = [
    "pytest-benchmark",
    "memory-profiler",
    "line-profiler",
]
```

### 4.2 依赖锁定

```bash
# 使用uv锁定依赖
uv pip compile pyproject.toml -o requirements.txt

# 锁定开发依赖
uv pip compile pyproject.toml --extra dev -o requirements-dev.txt

# 锁定所有可选依赖
uv pip compile pyproject.toml --all-extras -o requirements-all.txt
```

### 4.3 依赖更新策略

```bash
# 检查过时的依赖
uv pip list --outdated

# 更新依赖
uv pip install --upgrade package-name

# 批量更新
uv pip install --upgrade -r requirements.txt
```

## 5. 构建流程

### 5.1 本地构建

```bash
# 安装构建工具
uv pip install build

# 构建分发包
python -m build

# 构建结果
ls dist/
# my-package-0.1.0-py3-none-any.whl
# my-package-0.1.0.tar.gz
```

### 5.2 构建验证

```bash
# 验证构建结果
python -m build --check

# 安装并测试构建的包
uv pip install dist/my_package-0.1.0-py3-none-any.whl

# 运行测试
pytest tests/
```

### 5.3 多平台构建

```yaml
# .github/workflows/build.yml
name: Build

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: [3.8, 3.9, 3.10, 3.11, 3.12]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install uv
      run: pipx install uv
    
    - name: Install dependencies
      run: uv pip install build twine
    
    - name: Build package
      run: python -m build
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: dist-${{ matrix.os }}-py${{ matrix.python-version }}
        path: dist/
```

## 6. 发布流程

### 6.1 PyPI发布

```bash
# 安装发布工具
uv pip install twine

# 上传到测试PyPI
twine upload --repository testpypi dist/*

# 上传到正式PyPI
twine upload dist/*

# 使用API token认证
twine upload --username __token__ --password $PYPI_API_TOKEN dist/*
```

### 6.2 自动发布

```yaml
# .github/workflows/release.yml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install uv
      run: pipx install uv
    
    - name: Install dependencies
      run: uv pip install build twine
    
    - name: Build package
      run: python -m build
    
    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: twine upload dist/*
```

### 6.3 私有仓库发布

```bash
# 配置私有仓库
# ~/.pypirc
[distutils]
index-servers =
    pypi
    internal

[pypi]
repository = https://upload.pypi.org/legacy/
username = __token__
password = $PYPI_API_TOKEN

[internal]
repository = https://repo.example.com/api/pypi/python/simple
username = __token__
password = $INTERNAL_API_TOKEN

# 发布到私有仓库
twine upload --repository internal dist/*
```

## 7. 包签名与安全

### 7.1 GPG签名

```bash
# 生成GPG密钥
gpg --full-generate-key

# 列出密钥
gpg --list-secret-keys --keyid-format LONG

# 签名包
gpg --detach-sign --armor dist/my-package-0.1.0.tar.gz

# 上传签名
twine upload dist/my-package-0.1.0.tar.gz dist/my-package-0.1.0.tar.gz.asc
```

### 7.2 SBOM生成

```bash
# 安装SBOM工具
pip install cyclonedx-bom

# 生成SBOM
cyclonedx-py -o sbom.json

# 使用Syft生成SBOM
syft packages file:dist/*.whl -o cyclonedx-json > sbom.json
```

## 8. 容器化构建

### 8.1 Dockerfile

```dockerfile
# Dockerfile
FROM python:3.11-slim as builder

# 安装构建工具
RUN pip install --no-cache-dir uv

# 复制项目文件
COPY pyproject.toml ./
COPY src/ ./src/

# 构建包
RUN uv pip install build && python -m build

# 运行时镜像
FROM python:3.11-slim

# 安装运行时依赖
RUN pip install --no-cache-dir uv

# 复制构建的包
COPY --from=builder /dist/*.whl /tmp/

# 安装包
RUN uv pip install /tmp/*.whl

# 设置入口点
ENTRYPOINT ["my-command"]
```

### 8.2 多阶段构建

```dockerfile
# 多阶段构建示例
FROM python:3.11-slim as base

# 安装系统依赖
RUN apt-get update && apt-get install -y \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

FROM base as builder

# 安装构建工具
RUN pip install --no-cache-dir uv

# 复制项目文件
COPY pyproject.toml ./
COPY src/ ./src/

# 构建包
RUN uv pip install build && python -m build

FROM base as runtime

# 安装运行时依赖
RUN pip install --no-cache-dir uv

# 复制构建的包
COPY --from=builder /dist/*.whl /tmp/

# 安装包
RUN uv pip install /tmp/*.whl

# 创建非root用户
RUN useradd --create-home --shell /bin/bash app
USER app

# 设置工作目录
WORKDIR /home/app

# 设置入口点
ENTRYPOINT ["my-command"]
```

## 9. 质量保证

### 9.1 构建前检查

```bash
# 代码质量检查
ruff check .
black --check .
isort --check-only .

# 类型检查
mypy src/

# 安全扫描
bandit -r src/

# 依赖漏洞扫描
safety check
```

### 9.2 构建验证

```bash
# 验证包结构
python -m build --check

# 验证包内容
twine check dist/*

# 安装测试
uv pip install dist/*.whl --force-reinstall
python -c "import my_package; print(my_package.__version__)"
```

## 10. 最佳实践

### 10.1 构建优化

1. **最小化依赖**：只包含必要的依赖
2. **版本锁定**：使用精确的版本约束
3. **构建缓存**：利用Docker层缓存
4. **并行构建**：使用多核构建
5. **增量构建**：只构建变更的部分

### 10.2 发布策略

1. **测试先行**：在测试环境验证
2. **渐进发布**：先发布到测试PyPI
3. **回滚准备**：准备快速回滚方案
4. **监控发布**：监控发布后的指标
5. **文档同步**：及时更新文档

### 10.3 安全考虑

1. **依赖审计**：定期检查依赖漏洞
2. **包签名**：使用GPG签名包
3. **SBOM生成**：生成软件物料清单
4. **访问控制**：限制发布权限
5. **审计日志**：记录所有发布活动

---

## 返回与相关

- 返回目录：[03-工程与交付/README](../README.md)
- 相关文档：[项目管理](./项目管理.md)
- 示例项目：[minimal_build](../examples/minimal_build/)
