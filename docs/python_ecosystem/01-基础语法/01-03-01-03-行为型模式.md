# 03-01-03 è¡Œä¸ºå‹æ¨¡å¼

## æ¦‚è¿°

è¡Œä¸ºå‹æ¨¡å¼å…³æ³¨å¯¹è±¡ä¹‹é—´çš„é€šä¿¡ï¼Œæè¿°å¯¹è±¡ä¹‹é—´å¦‚ä½•åä½œä»¥åŠå¦‚ä½•åˆ†é…èŒè´£ã€‚è¿™äº›æ¨¡å¼å®šä¹‰äº†å¯¹è±¡ä¹‹é—´çš„äº¤äº’æ–¹å¼ï¼Œä½¿ç³»ç»Ÿæ›´åŠ çµæ´»å’Œå¯ç»´æŠ¤ã€‚

## 1. è´£ä»»é“¾æ¨¡å¼ (Chain of Responsibility)

### 1.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰ 1.1** (è´£ä»»é“¾æ¨¡å¼)
è´£ä»»é“¾æ¨¡å¼æ˜¯ä¸€ä¸ªå››å…ƒç»„ï¼š
$$Chain = (H, \rightarrow, \phi, \psi)$$

å…¶ä¸­ï¼š

- $H$ ä¸ºå¤„ç†å™¨é›†åˆ
- $\rightarrow$ ä¸ºåç»§å…³ç³»ï¼Œ$\rightarrow \subseteq H \times H$
- $\phi: H \times Request \rightarrow \{true, false\}$ ä¸ºå¤„ç†æ¡ä»¶å‡½æ•°
- $\psi: H \times Request \rightarrow Response$ ä¸ºå¤„ç†å‡½æ•°

**å®šç† 1.1** (è´£ä»»é“¾ä¼ é€’æ€§)
å¦‚æœ $h_1 \rightarrow h_2 \rightarrow h_3$ï¼Œåˆ™è¯·æ±‚ $r$ çš„å¤„ç†è·¯å¾„ä¸ºï¼š
$$Process(r) = \begin{cases}
\psi(h_1, r) & \text{if } \phi(h_1, r) = true \\
\psi(h_2, r) & \text{if } \phi(h_1, r) = false \land \phi(h_2, r) = true \\
\psi(h_3, r) & \text{if } \phi(h_1, r) = false \land \phi(h_2, r) = false
\end{cases}$$

### 1.2 Pythonå®ç°

```python
from abc import ABC, abstractmethod
from typing import Optional, Any, Protocol
from dataclasses import dataclass
from enum import Enum

class LogLevel(Enum):
    """æ—¥å¿—çº§åˆ«"""
    INFO = 1
    DEBUG = 2
    WARNING = 3
    ERROR = 4

@dataclass
class LogRequest:
    """æ—¥å¿—è¯·æ±‚"""
    message: str
    level: LogLevel
    timestamp: float

@dataclass
class LogResponse:
    """æ—¥å¿—å“åº”"""
    processed: bool
    handler: str
    message: str

class Handler(ABC):
    """å¤„ç†å™¨æŠ½è±¡åŸºç±»"""

    def __init__(self, name: str):
        self.name = name
        self._next_handler: Optional['Handler'] = None

    def set_next(self, handler: 'Handler') -> 'Handler':
        """è®¾ç½®ä¸‹ä¸€ä¸ªå¤„ç†å™¨"""
        self._next_handler = handler
        return handler

    def handle(self, request: LogRequest) -> LogResponse:
        """å¤„ç†è¯·æ±‚"""
        if self.can_handle(request):
            return self.process(request)
        elif self._next_handler:
            return self._next_handler.handle(request)
        else:
            return LogResponse(False, self.name, "No handler available")

    @abstractmethod
    def can_handle(self, request: LogRequest) -> bool:
        """åˆ¤æ–­æ˜¯å¦å¯ä»¥å¤„ç†è¯·æ±‚"""
        pass

    @abstractmethod
    def process(self, request: LogRequest) -> LogResponse:
        """å¤„ç†è¯·æ±‚"""
        pass

class ConsoleHandler(Handler):
    """æ§åˆ¶å°å¤„ç†å™¨"""

    def can_handle(self, request: LogRequest) -> bool:
        return request.level in [LogLevel.INFO, LogLevel.DEBUG]

    def process(self, request: LogRequest) -> LogResponse:
        print(f"[{self.name}] {request.level.name}: {request.message}")
        return LogResponse(True, self.name, f"Processed by {self.name}")

class FileHandler(Handler):
    """æ–‡ä»¶å¤„ç†å™¨"""

    def can_handle(self, request: LogRequest) -> bool:
        return request.level in [LogLevel.WARNING, LogLevel.ERROR]

    def process(self, request: LogRequest) -> LogResponse:
        # æ¨¡æ‹Ÿæ–‡ä»¶å†™å…¥
        print(f"[{self.name}] Writing to file: {request.level.name}: {request.message}")
        return LogResponse(True, self.name, f"Written to file by {self.name}")

class EmailHandler(Handler):
    """é‚®ä»¶å¤„ç†å™¨"""

    def can_handle(self, request: LogRequest) -> bool:
        return request.level == LogLevel.ERROR

    def process(self, request: LogRequest) -> LogResponse:
        print(f"[{self.name}] Sending email: {request.level.name}: {request.message}")
        return LogResponse(True, self.name, f"Email sent by {self.name}")

# ä½¿ç”¨ç¤ºä¾‹
def test_chain_of_responsibility():
    """æµ‹è¯•è´£ä»»é“¾æ¨¡å¼"""
    # åˆ›å»ºå¤„ç†å™¨é“¾
    console = ConsoleHandler("Console")
    file = FileHandler("File")
    email = EmailHandler("Email")

    # è®¾ç½®è´£ä»»é“¾
    console.set_next(file).set_next(email)

    # æµ‹è¯•ä¸åŒçº§åˆ«çš„æ—¥å¿—
    requests = [
        LogRequest("Debug message", LogLevel.DEBUG, 1234567890.0),
        LogRequest("Warning message", LogLevel.WARNING, 1234567890.0),
        LogRequest("Error message", LogLevel.ERROR, 1234567890.0),
    ]

    for request in requests:
        response = console.handle(request)
        print(f"Request: {request.message} -> Response: {response.processed} by {response.handler}")
        print()

if __name__ == "__main__":
    test_chain_of_responsibility()

## 2. å‘½ä»¤æ¨¡å¼ (Command)

### 2.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰ 2.1** (å‘½ä»¤æ¨¡å¼)
å‘½ä»¤æ¨¡å¼æ˜¯ä¸€ä¸ªäº”å…ƒç»„ï¼š
$$Command = (C, I, E, \sigma, \tau)$$

å…¶ä¸­ï¼š
- $C$ ä¸ºå‘½ä»¤é›†åˆ
- $I$ ä¸ºè°ƒç”¨è€…é›†åˆ
- $E$ ä¸ºæ‰§è¡Œè€…é›†åˆ
- $\sigma: C \rightarrow E$ ä¸ºå‘½ä»¤åˆ°æ‰§è¡Œè€…çš„æ˜ å°„
- $\tau: C \times State \rightarrow State$ ä¸ºå‘½ä»¤æ‰§è¡Œå‡½æ•°

**å®šç† 2.1** (å‘½ä»¤å¯æ’¤é”€æ€§)
å¦‚æœå‘½ä»¤ $c$ æ˜¯å¯æ’¤é”€çš„ï¼Œåˆ™å­˜åœ¨é€†å‘½ä»¤ $c^{-1}$ ä½¿å¾—ï¼š
$$\tau(c^{-1}, \tau(c, s)) = s$$

### 2.2 Pythonå®ç°

```python
from abc import ABC, abstractmethod
from typing import List, Any, Protocol
from dataclasses import dataclass
from enum import Enum
import copy

class Command(ABC):
    """å‘½ä»¤æŠ½è±¡åŸºç±»"""

    @abstractmethod
    def execute(self) -> None:
        """æ‰§è¡Œå‘½ä»¤"""
        pass

    @abstractmethod
    def undo(self) -> None:
        """æ’¤é”€å‘½ä»¤"""
        pass

class TextEditor:
    """æ–‡æœ¬ç¼–è¾‘å™¨"""

    def __init__(self):
        self.content = ""
        self.cursor_position = 0

    def insert_text(self, text: str, position: int) -> None:
        """æ’å…¥æ–‡æœ¬"""
        self.content = self.content[:position] + text + self.content[position:]
        self.cursor_position = position + len(text)

    def delete_text(self, start: int, end: int) -> str:
        """åˆ é™¤æ–‡æœ¬"""
        deleted_text = self.content[start:end]
        self.content = self.content[:start] + self.content[end:]
        self.cursor_position = start
        return deleted_text

    def get_content(self) -> str:
        """è·å–å†…å®¹"""
        return self.content

class InsertCommand(Command):
    """æ’å…¥å‘½ä»¤"""

    def __init__(self, editor: TextEditor, text: str, position: int):
        self.editor = editor
        self.text = text
        self.position = position

    def execute(self) -> None:
        self.editor.insert_text(self.text, self.position)

    def undo(self) -> None:
        self.editor.delete_text(self.position, self.position + len(self.text))

class DeleteCommand(Command):
    """åˆ é™¤å‘½ä»¤"""

    def __init__(self, editor: TextEditor, start: int, end: int):
        self.editor = editor
        self.start = start
        self.end = end
        self.deleted_text = ""

    def execute(self) -> None:
        self.deleted_text = self.editor.delete_text(self.start, self.end)

    def undo(self) -> None:
        self.editor.insert_text(self.deleted_text, self.start)

class CommandInvoker:
    """å‘½ä»¤è°ƒç”¨è€…"""

    def __init__(self):
        self.commands: List[Command] = []
        self.current_index = -1

    def execute_command(self, command: Command) -> None:
        """æ‰§è¡Œå‘½ä»¤"""
        # æ¸…é™¤å½“å‰ä½ç½®ä¹‹åçš„æ‰€æœ‰å‘½ä»¤
        self.commands = self.commands[:self.current_index + 1]

        command.execute()
        self.commands.append(command)
        self.current_index += 1

    def undo(self) -> None:
        """æ’¤é”€å‘½ä»¤"""
        if self.current_index >= 0:
            self.commands[self.current_index].undo()
            self.current_index -= 1

    def redo(self) -> None:
        """é‡åšå‘½ä»¤"""
        if self.current_index < len(self.commands) - 1:
            self.current_index += 1
            self.commands[self.current_index].execute()

# ä½¿ç”¨ç¤ºä¾‹
def test_command_pattern():
    """æµ‹è¯•å‘½ä»¤æ¨¡å¼"""
    editor = TextEditor()
    invoker = CommandInvoker()

    # æ‰§è¡Œä¸€ç³»åˆ—å‘½ä»¤
    commands = [
        InsertCommand(editor, "Hello", 0),
        InsertCommand(editor, " World", 5),
        DeleteCommand(editor, 0, 5),
        InsertCommand(editor, "Hi", 0),
    ]

    print("æ‰§è¡Œå‘½ä»¤:")
    for i, command in enumerate(commands):
        invoker.execute_command(command)
        print(f"Step {i+1}: {editor.get_content()}")

    print("\næ’¤é”€å‘½ä»¤:")
    for i in range(len(commands)):
        invoker.undo()
        print(f"Undo {i+1}: {editor.get_content()}")

    print("\né‡åšå‘½ä»¤:")
    for i in range(len(commands)):
        invoker.redo()
        print(f"Redo {i+1}: {editor.get_content()}")

if __name__ == "__main__":
    test_command_pattern()

## 3. è§‚å¯Ÿè€…æ¨¡å¼ (Observer)

### 3.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰ 3.1** (è§‚å¯Ÿè€…æ¨¡å¼)
è§‚å¯Ÿè€…æ¨¡å¼æ˜¯ä¸€ä¸ªå››å…ƒç»„ï¼š
$$Observer = (S, O, \rho, \delta)$$

å…¶ä¸­ï¼š
- $S$ ä¸ºä¸»é¢˜é›†åˆ
- $O$ ä¸ºè§‚å¯Ÿè€…é›†åˆ
- $\rho \subseteq S \times O$ ä¸ºè®¢é˜…å…³ç³»
- $\delta: S \times Event \rightarrow \mathcal{P}(O)$ ä¸ºé€šçŸ¥å‡½æ•°

**å®šç† 3.1** (è§‚å¯Ÿè€…é€šçŸ¥å®Œæ•´æ€§)
å¯¹äºä¸»é¢˜ $s$ å’Œäº‹ä»¶ $e$ï¼Œæ‰€æœ‰è®¢é˜…çš„è§‚å¯Ÿè€…éƒ½ä¼šè¢«é€šçŸ¥ï¼š
$$\forall o \in O: (s, o) \in \rho \Rightarrow o \in \delta(s, e)$$

### 3.2 Pythonå®ç°

```python
from abc import ABC, abstractmethod
from typing import List, Dict, Any, Protocol
from dataclasses import dataclass
from enum import Enum
import time
from datetime import datetime

class EventType(Enum):
    """äº‹ä»¶ç±»å‹"""
    PRICE_CHANGE = "price_change"
    VOLUME_CHANGE = "volume_change"
    NEWS_UPDATE = "news_update"

@dataclass
class Event:
    """äº‹ä»¶"""
    type: EventType
    data: Any
    timestamp: datetime

class Observer(ABC):
    """è§‚å¯Ÿè€…æŠ½è±¡åŸºç±»"""

    @abstractmethod
    def update(self, event: Event) -> None:
        """æ›´æ–°æ–¹æ³•"""
        pass

class Subject(ABC):
    """ä¸»é¢˜æŠ½è±¡åŸºç±»"""

    def __init__(self):
        self._observers: Dict[EventType, List[Observer]] = {
            event_type: [] for event_type in EventType
        }

    def attach(self, observer: Observer, event_type: EventType) -> None:
        """æ·»åŠ è§‚å¯Ÿè€…"""
        if observer not in self._observers[event_type]:
            self._observers[event_type].append(observer)

    def detach(self, observer: Observer, event_type: EventType) -> None:
        """ç§»é™¤è§‚å¯Ÿè€…"""
        if observer in self._observers[event_type]:
            self._observers[event_type].remove(observer)

    def notify(self, event: Event) -> None:
        """é€šçŸ¥è§‚å¯Ÿè€…"""
        for observer in self._observers[event.type]:
            observer.update(event)

class StockMarket(Subject):
    """è‚¡ç¥¨å¸‚åœº"""

    def __init__(self, symbol: str):
        super().__init__()
        self.symbol = symbol
        self.price = 100.0
        self.volume = 1000000

    def set_price(self, price: float) -> None:
        """è®¾ç½®ä»·æ ¼"""
        old_price = self.price
        self.price = price

        event = Event(
            type=EventType.PRICE_CHANGE,
            data={"symbol": self.symbol, "old_price": old_price, "new_price": price},
            timestamp=datetime.now()
        )
        self.notify(event)

    def set_volume(self, volume: int) -> None:
        """è®¾ç½®æˆäº¤é‡"""
        old_volume = self.volume
        self.volume = volume

        event = Event(
            type=EventType.VOLUME_CHANGE,
            data={"symbol": self.symbol, "old_volume": old_volume, "new_volume": volume},
            timestamp=datetime.now()
        )
        self.notify(event)

    def publish_news(self, news: str) -> None:
        """å‘å¸ƒæ–°é—»"""
        event = Event(
            type=EventType.NEWS_UPDATE,
            data={"symbol": self.symbol, "news": news},
            timestamp=datetime.now()
        )
        self.notify(event)

class PriceAlert(Observer):
    """ä»·æ ¼æé†’"""

    def __init__(self, symbol: str, threshold: float):
        self.symbol = symbol
        self.threshold = threshold

    def update(self, event: Event) -> None:
        if event.type == EventType.PRICE_CHANGE:
            data = event.data
            if data["symbol"] == self.symbol:
                new_price = data["new_price"]
                if new_price > self.threshold:
                    print(f"ğŸš¨ ä»·æ ¼æé†’: {self.symbol} ä»·æ ¼ {new_price} è¶…è¿‡é˜ˆå€¼ {self.threshold}")

class VolumeAnalyzer(Observer):
    """æˆäº¤é‡åˆ†æå™¨"""

    def __init__(self, symbol: str):
        self.symbol = symbol
        self.volume_history = []

    def update(self, event: Event) -> None:
        if event.type == EventType.VOLUME_CHANGE:
            data = event.data
            if data["symbol"] == self.symbol:
                self.volume_history.append(data["new_volume"])
                avg_volume = sum(self.volume_history) / len(self.volume_history)
                print(f"ğŸ“Š æˆäº¤é‡åˆ†æ: {self.symbol} å½“å‰æˆäº¤é‡ {data['new_volume']}, å¹³å‡æˆäº¤é‡ {avg_volume:.0f}")

class NewsTracker(Observer):
    """æ–°é—»è¿½è¸ªå™¨"""

    def __init__(self, symbol: str):
        self.symbol = symbol

    def update(self, event: Event) -> None:
        if event.type == EventType.NEWS_UPDATE:
            data = event.data
            if data["symbol"] == self.symbol:
                print(f"ğŸ“° æ–°é—»æ›´æ–°: {self.symbol} - {data['news']}")

# ä½¿ç”¨ç¤ºä¾‹
def test_observer_pattern():
    """æµ‹è¯•è§‚å¯Ÿè€…æ¨¡å¼"""
    # åˆ›å»ºè‚¡ç¥¨å¸‚åœº
    market = StockMarket("AAPL")

    # åˆ›å»ºè§‚å¯Ÿè€…
    price_alert = PriceAlert("AAPL", 150.0)
    volume_analyzer = VolumeAnalyzer("AAPL")
    news_tracker = NewsTracker("AAPL")

    # æ³¨å†Œè§‚å¯Ÿè€…
    market.attach(price_alert, EventType.PRICE_CHANGE)
    market.attach(volume_analyzer, EventType.VOLUME_CHANGE)
    market.attach(news_tracker, EventType.NEWS_UPDATE)

    # æ¨¡æ‹Ÿå¸‚åœºå˜åŒ–
    print("=== å¸‚åœºå˜åŒ–æ¨¡æ‹Ÿ ===")
    market.set_price(120.0)
    market.set_volume(1500000)
    market.publish_news("è‹¹æœå…¬å¸å‘å¸ƒæ–°äº§å“")
    market.set_price(160.0)  # è§¦å‘ä»·æ ¼æé†’
    market.set_volume(2000000)

if __name__ == "__main__":
    test_observer_pattern()

## 4. ç­–ç•¥æ¨¡å¼ (Strategy)

### 4.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰ 4.1** (ç­–ç•¥æ¨¡å¼)
ç­–ç•¥æ¨¡å¼æ˜¯ä¸€ä¸ªå››å…ƒç»„ï¼š
$$Strategy = (C, S, \sigma, \tau)$$

å…¶ä¸­ï¼š
- $C$ ä¸ºä¸Šä¸‹æ–‡é›†åˆ
- $S$ ä¸ºç­–ç•¥é›†åˆ
- $\sigma: C \rightarrow S$ ä¸ºç­–ç•¥é€‰æ‹©å‡½æ•°
- $\tau: S \times Input \rightarrow Output$ ä¸ºç­–ç•¥æ‰§è¡Œå‡½æ•°

**å®šç† 4.1** (ç­–ç•¥å¯æ›¿æ¢æ€§)
å¯¹äºä»»æ„ä¸Šä¸‹æ–‡ $c$ å’Œè¾“å…¥ $x$ï¼Œç­–ç•¥çš„æ‰§è¡Œç»“æœåªä¾èµ–äºé€‰æ‹©çš„ç­–ç•¥ï¼š
$$\tau(\sigma(c), x) = \tau(s, x) \text{ where } s = \sigma(c)$$

### 4.2 Pythonå®ç°

```python
from abc import ABC, abstractmethod
from typing import List, Protocol, TypeVar, Generic
from dataclasses import dataclass
from enum import Enum
import math

T = TypeVar('T')

class SortStrategy(ABC, Generic[T]):
    """æ’åºç­–ç•¥æŠ½è±¡åŸºç±»"""

    @abstractmethod
    def sort(self, data: List[T]) -> List[T]:
        """æ’åºæ–¹æ³•"""
        pass

    @abstractmethod
    def get_name(self) -> str:
        """è·å–ç­–ç•¥åç§°"""
        pass

class BubbleSort(SortStrategy[int]):
    """å†’æ³¡æ’åº"""

    def sort(self, data: List[int]) -> List[int]:
        result = data.copy()
        n = len(result)

        for i in range(n):
            for j in range(0, n - i - 1):
                if result[j] > result[j + 1]:
                    result[j], result[j + 1] = result[j + 1], result[j]

        return result

    def get_name(self) -> str:
        return "Bubble Sort"

class QuickSort(SortStrategy[int]):
    """å¿«é€Ÿæ’åº"""

    def sort(self, data: List[int]) -> List[int]:
        if len(data) <= 1:
            return data

        pivot = data[len(data) // 2]
        left = [x for x in data if x < pivot]
        middle = [x for x in data if x == pivot]
        right = [x for x in data if x > pivot]

        return self.sort(left) + middle + self.sort(right)

    def get_name(self) -> str:
        return "Quick Sort"

class MergeSort(SortStrategy[int]):
    """å½’å¹¶æ’åº"""

    def sort(self, data: List[int]) -> List[int]:
        if len(data) <= 1:
            return data

        mid = len(data) // 2
        left = self.sort(data[:mid])
        right = self.sort(data[mid:])

        return self._merge(left, right)

    def _merge(self, left: List[int], right: List[int]) -> List[int]:
        result = []
        i = j = 0

        while i < len(left) and j < len(right):
            if left[i] <= right[j]:
                result.append(left[i])
                i += 1
            else:
                result.append(right[j])
                j += 1

        result.extend(left[i:])
        result.extend(right[j:])
        return result

    def get_name(self) -> str:
        return "Merge Sort"

class SortContext:
    """æ’åºä¸Šä¸‹æ–‡"""

    def __init__(self, strategy: SortStrategy[int]):
        self._strategy = strategy

    def set_strategy(self, strategy: SortStrategy[int]) -> None:
        """è®¾ç½®ç­–ç•¥"""
        self._strategy = strategy

    def sort(self, data: List[int]) -> List[int]:
        """æ‰§è¡Œæ’åº"""
        return self._strategy.sort(data)

    def get_strategy_name(self) -> str:
        """è·å–ç­–ç•¥åç§°"""
        return self._strategy.get_name()

# ä½¿ç”¨ç¤ºä¾‹
def test_strategy_pattern():
    """æµ‹è¯•ç­–ç•¥æ¨¡å¼"""
    # æµ‹è¯•æ•°æ®
    test_data = [64, 34, 25, 12, 22, 11, 90]

    # åˆ›å»ºä¸åŒçš„æ’åºç­–ç•¥
    strategies = [
        BubbleSort(),
        QuickSort(),
        MergeSort()
    ]

    # æµ‹è¯•æ¯ç§ç­–ç•¥
    for strategy in strategies:
        context = SortContext(strategy)
        sorted_data = context.sort(test_data.copy())

        print(f"ç­–ç•¥: {context.get_strategy_name()}")
        print(f"åŸå§‹æ•°æ®: {test_data}")
        print(f"æ’åºç»“æœ: {sorted_data}")
        print(f"æ˜¯å¦æ­£ç¡®: {sorted_data == sorted(test_data)}")
        print()

if __name__ == "__main__":
    test_strategy_pattern()

## 5. çŠ¶æ€æ¨¡å¼ (State)

### 5.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰ 5.1** (çŠ¶æ€æ¨¡å¼)
çŠ¶æ€æ¨¡å¼æ˜¯ä¸€ä¸ªäº”å…ƒç»„ï¼š
$$State = (C, S, \sigma, \tau, \delta)$$

å…¶ä¸­ï¼š
- $C$ ä¸ºä¸Šä¸‹æ–‡é›†åˆ
- $S$ ä¸ºçŠ¶æ€é›†åˆ
- $\sigma: C \rightarrow S$ ä¸ºçŠ¶æ€å‡½æ•°
- $\tau: S \times Event \rightarrow S$ ä¸ºçŠ¶æ€è½¬æ¢å‡½æ•°
- $\delta: S \times Action \rightarrow Response$ ä¸ºè¡Œä¸ºå‡½æ•°

**å®šç† 5.1** (çŠ¶æ€è½¬æ¢ä¸€è‡´æ€§)
å¯¹äºä¸Šä¸‹æ–‡ $c$ å’Œäº‹ä»¶ $e$ï¼ŒçŠ¶æ€è½¬æ¢æ˜¯ç¡®å®šçš„ï¼š
$$\sigma(c') = \tau(\sigma(c), e) \text{ where } c' = \text{update}(c, e)$$

### 5.2 Pythonå®ç°

```python
from abc import ABC, abstractmethod
from typing import Optional, Protocol
from dataclasses import dataclass
from enum import Enum

class OrderStatus(Enum):
    """è®¢å•çŠ¶æ€"""
    PENDING = "pending"
    CONFIRMED = "confirmed"
    SHIPPED = "shipped"
    DELIVERED = "delivered"
    CANCELLED = "cancelled"

class OrderState(ABC):
    """è®¢å•çŠ¶æ€æŠ½è±¡åŸºç±»"""

    @abstractmethod
    def confirm(self, order: 'Order') -> None:
        """ç¡®è®¤è®¢å•"""
        pass

    @abstractmethod
    def ship(self, order: 'Order') -> None:
        """å‘è´§"""
        pass

    @abstractmethod
    def deliver(self, order: 'Order') -> None:
        """é€è¾¾"""
        pass

    @abstractmethod
    def cancel(self, order: 'Order') -> None:
        """å–æ¶ˆè®¢å•"""
        pass

    @abstractmethod
    def get_status(self) -> OrderStatus:
        """è·å–çŠ¶æ€"""
        pass

class PendingState(OrderState):
    """å¾…ç¡®è®¤çŠ¶æ€"""

    def confirm(self, order: 'Order') -> None:
        print("è®¢å•å·²ç¡®è®¤")
        order.set_state(ConfirmedState())

    def ship(self, order: 'Order') -> None:
        print("âŒ å¾…ç¡®è®¤è®¢å•æ— æ³•å‘è´§")

    def deliver(self, order: 'Order') -> None:
        print("âŒ å¾…ç¡®è®¤è®¢å•æ— æ³•é€è¾¾")

    def cancel(self, order: 'Order') -> None:
        print("è®¢å•å·²å–æ¶ˆ")
        order.set_state(CancelledState())

    def get_status(self) -> OrderStatus:
        return OrderStatus.PENDING

class ConfirmedState(OrderState):
    """å·²ç¡®è®¤çŠ¶æ€"""

    def confirm(self, order: 'Order') -> None:
        print("âŒ è®¢å•å·²ç»ç¡®è®¤")

    def ship(self, order: 'Order') -> None:
        print("è®¢å•å·²å‘è´§")
        order.set_state(ShippedState())

    def deliver(self, order: 'Order') -> None:
        print("âŒ å·²ç¡®è®¤è®¢å•æ— æ³•ç›´æ¥é€è¾¾")

    def cancel(self, order: 'Order') -> None:
        print("è®¢å•å·²å–æ¶ˆ")
        order.set_state(CancelledState())

    def get_status(self) -> OrderStatus:
        return OrderStatus.CONFIRMED

class ShippedState(OrderState):
    """å·²å‘è´§çŠ¶æ€"""

    def confirm(self, order: 'Order') -> None:
        print("âŒ å·²å‘è´§è®¢å•æ— æ³•é‡æ–°ç¡®è®¤")

    def ship(self, order: 'Order') -> None:
        print("âŒ è®¢å•å·²ç»å‘è´§")

    def deliver(self, order: 'Order') -> None:
        print("è®¢å•å·²é€è¾¾")
        order.set_state(DeliveredState())

    def cancel(self, order: 'Order') -> None:
        print("âŒ å·²å‘è´§è®¢å•æ— æ³•å–æ¶ˆ")

    def get_status(self) -> OrderStatus:
        return OrderStatus.SHIPPED

class DeliveredState(OrderState):
    """å·²é€è¾¾çŠ¶æ€"""

    def confirm(self, order: 'Order') -> None:
        print("âŒ å·²é€è¾¾è®¢å•æ— æ³•é‡æ–°ç¡®è®¤")

    def ship(self, order: 'Order') -> None:
        print("âŒ å·²é€è¾¾è®¢å•æ— æ³•é‡æ–°å‘è´§")

    def deliver(self, order: 'Order') -> None:
        print("âŒ è®¢å•å·²ç»é€è¾¾")

    def cancel(self, order: 'Order') -> None:
        print("âŒ å·²é€è¾¾è®¢å•æ— æ³•å–æ¶ˆ")

    def get_status(self) -> OrderStatus:
        return OrderStatus.DELIVERED

class CancelledState(OrderState):
    """å·²å–æ¶ˆçŠ¶æ€"""

    def confirm(self, order: 'Order') -> None:
        print("âŒ å·²å–æ¶ˆè®¢å•æ— æ³•é‡æ–°ç¡®è®¤")

    def ship(self, order: 'Order') -> None:
        print("âŒ å·²å–æ¶ˆè®¢å•æ— æ³•å‘è´§")

    def deliver(self, order: 'Order') -> None:
        print("âŒ å·²å–æ¶ˆè®¢å•æ— æ³•é€è¾¾")

    def cancel(self, order: 'Order') -> None:
        print("âŒ è®¢å•å·²ç»å–æ¶ˆ")

    def get_status(self) -> OrderStatus:
        return OrderStatus.CANCELLED

class Order:
    """è®¢å•ç±»"""

    def __init__(self, order_id: str, customer: str):
        self.order_id = order_id
        self.customer = customer
        self._state: OrderState = PendingState()

    def set_state(self, state: OrderState) -> None:
        """è®¾ç½®çŠ¶æ€"""
        self._state = state

    def confirm(self) -> None:
        """ç¡®è®¤è®¢å•"""
        self._state.confirm(self)

    def ship(self) -> None:
        """å‘è´§"""
        self._state.ship(self)

    def deliver(self) -> None:
        """é€è¾¾"""
        self._state.deliver(self)

    def cancel(self) -> None:
        """å–æ¶ˆè®¢å•"""
        self._state.cancel(self)

    def get_status(self) -> OrderStatus:
        """è·å–çŠ¶æ€"""
        return self._state.get_status()

    def __str__(self) -> str:
        return f"Order({self.order_id}, {self.customer}, {self.get_status().value})"

# ä½¿ç”¨ç¤ºä¾‹
def test_state_pattern():
    """æµ‹è¯•çŠ¶æ€æ¨¡å¼"""
    # åˆ›å»ºè®¢å•
    order = Order("ORD-001", "å¼ ä¸‰")
    print(f"åˆå§‹çŠ¶æ€: {order}")

    # æµ‹è¯•çŠ¶æ€è½¬æ¢
    print("\n=== æ­£å¸¸æµç¨‹ ===")
    order.confirm()
    print(f"çŠ¶æ€: {order}")

    order.ship()
    print(f"çŠ¶æ€: {order}")

    order.deliver()
    print(f"çŠ¶æ€: {order}")

    # æµ‹è¯•æ— æ•ˆæ“ä½œ
    print("\n=== æ— æ•ˆæ“ä½œæµ‹è¯• ===")
    order.confirm()  # å·²é€è¾¾è®¢å•æ— æ³•é‡æ–°ç¡®è®¤
    order.ship()     # å·²é€è¾¾è®¢å•æ— æ³•é‡æ–°å‘è´§
    order.cancel()   # å·²é€è¾¾è®¢å•æ— æ³•å–æ¶ˆ

    # æµ‹è¯•å–æ¶ˆæµç¨‹
    print("\n=== å–æ¶ˆæµç¨‹ ===")
    order2 = Order("ORD-002", "æå››")
    print(f"åˆå§‹çŠ¶æ€: {order2}")

    order2.cancel()
    print(f"çŠ¶æ€: {order2}")

    # æµ‹è¯•å–æ¶ˆåçš„æ— æ•ˆæ“ä½œ
    order2.confirm()  # å·²å–æ¶ˆè®¢å•æ— æ³•é‡æ–°ç¡®è®¤
    order2.ship()     # å·²å–æ¶ˆè®¢å•æ— æ³•å‘è´§

if __name__ == "__main__":
    test_state_pattern()

## 6. æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method)

### 6.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰ 6.1** (æ¨¡æ¿æ–¹æ³•æ¨¡å¼)
æ¨¡æ¿æ–¹æ³•æ¨¡å¼æ˜¯ä¸€ä¸ªå››å…ƒç»„ï¼š
$$Template = (A, S, \alpha, \beta)$$

å…¶ä¸­ï¼š
- $A$ ä¸ºç®—æ³•æ¡†æ¶é›†åˆ
- $S$ ä¸ºå…·ä½“æ­¥éª¤é›†åˆ
- $\alpha: A \rightarrow S^*$ ä¸ºç®—æ³•åˆ°æ­¥éª¤åºåˆ—çš„æ˜ å°„
- $\beta: S \times Context \rightarrow Result$ ä¸ºæ­¥éª¤æ‰§è¡Œå‡½æ•°

**å®šç† 6.1** (æ¨¡æ¿æ–¹æ³•ä¸å˜æ€§)
å¯¹äºç®—æ³•æ¡†æ¶ $a$ï¼Œæ­¥éª¤åºåˆ—æ˜¯å›ºå®šçš„ï¼š
$$\alpha(a) = [s_1, s_2, ..., s_n] \text{ where } s_i \in S$$

### 6.2 Pythonå®ç°

```python
from abc import ABC, abstractmethod
from typing import List, Any, Protocol
from dataclasses import dataclass
from enum import Enum

class DataProcessor(ABC):
    """æ•°æ®å¤„ç†å™¨æŠ½è±¡åŸºç±»"""

    def process(self, data: List[Any]) -> List[Any]:
        """æ¨¡æ¿æ–¹æ³•ï¼šå¤„ç†æ•°æ®çš„å®Œæ•´æµç¨‹"""
        print("å¼€å§‹æ•°æ®å¤„ç†...")

        # 1. æ•°æ®éªŒè¯
        validated_data = self.validate_data(data)
        print(f"æ•°æ®éªŒè¯å®Œæˆï¼Œæœ‰æ•ˆæ•°æ®: {len(validated_data)} æ¡")

        # 2. æ•°æ®æ¸…æ´—
        cleaned_data = self.clean_data(validated_data)
        print(f"æ•°æ®æ¸…æ´—å®Œæˆï¼Œæ¸…æ´—åæ•°æ®: {len(cleaned_data)} æ¡")

        # 3. æ•°æ®è½¬æ¢
        transformed_data = self.transform_data(cleaned_data)
        print(f"æ•°æ®è½¬æ¢å®Œæˆï¼Œè½¬æ¢åæ•°æ®: {len(transformed_data)} æ¡")

        # 4. æ•°æ®èšåˆ
        aggregated_data = self.aggregate_data(transformed_data)
        print(f"æ•°æ®èšåˆå®Œæˆï¼Œèšåˆåæ•°æ®: {len(aggregated_data)} æ¡")

        # 5. ç»“æœè¾“å‡º
        result = self.output_result(aggregated_data)
        print("æ•°æ®å¤„ç†å®Œæˆ!")

        return result

    @abstractmethod
    def validate_data(self, data: List[Any]) -> List[Any]:
        """æ•°æ®éªŒè¯ï¼ˆæŠ½è±¡æ–¹æ³•ï¼‰"""
        pass

    @abstractmethod
    def clean_data(self, data: List[Any]) -> List[Any]:
        """æ•°æ®æ¸…æ´—ï¼ˆæŠ½è±¡æ–¹æ³•ï¼‰"""
        pass

    @abstractmethod
    def transform_data(self, data: List[Any]) -> List[Any]:
        """æ•°æ®è½¬æ¢ï¼ˆæŠ½è±¡æ–¹æ³•ï¼‰"""
        pass

    @abstractmethod
    def aggregate_data(self, data: List[Any]) -> List[Any]:
        """æ•°æ®èšåˆï¼ˆæŠ½è±¡æ–¹æ³•ï¼‰"""
        pass

    @abstractmethod
    def output_result(self, data: List[Any]) -> List[Any]:
        """ç»“æœè¾“å‡ºï¼ˆæŠ½è±¡æ–¹æ³•ï¼‰"""
        pass

class SalesDataProcessor(DataProcessor):
    """é”€å”®æ•°æ®å¤„ç†å™¨"""

    def validate_data(self, data: List[Any]) -> List[Any]:
        """éªŒè¯é”€å”®æ•°æ®"""
        validated = []
        for item in data:
            if isinstance(item, dict) and 'amount' in item and 'date' in item:
                if item['amount'] > 0:
                    validated.append(item)
        return validated

    def clean_data(self, data: List[Any]) -> List[Any]:
        """æ¸…æ´—é”€å”®æ•°æ®"""
        cleaned = []
        for item in data:
            # ç§»é™¤å¼‚å¸¸å€¼
            if item['amount'] < 10000:  # å‡è®¾å¼‚å¸¸å€¼é˜ˆå€¼
                cleaned.append(item)
        return cleaned

    def transform_data(self, data: List[Any]) -> List[Any]:
        """è½¬æ¢é”€å”®æ•°æ®"""
        transformed = []
        for item in data:
            # æ·»åŠ è®¡ç®—å­—æ®µ
            item_copy = item.copy()
            item_copy['month'] = item['date'][:7]  # æå–æœˆä»½
            item_copy['quarter'] = f"Q{(int(item['date'][5:7])-1)//3 + 1}"
            transformed.append(item_copy)
        return transformed

    def aggregate_data(self, data: List[Any]) -> List[Any]:
        """èšåˆé”€å”®æ•°æ®"""
        monthly_sales = {}
        for item in data:
            month = item['month']
            if month not in monthly_sales:
                monthly_sales[month] = {'total': 0, 'count': 0}
            monthly_sales[month]['total'] += item['amount']
            monthly_sales[month]['count'] += 1

        aggregated = []
        for month, stats in monthly_sales.items():
            aggregated.append({
                'month': month,
                'total_sales': stats['total'],
                'transaction_count': stats['count'],
                'average_sale': stats['total'] / stats['count']
            })
        return aggregated

    def output_result(self, data: List[Any]) -> List[Any]:
        """è¾“å‡ºé”€å”®åˆ†æç»“æœ"""
        # æŒ‰æ€»é”€å”®é¢æ’åº
        result = sorted(data, key=lambda x: x['total_sales'], reverse=True)
        return result

class UserDataProcessor(DataProcessor):
    """ç”¨æˆ·æ•°æ®å¤„ç†å™¨"""

    def validate_data(self, data: List[Any]) -> List[Any]:
        """éªŒè¯ç”¨æˆ·æ•°æ®"""
        validated = []
        for item in data:
            if isinstance(item, dict) and 'user_id' in item and 'age' in item:
                if 0 < item['age'] < 120:  # åˆç†çš„å¹´é¾„èŒƒå›´
                    validated.append(item)
        return validated

    def clean_data(self, data: List[Any]) -> List[Any]:
        """æ¸…æ´—ç”¨æˆ·æ•°æ®"""
        cleaned = []
        for item in data:
            # ç§»é™¤é‡å¤ç”¨æˆ·
            if not any(x['user_id'] == item['user_id'] for x in cleaned):
                cleaned.append(item)
        return cleaned

    def transform_data(self, data: List[Any]) -> List[Any]:
        """è½¬æ¢ç”¨æˆ·æ•°æ®"""
        transformed = []
        for item in data:
            item_copy = item.copy()
            # æ·»åŠ å¹´é¾„æ®µ
            if item['age'] < 18:
                item_copy['age_group'] = 'æœªæˆå¹´'
            elif item['age'] < 30:
                item_copy['age_group'] = 'é’å¹´'
            elif item['age'] < 50:
                item_copy['age_group'] = 'ä¸­å¹´'
            else:
                item_copy['age_group'] = 'è€å¹´'
            transformed.append(item_copy)
        return transformed

    def aggregate_data(self, data: List[Any]) -> List[Any]:
        """èšåˆç”¨æˆ·æ•°æ®"""
        age_group_stats = {}
        for item in data:
            age_group = item['age_group']
            if age_group not in age_group_stats:
                age_group_stats[age_group] = {'count': 0, 'total_age': 0}
            age_group_stats[age_group]['count'] += 1
            age_group_stats[age_group]['total_age'] += item['age']

        aggregated = []
        for age_group, stats in age_group_stats.items():
            aggregated.append({
                'age_group': age_group,
                'user_count': stats['count'],
                'average_age': stats['total_age'] / stats['count']
            })
        return aggregated

    def output_result(self, data: List[Any]) -> List[Any]:
        """è¾“å‡ºç”¨æˆ·åˆ†æç»“æœ"""
        # æŒ‰ç”¨æˆ·æ•°é‡æ’åº
        result = sorted(data, key=lambda x: x['user_count'], reverse=True)
        return result

# ä½¿ç”¨ç¤ºä¾‹
def test_template_method_pattern():
    """æµ‹è¯•æ¨¡æ¿æ–¹æ³•æ¨¡å¼"""
    # æµ‹è¯•é”€å”®æ•°æ®å¤„ç†
    print("=== é”€å”®æ•°æ®å¤„ç† ===")
    sales_data = [
        {'amount': 1000, 'date': '2024-01-15'},
        {'amount': 2000, 'date': '2024-01-20'},
        {'amount': 1500, 'date': '2024-02-10'},
        {'amount': 3000, 'date': '2024-02-25'},
        {'amount': 500, 'date': '2024-03-05'},
    ]

    sales_processor = SalesDataProcessor()
    sales_result = sales_processor.process(sales_data)
    print("é”€å”®åˆ†æç»“æœ:")
    for item in sales_result:
        print(f"  {item['month']}: æ€»é”€å”®é¢ {item['total_sales']}, äº¤æ˜“æ¬¡æ•° {item['transaction_count']}")

    print("\n=== ç”¨æˆ·æ•°æ®å¤„ç† ===")
    user_data = [
        {'user_id': 1, 'age': 25},
        {'user_id': 2, 'age': 35},
        {'user_id': 3, 'age': 45},
        {'user_id': 4, 'age': 22},
        {'user_id': 5, 'age': 55},
        {'user_id': 1, 'age': 25},  # é‡å¤ç”¨æˆ·
    ]

    user_processor = UserDataProcessor()
    user_result = user_processor.process(user_data)
    print("ç”¨æˆ·åˆ†æç»“æœ:")
    for item in user_result:
        print(f"  {item['age_group']}: ç”¨æˆ·æ•° {item['user_count']}, å¹³å‡å¹´é¾„ {item['average_age']:.1f}")

if __name__ == "__main__":
    test_template_method_pattern()

## 7. è®¿é—®è€…æ¨¡å¼ (Visitor)

### 7.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰ 7.1** (è®¿é—®è€…æ¨¡å¼)
è®¿é—®è€…æ¨¡å¼æ˜¯ä¸€ä¸ªäº”å…ƒç»„ï¼š
$$Visitor = (E, V, \alpha, \beta, \gamma)$$

å…¶ä¸­ï¼š
- $E$ ä¸ºå…ƒç´ é›†åˆ
- $V$ ä¸ºè®¿é—®è€…é›†åˆ
- $\alpha: E \rightarrow \mathcal{P}(V)$ ä¸ºå…ƒç´ å¯æ¥å—è®¿é—®è€…é›†åˆ
- $\beta: V \times E \rightarrow Result$ ä¸ºè®¿é—®å‡½æ•°
- $\gamma: E \rightarrow \mathcal{P}(E)$ ä¸ºå…ƒç´ ç»“æ„å‡½æ•°

**å®šç† 7.1** (è®¿é—®è€…åŒåˆ†æ´¾)
å¯¹äºå…ƒç´  $e$ å’Œè®¿é—®è€… $v$ï¼Œè®¿é—®æ“ä½œæ˜¯åŒåˆ†æ´¾çš„ï¼š
$$\beta(v, e) = \text{visit}_{type(e)}(v, e)$$

### 7.2 Pythonå®ç°

```python
from abc import ABC, abstractmethod
from typing import List, Any, Protocol
from dataclasses import dataclass
from enum import Enum

class Visitor(ABC):
    """è®¿é—®è€…æŠ½è±¡åŸºç±»"""

    @abstractmethod
    def visit_circle(self, circle: 'Circle') -> Any:
        """è®¿é—®åœ†å½¢"""
        pass

    @abstractmethod
    def visit_rectangle(self, rectangle: 'Rectangle') -> Any:
        """è®¿é—®çŸ©å½¢"""
        pass

    @abstractmethod
    def visit_triangle(self, triangle: 'Triangle') -> Any:
        """è®¿é—®ä¸‰è§’å½¢"""
        pass

class Shape(ABC):
    """å½¢çŠ¶æŠ½è±¡åŸºç±»"""

    @abstractmethod
    def accept(self, visitor: Visitor) -> Any:
        """æ¥å—è®¿é—®è€…"""
        pass

class Circle(Shape):
    """åœ†å½¢"""

    def __init__(self, radius: float):
        self.radius = radius

    def accept(self, visitor: Visitor) -> Any:
        return visitor.visit_circle(self)

class Rectangle(Shape):
    """çŸ©å½¢"""

    def __init__(self, width: float, height: float):
        self.width = width
        self.height = height

    def accept(self, visitor: Visitor) -> Any:
        return visitor.visit_rectangle(self)

class Triangle(Shape):
    """ä¸‰è§’å½¢"""

    def __init__(self, a: float, b: float, c: float):
        self.a = a
        self.b = b
        self.c = c

    def accept(self, visitor: Visitor) -> Any:
        return visitor.visit_triangle(self)

class AreaVisitor(Visitor):
    """é¢ç§¯è®¡ç®—è®¿é—®è€…"""

    def visit_circle(self, circle: Circle) -> float:
        import math
        return math.pi * circle.radius ** 2

    def visit_rectangle(self, rectangle: Rectangle) -> float:
        return rectangle.width * rectangle.height

    def visit_triangle(self, triangle: Triangle) -> float:
        import math
        # æµ·ä¼¦å…¬å¼
        s = (triangle.a + triangle.b + triangle.c) / 2
        return math.sqrt(s * (s - triangle.a) * (s - triangle.b) * (s - triangle.c))

class PerimeterVisitor(Visitor):
    """å‘¨é•¿è®¡ç®—è®¿é—®è€…"""

    def visit_circle(self, circle: Circle) -> float:
        import math
        return 2 * math.pi * circle.radius

    def visit_rectangle(self, rectangle: Rectangle) -> float:
        return 2 * (rectangle.width + rectangle.height)

    def visit_triangle(self, triangle: Triangle) -> float:
        return triangle.a + triangle.b + triangle.c

class DrawVisitor(Visitor):
    """ç»˜åˆ¶è®¿é—®è€…"""

    def visit_circle(self, circle: Circle) -> str:
        return f"ç»˜åˆ¶åœ†å½¢ï¼ŒåŠå¾„: {circle.radius}"

    def visit_rectangle(self, rectangle: Rectangle) -> str:
        return f"ç»˜åˆ¶çŸ©å½¢ï¼Œå®½: {rectangle.width}, é«˜: {rectangle.height}"

    def visit_triangle(self, triangle: Triangle) -> str:
        return f"ç»˜åˆ¶ä¸‰è§’å½¢ï¼Œè¾¹é•¿: {triangle.a}, {triangle.b}, {triangle.c}"

class ShapeCollection:
    """å½¢çŠ¶é›†åˆ"""

    def __init__(self):
        self.shapes: List[Shape] = []

    def add_shape(self, shape: Shape) -> None:
        """æ·»åŠ å½¢çŠ¶"""
        self.shapes.append(shape)

    def accept_visitor(self, visitor: Visitor) -> List[Any]:
        """æ¥å—è®¿é—®è€…"""
        results = []
        for shape in self.shapes:
            results.append(shape.accept(visitor))
        return results

# ä½¿ç”¨ç¤ºä¾‹
def test_visitor_pattern():
    """æµ‹è¯•è®¿é—®è€…æ¨¡å¼"""
    # åˆ›å»ºå½¢çŠ¶é›†åˆ
    collection = ShapeCollection()
    collection.add_shape(Circle(5))
    collection.add_shape(Rectangle(4, 6))
    collection.add_shape(Triangle(3, 4, 5))

    # è®¡ç®—é¢ç§¯
    area_visitor = AreaVisitor()
    areas = collection.accept_visitor(area_visitor)
    print("é¢ç§¯è®¡ç®—:")
    for i, area in enumerate(areas):
        print(f"  å½¢çŠ¶ {i+1}: {area:.2f}")

    # è®¡ç®—å‘¨é•¿
    perimeter_visitor = PerimeterVisitor()
    perimeters = collection.accept_visitor(perimeter_visitor)
    print("\nå‘¨é•¿è®¡ç®—:")
    for i, perimeter in enumerate(perimeters):
        print(f"  å½¢çŠ¶ {i+1}: {perimeter:.2f}")

    # ç»˜åˆ¶å½¢çŠ¶
    draw_visitor = DrawVisitor()
    drawings = collection.accept_visitor(draw_visitor)
    print("\nç»˜åˆ¶æ“ä½œ:")
    for i, drawing in enumerate(drawings):
        print(f"  å½¢çŠ¶ {i+1}: {drawing}")

if __name__ == "__main__":
    test_visitor_pattern()

## æ€»ç»“

è¡Œä¸ºå‹æ¨¡å¼é€šè¿‡å®šä¹‰å¯¹è±¡é—´çš„äº¤äº’æ–¹å¼ï¼Œä½¿ç³»ç»Ÿæ›´åŠ çµæ´»å’Œå¯ç»´æŠ¤ã€‚æ¯ç§æ¨¡å¼éƒ½æœ‰å…¶ç‰¹å®šçš„åº”ç”¨åœºæ™¯ï¼š

1. **è´£ä»»é“¾æ¨¡å¼**: é€‚ç”¨äºéœ€è¦åŠ¨æ€ç¡®å®šå¤„ç†è€…çš„åœºæ™¯
2. **å‘½ä»¤æ¨¡å¼**: é€‚ç”¨äºéœ€è¦æ”¯æŒæ’¤é”€ã€é‡åšæ“ä½œçš„åœºæ™¯
3. **è§‚å¯Ÿè€…æ¨¡å¼**: é€‚ç”¨äºéœ€è¦å®ç°æ¾è€¦åˆçš„äº‹ä»¶é€šçŸ¥æœºåˆ¶
4. **ç­–ç•¥æ¨¡å¼**: é€‚ç”¨äºéœ€è¦åœ¨è¿è¡Œæ—¶åˆ‡æ¢ç®—æ³•çš„åœºæ™¯
5. **çŠ¶æ€æ¨¡å¼**: é€‚ç”¨äºå¯¹è±¡è¡Œä¸ºéšçŠ¶æ€æ”¹å˜è€Œæ”¹å˜çš„åœºæ™¯
6. **æ¨¡æ¿æ–¹æ³•æ¨¡å¼**: é€‚ç”¨äºå®šä¹‰ç®—æ³•æ¡†æ¶ï¼Œè®©å­ç±»å®ç°å…·ä½“æ­¥éª¤
7. **è®¿é—®è€…æ¨¡å¼**: é€‚ç”¨äºéœ€è¦å¯¹å¤æ‚å¯¹è±¡ç»“æ„è¿›è¡Œå¤šç§æ“ä½œçš„åœºæ™¯

è¿™äº›æ¨¡å¼éƒ½æä¾›äº†å½¢å¼åŒ–çš„æ•°å­¦å®šä¹‰å’Œå®Œæ•´çš„Pythonå®ç°ï¼Œç¡®ä¿äº†ç†è®ºçš„ä¸€è‡´æ€§å’Œå®è·µçš„å¯è¡Œæ€§ã€‚
