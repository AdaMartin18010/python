# å¾®æœåŠ¡æ¶æ„ï¼šæœåŠ¡å‘ç°ç†è®º

## ğŸ“‹ æ¦‚è¿°

æœåŠ¡å‘ç°æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„å…³é”®ç»„ä»¶ï¼Œè´Ÿè´£ç®¡ç†æœåŠ¡å®ä¾‹çš„æ³¨å†Œã€å‘ç°å’Œå¥åº·æ£€æŸ¥ã€‚æœ¬æ–‡æ¡£ä»å½¢å¼åŒ–è§’åº¦åˆ†ææœåŠ¡å‘ç°çš„ç†è®ºåŸºç¡€ã€ç®—æ³•è®¾è®¡å’Œå®ç°æ–¹æ³•ã€‚

## 1. æ¦‚å¿µåŸºç¡€

### 1.1 æœåŠ¡å‘ç°å®šä¹‰

**æœåŠ¡å‘ç°**æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­ç”¨äºåŠ¨æ€å‘ç°å’Œå®šä½æœåŠ¡å®ä¾‹çš„æœºåˆ¶ï¼ŒåŒ…æ‹¬æœåŠ¡æ³¨å†Œã€æœåŠ¡å‘ç°å’Œå¥åº·æ£€æŸ¥ä¸‰ä¸ªæ ¸å¿ƒåŠŸèƒ½ã€‚

#### å½¢å¼åŒ–å®šä¹‰

è®¾ $S = \{s_1, s_2, ..., s_n\}$ ä¸ºæœåŠ¡é›†åˆï¼Œ$I = \{i_1, i_2, ..., i_m\}$ ä¸ºæœåŠ¡å®ä¾‹é›†åˆã€‚

æœåŠ¡å‘ç°ç³»ç»Ÿ $SD = (Registry, Discovery, HealthCheck)$ å…¶ä¸­ï¼š

- **æ³¨å†Œä¸­å¿ƒ** (Registry): $R: I \rightarrow S \times Metadata$
- **å‘ç°æœåŠ¡** (Discovery): $D: S \times Criteria \rightarrow 2^I$
- **å¥åº·æ£€æŸ¥** (HealthCheck): $H: I \rightarrow \{healthy, unhealthy\}$

### 1.2 æœåŠ¡å‘ç°ç›®æ ‡

#### 1.2.1 å¯ç”¨æ€§æœ€å¤§åŒ–

æœåŠ¡å¯ç”¨æ€§å®šä¹‰ä¸ºï¼š

$$Availability(S) = \frac{|\{i \in I_S | H(i) = healthy\}|}{|I_S|}$$

å…¶ä¸­ $I_S$ ä¸ºæœåŠ¡ $S$ çš„æ‰€æœ‰å®ä¾‹é›†åˆã€‚

#### 1.2.2 è´Ÿè½½å‡è¡¡

è´Ÿè½½å‡è¡¡ç›®æ ‡å‡½æ•°ï¼š

$$LoadBalance(I_S) = 1 - \frac{\sigma(Load(I_S))}{\mu(Load(I_S))}$$

å…¶ä¸­ $Load(i)$ ä¸ºå®ä¾‹ $i$ çš„è´Ÿè½½ï¼Œ$\sigma$ ä¸ºæ ‡å‡†å·®ï¼Œ$\mu$ ä¸ºå¹³å‡å€¼ã€‚

#### 1.2.3 å“åº”æ—¶é—´æœ€å°åŒ–

å¹³å‡å“åº”æ—¶é—´ï¼š

$$ResponseTime(S) = \frac{1}{|I_S|} \sum_{i \in I_S} RT(i)$$

å…¶ä¸­ $RT(i)$ ä¸ºå®ä¾‹ $i$ çš„å“åº”æ—¶é—´ã€‚

## 2. æœåŠ¡å‘ç°ç­–ç•¥

### 2.1 æœåŠ¡æ³¨å†Œç­–ç•¥

#### 2.1.1 ä¸»åŠ¨æ³¨å†Œ

**å®šä¹‰**: æœåŠ¡å®ä¾‹ä¸»åŠ¨å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±ã€‚

**å½¢å¼åŒ–è¡¨ç¤º**:

æ³¨å†Œå‡½æ•° $Register: I \times S \times Metadata \rightarrow Registry$

$$Register(i, s, m) = \{(i, s, m, timestamp)\}$$

#### 2.1.2 è¢«åŠ¨æ³¨å†Œ

**å®šä¹‰**: æ³¨å†Œä¸­å¿ƒä¸»åŠ¨å‘ç°å’Œæ³¨å†ŒæœåŠ¡å®ä¾‹ã€‚

**å½¢å¼åŒ–è¡¨ç¤º**:

å‘ç°å‡½æ•° $Discover: Network \rightarrow 2^I$

$$Discover(network) = \{i | i \in network \land isService(i)\}$$

### 2.2 æœåŠ¡å‘ç°ç­–ç•¥

#### 2.2.1 å®¢æˆ·ç«¯å‘ç°

**å®šä¹‰**: å®¢æˆ·ç«¯ç›´æ¥æŸ¥è¯¢æ³¨å†Œä¸­å¿ƒè·å–æœåŠ¡å®ä¾‹ã€‚

**å½¢å¼åŒ–è¡¨ç¤º**:

å‘ç°å‡½æ•° $ClientDiscovery: S \times Criteria \rightarrow 2^I$

$$ClientDiscovery(s, c) = \{i | (i, s, m) \in Registry \land H(i) = healthy \land match(i, c)\}$$

#### 2.2.2 æœåŠ¡ç«¯å‘ç°

**å®šä¹‰**: é€šè¿‡è´Ÿè½½å‡è¡¡å™¨æˆ–APIç½‘å…³è¿›è¡ŒæœåŠ¡å‘ç°ã€‚

**å½¢å¼åŒ–è¡¨ç¤º**:

è·¯ç”±å‡½æ•° $ServerDiscovery: Request \times S \rightarrow I$

$$ServerDiscovery(req, s) = argmin_{i \in I_s} Load(i)$$

### 2.3 è´Ÿè½½å‡è¡¡ç­–ç•¥

#### 2.3.1 è½®è¯¢ç®—æ³•

**å®šä¹‰**: æŒ‰é¡ºåºåˆ†é…è¯·æ±‚åˆ°æœåŠ¡å®ä¾‹ã€‚

**å½¢å¼åŒ–è¡¨ç¤º**:

$$RoundRobin(I_S, req) = I_S[req.id \bmod |I_S|]$$

#### 2.3.2 åŠ æƒè½®è¯¢ç®—æ³•

**å®šä¹‰**: æ ¹æ®æƒé‡åˆ†é…è¯·æ±‚ã€‚

**å½¢å¼åŒ–è¡¨ç¤º**:

$$WeightedRoundRobin(I_S, weights, req) = I_S[j]$$

å…¶ä¸­ $j$ æ»¡è¶³ï¼š

$$\sum_{k=0}^{j-1} weights[k] \leq req.id \bmod \sum_{k=0}^{|I_S|-1} weights[k] < \sum_{k=0}^{j} weights[k]$$

#### 2.3.3 æœ€å°‘è¿æ¥ç®—æ³•

**å®šä¹‰**: é€‰æ‹©è¿æ¥æ•°æœ€å°‘çš„å®ä¾‹ã€‚

**å½¢å¼åŒ–è¡¨ç¤º**:

$$LeastConnection(I_S) = argmin_{i \in I_S} Connections(i)$$

#### 2.3.4 ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•

**å®šä¹‰**: ä½¿ç”¨å“ˆå¸Œå‡½æ•°ç¡®ä¿ç›¸åŒè¯·æ±‚æ€»æ˜¯è·¯ç”±åˆ°ç›¸åŒå®ä¾‹ã€‚

**å½¢å¼åŒ–è¡¨ç¤º**:

$$ConsistentHash(I_S, key) = I_S[hash(key) \bmod |I_S|]$$

## 3. æœåŠ¡å‘ç°ç®—æ³•

### 3.1 æ³¨å†Œä¸­å¿ƒç®—æ³•

#### 3.1.1 åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨

**ç®—æ³•æè¿°**:

```python
class DistributedRegistry:
    """åˆ†å¸ƒå¼æ³¨å†Œä¸­å¿ƒ"""
    
    def __init__(self):
        self.services = {}  # æœåŠ¡æ³¨å†Œè¡¨
        self.instances = {}  # å®ä¾‹ä¿¡æ¯
        self.health_checks = {}  # å¥åº·æ£€æŸ¥çŠ¶æ€
    
    def register_service(self, service_name: str, instance: ServiceInstance) -> bool:
        """æ³¨å†ŒæœåŠ¡å®ä¾‹"""
        if service_name not in self.services:
            self.services[service_name] = []
        
        # æ£€æŸ¥å®ä¾‹æ˜¯å¦å·²å­˜åœ¨
        for existing_instance in self.services[service_name]:
            if existing_instance.id == instance.id:
                # æ›´æ–°å®ä¾‹ä¿¡æ¯
                existing_instance.update(instance)
                return True
        
        # æ·»åŠ æ–°å®ä¾‹
        self.services[service_name].append(instance)
        self.instances[instance.id] = instance
        return True
    
    def deregister_service(self, service_name: str, instance_id: str) -> bool:
        """æ³¨é”€æœåŠ¡å®ä¾‹"""
        if service_name in self.services:
            self.services[service_name] = [
                inst for inst in self.services[service_name] 
                if inst.id != instance_id
            ]
        
        if instance_id in self.instances:
            del self.instances[instance_id]
        
        return True
    
    def discover_service(self, service_name: str, criteria: DiscoveryCriteria = None) -> List[ServiceInstance]:
        """å‘ç°æœåŠ¡å®ä¾‹"""
        if service_name not in self.services:
            return []
        
        instances = self.services[service_name]
        
        # è¿‡æ»¤å¥åº·å®ä¾‹
        healthy_instances = [
            inst for inst in instances 
            if self.is_healthy(inst.id)
        ]
        
        # åº”ç”¨å‘ç°æ¡ä»¶
        if criteria:
            healthy_instances = self.apply_criteria(healthy_instances, criteria)
        
        return healthy_instances
    
    def is_healthy(self, instance_id: str) -> bool:
        """æ£€æŸ¥å®ä¾‹å¥åº·çŠ¶æ€"""
        return self.health_checks.get(instance_id, False)
    
    def update_health(self, instance_id: str, is_healthy: bool):
        """æ›´æ–°å¥åº·çŠ¶æ€"""
        self.health_checks[instance_id] = is_healthy
```

#### 3.1.2 ä¸€è‡´æ€§åè®®

**Raftç®—æ³•**:

Raftç®—æ³•ç”¨äºä¿è¯æ³¨å†Œä¸­å¿ƒçš„ä¸€è‡´æ€§ï¼ŒåŒ…æ‹¬ï¼š

1. **é¢†å¯¼è€…é€‰ä¸¾**: é€‰æ‹©ä¸€ä¸ªé¢†å¯¼è€…å¤„ç†æ‰€æœ‰å†™è¯·æ±‚
2. **æ—¥å¿—å¤åˆ¶**: å°†å†™è¯·æ±‚å¤åˆ¶åˆ°æ‰€æœ‰èŠ‚ç‚¹
3. **å®‰å…¨æ€§**: ç¡®ä¿æ‰€æœ‰èŠ‚ç‚¹çœ‹åˆ°ç›¸åŒçš„æ—¥å¿—

**å½¢å¼åŒ–è¡¨ç¤º**:

è®¾ $N = \{n_1, n_2, ..., n_k\}$ ä¸ºèŠ‚ç‚¹é›†åˆï¼Œ$L$ ä¸ºæ—¥å¿—ã€‚

RaftçŠ¶æ€æœº $Raft = (State, Term, Log, CommitIndex)$ å…¶ä¸­ï¼š

- $State \in \{follower, candidate, leader\}$
- $Term$ ä¸ºå½“å‰ä»»æœŸ
- $Log$ ä¸ºæ—¥å¿—æ¡ç›®
- $CommitIndex$ ä¸ºå·²æäº¤çš„æ—¥å¿—ç´¢å¼•

### 3.2 è´Ÿè½½å‡è¡¡ç®—æ³•

#### 3.2.1 è½®è¯¢è´Ÿè½½å‡è¡¡å™¨

```python
class RoundRobinLoadBalancer:
    """è½®è¯¢è´Ÿè½½å‡è¡¡å™¨"""
    
    def __init__(self):
        self.current_index = 0
        self.instances = []
    
    def add_instance(self, instance: ServiceInstance):
        """æ·»åŠ æœåŠ¡å®ä¾‹"""
        self.instances.append(instance)
    
    def remove_instance(self, instance_id: str):
        """ç§»é™¤æœåŠ¡å®ä¾‹"""
        self.instances = [inst for inst in self.instances if inst.id != instance_id]
    
    def get_next_instance(self) -> ServiceInstance:
        """è·å–ä¸‹ä¸€ä¸ªå®ä¾‹"""
        if not self.instances:
            raise ValueError("No available instances")
        
        instance = self.instances[self.current_index]
        self.current_index = (self.current_index + 1) % len(self.instances)
        
        return instance
```

#### 3.2.2 åŠ æƒè½®è¯¢è´Ÿè½½å‡è¡¡å™¨

```python
class WeightedRoundRobinLoadBalancer:
    """åŠ æƒè½®è¯¢è´Ÿè½½å‡è¡¡å™¨"""
    
    def __init__(self):
        self.instances = []
        self.weights = []
        self.current_weight = 0
        self.current_index = 0
    
    def add_instance(self, instance: ServiceInstance, weight: int = 1):
        """æ·»åŠ æœåŠ¡å®ä¾‹"""
        self.instances.append(instance)
        self.weights.append(weight)
    
    def get_next_instance(self) -> ServiceInstance:
        """è·å–ä¸‹ä¸€ä¸ªå®ä¾‹"""
        if not self.instances:
            raise ValueError("No available instances")
        
        while True:
            if self.current_index >= len(self.instances):
                self.current_index = 0
                self.current_weight = 0
            
            if self.current_weight < self.weights[self.current_index]:
                self.current_weight += 1
                return self.instances[self.current_index]
            
            self.current_index += 1
            self.current_weight = 0
```

#### 3.2.3 æœ€å°‘è¿æ¥è´Ÿè½½å‡è¡¡å™¨

```python
class LeastConnectionLoadBalancer:
    """æœ€å°‘è¿æ¥è´Ÿè½½å‡è¡¡å™¨"""
    
    def __init__(self):
        self.instances = {}
        self.connection_counts = {}
    
    def add_instance(self, instance: ServiceInstance):
        """æ·»åŠ æœåŠ¡å®ä¾‹"""
        self.instances[instance.id] = instance
        self.connection_counts[instance.id] = 0
    
    def get_next_instance(self) -> ServiceInstance:
        """è·å–è¿æ¥æ•°æœ€å°‘çš„å®ä¾‹"""
        if not self.instances:
            raise ValueError("No available instances")
        
        min_connections = float('inf')
        selected_instance = None
        
        for instance_id, instance in self.instances.items():
            if self.connection_counts[instance_id] < min_connections:
                min_connections = self.connection_counts[instance_id]
                selected_instance = instance
        
        if selected_instance:
            self.connection_counts[selected_instance.id] += 1
        
        return selected_instance
    
    def release_connection(self, instance_id: str):
        """é‡Šæ”¾è¿æ¥"""
        if instance_id in self.connection_counts:
            self.connection_counts[instance_id] = max(0, self.connection_counts[instance_id] - 1)
```

#### 3.2.4 ä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½å‡è¡¡å™¨

```python
import hashlib

class ConsistentHashLoadBalancer:
    """ä¸€è‡´æ€§å“ˆå¸Œè´Ÿè½½å‡è¡¡å™¨"""
    
    def __init__(self, virtual_nodes: int = 150):
        self.virtual_nodes = virtual_nodes
        self.hash_ring = {}
        self.sorted_keys = []
    
    def add_instance(self, instance: ServiceInstance):
        """æ·»åŠ æœåŠ¡å®ä¾‹"""
        for i in range(self.virtual_nodes):
            virtual_node_key = f"{instance.id}-{i}"
            hash_value = self._hash(virtual_node_key)
            self.hash_ring[hash_value] = instance
        
        self._update_sorted_keys()
    
    def remove_instance(self, instance_id: str):
        """ç§»é™¤æœåŠ¡å®ä¾‹"""
        keys_to_remove = []
        for key, instance in self.hash_ring.items():
            if instance.id == instance_id:
                keys_to_remove.append(key)
        
        for key in keys_to_remove:
            del self.hash_ring[key]
        
        self._update_sorted_keys()
    
    def get_instance(self, request_key: str) -> ServiceInstance:
        """æ ¹æ®è¯·æ±‚é”®è·å–å®ä¾‹"""
        if not self.hash_ring:
            raise ValueError("No available instances")
        
        hash_value = self._hash(request_key)
        
        # æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äºhash_valueçš„é”®
        for key in self.sorted_keys:
            if key >= hash_value:
                return self.hash_ring[key]
        
        # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œè¿”å›ç¬¬ä¸€ä¸ª
        return self.hash_ring[self.sorted_keys[0]]
    
    def _hash(self, key: str) -> int:
        """è®¡ç®—å“ˆå¸Œå€¼"""
        return int(hashlib.md5(key.encode()).hexdigest(), 16)
    
    def _update_sorted_keys(self):
        """æ›´æ–°æ’åºçš„é”®åˆ—è¡¨"""
        self.sorted_keys = sorted(self.hash_ring.keys())
```

### 3.3 å¥åº·æ£€æŸ¥ç®—æ³•

#### 3.3.1 å¿ƒè·³æ£€æµ‹

```python
import time
import threading

class HeartbeatHealthChecker:
    """å¿ƒè·³å¥åº·æ£€æŸ¥å™¨"""
    
    def __init__(self, timeout: float = 30.0):
        self.timeout = timeout
        self.last_heartbeats = {}
        self.health_status = {}
        self.running = False
        self.check_thread = None
    
    def start(self):
        """å¯åŠ¨å¥åº·æ£€æŸ¥"""
        self.running = True
        self.check_thread = threading.Thread(target=self._health_check_loop)
        self.check_thread.daemon = True
        self.check_thread.start()
    
    def stop(self):
        """åœæ­¢å¥åº·æ£€æŸ¥"""
        self.running = False
        if self.check_thread:
            self.check_thread.join()
    
    def update_heartbeat(self, instance_id: str):
        """æ›´æ–°å¿ƒè·³æ—¶é—´"""
        self.last_heartbeats[instance_id] = time.time()
        self.health_status[instance_id] = True
    
    def is_healthy(self, instance_id: str) -> bool:
        """æ£€æŸ¥å®ä¾‹æ˜¯å¦å¥åº·"""
        return self.health_status.get(instance_id, False)
    
    def _health_check_loop(self):
        """å¥åº·æ£€æŸ¥å¾ªç¯"""
        while self.running:
            current_time = time.time()
            
            for instance_id, last_heartbeat in self.last_heartbeats.items():
                if current_time - last_heartbeat > self.timeout:
                    self.health_status[instance_id] = False
            
            time.sleep(5)  # æ¯5ç§’æ£€æŸ¥ä¸€æ¬¡
```

#### 3.3.2 HTTPå¥åº·æ£€æŸ¥

```python
import requests
import threading
import time

class HTTPHealthChecker:
    """HTTPå¥åº·æ£€æŸ¥å™¨"""
    
    def __init__(self, check_interval: float = 30.0, timeout: float = 5.0):
        self.check_interval = check_interval
        self.timeout = timeout
        self.health_endpoints = {}
        self.health_status = {}
        self.running = False
        self.check_thread = None
    
    def add_health_endpoint(self, instance_id: str, endpoint: str):
        """æ·»åŠ å¥åº·æ£€æŸ¥ç«¯ç‚¹"""
        self.health_endpoints[instance_id] = endpoint
        self.health_status[instance_id] = True
    
    def start(self):
        """å¯åŠ¨å¥åº·æ£€æŸ¥"""
        self.running = True
        self.check_thread = threading.Thread(target=self._health_check_loop)
        self.check_thread.daemon = True
        self.check_thread.start()
    
    def stop(self):
        """åœæ­¢å¥åº·æ£€æŸ¥"""
        self.running = False
        if self.check_thread:
            self.check_thread.join()
    
    def is_healthy(self, instance_id: str) -> bool:
        """æ£€æŸ¥å®ä¾‹æ˜¯å¦å¥åº·"""
        return self.health_status.get(instance_id, False)
    
    def _health_check_loop(self):
        """å¥åº·æ£€æŸ¥å¾ªç¯"""
        while self.running:
            for instance_id, endpoint in self.health_endpoints.items():
                try:
                    response = requests.get(endpoint, timeout=self.timeout)
                    self.health_status[instance_id] = response.status_code == 200
                except Exception:
                    self.health_status[instance_id] = False
            
            time.sleep(self.check_interval)
```

## 4. Pythonå®ç°

### 4.1 æœåŠ¡å‘ç°æ¡†æ¶

```python
from abc import ABC, abstractmethod
from dataclasses import dataclass
from typing import List, Dict, Optional, Set
from enum import Enum
import time
import json

class ServiceStatus(Enum):
    """æœåŠ¡çŠ¶æ€æšä¸¾"""
    HEALTHY = "healthy"
    UNHEALTHY = "unhealthy"
    UNKNOWN = "unknown"

@dataclass
class ServiceInstance:
    """æœåŠ¡å®ä¾‹"""
    id: str
    service_name: str
    host: str
    port: int
    metadata: Dict[str, str]
    status: ServiceStatus
    last_heartbeat: float
    
    def __post_init__(self):
        if self.metadata is None:
            self.metadata = {}
        if self.last_heartbeat is None:
            self.last_heartbeat = time.time()

@dataclass
class DiscoveryCriteria:
    """æœåŠ¡å‘ç°æ¡ä»¶"""
    tags: Set[str]
    version: Optional[str]
    region: Optional[str]
    load_balancing_strategy: str = "round_robin"
    
    def __post_init__(self):
        if self.tags is None:
            self.tags = set()

class ServiceRegistry(ABC):
    """æœåŠ¡æ³¨å†Œä¸­å¿ƒæŠ½è±¡åŸºç±»"""
    
    @abstractmethod
    def register(self, instance: ServiceInstance) -> bool:
        """æ³¨å†ŒæœåŠ¡å®ä¾‹"""
        pass
    
    @abstractmethod
    def deregister(self, instance_id: str) -> bool:
        """æ³¨é”€æœåŠ¡å®ä¾‹"""
        pass
    
    @abstractmethod
    def get_instances(self, service_name: str, criteria: Optional[DiscoveryCriteria] = None) -> List[ServiceInstance]:
        """è·å–æœåŠ¡å®ä¾‹"""
        pass
    
    @abstractmethod
    def update_health(self, instance_id: str, status: ServiceStatus) -> bool:
        """æ›´æ–°å¥åº·çŠ¶æ€"""
        pass

class LoadBalancer(ABC):
    """è´Ÿè½½å‡è¡¡å™¨æŠ½è±¡åŸºç±»"""
    
    @abstractmethod
    def add_instance(self, instance: ServiceInstance):
        """æ·»åŠ æœåŠ¡å®ä¾‹"""
        pass
    
    @abstractmethod
    def remove_instance(self, instance_id: str):
        """ç§»é™¤æœåŠ¡å®ä¾‹"""
        pass
    
    @abstractmethod
    def get_instance(self, request_key: Optional[str] = None) -> ServiceInstance:
        """è·å–æœåŠ¡å®ä¾‹"""
        pass

class HealthChecker(ABC):
    """å¥åº·æ£€æŸ¥å™¨æŠ½è±¡åŸºç±»"""
    
    @abstractmethod
    def start(self):
        """å¯åŠ¨å¥åº·æ£€æŸ¥"""
        pass
    
    @abstractmethod
    def stop(self):
        """åœæ­¢å¥åº·æ£€æŸ¥"""
        pass
    
    @abstractmethod
    def is_healthy(self, instance_id: str) -> bool:
        """æ£€æŸ¥å®ä¾‹æ˜¯å¦å¥åº·"""
        pass
```

### 4.2 å†…å­˜æ³¨å†Œä¸­å¿ƒå®ç°

```python
class InMemoryServiceRegistry(ServiceRegistry):
    """å†…å­˜æœåŠ¡æ³¨å†Œä¸­å¿ƒ"""
    
    def __init__(self):
        self.services: Dict[str, List[ServiceInstance]] = {}
        self.instances: Dict[str, ServiceInstance] = {}
    
    def register(self, instance: ServiceInstance) -> bool:
        """æ³¨å†ŒæœåŠ¡å®ä¾‹"""
        if instance.service_name not in self.services:
            self.services[instance.service_name] = []
        
        # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        for existing_instance in self.services[instance.service_name]:
            if existing_instance.id == instance.id:
                # æ›´æ–°å®ä¾‹ä¿¡æ¯
                existing_instance.host = instance.host
                existing_instance.port = instance.port
                existing_instance.metadata = instance.metadata
                existing_instance.last_heartbeat = time.time()
                return True
        
        # æ·»åŠ æ–°å®ä¾‹
        self.services[instance.service_name].append(instance)
        self.instances[instance.id] = instance
        return True
    
    def deregister(self, instance_id: str) -> bool:
        """æ³¨é”€æœåŠ¡å®ä¾‹"""
        if instance_id in self.instances:
            instance = self.instances[instance_id]
            if instance.service_name in self.services:
                self.services[instance.service_name] = [
                    inst for inst in self.services[instance.service_name] 
                    if inst.id != instance_id
                ]
            del self.instances[instance_id]
            return True
        return False
    
    def get_instances(self, service_name: str, criteria: Optional[DiscoveryCriteria] = None) -> List[ServiceInstance]:
        """è·å–æœåŠ¡å®ä¾‹"""
        if service_name not in self.services:
            return []
        
        instances = self.services[service_name]
        
        # è¿‡æ»¤å¥åº·å®ä¾‹
        healthy_instances = [
            inst for inst in instances 
            if inst.status == ServiceStatus.HEALTHY
        ]
        
        # åº”ç”¨å‘ç°æ¡ä»¶
        if criteria:
            healthy_instances = self._apply_criteria(healthy_instances, criteria)
        
        return healthy_instances
    
    def update_health(self, instance_id: str, status: ServiceStatus) -> bool:
        """æ›´æ–°å¥åº·çŠ¶æ€"""
        if instance_id in self.instances:
            self.instances[instance_id].status = status
            return True
        return False
    
    def _apply_criteria(self, instances: List[ServiceInstance], criteria: DiscoveryCriteria) -> List[ServiceInstance]:
        """åº”ç”¨å‘ç°æ¡ä»¶"""
        filtered_instances = instances
        
        # æŒ‰æ ‡ç­¾è¿‡æ»¤
        if criteria.tags:
            filtered_instances = [
                inst for inst in filtered_instances
                if criteria.tags.issubset(set(inst.metadata.get('tags', '').split(',')))
            ]
        
        # æŒ‰ç‰ˆæœ¬è¿‡æ»¤
        if criteria.version:
            filtered_instances = [
                inst for inst in filtered_instances
                if inst.metadata.get('version') == criteria.version
            ]
        
        # æŒ‰åŒºåŸŸè¿‡æ»¤
        if criteria.region:
            filtered_instances = [
                inst for inst in filtered_instances
                if inst.metadata.get('region') == criteria.region
            ]
        
        return filtered_instances
```

### 4.3 æœåŠ¡å‘ç°å®¢æˆ·ç«¯

```python
class ServiceDiscoveryClient:
    """æœåŠ¡å‘ç°å®¢æˆ·ç«¯"""
    
    def __init__(self, registry: ServiceRegistry, load_balancer: LoadBalancer):
        self.registry = registry
        self.load_balancer = load_balancer
        self.cache = {}
        self.cache_ttl = 30  # ç¼“å­˜30ç§’
    
    def discover_service(self, service_name: str, criteria: Optional[DiscoveryCriteria] = None) -> ServiceInstance:
        """å‘ç°æœåŠ¡"""
        cache_key = f"{service_name}:{hash(criteria) if criteria else 'default'}"
        
        # æ£€æŸ¥ç¼“å­˜
        if cache_key in self.cache:
            cache_entry = self.cache[cache_key]
            if time.time() - cache_entry['timestamp'] < self.cache_ttl:
                return cache_entry['instance']
        
        # ä»æ³¨å†Œä¸­å¿ƒè·å–å®ä¾‹
        instances = self.registry.get_instances(service_name, criteria)
        
        if not instances:
            raise ValueError(f"No available instances for service: {service_name}")
        
        # æ›´æ–°è´Ÿè½½å‡è¡¡å™¨
        self.load_balancer.remove_instance(service_name)  # æ¸…é™¤æ—§å®ä¾‹
        for instance in instances:
            self.load_balancer.add_instance(instance)
        
        # è·å–å®ä¾‹
        selected_instance = self.load_balancer.get_instance()
        
        # æ›´æ–°ç¼“å­˜
        self.cache[cache_key] = {
            'instance': selected_instance,
            'timestamp': time.time()
        }
        
        return selected_instance
    
    def clear_cache(self):
        """æ¸…é™¤ç¼“å­˜"""
        self.cache.clear()
```

## 5. å®é™…åº”ç”¨ç¤ºä¾‹

### 5.1 å¾®æœåŠ¡æœåŠ¡å‘ç°ç¤ºä¾‹

```python
def demonstrate_service_discovery():
    """æ¼”ç¤ºæœåŠ¡å‘ç°åŠŸèƒ½"""
    print("=== å¾®æœåŠ¡æœåŠ¡å‘ç°æ¼”ç¤º ===\n")
    
    # åˆ›å»ºæ³¨å†Œä¸­å¿ƒ
    registry = InMemoryServiceRegistry()
    
    # åˆ›å»ºè´Ÿè½½å‡è¡¡å™¨
    load_balancer = RoundRobinLoadBalancer()
    
    # åˆ›å»ºæœåŠ¡å‘ç°å®¢æˆ·ç«¯
    client = ServiceDiscoveryClient(registry, load_balancer)
    
    # æ³¨å†ŒæœåŠ¡å®ä¾‹
    instances = [
        ServiceInstance(
            id="user-service-1",
            service_name="user-service",
            host="192.168.1.10",
            port=8080,
            metadata={"version": "1.0", "region": "us-east", "tags": "api,user"},
            status=ServiceStatus.HEALTHY,
            last_heartbeat=time.time()
        ),
        ServiceInstance(
            id="user-service-2",
            service_name="user-service",
            host="192.168.1.11",
            port=8080,
            metadata={"version": "1.0", "region": "us-east", "tags": "api,user"},
            status=ServiceStatus.HEALTHY,
            last_heartbeat=time.time()
        ),
        ServiceInstance(
            id="user-service-3",
            service_name="user-service",
            host="192.168.1.12",
            port=8080,
            metadata={"version": "1.1", "region": "us-west", "tags": "api,user"},
            status=ServiceStatus.HEALTHY,
            last_heartbeat=time.time()
        ),
        ServiceInstance(
            id="order-service-1",
            service_name="order-service",
            host="192.168.1.20",
            port=8081,
            metadata={"version": "1.0", "region": "us-east", "tags": "api,order"},
            status=ServiceStatus.HEALTHY,
            last_heartbeat=time.time()
        ),
    ]
    
    # æ³¨å†Œå®ä¾‹
    for instance in instances:
        registry.register(instance)
        print(f"æ³¨å†ŒæœåŠ¡å®ä¾‹: {instance.service_name} - {instance.host}:{instance.port}")
    
    print("\n1. åŸºæœ¬æœåŠ¡å‘ç°:")
    try:
        user_instance = client.discover_service("user-service")
        print(f"  å‘ç°ç”¨æˆ·æœåŠ¡å®ä¾‹: {user_instance.host}:{user_instance.port}")
        
        order_instance = client.discover_service("order-service")
        print(f"  å‘ç°è®¢å•æœåŠ¡å®ä¾‹: {order_instance.host}:{order_instance.port}")
    except ValueError as e:
        print(f"  é”™è¯¯: {e}")
    
    print("\n2. æ¡ä»¶æœåŠ¡å‘ç°:")
    try:
        # æŒ‰ç‰ˆæœ¬è¿‡æ»¤
        criteria_v1 = DiscoveryCriteria(
            tags=set(),
            version="1.0",
            region=None
        )
        v1_instance = client.discover_service("user-service", criteria_v1)
        print(f"  å‘ç°v1.0ç‰ˆæœ¬å®ä¾‹: {v1_instance.host}:{v1_instance.port}")
        
        # æŒ‰åŒºåŸŸè¿‡æ»¤
        criteria_west = DiscoveryCriteria(
            tags=set(),
            version=None,
            region="us-west"
        )
        west_instance = client.discover_service("user-service", criteria_west)
        print(f"  å‘ç°us-weståŒºåŸŸå®ä¾‹: {west_instance.host}:{west_instance.port}")
    except ValueError as e:
        print(f"  é”™è¯¯: {e}")
    
    print("\n3. è´Ÿè½½å‡è¡¡æµ‹è¯•:")
    for i in range(5):
        try:
            instance = client.discover_service("user-service")
            print(f"  è¯·æ±‚ {i+1}: {instance.host}:{instance.port}")
        except ValueError as e:
            print(f"  é”™è¯¯: {e}")
    
    print("\n4. å¥åº·çŠ¶æ€æ›´æ–°:")
    # å°†ç¬¬ä¸€ä¸ªå®ä¾‹æ ‡è®°ä¸ºä¸å¥åº·
    registry.update_health("user-service-1", ServiceStatus.UNHEALTHY)
    print("  å°†user-service-1æ ‡è®°ä¸ºä¸å¥åº·")
    
    try:
        instance = client.discover_service("user-service")
        print(f"  å‘ç°å¥åº·å®ä¾‹: {instance.host}:{instance.port}")
    except ValueError as e:
        print(f"  é”™è¯¯: {e}")

if __name__ == "__main__":
    demonstrate_service_discovery()
```

## 6. æ€§èƒ½åˆ†æ

### 6.1 ç®—æ³•å¤æ‚åº¦åˆ†æ

#### 6.1.1 æ³¨å†Œä¸­å¿ƒæ“ä½œ

- **æ³¨å†Œ**: $O(1)$ å¹³å‡æ—¶é—´å¤æ‚åº¦
- **æ³¨é”€**: $O(n)$ æœ€åæ—¶é—´å¤æ‚åº¦ï¼Œå…¶ä¸­ $n$ ä¸ºæœåŠ¡å®ä¾‹æ•°é‡
- **æŸ¥è¯¢**: $O(n)$ æ—¶é—´å¤æ‚åº¦ï¼Œå…¶ä¸­ $n$ ä¸ºæœåŠ¡å®ä¾‹æ•°é‡

#### 6.1.2 è´Ÿè½½å‡è¡¡ç®—æ³•

- **è½®è¯¢**: $O(1)$ æ—¶é—´å¤æ‚åº¦
- **åŠ æƒè½®è¯¢**: $O(1)$ æ—¶é—´å¤æ‚åº¦
- **æœ€å°‘è¿æ¥**: $O(n)$ æ—¶é—´å¤æ‚åº¦ï¼Œå…¶ä¸­ $n$ ä¸ºå®ä¾‹æ•°é‡
- **ä¸€è‡´æ€§å“ˆå¸Œ**: $O(\log n)$ æ—¶é—´å¤æ‚åº¦ï¼Œå…¶ä¸­ $n$ ä¸ºè™šæ‹ŸèŠ‚ç‚¹æ•°é‡

### 6.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 6.2.1 ç¼“å­˜ä¼˜åŒ–

```python
class CachedServiceDiscoveryClient(ServiceDiscoveryClient):
    """å¸¦ç¼“å­˜çš„æœåŠ¡å‘ç°å®¢æˆ·ç«¯"""
    
    def __init__(self, registry: ServiceRegistry, load_balancer: LoadBalancer, cache_ttl: float = 30.0):
        super().__init__(registry, load_balancer)
        self.cache_ttl = cache_ttl
        self.cache = {}
        self.cache_timestamps = {}
    
    def discover_service(self, service_name: str, criteria: Optional[DiscoveryCriteria] = None) -> ServiceInstance:
        """å‘ç°æœåŠ¡ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
        cache_key = self._get_cache_key(service_name, criteria)
        
        # æ£€æŸ¥ç¼“å­˜
        if self._is_cache_valid(cache_key):
            return self.cache[cache_key]
        
        # ä»æ³¨å†Œä¸­å¿ƒè·å–
        instance = super().discover_service(service_name, criteria)
        
        # æ›´æ–°ç¼“å­˜
        self.cache[cache_key] = instance
        self.cache_timestamps[cache_key] = time.time()
        
        return instance
    
    def _get_cache_key(self, service_name: str, criteria: Optional[DiscoveryCriteria]) -> str:
        """ç”Ÿæˆç¼“å­˜é”®"""
        if criteria:
            return f"{service_name}:{hash(criteria)}"
        return f"{service_name}:default"
    
    def _is_cache_valid(self, cache_key: str) -> bool:
        """æ£€æŸ¥ç¼“å­˜æ˜¯å¦æœ‰æ•ˆ"""
        if cache_key not in self.cache_timestamps:
            return False
        
        return time.time() - self.cache_timestamps[cache_key] < self.cache_ttl
```

#### 6.2.2 è¿æ¥æ± ä¼˜åŒ–

```python
class ConnectionPool:
    """è¿æ¥æ± """
    
    def __init__(self, max_connections: int = 100):
        self.max_connections = max_connections
        self.connections = {}
        self.connection_counts = {}
    
    def get_connection(self, instance: ServiceInstance):
        """è·å–è¿æ¥"""
        instance_key = f"{instance.host}:{instance.port}"
        
        if instance_key not in self.connections:
            self.connections[instance_key] = []
            self.connection_counts[instance_key] = 0
        
        if self.connection_counts[instance_key] < self.max_connections:
            # åˆ›å»ºæ–°è¿æ¥
            connection = self._create_connection(instance)
            self.connections[instance_key].append(connection)
            self.connection_counts[instance_key] += 1
            return connection
        else:
            # å¤ç”¨ç°æœ‰è¿æ¥
            return self.connections[instance_key][0]
    
    def release_connection(self, instance: ServiceInstance, connection):
        """é‡Šæ”¾è¿æ¥"""
        instance_key = f"{instance.host}:{instance.port}"
        
        if instance_key in self.connections and connection in self.connections[instance_key]:
            # åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šå°†è¿æ¥æ”¾å›æ± ä¸­è€Œä¸æ˜¯åˆ é™¤
            pass
    
    def _create_connection(self, instance: ServiceInstance):
        """åˆ›å»ºè¿æ¥"""
        # è¿™é‡Œåº”è¯¥åˆ›å»ºå®é™…çš„ç½‘ç»œè¿æ¥
        return f"connection_to_{instance.host}_{instance.port}"
```

## 7. æœ€ä½³å®è·µ

### 7.1 æœåŠ¡æ³¨å†Œæœ€ä½³å®è·µ

1. **è‡ªåŠ¨æ³¨å†Œ**: æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨æ³¨å†Œï¼Œå…³é—­æ—¶è‡ªåŠ¨æ³¨é”€
2. **å¥åº·æ£€æŸ¥**: å®šæœŸè¿›è¡Œå¥åº·æ£€æŸ¥ï¼ŒåŠæ—¶æ›´æ–°çŠ¶æ€
3. **å…ƒæ•°æ®ç®¡ç†**: åˆç†ä½¿ç”¨å…ƒæ•°æ®ï¼Œä¾¿äºæœåŠ¡å‘ç°å’Œè·¯ç”±
4. **ç‰ˆæœ¬ç®¡ç†**: ä½¿ç”¨ç‰ˆæœ¬å·ç®¡ç†æœåŠ¡å®ä¾‹

### 7.2 æœåŠ¡å‘ç°æœ€ä½³å®è·µ

1. **ç¼“å­˜ç­–ç•¥**: åˆç†ä½¿ç”¨ç¼“å­˜ï¼Œå‡å°‘æ³¨å†Œä¸­å¿ƒå‹åŠ›
2. **è´Ÿè½½å‡è¡¡**: é€‰æ‹©åˆé€‚çš„è´Ÿè½½å‡è¡¡ç­–ç•¥
3. **æ•…éšœè½¬ç§»**: å®ç°æ•…éšœè½¬ç§»æœºåˆ¶
4. **ç›‘æ§å‘Šè­¦**: ç›‘æ§æœåŠ¡å‘ç°çŠ¶æ€ï¼ŒåŠæ—¶å‘Šè­¦

### 7.3 é«˜å¯ç”¨è®¾è®¡

1. **æ³¨å†Œä¸­å¿ƒé›†ç¾¤**: ä½¿ç”¨é›†ç¾¤ä¿è¯æ³¨å†Œä¸­å¿ƒé«˜å¯ç”¨
2. **å®¢æˆ·ç«¯ç¼“å­˜**: å®¢æˆ·ç«¯ç¼“å­˜æœåŠ¡åˆ—è¡¨ï¼Œé¿å…å•ç‚¹æ•…éšœ
3. **å¥åº·æ£€æŸ¥**: å¤šçº§å¥åº·æ£€æŸ¥æœºåˆ¶
4. **æ•…éšœéš”ç¦»**: å®ç°æ•…éšœéš”ç¦»ï¼Œé¿å…çº§è”æ•…éšœ

## 8. æ€»ç»“

æœåŠ¡å‘ç°æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­çš„å…³é”®ç»„ä»¶ï¼Œéœ€è¦ç»¼åˆè€ƒè™‘å¯ç”¨æ€§ã€æ€§èƒ½å’Œä¸€è‡´æ€§ã€‚æœ¬æ–‡æ¡£ä»å½¢å¼åŒ–è§’åº¦åˆ†æäº†æœåŠ¡å‘ç°çš„ç†è®ºåŸºç¡€ï¼Œæä¾›äº†å¤šç§ç®—æ³•å’Œå®ç°æ–¹æ³•ï¼Œå¹¶é€šè¿‡Pythonå®ç°å±•ç¤ºäº†å…·ä½“çš„åº”ç”¨ã€‚

### å…³é”®è¦ç‚¹

1. **ç†è®ºåŸºç¡€**: æœåŠ¡å‘ç°éœ€è¦ä¸¥æ ¼çš„æ•°å­¦å®šä¹‰å’Œå½¢å¼åŒ–åˆ†æ
2. **ç®—æ³•é€‰æ‹©**: ä¸åŒè´Ÿè½½å‡è¡¡ç®—æ³•é€‚ç”¨äºä¸åŒåœºæ™¯
3. **é«˜å¯ç”¨è®¾è®¡**: éœ€è¦è€ƒè™‘æ³¨å†Œä¸­å¿ƒé›†ç¾¤å’Œå®¢æˆ·ç«¯ç¼“å­˜
4. **æ€§èƒ½ä¼˜åŒ–**: åˆç†ä½¿ç”¨ç¼“å­˜å’Œè¿æ¥æ± ä¼˜åŒ–æ€§èƒ½

### æœªæ¥å‘å±•æ–¹å‘

1. **æœåŠ¡ç½‘æ ¼**: é›†æˆæœåŠ¡ç½‘æ ¼æŠ€æœ¯ï¼Œæä¾›æ›´å¼ºå¤§çš„æœåŠ¡å‘ç°èƒ½åŠ›
2. **æ™ºèƒ½è·¯ç”±**: åŸºäºæœºå™¨å­¦ä¹ çš„æ™ºèƒ½è·¯ç”±ç­–ç•¥
3. **å¤šæ•°æ®ä¸­å¿ƒ**: æ”¯æŒå¤šæ•°æ®ä¸­å¿ƒçš„å…¨å±€æœåŠ¡å‘ç°
4. **å®æ—¶ç›‘æ§**: æ›´ç»†ç²’åº¦çš„å®æ—¶ç›‘æ§å’Œå‘Šè­¦

---

*æœ€åæ›´æ–°: 2024-12-19*
*æ–‡æ¡£çŠ¶æ€: å®Œæˆ*
