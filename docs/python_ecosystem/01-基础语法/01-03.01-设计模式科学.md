# 03.01 è®¾è®¡æ¨¡å¼ç§‘å­¦

## ğŸ“‹ æ¦‚è¿°

è®¾è®¡æ¨¡å¼ç§‘å­¦æ˜¯è½¯ä»¶å·¥ç¨‹çš„æ ¸å¿ƒç†è®ºï¼Œç ”ç©¶å¯é‡ç”¨çš„è½¯ä»¶è®¾è®¡è§£å†³æ–¹æ¡ˆã€‚æœ¬æ–‡æ¡£ä»å½¢å¼åŒ–è§’åº¦å®šä¹‰è®¾è®¡æ¨¡å¼çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå¹¶æä¾›Pythonå®ç°ã€‚

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### 1. è®¾è®¡æ¨¡å¼çš„å½¢å¼åŒ–å®šä¹‰

**æ•°å­¦å®šä¹‰**ï¼š
è®¾è®¡æ¨¡å¼æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ $P = (C, R, I)$ï¼Œå…¶ä¸­ï¼š

- $C$ æ˜¯ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰
- $R$ æ˜¯å…³ç³»ï¼ˆRelationsï¼‰
- $I$ æ˜¯å®ç°ï¼ˆImplementationï¼‰

**Pythonå®ç°**ï¼š

```python
from typing import TypeVar, Dict, List, Any, Callable, Protocol
from abc import ABC, abstractmethod
from dataclasses import dataclass
from enum import Enum

T = TypeVar('T')

class PatternType(Enum):
    CREATIONAL = "creational"
    STRUCTURAL = "structural"
    BEHAVIORAL = "behavioral"

@dataclass
class DesignPattern:
    """è®¾è®¡æ¨¡å¼å®šä¹‰"""
    name: str
    pattern_type: PatternType
    context: str
    problem: str
    solution: str
    consequences: List[str]

class PatternContext:
    """æ¨¡å¼ä¸Šä¸‹æ–‡"""
    
    def __init__(self, description: str, constraints: List[str]):
        self.description = description
        self.constraints = constraints
        self.parameters: Dict[str, Any] = {}

class PatternRelation:
    """æ¨¡å¼å…³ç³»"""
    
    def __init__(self, source: str, target: str, relation_type: str):
        self.source = source
        self.target = target
        self.relation_type = relation_type

class PatternImplementation:
    """æ¨¡å¼å®ç°"""
    
    def __init__(self, pattern: DesignPattern):
        self.pattern = pattern
        self.components: Dict[str, Any] = {}
        self.relationships: List[PatternRelation] = []
    
    def add_component(self, name: str, component: Any):
        """æ·»åŠ ç»„ä»¶"""
        self.components[name] = component
    
    def add_relationship(self, relation: PatternRelation):
        """æ·»åŠ å…³ç³»"""
        self.relationships.append(relation)
    
    def validate(self) -> bool:
        """éªŒè¯å®ç°"""
        # ç®€åŒ–çš„éªŒè¯é€»è¾‘
        return len(self.components) > 0 and len(self.relationships) >= 0

# ç¤ºä¾‹ï¼šè®¾è®¡æ¨¡å¼æ¡†æ¶
class DesignPatternFramework:
    """è®¾è®¡æ¨¡å¼æ¡†æ¶"""
    
    def __init__(self):
        self.patterns: Dict[str, DesignPattern] = {}
        self.implementations: Dict[str, PatternImplementation] = {}
    
    def register_pattern(self, pattern: DesignPattern):
        """æ³¨å†Œè®¾è®¡æ¨¡å¼"""
        self.patterns[pattern.name] = pattern
    
    def create_implementation(self, pattern_name: str) -> PatternImplementation:
        """åˆ›å»ºæ¨¡å¼å®ç°"""
        if pattern_name not in self.patterns:
            raise ValueError(f"Pattern '{pattern_name}' not found")
        
        pattern = self.patterns[pattern_name]
        implementation = PatternImplementation(pattern)
        self.implementations[pattern_name] = implementation
        
        return implementation
    
    def get_pattern(self, name: str) -> DesignPattern:
        """è·å–è®¾è®¡æ¨¡å¼"""
        return self.patterns.get(name)
    
    def list_patterns(self, pattern_type: PatternType = None) -> List[DesignPattern]:
        """åˆ—å‡ºè®¾è®¡æ¨¡å¼"""
        if pattern_type:
            return [p for p in self.patterns.values() if p.pattern_type == pattern_type]
        return list(self.patterns.values())

# åˆ›å»ºæ¡†æ¶å®ä¾‹
framework = DesignPatternFramework()
```

### 2. åˆ›å»ºå‹æ¨¡å¼

#### 2.1 å•ä¾‹æ¨¡å¼

**æ•°å­¦å®šä¹‰**ï¼š
å•ä¾‹æ¨¡å¼ç¡®ä¿ç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼š$\forall x, y \in Instance(C): x = y$

**Pythonå®ç°**ï¼š

```python
class SingletonPattern:
    """å•ä¾‹æ¨¡å¼"""
    
    def __init__(self):
        self._instance = None
        self._initialized = False
    
    def get_instance(self):
        """è·å–å•ä¾‹å®ä¾‹"""
        if not self._initialized:
            self._instance = self._create_instance()
            self._initialized = True
        return self._instance
    
    def _create_instance(self):
        """åˆ›å»ºå®ä¾‹"""
        return SingletonInstance()
    
    def reset(self):
        """é‡ç½®å•ä¾‹ï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰"""
        self._instance = None
        self._initialized = False

class SingletonInstance:
    """å•ä¾‹å®ä¾‹"""
    
    def __init__(self):
        self.data = {}
    
    def set_data(self, key: str, value: Any):
        """è®¾ç½®æ•°æ®"""
        self.data[key] = value
    
    def get_data(self, key: str) -> Any:
        """è·å–æ•°æ®"""
        return self.data.get(key)

# æ³¨å†Œå•ä¾‹æ¨¡å¼
singleton_pattern = DesignPattern(
    name="Singleton",
    pattern_type=PatternType.CREATIONAL,
    context="éœ€è¦ç¡®ä¿ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹",
    problem="å¦‚ä½•ç¡®ä¿ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›å…¨å±€è®¿é—®ç‚¹",
    solution="ä½¿ç”¨ç§æœ‰æ„é€ å‡½æ•°å’Œé™æ€å®ä¾‹",
    consequences=["ä¿è¯å”¯ä¸€æ€§", "å…¨å±€è®¿é—®", "å»¶è¿Ÿåˆå§‹åŒ–"]
)

framework.register_pattern(singleton_pattern)

# ç¤ºä¾‹ï¼šå•ä¾‹æ¨¡å¼ä½¿ç”¨
def demonstrate_singleton():
    """æ¼”ç¤ºå•ä¾‹æ¨¡å¼"""
    singleton = SingletonPattern()
    
    # è·å–å®ä¾‹
    instance1 = singleton.get_instance()
    instance2 = singleton.get_instance()
    
    # éªŒè¯æ˜¯åŒä¸€ä¸ªå®ä¾‹
    print("å•ä¾‹æ¨¡å¼ç¤ºä¾‹:")
    print(f"å®ä¾‹1: {instance1}")
    print(f"å®ä¾‹2: {instance2}")
    print(f"æ˜¯åŒä¸€ä¸ªå®ä¾‹: {instance1 is instance2}")
    
    # ä½¿ç”¨å®ä¾‹
    instance1.set_data("config", "value")
    print(f"ä»å®ä¾‹2è·å–æ•°æ®: {instance2.get_data('config')}")
    
    return singleton

# è¿è¡Œç¤ºä¾‹
singleton_demo = demonstrate_singleton()
```

#### 2.2 å·¥å‚æ¨¡å¼

**æ•°å­¦å®šä¹‰**ï¼š
å·¥å‚æ¨¡å¼å®šä¹‰åˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼š$Factory(C) \rightarrow Product(C)$

**Pythonå®ç°**ï¼š

```python
from abc import ABC, abstractmethod

class Product(ABC):
    """äº§å“æŠ½è±¡åŸºç±»"""
    
    @abstractmethod
    def operation(self) -> str:
        pass

class ConcreteProductA(Product):
    """å…·ä½“äº§å“A"""
    
    def operation(self) -> str:
        return "ConcreteProductA operation"

class ConcreteProductB(Product):
    """å…·ä½“äº§å“B"""
    
    def operation(self) -> str:
        return "ConcreteProductB operation"

class Factory(ABC):
    """å·¥å‚æŠ½è±¡åŸºç±»"""
    
    @abstractmethod
    def create_product(self, product_type: str) -> Product:
        pass

class ConcreteFactory(Factory):
    """å…·ä½“å·¥å‚"""
    
    def create_product(self, product_type: str) -> Product:
        if product_type == "A":
            return ConcreteProductA()
        elif product_type == "B":
            return ConcreteProductB()
        else:
            raise ValueError(f"Unknown product type: {product_type}")

# æ³¨å†Œå·¥å‚æ¨¡å¼
factory_pattern = DesignPattern(
    name="Factory Method",
    pattern_type=PatternType.CREATIONAL,
    context="éœ€è¦æ ¹æ®æ¡ä»¶åˆ›å»ºä¸åŒç±»å‹çš„å¯¹è±¡",
    problem="å¦‚ä½•æ ¹æ®æ¡ä»¶åˆ›å»ºå¯¹è±¡è€Œä¸æš´éœ²åˆ›å»ºé€»è¾‘",
    solution="å®šä¹‰åˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œè®©å­ç±»å†³å®šå®ä¾‹åŒ–å“ªä¸ªç±»",
    consequences=["è§£è€¦", "å¯æ‰©å±•", "ç¬¦åˆå¼€é—­åŸåˆ™"]
)

framework.register_pattern(factory_pattern)

# ç¤ºä¾‹ï¼šå·¥å‚æ¨¡å¼ä½¿ç”¨
def demonstrate_factory():
    """æ¼”ç¤ºå·¥å‚æ¨¡å¼"""
    factory = ConcreteFactory()
    
    # åˆ›å»ºäº§å“
    product_a = factory.create_product("A")
    product_b = factory.create_product("B")
    
    print("å·¥å‚æ¨¡å¼ç¤ºä¾‹:")
    print(f"äº§å“A: {product_a.operation()}")
    print(f"äº§å“B: {product_b.operation()}")
    
    return factory

# è¿è¡Œç¤ºä¾‹
factory_demo = demonstrate_factory()
```

### 3. ç»“æ„å‹æ¨¡å¼

#### 3.1 é€‚é…å™¨æ¨¡å¼

**æ•°å­¦å®šä¹‰**ï¼š
é€‚é…å™¨æ¨¡å¼å°†æ¥å£è½¬æ¢ä¸ºå®¢æˆ·ç«¯æœŸæœ›çš„æ¥å£ï¼š$Adapter(Target) \rightarrow Adaptee$

**Pythonå®ç°**ï¼š

```python
class Target(Protocol):
    """ç›®æ ‡æ¥å£"""
    
    def request(self) -> str:
        ...

class Adaptee:
    """è¢«é€‚é…çš„ç±»"""
    
    def specific_request(self) -> str:
        return "Specific request from Adaptee"

class Adapter:
    """é€‚é…å™¨"""
    
    def __init__(self, adaptee: Adaptee):
        self.adaptee = adaptee
    
    def request(self) -> str:
        """é€‚é…ç›®æ ‡æ¥å£"""
        return f"Adapter: {self.adaptee.specific_request()}"

# æ³¨å†Œé€‚é…å™¨æ¨¡å¼
adapter_pattern = DesignPattern(
    name="Adapter",
    pattern_type=PatternType.STRUCTURAL,
    context="éœ€è¦å°†ä¸å…¼å®¹çš„æ¥å£è½¬æ¢ä¸ºå®¢æˆ·ç«¯æœŸæœ›çš„æ¥å£",
    problem="å¦‚ä½•è®©ä¸å…¼å®¹çš„ç±»èƒ½å¤Ÿä¸€èµ·å·¥ä½œ",
    solution="åˆ›å»ºé€‚é…å™¨ç±»ï¼Œå°†ä¸å…¼å®¹çš„æ¥å£è½¬æ¢ä¸ºæœŸæœ›çš„æ¥å£",
    consequences=["å…¼å®¹æ€§", "å¯é‡ç”¨æ€§", "é€æ˜æ€§"]
)

framework.register_pattern(adapter_pattern)

# ç¤ºä¾‹ï¼šé€‚é…å™¨æ¨¡å¼ä½¿ç”¨
def demonstrate_adapter():
    """æ¼”ç¤ºé€‚é…å™¨æ¨¡å¼"""
    adaptee = Adaptee()
    adapter = Adapter(adaptee)
    
    print("é€‚é…å™¨æ¨¡å¼ç¤ºä¾‹:")
    print(f"è¢«é€‚é…å¯¹è±¡: {adaptee.specific_request()}")
    print(f"é€‚é…å: {adapter.request()}")
    
    return adapter

# è¿è¡Œç¤ºä¾‹
adapter_demo = demonstrate_adapter()
```

#### 3.2 è£…é¥°å™¨æ¨¡å¼

**æ•°å­¦å®šä¹‰**ï¼š
è£…é¥°å™¨æ¨¡å¼åŠ¨æ€åœ°ç»™å¯¹è±¡æ·»åŠ èŒè´£ï¼š$Decorator(Component) \rightarrow Component$

**Pythonå®ç°**ï¼š

```python
class Component(ABC):
    """ç»„ä»¶æŠ½è±¡åŸºç±»"""
    
    @abstractmethod
    def operation(self) -> str:
        pass

class ConcreteComponent(Component):
    """å…·ä½“ç»„ä»¶"""
    
    def operation(self) -> str:
        return "ConcreteComponent"

class Decorator(Component):
    """è£…é¥°å™¨åŸºç±»"""
    
    def __init__(self, component: Component):
        self.component = component
    
    def operation(self) -> str:
        return self.component.operation()

class ConcreteDecoratorA(Decorator):
    """å…·ä½“è£…é¥°å™¨A"""
    
    def operation(self) -> str:
        return f"ConcreteDecoratorA({super().operation()})"

class ConcreteDecoratorB(Decorator):
    """å…·ä½“è£…é¥°å™¨B"""
    
    def operation(self) -> str:
        return f"ConcreteDecoratorB({super().operation()})"

# æ³¨å†Œè£…é¥°å™¨æ¨¡å¼
decorator_pattern = DesignPattern(
    name="Decorator",
    pattern_type=PatternType.STRUCTURAL,
    context="éœ€è¦åŠ¨æ€åœ°ç»™å¯¹è±¡æ·»åŠ èŒè´£",
    problem="å¦‚ä½•åœ¨ä¸ä¿®æ”¹ç±»çš„æƒ…å†µä¸‹æ‰©å±•å¯¹è±¡çš„åŠŸèƒ½",
    solution="ä½¿ç”¨è£…é¥°å™¨ç±»åŒ…è£…åŸå¯¹è±¡ï¼Œæä¾›é¢å¤–çš„åŠŸèƒ½",
    consequences=["çµæ´»æ€§", "å¯æ‰©å±•æ€§", "ç¬¦åˆå¼€é—­åŸåˆ™"]
)

framework.register_pattern(decorator_pattern)

# ç¤ºä¾‹ï¼šè£…é¥°å™¨æ¨¡å¼ä½¿ç”¨
def demonstrate_decorator():
    """æ¼”ç¤ºè£…é¥°å™¨æ¨¡å¼"""
    component = ConcreteComponent()
    decorator_a = ConcreteDecoratorA(component)
    decorator_b = ConcreteDecoratorB(decorator_a)
    
    print("è£…é¥°å™¨æ¨¡å¼ç¤ºä¾‹:")
    print(f"åŸå§‹ç»„ä»¶: {component.operation()}")
    print(f"è£…é¥°å™¨A: {decorator_a.operation()}")
    print(f"è£…é¥°å™¨B: {decorator_b.operation()}")
    
    return decorator_b

# è¿è¡Œç¤ºä¾‹
decorator_demo = demonstrate_decorator()
```

### 4. è¡Œä¸ºå‹æ¨¡å¼

#### 4.1 è§‚å¯Ÿè€…æ¨¡å¼

**æ•°å­¦å®šä¹‰**ï¼š
è§‚å¯Ÿè€…æ¨¡å¼å®šä¹‰ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼š$Subject \rightarrow \forall Observer_i: notify()$

**Pythonå®ç°**ï¼š

```python
from abc import ABC, abstractmethod
from typing import List

class Observer(ABC):
    """è§‚å¯Ÿè€…æŠ½è±¡åŸºç±»"""
    
    @abstractmethod
    def update(self, subject: 'Subject') -> None:
        pass

class Subject(ABC):
    """ä¸»é¢˜æŠ½è±¡åŸºç±»"""
    
    def __init__(self):
        self._observers: List[Observer] = []
        self._state = None
    
    def attach(self, observer: Observer) -> None:
        """æ·»åŠ è§‚å¯Ÿè€…"""
        if observer not in self._observers:
            self._observers.append(observer)
    
    def detach(self, observer: Observer) -> None:
        """ç§»é™¤è§‚å¯Ÿè€…"""
        self._observers.remove(observer)
    
    def notify(self) -> None:
        """é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…"""
        for observer in self._observers:
            observer.update(self)
    
    @property
    def state(self):
        return self._state
    
    @state.setter
    def state(self, value):
        self._state = value
        self.notify()

class ConcreteSubject(Subject):
    """å…·ä½“ä¸»é¢˜"""
    
    def __init__(self):
        super().__init__()
        self._state = "Initial State"

class ConcreteObserverA(Observer):
    """å…·ä½“è§‚å¯Ÿè€…A"""
    
    def __init__(self, name: str):
        self.name = name
    
    def update(self, subject: Subject) -> None:
        print(f"Observer {self.name} received update: {subject.state}")

class ConcreteObserverB(Observer):
    """å…·ä½“è§‚å¯Ÿè€…B"""
    
    def __init__(self, name: str):
        self.name = name
    
    def update(self, subject: Subject) -> None:
        print(f"Observer {self.name} processed: {subject.state}")

# æ³¨å†Œè§‚å¯Ÿè€…æ¨¡å¼
observer_pattern = DesignPattern(
    name="Observer",
    pattern_type=PatternType.BEHAVIORAL,
    context="éœ€è¦å»ºç«‹å¯¹è±¡é—´çš„ä¸€å¯¹å¤šä¾èµ–å…³ç³»",
    problem="å¦‚ä½•è®©å¯¹è±¡åœ¨çŠ¶æ€æ”¹å˜æ—¶é€šçŸ¥å…¶ä»–å¯¹è±¡",
    solution="å®šä¹‰ä¸»é¢˜å’Œè§‚å¯Ÿè€…ï¼Œå½“ä¸»é¢˜çŠ¶æ€æ”¹å˜æ—¶é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…",
    consequences=["æ¾è€¦åˆ", "å¯æ‰©å±•", "æ”¯æŒå¹¿æ’­é€šä¿¡"]
)

framework.register_pattern(observer_pattern)

# ç¤ºä¾‹ï¼šè§‚å¯Ÿè€…æ¨¡å¼ä½¿ç”¨
def demonstrate_observer():
    """æ¼”ç¤ºè§‚å¯Ÿè€…æ¨¡å¼"""
    subject = ConcreteSubject()
    
    observer_a = ConcreteObserverA("A")
    observer_b = ConcreteObserverB("B")
    
    # æ·»åŠ è§‚å¯Ÿè€…
    subject.attach(observer_a)
    subject.attach(observer_b)
    
    print("è§‚å¯Ÿè€…æ¨¡å¼ç¤ºä¾‹:")
    
    # æ”¹å˜çŠ¶æ€ï¼Œè§¦å‘é€šçŸ¥
    subject.state = "New State"
    
    # ç§»é™¤è§‚å¯Ÿè€…
    subject.detach(observer_a)
    subject.state = "Another State"
    
    return subject

# è¿è¡Œç¤ºä¾‹
observer_demo = demonstrate_observer()
```

#### 4.2 ç­–ç•¥æ¨¡å¼

**æ•°å­¦å®šä¹‰**ï¼š
ç­–ç•¥æ¨¡å¼å®šä¹‰ç®—æ³•æ—ï¼š$\forall Strategy_i: execute(Context) \rightarrow Result$

**Pythonå®ç°**ï¼š

```python
from abc import ABC, abstractmethod
from typing import List

class Strategy(ABC):
    """ç­–ç•¥æŠ½è±¡åŸºç±»"""
    
    @abstractmethod
    def execute(self, data: List[int]) -> List[int]:
        pass

class BubbleSortStrategy(Strategy):
    """å†’æ³¡æ’åºç­–ç•¥"""
    
    def execute(self, data: List[int]) -> List[int]:
        result = data.copy()
        n = len(result)
        
        for i in range(n):
            for j in range(0, n - i - 1):
                if result[j] > result[j + 1]:
                    result[j], result[j + 1] = result[j + 1], result[j]
        
        return result

class QuickSortStrategy(Strategy):
    """å¿«é€Ÿæ’åºç­–ç•¥"""
    
    def execute(self, data: List[int]) -> List[int]:
        if len(data) <= 1:
            return data
        
        pivot = data[len(data) // 2]
        left = [x for x in data if x < pivot]
        middle = [x for x in data if x == pivot]
        right = [x for x in data if x > pivot]
        
        return self.execute(left) + middle + self.execute(right)

class Context:
    """ä¸Šä¸‹æ–‡"""
    
    def __init__(self, strategy: Strategy):
        self.strategy = strategy
    
    def set_strategy(self, strategy: Strategy):
        """è®¾ç½®ç­–ç•¥"""
        self.strategy = strategy
    
    def execute_strategy(self, data: List[int]) -> List[int]:
        """æ‰§è¡Œç­–ç•¥"""
        return self.strategy.execute(data)

# æ³¨å†Œç­–ç•¥æ¨¡å¼
strategy_pattern = DesignPattern(
    name="Strategy",
    pattern_type=PatternType.BEHAVIORAL,
    context="éœ€è¦æ ¹æ®æ¡ä»¶é€‰æ‹©ä¸åŒçš„ç®—æ³•",
    problem="å¦‚ä½•è®©ç®—æ³•å¯ä»¥ç›¸äº’æ›¿æ¢",
    solution="å®šä¹‰ç®—æ³•æ—ï¼Œå°è£…æ¯ä¸ªç®—æ³•ï¼Œä½¿å®ƒä»¬å¯ä»¥äº’æ¢",
    consequences=["ç®—æ³•å¯æ›¿æ¢", "é¿å…æ¡ä»¶è¯­å¥", "ç¬¦åˆå¼€é—­åŸåˆ™"]
)

framework.register_pattern(strategy_pattern)

# ç¤ºä¾‹ï¼šç­–ç•¥æ¨¡å¼ä½¿ç”¨
def demonstrate_strategy():
    """æ¼”ç¤ºç­–ç•¥æ¨¡å¼"""
    data = [5, 2, 4, 1, 3]
    
    # ä½¿ç”¨å†’æ³¡æ’åºç­–ç•¥
    bubble_strategy = BubbleSortStrategy()
    context = Context(bubble_strategy)
    
    print("ç­–ç•¥æ¨¡å¼ç¤ºä¾‹:")
    print(f"åŸå§‹æ•°æ®: {data}")
    print(f"å†’æ³¡æ’åº: {context.execute_strategy(data)}")
    
    # åˆ‡æ¢åˆ°å¿«é€Ÿæ’åºç­–ç•¥
    quick_strategy = QuickSortStrategy()
    context.set_strategy(quick_strategy)
    print(f"å¿«é€Ÿæ’åº: {context.execute_strategy(data)}")
    
    return context

# è¿è¡Œç¤ºä¾‹
strategy_demo = demonstrate_strategy()
```

### 5. æ¨¡å¼ç»„åˆä¸æ¼”åŒ–

#### 5.1 æ¨¡å¼ç»„åˆ

**æ•°å­¦å®šä¹‰**ï¼š
æ¨¡å¼ç»„åˆæ˜¯å¤šä¸ªæ¨¡å¼çš„ç»„åˆï¼š$Combined = P_1 \circ P_2 \circ \cdots \circ P_n$

**Pythonå®ç°**ï¼š

```python
class PatternComposition:
    """æ¨¡å¼ç»„åˆ"""
    
    def __init__(self):
        self.patterns: List[DesignPattern] = []
        self.composition_rules: Dict[str, List[str]] = {}
    
    def add_pattern(self, pattern: DesignPattern):
        """æ·»åŠ æ¨¡å¼"""
        self.patterns.append(pattern)
    
    def add_composition_rule(self, pattern_name: str, compatible_patterns: List[str]):
        """æ·»åŠ ç»„åˆè§„åˆ™"""
        self.composition_rules[pattern_name] = compatible_patterns
    
    def get_compatible_patterns(self, pattern_name: str) -> List[str]:
        """è·å–å…¼å®¹æ¨¡å¼"""
        return self.composition_rules.get(pattern_name, [])
    
    def validate_composition(self, pattern_names: List[str]) -> bool:
        """éªŒè¯æ¨¡å¼ç»„åˆ"""
        for i, pattern_name in enumerate(pattern_names):
            if pattern_name in self.composition_rules:
                compatible = self.composition_rules[pattern_name]
                for other_pattern in pattern_names[i+1:]:
                    if other_pattern not in compatible:
                        return False
        return True

# ç¤ºä¾‹ï¼šæ¨¡å¼ç»„åˆ
def demonstrate_pattern_composition():
    """æ¼”ç¤ºæ¨¡å¼ç»„åˆ"""
    composition = PatternComposition()
    
    # æ·»åŠ ç»„åˆè§„åˆ™
    composition.add_composition_rule("Singleton", ["Factory", "Observer"])
    composition.add_composition_rule("Factory", ["Strategy", "Decorator"])
    composition.add_composition_rule("Observer", ["Strategy"])
    
    # éªŒè¯ç»„åˆ
    valid_combination = ["Singleton", "Factory", "Strategy"]
    invalid_combination = ["Singleton", "Strategy", "Decorator"]
    
    print("æ¨¡å¼ç»„åˆç¤ºä¾‹:")
    print(f"æœ‰æ•ˆç»„åˆ {valid_combination}: {composition.validate_composition(valid_combination)}")
    print(f"æ— æ•ˆç»„åˆ {invalid_combination}: {composition.validate_composition(invalid_combination)}")
    
    return composition

# è¿è¡Œç¤ºä¾‹
composition_demo = demonstrate_pattern_composition()
```

#### 5.2 æ¨¡å¼æ¼”åŒ–

**æ•°å­¦å®šä¹‰**ï¼š
æ¨¡å¼æ¼”åŒ–æ˜¯æ¨¡å¼éšæ—¶é—´çš„å˜åŒ–ï¼š$P(t+1) = evolve(P(t), context(t))$

**Pythonå®ç°**ï¼š

```python
from typing import Dict, Any
import time

class PatternEvolution:
    """æ¨¡å¼æ¼”åŒ–"""
    
    def __init__(self):
        self.evolution_history: List[Dict[str, Any]] = []
        self.current_patterns: Dict[str, DesignPattern] = {}
    
    def evolve_pattern(self, pattern_name: str, evolution_context: Dict[str, Any]):
        """æ¼”åŒ–æ¨¡å¼"""
        if pattern_name not in self.current_patterns:
            return
        
        pattern = self.current_patterns[pattern_name]
        
        # è®°å½•æ¼”åŒ–å†å²
        evolution_record = {
            'timestamp': time.time(),
            'pattern_name': pattern_name,
            'context': evolution_context,
            'original_pattern': pattern
        }
        
        # åº”ç”¨æ¼”åŒ–è§„åˆ™
        evolved_pattern = self._apply_evolution_rules(pattern, evolution_context)
        
        # æ›´æ–°å½“å‰æ¨¡å¼
        self.current_patterns[pattern_name] = evolved_pattern
        
        # è®°å½•æ¼”åŒ–ç»“æœ
        evolution_record['evolved_pattern'] = evolved_pattern
        self.evolution_history.append(evolution_record)
    
    def _apply_evolution_rules(self, pattern: DesignPattern, context: Dict[str, Any]) -> DesignPattern:
        """åº”ç”¨æ¼”åŒ–è§„åˆ™"""
        # ç®€åŒ–çš„æ¼”åŒ–è§„åˆ™
        evolved_consequences = pattern.consequences.copy()
        
        if context.get('performance_requirement'):
            evolved_consequences.append("æ€§èƒ½ä¼˜åŒ–")
        
        if context.get('scalability_requirement'):
            evolved_consequences.append("å¯æ‰©å±•æ€§å¢å¼º")
        
        return DesignPattern(
            name=pattern.name,
            pattern_type=pattern.pattern_type,
            context=pattern.context,
            problem=pattern.problem,
            solution=pattern.solution,
            consequences=evolved_consequences
        )
    
    def get_evolution_history(self, pattern_name: str) -> List[Dict[str, Any]]:
        """è·å–æ¼”åŒ–å†å²"""
        return [record for record in self.evolution_history 
                if record['pattern_name'] == pattern_name]

# ç¤ºä¾‹ï¼šæ¨¡å¼æ¼”åŒ–
def demonstrate_pattern_evolution():
    """æ¼”ç¤ºæ¨¡å¼æ¼”åŒ–"""
    evolution = PatternEvolution()
    
    # æ·»åŠ åˆå§‹æ¨¡å¼
    initial_pattern = DesignPattern(
        name="Simple Singleton",
        pattern_type=PatternType.CREATIONAL,
        context="åŸºæœ¬å•ä¾‹éœ€æ±‚",
        problem="ç¡®ä¿å”¯ä¸€å®ä¾‹",
        solution="ç§æœ‰æ„é€ å‡½æ•°",
        consequences=["å”¯ä¸€æ€§"]
    )
    
    evolution.current_patterns["Singleton"] = initial_pattern
    
    # æ¼”åŒ–æ¨¡å¼
    evolution_context = {
        'performance_requirement': True,
        'thread_safety_requirement': True
    }
    
    evolution.evolve_pattern("Singleton", evolution_context)
    
    print("æ¨¡å¼æ¼”åŒ–ç¤ºä¾‹:")
    print(f"åˆå§‹æ¨¡å¼: {initial_pattern.consequences}")
    print(f"æ¼”åŒ–åæ¨¡å¼: {evolution.current_patterns['Singleton'].consequences}")
    
    return evolution

# è¿è¡Œç¤ºä¾‹
evolution_demo = demonstrate_pattern_evolution()
```

## ğŸ“Š è®¾è®¡æ¨¡å¼ç§‘å­¦æ€»ç»“

### æ ¸å¿ƒç‰¹å¾

1. **å¯é‡ç”¨æ€§**ï¼šè§£å†³å¸¸è§è®¾è®¡é—®é¢˜
2. **æ ‡å‡†åŒ–**ï¼šæä¾›æ ‡å‡†åŒ–çš„è§£å†³æ–¹æ¡ˆ
3. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒç³»ç»Ÿæ¼”åŒ–
4. **å¯ç»´æŠ¤æ€§**ï¼šæé«˜ä»£ç è´¨é‡

### æ•°å­¦å½¢å¼åŒ–

è®¾è®¡æ¨¡å¼ç§‘å­¦å¯ä»¥ç”¨ä»¥ä¸‹æ•°å­¦ç»“æ„è¡¨ç¤ºï¼š

$$DesignPatternScience = (Patterns, Relations, Implementations, Evolution)$$

### Pythonå®ç°éªŒè¯

```python
class DesignPatternValidator:
    """è®¾è®¡æ¨¡å¼éªŒè¯å™¨"""
    
    def __init__(self):
        self.framework = framework
    
    def validate_pattern_registration(self) -> bool:
        """éªŒè¯æ¨¡å¼æ³¨å†Œ"""
        patterns = self.framework.list_patterns()
        return len(patterns) > 0
    
    def validate_pattern_types(self) -> bool:
        """éªŒè¯æ¨¡å¼ç±»å‹"""
        creational = self.framework.list_patterns(PatternType.CREATIONAL)
        structural = self.framework.list_patterns(PatternType.STRUCTURAL)
        behavioral = self.framework.list_patterns(PatternType.BEHAVIORAL)
        
        return len(creational) > 0 and len(structural) > 0 and len(behavioral) > 0
    
    def validate_implementation(self) -> bool:
        """éªŒè¯å®ç°"""
        # æµ‹è¯•å•ä¾‹æ¨¡å¼å®ç°
        singleton = SingletonPattern()
        instance1 = singleton.get_instance()
        instance2 = singleton.get_instance()
        
        return instance1 is instance2
    
    def validate_pattern_composition(self) -> bool:
        """éªŒè¯æ¨¡å¼ç»„åˆ"""
        composition = PatternComposition()
        composition.add_composition_rule("A", ["B"])
        composition.add_composition_rule("B", ["A"])
        
        return composition.validate_composition(["A", "B"])
    
    def run_all_tests(self) -> Dict[str, bool]:
        """è¿è¡Œæ‰€æœ‰æµ‹è¯•"""
        tests = {
            'pattern_registration': self.validate_pattern_registration(),
            'pattern_types': self.validate_pattern_types(),
            'implementation': self.validate_implementation(),
            'pattern_composition': self.validate_pattern_composition()
        }
        
        print("=== è®¾è®¡æ¨¡å¼ç§‘å­¦éªŒè¯ç»“æœ ===")
        for test_name, result in tests.items():
            print(f"{test_name}: {'PASS' if result else 'FAIL'}")
        
        return tests

# ä½¿ç”¨ç¤ºä¾‹
validator = DesignPatternValidator()
test_results = validator.run_all_tests()
```

## ğŸ”— ç›¸å…³é“¾æ¥

- [02.01 ç®—æ³•ç†è®º](../02-ç†è®ºåŸºç¡€/02.01-ç®—æ³•ç†è®º.md)
- [03.02 å¹¶å‘ç¼–ç¨‹ç§‘å­¦](./03.02-å¹¶å‘ç¼–ç¨‹ç§‘å­¦.md)
- [04.01 é‡‘èç§‘æŠ€](../04-è¡Œä¸šé¢†åŸŸ/04.01-é‡‘èç§‘æŠ€.md)

---

*è®¾è®¡æ¨¡å¼ç§‘å­¦ä¸ºè½¯ä»¶å·¥ç¨‹æä¾›äº†å¯é‡ç”¨çš„è®¾è®¡è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡å½¢å¼åŒ–å®šä¹‰å’ŒPythonå®ç°ï¼Œæˆ‘ä»¬å¯ä»¥å»ºç«‹é«˜è´¨é‡çš„è½¯ä»¶ç³»ç»Ÿã€‚*
