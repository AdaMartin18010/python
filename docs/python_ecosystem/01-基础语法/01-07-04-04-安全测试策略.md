# å®‰å…¨æµ‹è¯•ç­–ç•¥

## ğŸ“‹ æ¦‚è¿°

å®‰å…¨æµ‹è¯•æ˜¯éªŒè¯ç³»ç»Ÿå®‰å…¨æ€§çš„é‡è¦æ‰‹æ®µï¼Œé€šè¿‡è¯†åˆ«å’ŒéªŒè¯å®‰å…¨æ¼æ´ï¼Œç¡®ä¿ç³»ç»Ÿèƒ½å¤ŸæŠµå¾¡å„ç§å®‰å…¨å¨èƒã€‚

## 1. ç†è®ºåŸºç¡€

### 1.1 å®‰å…¨å¨èƒæ¨¡å‹

**å®šä¹‰ 1.1** (å®‰å…¨å¨èƒ)
å®‰å…¨å¨èƒæ˜¯å¯èƒ½æŸå®³ç³»ç»Ÿå®‰å…¨çš„äº‹ä»¶ï¼š
$$\text{Threat} = (A, V, I, P)$$
å…¶ä¸­ï¼š

- $A$ æ˜¯æ”»å‡»è€…
- $V$ æ˜¯æ¼æ´
- $I$ æ˜¯å½±å“
- $P$ æ˜¯æ¦‚ç‡

**å®šä¹‰ 1.2** (é£é™©ç­‰çº§)
é£é™©ç­‰çº§æ˜¯å¨èƒä¸¥é‡ç¨‹åº¦çš„é‡åŒ–ï¼š
$$\text{Risk Level} = \text{Impact} \times \text{Probability}$$

## 2. Pythonå®ç°

### 2.1 å®‰å…¨æµ‹è¯•æ¡†æ¶

```python
from typing import Dict, List, Optional, Tuple, Any
from dataclasses import dataclass
from abc import ABC, abstractmethod
import requests
import sqlite3
import hashlib
import jwt
import re
from enum import Enum
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class SecurityLevel(Enum):
    """å®‰å…¨ç­‰çº§æšä¸¾"""
    LOW = "low"
    MEDIUM = "medium"
    HIGH = "high"
    CRITICAL = "critical"

@dataclass
class SecurityVulnerability:
    """å®‰å…¨æ¼æ´"""
    name: str
    description: str
    level: SecurityLevel
    cve_id: Optional[str] = None
    remediation: str = ""

class SecurityTester:
    """å®‰å…¨æµ‹è¯•å™¨"""
    
    def __init__(self):
        self.vulnerabilities: List[SecurityVulnerability] = []
    
    def test_sql_injection(self, url: str, params: Dict[str, str]) -> List[SecurityVulnerability]:
        """SQLæ³¨å…¥æµ‹è¯•"""
        payloads = [
            "' OR '1'='1",
            "'; DROP TABLE users; --",
            "' UNION SELECT * FROM users --"
        ]
        
        vulnerabilities = []
        for param, value in params.items():
            for payload in payloads:
                test_params = params.copy()
                test_params[param] = payload
                
                try:
                    response = requests.get(url, params=test_params, timeout=10)
                    if self._detect_sql_error(response.text):
                        vuln = SecurityVulnerability(
                            name="SQL Injection",
                            description=f"Parameter {param} is vulnerable to SQL injection",
                            level=SecurityLevel.CRITICAL,
                            remediation="Use parameterized queries"
                        )
                        vulnerabilities.append(vuln)
                except Exception as e:
                    logger.error(f"SQLæ³¨å…¥æµ‹è¯•å¤±è´¥: {e}")
        
        return vulnerabilities
    
    def test_xss(self, url: str, params: Dict[str, str]) -> List[SecurityVulnerability]:
        """XSSæµ‹è¯•"""
        payloads = [
            "<script>alert('XSS')</script>",
            "javascript:alert('XSS')",
            "<img src=x onerror=alert('XSS')>"
        ]
        
        vulnerabilities = []
        for param, value in params.items():
            for payload in payloads:
                test_params = params.copy()
                test_params[param] = payload
                
                try:
                    response = requests.get(url, params=test_params, timeout=10)
                    if payload in response.text:
                        vuln = SecurityVulnerability(
                            name="Cross-Site Scripting (XSS)",
                            description=f"Parameter {param} is vulnerable to XSS",
                            level=SecurityLevel.HIGH,
                            remediation="Validate and sanitize input"
                        )
                        vulnerabilities.append(vuln)
                except Exception as e:
                    logger.error(f"XSSæµ‹è¯•å¤±è´¥: {e}")
        
        return vulnerabilities
    
    def test_authentication(self, login_url: str, credentials: List[Tuple[str, str]]) -> List[SecurityVulnerability]:
        """è®¤è¯æµ‹è¯•"""
        vulnerabilities = []
        
        # æµ‹è¯•å¼±å¯†ç 
        weak_passwords = ["123456", "password", "admin", "test"]
        for username, password in credentials:
            for weak_pwd in weak_passwords:
                try:
                    data = {"username": username, "password": weak_pwd}
                    response = requests.post(login_url, data=data, timeout=10)
                    if response.status_code == 200:
                        vuln = SecurityVulnerability(
                            name="Weak Password",
                            description=f"User {username} has weak password",
                            level=SecurityLevel.MEDIUM,
                            remediation="Enforce strong password policy"
                        )
                        vulnerabilities.append(vuln)
                except Exception as e:
                    logger.error(f"è®¤è¯æµ‹è¯•å¤±è´¥: {e}")
        
        return vulnerabilities
    
    def test_authorization(self, protected_url: str, user_roles: Dict[str, str]) -> List[SecurityVulnerability]:
        """æˆæƒæµ‹è¯•"""
        vulnerabilities = []
        
        for role, token in user_roles.items():
            try:
                headers = {"Authorization": f"Bearer {token}"}
                response = requests.get(protected_url, headers=headers, timeout=10)
                
                # æ£€æŸ¥æ˜¯å¦è®¿é—®äº†ä¸åº”è¯¥è®¿é—®çš„èµ„æº
                if response.status_code == 200 and role == "user":
                    vuln = SecurityVulnerability(
                        name="Authorization Bypass",
                        description=f"User role can access admin resources",
                        level=SecurityLevel.HIGH,
                        remediation="Implement proper role-based access control"
                    )
                    vulnerabilities.append(vuln)
            except Exception as e:
                logger.error(f"æˆæƒæµ‹è¯•å¤±è´¥: {e}")
        
        return vulnerabilities
    
    def _detect_sql_error(self, response_text: str) -> bool:
        """æ£€æµ‹SQLé”™è¯¯"""
        sql_errors = [
            "SQL syntax",
            "mysql_fetch_array",
            "ORA-",
            "PostgreSQL",
            "SQLite"
        ]
        
        for error in sql_errors:
            if error.lower() in response_text.lower():
                return True
        return False

class SecurityScanner:
    """å®‰å…¨æ‰«æå™¨"""
    
    def __init__(self):
        self.scan_results: Dict[str, List[SecurityVulnerability]] = {}
    
    def scan_web_application(self, base_url: str) -> Dict[str, List[SecurityVulnerability]]:
        """æ‰«æWebåº”ç”¨"""
        tester = SecurityTester()
        results = {}
        
        # æ‰«æå¸¸è§ç«¯ç‚¹
        endpoints = ["/", "/login", "/admin", "/api/users", "/search"]
        
        for endpoint in endpoints:
            url = base_url + endpoint
            params = {"q": "test", "id": "1"}
            
            # SQLæ³¨å…¥æµ‹è¯•
            sql_vulns = tester.test_sql_injection(url, params)
            if sql_vulns:
                results[f"{endpoint}_sql_injection"] = sql_vulns
            
            # XSSæµ‹è¯•
            xss_vulns = tester.test_xss(url, params)
            if xss_vulns:
                results[f"{endpoint}_xss"] = xss_vulns
        
        return results
    
    def generate_security_report(self) -> str:
        """ç”Ÿæˆå®‰å…¨æŠ¥å‘Š"""
        report = "å®‰å…¨æµ‹è¯•æŠ¥å‘Š\n============\n\n"
        
        total_vulns = sum(len(vulns) for vulns in self.scan_results.values())
        critical_vulns = sum(
            len([v for v in vulns if v.level == SecurityLevel.CRITICAL])
            for vulns in self.scan_results.values()
        )
        
        report += f"æ€»æ¼æ´æ•°: {total_vulns}\n"
        report += f"ä¸¥é‡æ¼æ´æ•°: {critical_vulns}\n\n"
        
        for test_name, vulnerabilities in self.scan_results.items():
            report += f"{test_name}:\n"
            for vuln in vulnerabilities:
                report += f"  - {vuln.name} ({vuln.level.value}): {vuln.description}\n"
                report += f"    ä¿®å¤å»ºè®®: {vuln.remediation}\n"
            report += "\n"
        
        return report

# å®é™…åº”ç”¨ç¤ºä¾‹
def security_test_example():
    """å®‰å…¨æµ‹è¯•ç¤ºä¾‹"""
    print("=== å®‰å…¨æµ‹è¯•ç¤ºä¾‹ ===")
    
    scanner = SecurityScanner()
    
    # æ¨¡æ‹ŸWebåº”ç”¨æ‰«æ
    base_url = "http://example.com"
    results = scanner.scan_web_application(base_url)
    
    # ç”ŸæˆæŠ¥å‘Š
    report = scanner.generate_security_report()
    print(report)

if __name__ == "__main__":
    security_test_example()
```

## 3. æµ‹è¯•ç­–ç•¥

### 3.1 æµ‹è¯•ç±»å‹

1. **æ¼æ´æ‰«æ**: è‡ªåŠ¨å‘ç°å·²çŸ¥æ¼æ´
2. **æ¸—é€æµ‹è¯•**: æ¨¡æ‹Ÿæ”»å‡»è€…è¡Œä¸º
3. **ä»£ç å®¡è®¡**: å®¡æŸ¥æºä»£ç å®‰å…¨
4. **é…ç½®å®¡è®¡**: æ£€æŸ¥å®‰å…¨é…ç½®

### 3.2 å®‰å…¨åŸºå‡†

1. **OWASP Top 10**: å¸¸è§Webåº”ç”¨æ¼æ´
2. **CWE**: å¸¸è§å¼±ç‚¹æšä¸¾
3. **CVE**: å¸¸è§æ¼æ´æŠ«éœ²

## 4. æœ€ä½³å®è·µ

### 4.1 æµ‹è¯•ç¯å¢ƒ

1. **éš”ç¦»ç¯å¢ƒ**: ä½¿ç”¨ä¸“ç”¨æµ‹è¯•ç¯å¢ƒ
2. **æ•°æ®ä¿æŠ¤**: ä¿æŠ¤æ•æ„Ÿæµ‹è¯•æ•°æ®
3. **æƒé™æ§åˆ¶**: é™åˆ¶æµ‹è¯•æƒé™

### 4.2 æŒç»­å®‰å…¨

1. **å®šæœŸæ‰«æ**: å®šæœŸè¿›è¡Œå®‰å…¨æ‰«æ
2. **æ¼æ´ç®¡ç†**: å»ºç«‹æ¼æ´ç®¡ç†æµç¨‹
3. **å®‰å…¨åŸ¹è®­**: æé«˜å®‰å…¨æ„è¯†

## 5. æ€»ç»“

å®‰å…¨æµ‹è¯•æ˜¯ç¡®ä¿ç³»ç»Ÿå®‰å…¨æ€§çš„é‡è¦æ‰‹æ®µï¼Œé€šè¿‡ç³»ç»Ÿæ€§çš„æµ‹è¯•ç­–ç•¥å’Œå·¥å…·ï¼Œå¯ä»¥æœ‰æ•ˆè¯†åˆ«å’Œä¿®å¤å®‰å…¨æ¼æ´ã€‚

---

**ç›¸å…³æ–‡æ¡£**:

- [å•å…ƒæµ‹è¯•ç­–ç•¥](./07-04-01-å•å…ƒæµ‹è¯•ç­–ç•¥.md)
- [é›†æˆæµ‹è¯•ç­–ç•¥](./07-04-02-é›†æˆæµ‹è¯•ç­–ç•¥.md)
- [å®‰å…¨æœ€ä½³å®è·µ](../07-02-æœ€ä½³å®è·µ/07-02-06-å®‰å…¨æœ€ä½³å®è·µ.md)
