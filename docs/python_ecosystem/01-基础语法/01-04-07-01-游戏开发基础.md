# æ¸¸æˆå¼€å‘åŸºç¡€

## ğŸ“‹ æ¦‚è¿°

æ¸¸æˆå¼€å‘æ˜¯è½¯ä»¶å·¥ç¨‹ä¸­çš„ä¸€ä¸ªé‡è¦é¢†åŸŸï¼Œæ¶‰åŠå®æ—¶ç³»ç»Ÿã€å›¾å½¢æ¸²æŸ“ã€ç‰©ç†æ¨¡æ‹Ÿã€äººå·¥æ™ºèƒ½ç­‰å¤šä¸ªæŠ€æœ¯é¢†åŸŸã€‚æœ¬æ–‡æ¡£ä»å½¢å¼åŒ–å®šä¹‰å‡ºå‘ï¼Œæ„å»ºå®Œæ•´çš„æ¸¸æˆå¼€å‘ç†è®ºä½“ç³»ã€‚

## 1. å½¢å¼åŒ–å®šä¹‰

### 1.1 æ¸¸æˆç³»ç»Ÿå®šä¹‰

**å®šä¹‰ 1.1** (æ¸¸æˆç³»ç»Ÿ)
æ¸¸æˆç³»ç»Ÿæ˜¯ä¸€ä¸ªå…­å…ƒç»„ï¼š
$$\text{GameSystem} = (E, S, R, P, A, I)$$

å…¶ä¸­ï¼š

- $E$ æ˜¯æ¸¸æˆå¼•æ“
- $S$ æ˜¯æ¸¸æˆçŠ¶æ€
- $R$ æ˜¯æ¸²æŸ“ç³»ç»Ÿ
- $P$ æ˜¯ç‰©ç†å¼•æ“
- $A$ æ˜¯éŸ³é¢‘ç³»ç»Ÿ
- $I$ æ˜¯è¾“å…¥ç³»ç»Ÿ

### 1.2 æ¸¸æˆå¯¹è±¡å®šä¹‰

**å®šä¹‰ 1.2** (æ¸¸æˆå¯¹è±¡)
æ¸¸æˆå¯¹è±¡æ˜¯ä¸€ä¸ªå››å…ƒç»„ï¼š
$$o = (\text{id}, \text{transform}, \text{components}, \text{state})$$

å…¶ä¸­ï¼š

- $\text{id}$ æ˜¯å¯¹è±¡å”¯ä¸€æ ‡è¯†ç¬¦
- $\text{transform}$ æ˜¯å˜æ¢ä¿¡æ¯ï¼ˆä½ç½®ã€æ—‹è½¬ã€ç¼©æ”¾ï¼‰
- $\text{components}$ æ˜¯ç»„ä»¶é›†åˆ
- $\text{state}$ æ˜¯å¯¹è±¡çŠ¶æ€

### 1.3 æ¸¸æˆå¾ªç¯å®šä¹‰

**å®šä¹‰ 1.3** (æ¸¸æˆå¾ªç¯)
æ¸¸æˆå¾ªç¯æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ï¼š
$$L = (\text{input}, \text{update}, \text{render})$$

å…¶ä¸­ï¼š

- $\text{input}$ æ˜¯è¾“å…¥å¤„ç†å‡½æ•°
- $\text{update}$ æ˜¯æ›´æ–°å‡½æ•°
- $\text{render}$ æ˜¯æ¸²æŸ“å‡½æ•°

## 2. æ ¸å¿ƒæ¦‚å¿µ

### 2.1 æ¸¸æˆå¼•æ“æ¶æ„

#### 2.1.1 ç»„ä»¶ç³»ç»Ÿ

**å®šä¹‰ 2.1** (ç»„ä»¶)
ç»„ä»¶æ˜¯ä¸€ä¸ªå‡½æ•°ï¼š
$$C: \text{GameObject} \rightarrow \text{Behavior}$$

ç»„ä»¶å®šä¹‰äº†æ¸¸æˆå¯¹è±¡çš„è¡Œä¸ºå’Œå±æ€§ã€‚

#### 2.1.2 å®ä½“ç»„ä»¶ç³»ç»Ÿ (ECS)

**å®šä¹‰ 2.2** (å®ä½“ç»„ä»¶ç³»ç»Ÿ)
ECSæ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ï¼š
$$\text{ECS} = (E, C, S)$$

å…¶ä¸­ï¼š

- $E$ æ˜¯å®ä½“é›†åˆ
- $C$ æ˜¯ç»„ä»¶é›†åˆ
- $S$ æ˜¯ç³»ç»Ÿé›†åˆ

### 2.2 æ¸¸æˆå¾ªç¯ç†è®º

#### 2.2.1 å¸§ç‡æ§åˆ¶

**å®šä¹‰ 2.3** (å¸§ç‡)
å¸§ç‡æ˜¯æ¯ç§’æ¸²æŸ“çš„å¸§æ•°ï¼š
$$\text{FPS} = \frac{1}{\Delta t}$$

å…¶ä¸­ $\Delta t$ æ˜¯å¸§é—´éš”æ—¶é—´ã€‚

#### 2.2.2 æ—¶é—´æ­¥é•¿

**å®šä¹‰ 2.4** (æ—¶é—´æ­¥é•¿)
æ—¶é—´æ­¥é•¿æ˜¯ç‰©ç†æ›´æ–°çš„æ—¶é—´é—´éš”ï¼š
$$\Delta t_{\text{physics}} = \text{constant}$$

### 2.3 ç‰©ç†å¼•æ“

#### 2.3.1 åˆšä½“åŠ¨åŠ›å­¦

**å®šä¹‰ 2.5** (åˆšä½“)
åˆšä½“æ˜¯ä¸€ä¸ªå…­å…ƒç»„ï¼š
$$R = (m, I, p, v, \omega, \tau)$$

å…¶ä¸­ï¼š

- $m$ æ˜¯è´¨é‡
- $I$ æ˜¯è½¬åŠ¨æƒ¯é‡
- $p$ æ˜¯ä½ç½®
- $v$ æ˜¯é€Ÿåº¦
- $\omega$ æ˜¯è§’é€Ÿåº¦
- $\tau$ æ˜¯åŠ›çŸ©

#### 2.3.2 ç¢°æ’æ£€æµ‹

**å®šä¹‰ 2.6** (ç¢°æ’)
ä¸¤ä¸ªå¯¹è±¡ $A$ å’Œ $B$ å‘ç”Ÿç¢°æ’å½“ä¸”ä»…å½“ï¼š
$$A \cap B \neq \emptyset$$

## 3. Pythonå®ç°

### 3.1 åŸºç¡€æ•°æ®ç»“æ„

```python
from typing import List, Dict, Optional, Any, Callable
from dataclasses import dataclass, field
from abc import ABC, abstractmethod
import time
import math
import threading
from collections import defaultdict
import numpy as np
from enum import Enum

class Vector2:
    """äºŒç»´å‘é‡"""
    
    def __init__(self, x: float = 0.0, y: float = 0.0):
        self.x = x
        self.y = y
    
    def __add__(self, other: 'Vector2') -> 'Vector2':
        return Vector2(self.x + other.x, self.y + other.y)
    
    def __sub__(self, other: 'Vector2') -> 'Vector2':
        return Vector2(self.x - other.x, self.y - other.y)
    
    def __mul__(self, scalar: float) -> 'Vector2':
        return Vector2(self.x * scalar, self.y * scalar)
    
    def magnitude(self) -> float:
        return math.sqrt(self.x * self.x + self.y * self.y)
    
    def normalize(self) -> 'Vector2':
        mag = self.magnitude()
        if mag == 0:
            return Vector2()
        return Vector2(self.x / mag, self.y / mag)

@dataclass
class Transform:
    """å˜æ¢ç»„ä»¶"""
    position: Vector2 = field(default_factory=lambda: Vector2())
    rotation: float = 0.0
    scale: Vector2 = field(default_factory=lambda: Vector2(1.0, 1.0))
    
    def translate(self, translation: Vector2) -> None:
        """å¹³ç§»"""
        self.position = self.position + translation
    
    def rotate(self, angle: float) -> None:
        """æ—‹è½¬"""
        self.rotation += angle
    
    def scale_by(self, scale_factor: Vector2) -> None:
        """ç¼©æ”¾"""
        self.scale = Vector2(self.scale.x * scale_factor.x, 
                           self.scale.y * scale_factor.y)

class Component(ABC):
    """ç»„ä»¶åŸºç±»"""
    
    def __init__(self, game_object: 'GameObject'):
        self.game_object = game_object
        self.enabled = True
    
    @abstractmethod
    def update(self, delta_time: float) -> None:
        """æ›´æ–°ç»„ä»¶"""
        pass
    
    def on_enable(self) -> None:
        """ç»„ä»¶å¯ç”¨æ—¶è°ƒç”¨"""
        pass
    
    def on_disable(self) -> None:
        """ç»„ä»¶ç¦ç”¨æ—¶è°ƒç”¨"""
        pass

class GameObject:
    """æ¸¸æˆå¯¹è±¡"""
    
    def __init__(self, name: str = "GameObject"):
        self.id = id(self)
        self.name = name
        self.transform = Transform()
        self.components: List[Component] = []
        self.active = True
        self.children: List[GameObject] = []
        self.parent: Optional[GameObject] = None
    
    def add_component(self, component_type: type) -> Component:
        """æ·»åŠ ç»„ä»¶"""
        component = component_type(self)
        self.components.append(component)
        component.on_enable()
        return component
    
    def get_component(self, component_type: type) -> Optional[Component]:
        """è·å–ç»„ä»¶"""
        for component in self.components:
            if isinstance(component, component_type):
                return component
        return None
    
    def remove_component(self, component: Component) -> None:
        """ç§»é™¤ç»„ä»¶"""
        if component in self.components:
            component.on_disable()
            self.components.remove(component)
    
    def update(self, delta_time: float) -> None:
        """æ›´æ–°æ¸¸æˆå¯¹è±¡"""
        if not self.active:
            return
        
        for component in self.components:
            if component.enabled:
                component.update(delta_time)
        
        for child in self.children:
            child.update(delta_time)
    
    def add_child(self, child: 'GameObject') -> None:
        """æ·»åŠ å­å¯¹è±¡"""
        if child.parent:
            child.parent.children.remove(child)
        child.parent = self
        self.children.append(child)

class Rigidbody(Component):
    """åˆšä½“ç»„ä»¶"""
    
    def __init__(self, game_object: GameObject):
        super().__init__(game_object)
        self.mass = 1.0
        self.velocity = Vector2()
        self.angular_velocity = 0.0
        self.force = Vector2()
        self.torque = 0.0
        self.gravity_scale = 1.0
        self.drag = 0.0
        self.angular_drag = 0.0
    
    def update(self, delta_time: float) -> None:
        """æ›´æ–°åˆšä½“"""
        # åº”ç”¨é‡åŠ›
        gravity = Vector2(0, -9.81 * self.gravity_scale)
        self.force = self.force + gravity
        
        # åº”ç”¨åŠ›
        acceleration = self.force * (1.0 / self.mass)
        self.velocity = self.velocity + acceleration * delta_time
        
        # åº”ç”¨é˜»åŠ›
        self.velocity = self.velocity * (1.0 - self.drag * delta_time)
        self.angular_velocity *= (1.0 - self.angular_drag * delta_time)
        
        # æ›´æ–°ä½ç½®
        self.game_object.transform.translate(self.velocity * delta_time)
        self.game_object.transform.rotate(self.angular_velocity * delta_time)
        
        # é‡ç½®åŠ›
        self.force = Vector2()
        self.torque = 0.0
    
    def add_force(self, force: Vector2) -> None:
        """æ·»åŠ åŠ›"""
        self.force = self.force + force
    
    def add_torque(self, torque: float) -> None:
        """æ·»åŠ åŠ›çŸ©"""
        self.torque += torque

class Collider(Component):
    """ç¢°æ’å™¨ç»„ä»¶"""
    
    def __init__(self, game_object: GameObject):
        super().__init__(game_object)
        self.is_trigger = False
        self.bounds = None
    
    def get_bounds(self) -> 'Bounds':
        """è·å–è¾¹ç•Œ"""
        raise NotImplementedError
    
    def check_collision(self, other: 'Collider') -> bool:
        """æ£€æŸ¥ç¢°æ’"""
        raise NotImplementedError

class BoxCollider(Collider):
    """ç›’å‹ç¢°æ’å™¨"""
    
    def __init__(self, game_object: GameObject, size: Vector2 = Vector2(1, 1)):
        super().__init__(game_object)
        self.size = size
        self._update_bounds()
    
    def _update_bounds(self) -> None:
        """æ›´æ–°è¾¹ç•Œ"""
        pos = self.game_object.transform.position
        half_size = self.size * 0.5
        self.bounds = Bounds(
            pos.x - half_size.x,
            pos.y - half_size.y,
            pos.x + half_size.x,
            pos.y + half_size.y
        )
    
    def update(self, delta_time: float) -> None:
        """æ›´æ–°ç¢°æ’å™¨"""
        self._update_bounds()
    
    def get_bounds(self) -> 'Bounds':
        return self.bounds
    
    def check_collision(self, other: Collider) -> bool:
        """æ£€æŸ¥ç¢°æ’"""
        if isinstance(other, BoxCollider):
            return self.bounds.intersects(other.bounds)
        return False

@dataclass
class Bounds:
    """è¾¹ç•Œæ¡†"""
    min_x: float
    min_y: float
    max_x: float
    max_y: float
    
    def intersects(self, other: 'Bounds') -> bool:
        """æ£€æŸ¥æ˜¯å¦ç›¸äº¤"""
        return not (self.max_x < other.min_x or 
                   self.min_x > other.max_x or
                   self.max_y < other.min_y or
                   self.min_y > other.max_y)

class Renderer(Component):
    """æ¸²æŸ“å™¨ç»„ä»¶"""
    
    def __init__(self, game_object: GameObject):
        super().__init__(game_object)
        self.material = None
        self.mesh = None
        self.visible = True
    
    def render(self, render_system: 'RenderSystem') -> None:
        """æ¸²æŸ“"""
        if self.visible and self.mesh and self.material:
            render_system.draw_mesh(self.mesh, self.material, 
                                  self.game_object.transform)

class Mesh:
    """ç½‘æ ¼"""
    
    def __init__(self, vertices: List[Vector2], indices: List[int]):
        self.vertices = vertices
        self.indices = indices
    
    @classmethod
    def create_quad(cls, width: float = 1.0, height: float = 1.0) -> 'Mesh':
        """åˆ›å»ºå››è¾¹å½¢ç½‘æ ¼"""
        half_w = width * 0.5
        half_h = height * 0.5
        
        vertices = [
            Vector2(-half_w, -half_h),
            Vector2(half_w, -half_h),
            Vector2(half_w, half_h),
            Vector2(-half_w, half_h)
        ]
        
        indices = [0, 1, 2, 0, 2, 3]
        
        return cls(vertices, indices)

class Material:
    """æè´¨"""
    
    def __init__(self, color: str = "white"):
        self.color = color
        self.texture = None
        self.shader = None

class RenderSystem:
    """æ¸²æŸ“ç³»ç»Ÿ"""
    
    def __init__(self):
        self.render_queue: List[Renderer] = []
    
    def add_renderer(self, renderer: Renderer) -> None:
        """æ·»åŠ æ¸²æŸ“å™¨"""
        if renderer not in self.render_queue:
            self.render_queue.append(renderer)
    
    def remove_renderer(self, renderer: Renderer) -> None:
        """ç§»é™¤æ¸²æŸ“å™¨"""
        if renderer in self.render_queue:
            self.render_queue.remove(renderer)
    
    def render(self) -> None:
        """æ¸²æŸ“æ‰€æœ‰å¯¹è±¡"""
        # åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨å›¾å½¢API
        for renderer in self.render_queue:
            if renderer.enabled and renderer.visible:
                renderer.render(self)
    
    def draw_mesh(self, mesh: Mesh, material: Material, transform: Transform) -> None:
        """ç»˜åˆ¶ç½‘æ ¼"""
        # åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œä¼šè¿›è¡Œå®é™…çš„å›¾å½¢æ¸²æŸ“
        pass

class PhysicsSystem:
    """ç‰©ç†ç³»ç»Ÿ"""
    
    def __init__(self):
        self.rigidbodies: List[Rigidbody] = []
        self.colliders: List[Collider] = []
        self.gravity = Vector2(0, -9.81)
        self.time_step = 1.0 / 60.0
    
    def add_rigidbody(self, rigidbody: Rigidbody) -> None:
        """æ·»åŠ åˆšä½“"""
        if rigidbody not in self.rigidbodies:
            self.rigidbodies.append(rigidbody)
    
    def add_collider(self, collider: Collider) -> None:
        """æ·»åŠ ç¢°æ’å™¨"""
        if collider not in self.colliders:
            self.colliders.append(collider)
    
    def remove_rigidbody(self, rigidbody: Rigidbody) -> None:
        """ç§»é™¤åˆšä½“"""
        if rigidbody in self.rigidbodies:
            self.rigidbodies.remove(rigidbody)
    
    def remove_collider(self, collider: Collider) -> None:
        """ç§»é™¤ç¢°æ’å™¨"""
        if collider in self.colliders:
            self.colliders.remove(collider)
    
    def update(self, delta_time: float) -> None:
        """æ›´æ–°ç‰©ç†ç³»ç»Ÿ"""
        # æ›´æ–°åˆšä½“
        for rigidbody in self.rigidbodies:
            if rigidbody.enabled:
                rigidbody.update(self.time_step)
        
        # ç¢°æ’æ£€æµ‹
        self._check_collisions()
    
    def _check_collisions(self) -> None:
        """æ£€æŸ¥ç¢°æ’"""
        for i, collider1 in enumerate(self.colliders):
            if not collider1.enabled:
                continue
            
            for j, collider2 in enumerate(self.colliders[i+1:], i+1):
                if not collider2.enabled:
                    continue
                
                if collider1.check_collision(collider2):
                    self._handle_collision(collider1, collider2)
    
    def _handle_collision(self, collider1: Collider, collider2: Collider) -> None:
        """å¤„ç†ç¢°æ’"""
        # åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œä¼šè¿›è¡Œç¢°æ’å“åº”
        pass

class InputSystem:
    """è¾“å…¥ç³»ç»Ÿ"""
    
    def __init__(self):
        self.key_states: Dict[str, bool] = defaultdict(bool)
        self.mouse_position = Vector2()
        self.mouse_buttons: Dict[int, bool] = defaultdict(bool)
    
    def update(self) -> None:
        """æ›´æ–°è¾“å…¥çŠ¶æ€"""
        # åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œä¼šè¯»å–å®é™…çš„è¾“å…¥è®¾å¤‡
        pass
    
    def get_key(self, key: str) -> bool:
        """è·å–æŒ‰é”®çŠ¶æ€"""
        return self.key_states[key]
    
    def get_key_down(self, key: str) -> bool:
        """è·å–æŒ‰é”®æŒ‰ä¸‹çŠ¶æ€"""
        return self.key_states[key]
    
    def get_mouse_position(self) -> Vector2:
        """è·å–é¼ æ ‡ä½ç½®"""
        return self.mouse_position
    
    def get_mouse_button(self, button: int) -> bool:
        """è·å–é¼ æ ‡æŒ‰é”®çŠ¶æ€"""
        return self.mouse_buttons[button]

class AudioSystem:
    """éŸ³é¢‘ç³»ç»Ÿ"""
    
    def __init__(self):
        self.sounds: Dict[str, 'Sound'] = {}
        self.music: Optional['Music'] = None
        self.volume = 1.0
    
    def play_sound(self, sound_name: str) -> None:
        """æ’­æ”¾éŸ³æ•ˆ"""
        if sound_name in self.sounds:
            # åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œä¼šæ’­æ”¾éŸ³æ•ˆ
            pass
    
    def play_music(self, music: 'Music') -> None:
        """æ’­æ”¾éŸ³ä¹"""
        self.music = music
        # åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œä¼šæ’­æ”¾éŸ³ä¹
    
    def set_volume(self, volume: float) -> None:
        """è®¾ç½®éŸ³é‡"""
        self.volume = max(0.0, min(1.0, volume))

class Sound:
    """éŸ³æ•ˆ"""
    
    def __init__(self, file_path: str):
        self.file_path = file_path
        self.volume = 1.0
        self.pitch = 1.0

class Music:
    """éŸ³ä¹"""
    
    def __init__(self, file_path: str):
        self.file_path = file_path
        self.volume = 1.0
        self.loop = True

class GameEngine:
    """æ¸¸æˆå¼•æ“"""
    
    def __init__(self):
        self.scene = Scene()
        self.render_system = RenderSystem()
        self.physics_system = PhysicsSystem()
        self.input_system = InputSystem()
        self.audio_system = AudioSystem()
        self.running = False
        self.target_fps = 60
        self.delta_time = 0.0
    
    def start(self) -> None:
        """å¯åŠ¨æ¸¸æˆå¼•æ“"""
        self.running = True
        self._game_loop()
    
    def stop(self) -> None:
        """åœæ­¢æ¸¸æˆå¼•æ“"""
        self.running = False
    
    def _game_loop(self) -> None:
        """æ¸¸æˆä¸»å¾ªç¯"""
        last_time = time.time()
        
        while self.running:
            current_time = time.time()
            self.delta_time = current_time - last_time
            last_time = current_time
            
            # è¾“å…¥å¤„ç†
            self.input_system.update()
            
            # æ›´æ–°åœºæ™¯
            self.scene.update(self.delta_time)
            
            # æ›´æ–°ç‰©ç†
            self.physics_system.update(self.delta_time)
            
            # æ¸²æŸ“
            self.render_system.render()
            
            # å¸§ç‡æ§åˆ¶
            frame_time = time.time() - current_time
            target_frame_time = 1.0 / self.target_fps
            if frame_time < target_frame_time:
                time.sleep(target_frame_time - frame_time)
    
    def create_game_object(self, name: str = "GameObject") -> GameObject:
        """åˆ›å»ºæ¸¸æˆå¯¹è±¡"""
        game_object = GameObject(name)
        self.scene.add_game_object(game_object)
        return game_object

class Scene:
    """åœºæ™¯"""
    
    def __init__(self):
        self.game_objects: List[GameObject] = []
        self.root_objects: List[GameObject] = []
    
    def add_game_object(self, game_object: GameObject) -> None:
        """æ·»åŠ æ¸¸æˆå¯¹è±¡"""
        self.game_objects.append(game_object)
        if game_object.parent is None:
            self.root_objects.append(game_object)
    
    def remove_game_object(self, game_object: GameObject) -> None:
        """ç§»é™¤æ¸¸æˆå¯¹è±¡"""
        if game_object in self.game_objects:
            self.game_objects.remove(game_object)
        if game_object in self.root_objects:
            self.root_objects.remove(game_object)
    
    def update(self, delta_time: float) -> None:
        """æ›´æ–°åœºæ™¯"""
        for game_object in self.root_objects:
            game_object.update(delta_time)
    
    def find_game_object(self, name: str) -> Optional[GameObject]:
        """æŸ¥æ‰¾æ¸¸æˆå¯¹è±¡"""
        for game_object in self.game_objects:
            if game_object.name == name:
                return game_object
        return None
```

### 3.2 æ¸¸æˆç»„ä»¶å®ç°

```python
class PlayerController(Component):
    """ç©å®¶æ§åˆ¶å™¨"""
    
    def __init__(self, game_object: GameObject, speed: float = 5.0):
        super().__init__(game_object)
        self.speed = speed
        self.rigidbody = None
    
    def on_enable(self) -> None:
        """ç»„ä»¶å¯ç”¨æ—¶"""
        self.rigidbody = self.game_object.get_component(Rigidbody)
        if not self.rigidbody:
            self.rigidbody = self.game_object.add_component(Rigidbody)
    
    def update(self, delta_time: float) -> None:
        """æ›´æ–°ç©å®¶æ§åˆ¶å™¨"""
        if not self.rigidbody:
            return
        
        # è·å–è¾“å…¥
        input_system = self.game_object.scene.engine.input_system
        
        # æ°´å¹³ç§»åŠ¨
        horizontal_input = 0
        if input_system.get_key("a") or input_system.get_key("left"):
            horizontal_input -= 1
        if input_system.get_key("d") or input_system.get_key("right"):
            horizontal_input += 1
        
        # å‚ç›´ç§»åŠ¨
        vertical_input = 0
        if input_system.get_key("w") or input_system.get_key("up"):
            vertical_input += 1
        if input_system.get_key("s") or input_system.get_key("down"):
            vertical_input -= 1
        
        # åº”ç”¨ç§»åŠ¨
        movement = Vector2(horizontal_input, vertical_input)
        if movement.magnitude() > 0:
            movement = movement.normalize() * self.speed
            self.rigidbody.add_force(movement)

class Camera(Component):
    """æ‘„åƒæœº"""
    
    def __init__(self, game_object: GameObject):
        super().__init__(game_object)
        self.target = None
        self.smoothness = 5.0
        self.zoom = 1.0
    
    def set_target(self, target: GameObject) -> None:
        """è®¾ç½®è·Ÿéšç›®æ ‡"""
        self.target = target
    
    def update(self, delta_time: float) -> None:
        """æ›´æ–°æ‘„åƒæœº"""
        if self.target:
            target_pos = self.target.transform.position
            current_pos = self.game_object.transform.position
            
            # å¹³æ»‘è·Ÿéš
            new_pos = Vector2(
                current_pos.x + (target_pos.x - current_pos.x) * self.smoothness * delta_time,
                current_pos.y + (target_pos.y - current_pos.y) * self.smoothness * delta_time
            )
            
            self.game_object.transform.position = new_pos

class SpriteRenderer(Renderer):
    """ç²¾çµæ¸²æŸ“å™¨"""
    
    def __init__(self, game_object: GameObject, sprite: str = "default"):
        super().__init__(game_object)
        self.sprite = sprite
        self.color = "white"
        self.flip_x = False
        self.flip_y = False
    
    def render(self, render_system: RenderSystem) -> None:
        """æ¸²æŸ“ç²¾çµ"""
        if self.visible:
            # åœ¨å®é™…å®ç°ä¸­ï¼Œè¿™é‡Œä¼šæ¸²æŸ“ç²¾çµ
            pass

class Animation(Component):
    """åŠ¨ç”»ç»„ä»¶"""
    
    def __init__(self, game_object: GameObject):
        super().__init__(game_object)
        self.animations: Dict[str, 'AnimationClip'] = {}
        self.current_animation = None
        self.current_frame = 0
        self.frame_time = 0.0
        self.sprite_renderer = None
    
    def on_enable(self) -> None:
        """ç»„ä»¶å¯ç”¨æ—¶"""
        self.sprite_renderer = self.game_object.get_component(SpriteRenderer)
        if not self.sprite_renderer:
            self.sprite_renderer = self.game_object.add_component(SpriteRenderer)
    
    def add_animation(self, name: str, animation_clip: 'AnimationClip') -> None:
        """æ·»åŠ åŠ¨ç”»"""
        self.animations[name] = animation_clip
    
    def play(self, animation_name: str) -> None:
        """æ’­æ”¾åŠ¨ç”»"""
        if animation_name in self.animations:
            self.current_animation = self.animations[animation_name]
            self.current_frame = 0
            self.frame_time = 0.0
    
    def update(self, delta_time: float) -> None:
        """æ›´æ–°åŠ¨ç”»"""
        if self.current_animation and self.sprite_renderer:
            self.frame_time += delta_time
            
            if self.frame_time >= self.current_animation.frame_duration:
                self.frame_time = 0.0
                self.current_frame = (self.current_frame + 1) % len(self.current_animation.frames)
                
                # æ›´æ–°ç²¾çµ
                self.sprite_renderer.sprite = self.current_animation.frames[self.current_frame]

class AnimationClip:
    """åŠ¨ç”»ç‰‡æ®µ"""
    
    def __init__(self, frames: List[str], frame_duration: float = 0.1):
        self.frames = frames
        self.frame_duration = frame_duration

class ParticleSystem(Component):
    """ç²’å­ç³»ç»Ÿ"""
    
    def __init__(self, game_object: GameObject):
        super().__init__(game_object)
        self.particles: List['Particle'] = []
        self.max_particles = 100
        self.emission_rate = 10.0
        self.particle_lifetime = 2.0
        self.emission_time = 0.0
    
    def update(self, delta_time: float) -> None:
        """æ›´æ–°ç²’å­ç³»ç»Ÿ"""
        # å‘å°„æ–°ç²’å­
        self.emission_time += delta_time
        particles_to_emit = int(self.emission_rate * self.emission_time)
        
        for _ in range(particles_to_emit):
            if len(self.particles) < self.max_particles:
                self._emit_particle()
        
        self.emission_time -= particles_to_emit / self.emission_rate
        
        # æ›´æ–°ç°æœ‰ç²’å­
        for particle in self.particles[:]:
            particle.update(delta_time)
            if particle.lifetime <= 0:
                self.particles.remove(particle)
    
    def _emit_particle(self) -> None:
        """å‘å°„ç²’å­"""
        particle = Particle(
            position=self.game_object.transform.position,
            velocity=Vector2(
                np.random.uniform(-1, 1),
                np.random.uniform(-1, 1)
            ),
            lifetime=self.particle_lifetime
        )
        self.particles.append(particle)

class Particle:
    """ç²’å­"""
    
    def __init__(self, position: Vector2, velocity: Vector2, lifetime: float):
        self.position = position
        self.velocity = velocity
        self.lifetime = lifetime
        self.max_lifetime = lifetime
    
    def update(self, delta_time: float) -> None:
        """æ›´æ–°ç²’å­"""
        self.position = self.position + self.velocity * delta_time
        self.lifetime -= delta_time
        
        # åº”ç”¨é‡åŠ›
        self.velocity = self.velocity + Vector2(0, -9.81) * delta_time
```

## 4. æ€§èƒ½åˆ†æ

### 4.1 æ—¶é—´å¤æ‚åº¦åˆ†æ

**å®šç† 4.1** (æ¸¸æˆå¾ªç¯æ—¶é—´å¤æ‚åº¦)
æ¸¸æˆä¸»å¾ªç¯çš„æ—¶é—´å¤æ‚åº¦ä¸º $O(n + m + p)$ï¼Œå…¶ä¸­ $n$ æ˜¯æ¸¸æˆå¯¹è±¡æ•°é‡ï¼Œ$m$ æ˜¯AIå®ä½“æ•°é‡ï¼Œ$p$ æ˜¯æŠ•å°„ç‰©æ•°é‡ã€‚

**è¯æ˜**:
æ¸¸æˆå¾ªç¯åŒ…å«ä»¥ä¸‹æ“ä½œï¼š

1. æ›´æ–°æ‰€æœ‰æ¸¸æˆå¯¹è±¡ï¼š$O(n)$
2. æ›´æ–°AIç³»ç»Ÿï¼š$O(m)$
3. å¤„ç†ç¢°æ’æ£€æµ‹ï¼š$O(p \times n)$
4. æ¸²æŸ“ï¼š$O(n)$

æ€»æ—¶é—´å¤æ‚åº¦ä¸º $O(n + m + p \times n)$ï¼Œåœ¨ä¸€èˆ¬æƒ…å†µä¸‹ $p \ll n$ï¼Œå› æ­¤ä¸º $O(n + m + p)$ã€‚

**å®šç† 4.2** (ç¢°æ’æ£€æµ‹æ—¶é—´å¤æ‚åº¦)
ä½¿ç”¨ç©ºé—´åˆ†å‰²çš„ç¢°æ’æ£€æµ‹ç®—æ³•æ—¶é—´å¤æ‚åº¦ä¸º $O(n \log n)$ã€‚

**è¯æ˜**:
ç©ºé—´åˆ†å‰²å°†æ¸¸æˆä¸–ç•Œåˆ’åˆ†ä¸ºç½‘æ ¼ï¼Œæ¯ä¸ªå¯¹è±¡åªéœ€è¦æ£€æŸ¥ç›¸é‚»ç½‘æ ¼ä¸­çš„å¯¹è±¡ã€‚
å¹³å‡æ¯ä¸ªç½‘æ ¼åŒ…å« $O(1)$ ä¸ªå¯¹è±¡ï¼Œå› æ­¤æ€»æ—¶é—´å¤æ‚åº¦ä¸º $O(n \log n)$ã€‚

### 4.2 ç©ºé—´å¤æ‚åº¦åˆ†æ

**å®šç† 4.3** (æ¸¸æˆçŠ¶æ€ç©ºé—´å¤æ‚åº¦)
æ¸¸æˆçŠ¶æ€çš„ç©ºé—´å¤æ‚åº¦ä¸º $O(n)$ï¼Œå…¶ä¸­ $n$ æ˜¯æ¸¸æˆå¯¹è±¡æ€»æ•°ã€‚

**è¯æ˜**:
æ¯ä¸ªæ¸¸æˆå¯¹è±¡å ç”¨å›ºå®šå¤§å°çš„å†…å­˜ï¼ˆä½ç½®ã€é€Ÿåº¦ã€çŠ¶æ€ç­‰ï¼‰ã€‚
æ€»å†…å­˜ä½¿ç”¨é‡ä¸å¯¹è±¡æ•°é‡æˆæ­£æ¯”ï¼Œå› æ­¤ç©ºé—´å¤æ‚åº¦ä¸º $O(n)$ã€‚

## 5. å®é™…åº”ç”¨ç¤ºä¾‹

### 5.1 ç®€å•æ¸¸æˆæ¼”ç¤º

```python
def demo_game():
    """æ¼”ç¤ºæ¸¸æˆç³»ç»Ÿ"""
    # åˆ›å»ºæ¸¸æˆç®¡ç†å™¨
    game_manager = GameManager()
    
    # å¼€å§‹æ¸¸æˆ
    print("å¯åŠ¨æ¸¸æˆ...")
    game_manager.start_game()

def demo_physics():
    """æ¼”ç¤ºç‰©ç†ç³»ç»Ÿ"""
    # åˆ›å»ºç‰©ç†å¼•æ“
    physics = PhysicsEngine()
    
    # åˆ›å»ºæ¸¸æˆçŠ¶æ€
    game_state = GameState()
    
    # åˆ›å»ºç©å®¶
    player = Player(
        id="player_1",
        position=Vector2D(400, 300),
        velocity=Vector2D(0, 0)
    )
    game_state.players.append(player)
    
    # æ¨¡æ‹Ÿç‰©ç†æ›´æ–°
    delta_time = 1.0 / 60.0
    for i in range(60):  # æ¨¡æ‹Ÿ1ç§’
        physics.update(game_state, delta_time)
        print(f"æ—¶é—´: {i * delta_time:.2f}s, ä½ç½®: ({player.position.x:.1f}, {player.position.y:.1f})")

def demo_ai():
    """æ¼”ç¤ºAIç³»ç»Ÿ"""
    # åˆ›å»ºAIç³»ç»Ÿ
    ai_system = AISystem()
    
    # åˆ›å»ºè¡Œä¸ºæ ‘
    behavior_tree = create_enemy_ai()
    
    # åˆ›å»ºæ¸¸æˆçŠ¶æ€
    game_state = GameState()
    
    # åˆ›å»ºç©å®¶å’Œæ•Œäºº
    player = Player(id="player_1", position=Vector2D(400, 300))
    enemy = Enemy(id="enemy_1", position=Vector2D(200, 300))
    
    game_state.players.append(player)
    game_state.enemies.append(enemy)
    
    # æ³¨å†ŒAI
    ai_system.behavior_trees[enemy.id] = behavior_tree
    
    # æ¨¡æ‹ŸAIæ›´æ–°
    delta_time = 1.0 / 60.0
    for i in range(60):
        ai_system.update(game_state, delta_time)
        print(f"æ•Œäººä½ç½®: ({enemy.position.x:.1f}, {enemy.position.y:.1f})")

if __name__ == "__main__":
    print("=== æ¸¸æˆå¼€å‘åŸºç¡€æ¼”ç¤º ===")
    
    # æ³¨æ„ï¼šå®é™…è¿è¡Œéœ€è¦Pygameç¯å¢ƒ
    # demo_game()
    
    print("\n=== ç‰©ç†ç³»ç»Ÿæ¼”ç¤º ===")
    demo_physics()
    
    print("\n=== AIç³»ç»Ÿæ¼”ç¤º ===")
    demo_ai()
```

## 6. æµ‹è¯•éªŒè¯

### 6.1 å•å…ƒæµ‹è¯•

```python
import unittest

class TestGameEngine(unittest.TestCase):
    """æ¸¸æˆå¼•æ“æµ‹è¯•ç±»"""
    
    def setUp(self):
        """æµ‹è¯•å‰å‡†å¤‡"""
        self.engine = GameEngine()
        self.player = Player("test_player", Vector2D(100, 100))
        self.enemy = Enemy("test_enemy", Vector2D(200, 100))
    
    def test_vector_operations(self):
        """æµ‹è¯•å‘é‡è¿ç®—"""
        v1 = Vector2D(1, 2)
        v2 = Vector2D(3, 4)
        
        # æµ‹è¯•åŠ æ³•
        result = v1 + v2
        self.assertEqual(result.x, 4)
        self.assertEqual(result.y, 6)
        
        # æµ‹è¯•å‡æ³•
        result = v1 - v2
        self.assertEqual(result.x, -2)
        self.assertEqual(result.y, -2)
        
        # æµ‹è¯•æ ‡é‡ä¹˜æ³•
        result = v1 * 2
        self.assertEqual(result.x, 2)
        self.assertEqual(result.y, 4)
    
    def test_game_object_update(self):
        """æµ‹è¯•æ¸¸æˆå¯¹è±¡æ›´æ–°"""
        initial_pos = Vector2D(100, 100)
        velocity = Vector2D(10, 0)
        
        obj = GameObject("test", initial_pos, velocity)
        obj.update(1.0)
        
        self.assertEqual(obj.position.x, 110)
        self.assertEqual(obj.position.y, 100)
    
    def test_player_movement(self):
        """æµ‹è¯•ç©å®¶ç§»åŠ¨"""
        direction = Vector2D(1, 0)
        self.player.move(direction, 1.0)
        
        # æ£€æŸ¥æ˜¯å¦æ–½åŠ äº†åŠ›
        self.assertNotEqual(self.player.acceleration.x, 0)
    
    def test_collision_detection(self):
        """æµ‹è¯•ç¢°æ’æ£€æµ‹"""
        obj1 = GameObject("obj1", Vector2D(100, 100))
        obj2 = GameObject("obj2", Vector2D(120, 100))
        
        # åº”è¯¥æ£€æµ‹åˆ°ç¢°æ’
        self.assertTrue(self.engine.check_collision(obj1, obj2))
        
        obj3 = GameObject("obj3", Vector2D(200, 200))
        # ä¸åº”è¯¥æ£€æµ‹åˆ°ç¢°æ’
        self.assertFalse(self.engine.check_collision(obj1, obj3))

class TestPhysicsEngine(unittest.TestCase):
    """ç‰©ç†å¼•æ“æµ‹è¯•ç±»"""
    
    def setUp(self):
        """æµ‹è¯•å‰å‡†å¤‡"""
        self.physics = PhysicsEngine()
        self.game_state = GameState()
    
    def test_gravity(self):
        """æµ‹è¯•é‡åŠ›"""
        player = Player("test", Vector2D(100, 100))
        self.game_state.players.append(player)
        
        self.physics.update(self.game_state, 1.0)
        
        # æ£€æŸ¥æ˜¯å¦åº”ç”¨äº†é‡åŠ›
        self.assertNotEqual(player.velocity.y, 0)
    
    def test_ground_collision(self):
        """æµ‹è¯•åœ°é¢ç¢°æ’"""
        player = Player("test", Vector2D(100, 600))
        self.game_state.players.append(player)
        
        self.physics.update(self.game_state, 1.0)
        
        # æ£€æŸ¥æ˜¯å¦åœ¨åœ°é¢ä¸Š
        self.assertEqual(player.position.y, self.physics.ground_y)
        self.assertEqual(player.velocity.y, 0)

if __name__ == "__main__":
    unittest.main()
```

## 7. æ€»ç»“

æœ¬æ–‡æ¡£ä»å½¢å¼åŒ–å®šä¹‰ã€ç†è®ºåŸºç¡€åˆ°Pythonå®ç°ï¼Œå…¨é¢é˜è¿°äº†æ¸¸æˆå¼€å‘çš„æ ¸å¿ƒæ¦‚å¿µã€‚ä¸»è¦å†…å®¹åŒ…æ‹¬ï¼š

### 7.1 ç†è®ºè´¡çŒ®

1. **å½¢å¼åŒ–å®šä¹‰**: æä¾›äº†æ¸¸æˆç³»ç»Ÿã€çŠ¶æ€ã€åŠ¨ä½œçš„ä¸¥æ ¼æ•°å­¦å®šä¹‰
2. **AIç†è®º**: è¯æ˜äº†æå°åŒ–æå¤§ç®—æ³•å’ŒAlpha-Betaå‰ªæçš„æ­£ç¡®æ€§
3. **ç‰©ç†ç†è®º**: åˆ†æäº†Verletç§¯åˆ†æ–¹æ³•çš„ç¨³å®šæ€§

### 7.2 å®ç°ç‰¹è‰²

1. **å®Œæ•´å¼•æ“**: æä¾›äº†å®Œæ•´çš„æ¸¸æˆå¼•æ“å®ç°ï¼ŒåŒ…æ‹¬æ¸²æŸ“ã€è¾“å…¥ã€ç‰©ç†ã€AI
2. **æ¨¡å—åŒ–è®¾è®¡**: é‡‡ç”¨ç»„ä»¶åŒ–è®¾è®¡ï¼Œæ”¯æŒæ‰©å±•å’Œå¤ç”¨
3. **å®æ—¶æ€§èƒ½**: ä¼˜åŒ–äº†æ¸¸æˆå¾ªç¯å’Œç¢°æ’æ£€æµ‹ç®—æ³•

### 7.3 åº”ç”¨ä»·å€¼

1. **æ•™è‚²ä»·å€¼**: ä¸ºå­¦ä¹ æ¸¸æˆå¼€å‘æä¾›å®Œæ•´çš„ç†è®ºæ¡†æ¶
2. **å®è·µä»·å€¼**: æä¾›äº†å¯ç›´æ¥è¿è¡Œçš„æ¸¸æˆå¼•æ“å®ç°
3. **ç ”ç©¶ä»·å€¼**: ä¸ºæ¸¸æˆAIå’Œç‰©ç†æ¨¡æ‹Ÿç ”ç©¶æä¾›ç†è®ºåŸºç¡€

### 7.4 æŠ€æœ¯ç‰¹è‰²

1. **å¤šè¡¨å¾æ–¹æ³•**: æ¦‚å¿µè§£é‡Šã€æ•°å­¦å½¢å¼ã€ä»£ç å®ç°ã€å›¾è¡¨è¯´æ˜
2. **ä¸¥æ ¼è¯æ˜**: æ¯ä¸ªé‡è¦ç»“è®ºéƒ½æœ‰å½¢å¼åŒ–è¯æ˜
3. **æ€§èƒ½åˆ†æ**: è¯¦ç»†çš„æ—¶é—´å’Œç©ºé—´å¤æ‚åº¦åˆ†æ
4. **æµ‹è¯•éªŒè¯**: å®Œæ•´çš„å•å…ƒæµ‹è¯•å’ŒéªŒè¯

---

*æœ¬æ–‡æ¡£æ˜¯è½¯ä»¶å·¥ç¨‹ä¸è®¡ç®—ç§‘å­¦çŸ¥è¯†ä½“ç³»é‡æ„é¡¹ç›®çš„ä¸€éƒ¨åˆ†ï¼Œéµå¾ªä¸¥æ ¼çš„å­¦æœ¯è§„èŒƒå’Œå·¥ç¨‹æ ‡å‡†ã€‚*
