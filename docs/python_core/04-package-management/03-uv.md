# Python uv 极速包管理器

**uv完全使用指南 - Rust驱动的pip替代品**

---

## 📋 目录

- [uv简介](#uv简介)
- [基础用法](#基础用法)
- [项目管理](#项目管理)
- [性能优势](#性能优势)
- [最佳实践](#最佳实践)

---

## uv简介

### 什么是uv

```bash
# uv: Rust编写的极速Python包管理器
# by Astral (ruff的作者)

# 特点:
# 1. 极快: 比pip快10-100倍
# 2. pip兼容: 直接替代pip
# 3. 内存优化: 显著降低内存使用
# 4. 可靠: Rust编写,类型安全
# 5. 现代化: 支持最新PEP

# 安装uv
curl -LsSf https://astral.sh/uv/install.sh | sh

# 或使用pip
pip install uv

# 或使用pipx (推荐)
pipx install uv

# 检查版本
uv --version
# uv 0.4.0
```

### 为什么选择uv

```bash
# 性能对比 (安装requests):
# pip:     ~2.5s
# poetry:  ~3.0s
# uv:      ~0.3s  # 快8-10倍!

# 内存使用:
# pip:     ~50MB
# uv:      ~10MB  # 减少80%

# 依赖解析:
# pip:     顺序解析,可能失败
# uv:      并行解析,更可靠

# uv vs pip:
# ✅ 完全兼容pip命令
# ✅ 10-100倍速度提升
# ✅ 更好的依赖解析
# ✅ 更少的内存使用
# ✅ 支持最新Python特性
```

---

## 基础用法

### pip命令替换

```bash
# uv完全兼容pip命令
# 只需将 pip 替换为 uv pip

# 安装包
uv pip install requests

# 卸载包
uv pip uninstall requests

# 列出包
uv pip list

# 查看包信息
uv pip show requests

# 冻结依赖
uv pip freeze

# 从requirements.txt安装
uv pip install -r requirements.txt

# 升级包
uv pip install --upgrade requests

# 所有pip命令都支持!
```

### 安装包

```bash
# 1. 安装最新版本
uv pip install requests

# 2. 安装特定版本
uv pip install requests==2.31.0

# 3. 安装版本范围
uv pip install "requests>=2.28.0,<3.0.0"

# 4. 安装多个包
uv pip install requests flask numpy pandas

# 5. 从requirements.txt安装
uv pip install -r requirements.txt

# 6. 从GitHub安装
uv pip install git+https://github.com/user/repo.git

# 7. 安装editable模式
uv pip install -e /path/to/package

# 8. 安装extras
uv pip install "fastapi[all]"

# 9. 指定Python版本
uv pip install --python 3.12 requests

# 10. 使用虚拟环境
uv pip install --python .venv/bin/python requests
```

### 依赖编译

```bash
# uv pip compile - 类似 pip-tools
# 但快100倍!

# 1. 编译requirements.in
uv pip compile requirements.in -o requirements.txt

# 2. 升级特定包
uv pip compile requirements.in --upgrade-package requests

# 3. 升级所有包
uv pip compile requirements.in --upgrade

# 4. 生成哈希
uv pip compile requirements.in --generate-hashes

# 5. 指定Python版本
uv pip compile requirements.in --python-version 3.12

# 6. 包含额外依赖
uv pip compile requirements.in --extra dev
```

---

## 项目管理

### uv venv - 虚拟环境

```bash
# 创建虚拟环境
uv venv

# 指定Python版本
uv venv --python 3.12
uv venv --python python3.11

# 指定位置
uv venv .venv

# 使用系统site-packages
uv venv --system-site-packages

# 不安装pip
uv venv --no-pip

# 激活虚拟环境
# Linux/macOS
source .venv/bin/activate

# Windows
.venv\Scripts\activate

# 在虚拟环境中运行
uv run python script.py
```

### uv pip sync

```bash
# uv pip sync - 同步环境
# 确保环境与requirements.txt完全一致

# 1. 同步环境
uv pip sync requirements.txt

# 2. 会:
#    - 安装缺失的包
#    - 升级/降级版本不匹配的包
#    - 卸载额外的包

# 3. 适用场景:
#    - CI/CD环境
#    - 团队协作确保一致性
#    - 清理环境

# 示例工作流:
uv pip compile requirements.in -o requirements.txt
uv pip sync requirements.txt
```

### 项目初始化

```bash
# 典型项目结构
my-project/
  ├── pyproject.toml
  ├── requirements.in
  ├── requirements.txt
  ├── requirements-dev.in
  ├── requirements-dev.txt
  ├── .venv/
  └── src/

# 1. 创建虚拟环境
uv venv

# 2. 激活环境
source .venv/bin/activate

# 3. 编译依赖
uv pip compile requirements.in -o requirements.txt
uv pip compile requirements-dev.in -o requirements-dev.txt

# 4. 同步安装
uv pip sync requirements-dev.txt

# 5. 安装项目
uv pip install -e .
```

---

## 性能优势

### 速度对比

```bash
# 实际测试 (安装100个包)

# pip
time pip install -r requirements.txt
# real    2m30.456s

# poetry
time poetry install
# real    3m15.234s

# uv
time uv pip install -r requirements.txt
# real    0m12.123s  # 快12倍!

# uv pip compile (vs pip-compile)
# pip-compile: ~45s
# uv pip compile: ~0.5s  # 快90倍!
```

### 并行下载

```bash
# uv自动并行下载和安装
# pip: 顺序处理
# uv: 并行处理,充分利用多核

# 依赖解析优化
# pip: 回溯算法,可能很慢
# uv: 先进的SAT求解器,极快

# 缓存策略
# uv使用更高效的缓存机制
# 减少重复下载和编译
```

### 内存优化

```python
"""
uv内存优化策略
"""

# 1. 流式处理
# pip: 加载整个包到内存
# uv: 流式处理,内存占用低

# 2. 增量解析
# uv只解析需要的元数据

# 3. Rust零成本抽象
# 编译型语言,没有Python解释器开销

# 实际对比 (安装大型项目):
# pip peak memory: ~800MB
# uv peak memory: ~100MB
```

---

## 最佳实践

### 开发工作流

```bash
# 1. 项目初始化
uv venv
source .venv/bin/activate

# 2. 编写requirements.in
cat > requirements.in << EOF
fastapi
pydantic
uvicorn
EOF

# 3. 编译生成requirements.txt
uv pip compile requirements.in -o requirements.txt

# 4. 同步安装
uv pip sync requirements.txt

# 5. 添加新依赖
echo "requests" >> requirements.in
uv pip compile requirements.in -o requirements.txt
uv pip sync requirements.txt

# 6. 升级依赖
uv pip compile requirements.in --upgrade -o requirements.txt
uv pip sync requirements.txt
```

### CI/CD集成

```yaml
# GitHub Actions
name: Python CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install uv
      run: curl -LsSf https://astral.sh/uv/install.sh | sh
    
    - name: Set up Python
      run: uv venv --python 3.12
    
    - name: Install dependencies
      run: |
        source .venv/bin/activate
        uv pip sync requirements.txt
    
    - name: Run tests
      run: |
        source .venv/bin/activate
        pytest

# 或使用官方action
    - uses: astral-sh/setup-uv@v1
      with:
        version: "0.4.0"
```

### Docker集成

```dockerfile
# Dockerfile
FROM python:3.12-slim

# 安装uv
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.cargo/bin:$PATH"

WORKDIR /app

# 复制依赖文件
COPY requirements.txt .

# 创建虚拟环境并安装依赖
RUN uv venv && \
    uv pip sync requirements.txt

# 激活虚拟环境
ENV VIRTUAL_ENV=/app/.venv
ENV PATH="/app/.venv/bin:$PATH"

# 复制项目文件
COPY . .

CMD ["python", "-m", "uvicorn", "main:app", "--host", "0.0.0.0"]
```

### Makefile集成

```makefile
# Makefile
.PHONY: install update sync test clean

install:
	uv venv
	uv pip compile requirements.in -o requirements.txt
	uv pip compile requirements-dev.in -o requirements-dev.txt
	uv pip sync requirements-dev.txt

update:
	uv pip compile requirements.in --upgrade -o requirements.txt
	uv pip compile requirements-dev.in --upgrade -o requirements-dev.txt
	uv pip sync requirements-dev.txt

sync:
	uv pip sync requirements-dev.txt

test:
	pytest

clean:
	rm -rf .venv
	rm -rf .pytest_cache
	find . -type d -name __pycache__ -exec rm -rf {} +
```

---

## 📚 核心要点

### uv优势

- ✅ **极速**: 比pip快10-100倍
- ✅ **兼容**: 完全兼容pip命令
- ✅ **可靠**: Rust编写,更安全
- ✅ **内存**: 显著降低内存使用
- ✅ **现代**: 支持最新PEP标准

### 核心命令

- ✅ **uv pip install**: 安装包
- ✅ **uv pip compile**: 编译依赖
- ✅ **uv pip sync**: 同步环境
- ✅ **uv venv**: 创建虚拟环境
- ✅ **uv run**: 运行命令

### 性能

- ✅ **并行处理**: 充分利用多核
- ✅ **高效缓存**: 减少重复工作
- ✅ **内存优化**: 流式处理
- ✅ **快速解析**: SAT求解器

### 最佳实践

- ✅ 用uv pip compile替代pip-compile
- ✅ 用uv pip sync确保环境一致
- ✅ CI/CD中使用uv加速构建
- ✅ Docker镜像中使用uv
- ✅ 团队统一使用uv

### 迁移

- ✅ 从pip迁移: 直接替换命令
- ✅ 从poetry迁移: 使用requirements.in
- ✅ 完全兼容: 无需修改代码
- ✅ 渐进式: 可以逐步迁移

---

**掌握uv，享受极速Python包管理！** ⚡🚀

**相关文档**:
- [01-pip-basics.md](01-pip-basics.md) - pip基础
- [02-poetry.md](02-poetry.md) - Poetry包管理

**最后更新**: 2025年10月28日

