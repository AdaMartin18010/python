# Python PEP 8 代码风格指南

**PEP 8完全解读**

---

## 📋 目录

- [PEP 8简介](#PEP-8简介)
- [代码布局](#代码布局)
- [命名约定](#命名约定)
- [表达式和语句](#表达式和语句)
- [自动化工具](#自动化工具)

---

## PEP 8简介

### 什么是PEP 8

```python
"""
PEP 8: Style Guide for Python Code
Python代码风格指南
"""

# PEP 8是什么:
# - Python官方代码风格指南
# - 提高代码可读性
# - 促进代码一致性
# - 社区广泛采用

# 核心原则:
# "代码被阅读的次数远多于被编写的次数"
# "一致性很重要"
# "但实用性胜过纯粹性"

# 工具支持:
# - black: 自动格式化
# - ruff: 快速linter
# - flake8: 风格检查
# - pylint: 静态分析
```

---

## 代码布局

### 缩进

```python
"""
缩进规则
"""

# ✅ 使用4个空格缩进
def function():
    x = 1
    if x > 0:
        print(x)

# ❌ 不要使用Tab
def function():
	x = 1  # 使用Tab (错误)

# ✅ 续行对齐
# 方法1: 与开括号对齐
foo = long_function_name(var_one, var_two,
                         var_three, var_four)

# 方法2: 悬挂缩进
foo = long_function_name(
    var_one, var_two,
    var_three, var_four)

# ✅ if语句续行
if (this_is_one_thing and
        that_is_another_thing):
    do_something()

# ✅ 列表/字典/集合
my_list = [
    1, 2, 3,
    4, 5, 6,
]

my_dict = {
    'key1': 'value1',
    'key2': 'value2',
}
```

### 行长度

```python
"""
行长度限制
"""

# PEP 8: 最大79字符
# 现代实践: 88字符 (black默认) 或 100字符

# ✅ 短行
def short_function(arg1, arg2):
    return arg1 + arg2

# ✅ 长行拆分
def long_function_name(
    argument_one,
    argument_two,
    argument_three,
    argument_four
):
    return argument_one + argument_two

# ✅ 长字符串
long_string = (
    "This is a very long string that would be too long "
    "to fit on a single line, so we split it into "
    "multiple lines."
)

# ✅ 长URL注释
# See:
# https://very-long-url-that-would-exceed-the-line-limit.example.com/path

# ✅ with语句
with open('/path/to/some/file/you/want/to/read') as file_1, \
     open('/path/to/some/file/you/want/to/write') as file_2:
    file_2.write(file_1.read())
```

### 空行

```python
"""
空行规则
"""

# ✅ 顶级函数和类之间: 2个空行


def top_level_function_one():
    pass


def top_level_function_two():
    pass


class MyClass:
    pass


class AnotherClass:
    pass


# ✅ 类方法之间: 1个空行
class MyClass:
    def method_one(self):
        pass
    
    def method_two(self):
        pass


# ✅ 函数内逻辑分组: 1个空行
def function():
    # 步骤1
    x = 1
    y = 2
    
    # 步骤2
    result = x + y
    
    # 步骤3
    return result


# ❌ 不要过多空行
def bad():
    
    
    x = 1  # 开头多余空行
    
    
    return x
```

### 导入

```python
"""
导入规则
"""

# ✅ 标准库
import os
import sys

# ✅ 第三方库
import requests
import numpy as np

# ✅ 本地模块
from my_package import module1
from my_package import module2

# ✅ 每行一个导入
import os
import sys

# ❌ 不要多个导入在一行
import os, sys  # 错误

# ✅ from import可以在一行
from subprocess import Popen, PIPE

# ✅ 或者分行
from subprocess import (
    Popen,
    PIPE,
    STDOUT,
)

# ❌ 不要使用通配符导入
from module import *  # 错误

# ✅ 绝对导入
from my_package.sub_package import module

# ✅ 显式相对导入
from . import sibling
from ..parent import uncle
```

---

## 命名约定

### 命名风格

```python
"""
命名约定
"""

# ✅ 模块和包: lowercase_with_underscores
# my_module.py
# my_package/

# ✅ 类名: CapWords (PascalCase)
class MyClass:
    pass

class HTTPConnection:
    pass

# ✅ 函数和变量: lowercase_with_underscores
def my_function():
    pass

my_variable = 42

# ✅ 常量: UPPERCASE_WITH_UNDERSCORES
MAX_SIZE = 100
API_KEY = "secret"

# ✅ 方法和实例变量: lowercase_with_underscores
class MyClass:
    def public_method(self):
        self.public_attribute = 1
    
    def _private_method(self):
        self._private_attribute = 2

# ✅ 类的私有属性: __double_leading_underscore
class MyClass:
    def __init__(self):
        self.__private = 1  # 名称修饰

# ✅ 类型变量: CapWords
from typing import TypeVar

T = TypeVar('T')
KT = TypeVar('KT')  # Key Type
VT = TypeVar('VT')  # Value Type

# ❌ 避免单字母名称 (除了计数器和迭代器)
# 但可以用于数学代码
x = 5  # ✅ 数学变量
i = 0  # ✅ 循环计数器
d = {}  # ❌ 应该用 data 或 dictionary
```

### 特殊命名

```python
"""
特殊命名模式
"""

# ✅ 单前导下划线: _internal
# 表示内部使用,不会被from module import *导入
class MyClass:
    def _internal_method(self):
        """内部方法"""
        pass

# ✅ 双前导下划线: __private
# 触发名称修饰
class MyClass:
    def __init__(self):
        self.__private = 1  # 变成 _MyClass__private

# ✅ 双前后下划线: __special__
# Python魔术方法
class MyClass:
    def __init__(self):
        pass
    
    def __str__(self):
        return "MyClass"

# ✅ 单后缀下划线: class_
# 避免与Python关键字冲突
def function(class_=None):  # 避免与 class 关键字冲突
    pass

# ✅ dunder别名
# __all__: 定义from module import *导出内容
__all__ = ['public_function', 'PublicClass']

# __version__: 版本号
__version__ = '1.0.0'
```

---

## 表达式和语句

### 空格使用

```python
"""
空格规则
"""

# ✅ 运算符周围
x = 1 + 2
y = x * 2

# ✅ 赋值运算符
x = 1

# ✅ 参数默认值 (无空格)
def function(arg1, arg2=None):
    pass

# ✅ 类型注解 (有空格)
def function(arg1: int, arg2: str = None) -> int:
    pass

# ❌ 括号内侧无空格
spam(ham[1], {eggs: 2})  # ✅
spam( ham[ 1 ], { eggs: 2 } )  # ❌

# ✅ 逗号、分号、冒号后面有空格
x, y = 1, 2
if x == 4: print(x, y)
d = {'key': 'value'}

# ❌ 不要多余空格
x = 1  # ✅
x=1    # ❌
x =1   # ❌

# ✅ 切片
ham[1:9], ham[1:9:3], ham[:9:3], ham[1::3], ham[1:9:]
ham[lower:upper], ham[lower:upper:], ham[lower::step]

# ❌ 切片不要空格
ham[lower + offset : upper + offset]  # 错误
ham[lower + offset:upper + offset]    # ✅
```

### 注释

```python
"""
注释规则
"""

# ✅ 块注释: 与代码同级缩进
# 这是一个块注释
# 说明下面的代码段
def function():
    pass

# ✅ 行内注释: 至少2个空格分隔
x = x + 1  # 补偿边界

# ❌ 不要无意义的行内注释
x = x + 1  # x加1  # 没有额外信息

# ✅ 文档字符串
def function(arg1, arg2):
    """函数描述
    
    Args:
        arg1: 第一个参数
        arg2: 第二个参数
    
    Returns:
        返回值描述
    """
    pass

# ✅ TODO注释
# TODO(username): 具体要做的事情
# FIXME: 需要修复的问题
# XXX: 警告或需要注意的地方
```

### 比较

```python
"""
比较和条件
"""

# ✅ None比较: 使用is/is not
if x is None:
    pass

# ❌ 不要用==
if x == None:  # 错误
    pass

# ✅ 布尔值比较: 直接使用
if flag:
    pass

# ❌ 不要显式比较True/False
if flag == True:  # 错误
    pass

# ✅ 空序列: 直接判断
if not seq:
    pass

# ❌ 不要用len()
if len(seq) == 0:  # 啰嗦
    pass

# ✅ 字符串后缀/前缀
if filename.endswith('.py'):
    pass

# ❌ 不要用切片
if filename[-3:] == '.py':  # 不推荐
    pass

# ✅ isinstance检查类型
if isinstance(obj, int):
    pass

# ❌ 不要用type()
if type(obj) is int:  # 不推荐
    pass
```

---

## 自动化工具

### Black格式化

```bash
# 安装black
uv add --dev black

# 格式化文件
black script.py

# 格式化目录
black src/

# 检查不实际修改
black --check src/

# 查看diff
black --diff src/

# 配置pyproject.toml
cat >> pyproject.toml << EOF
[tool.black]
line-length = 88
target-version = ['py312']
include = '\.pyi?$'
extend-exclude = '''
/(
    \.git
  | \.mypy_cache
  | \.venv
  | build
  | dist
)/
'''
EOF
```

### Ruff检查

```bash
# 安装ruff
uv add --dev ruff

# 检查代码
ruff check src/

# 自动修复
ruff check --fix src/

# 格式化 (ruff v0.1.0+)
ruff format src/

# 配置pyproject.toml
cat >> pyproject.toml << EOF
[tool.ruff]
line-length = 88
target-version = "py312"

[tool.ruff.lint]
select = [
    "E",   # pycodestyle errors
    "W",   # pycodestyle warnings
    "F",   # pyflakes
    "I",   # isort
    "N",   # pep8-naming
    "UP",  # pyupgrade
]
ignore = [
    "E501",  # line too long (black处理)
]

[tool.ruff.lint.per-file-ignores]
"__init__.py" = ["F401"]  # 忽略未使用导入
EOF
```

### pre-commit集成

```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/psf/black
    rev: 23.10.0
    hooks:
      - id: black
        language_version: python3.12
  
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.0
    hooks:
      - id: ruff
        args: [--fix, --exit-non-zero-on-fix]
  
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.6.0
    hooks:
      - id: mypy
        additional_dependencies: [types-requests]
```

```bash
# 安装pre-commit
uv add --dev pre-commit

# 安装hooks
pre-commit install

# 手动运行
pre-commit run --all-files
```

---

## 📚 核心要点

### 代码布局

- ✅ **缩进**: 4个空格
- ✅ **行长度**: 79-100字符
- ✅ **空行**: 顶级2行, 方法1行
- ✅ **导入**: 分组, 每行一个

### 命名约定

- ✅ **模块**: lowercase_with_underscores
- ✅ **类**: CapWords
- ✅ **函数/变量**: lowercase_with_underscores
- ✅ **常量**: UPPERCASE
- ✅ **私有**: _leading_underscore

### 表达式

- ✅ **空格**: 运算符周围有
- ✅ **注释**: 清晰有意义
- ✅ **比较**: is None, not seq
- ✅ **类型检查**: isinstance

### 自动化

- ✅ **black**: 自动格式化
- ✅ **ruff**: 快速linter
- ✅ **pre-commit**: Git hooks
- ✅ **CI/CD**: 自动检查

### 原则

- ✅ 可读性第一
- ✅ 一致性重要
- ✅ 实用性优先
- ✅ 团队规范

---

**遵循PEP 8，写出优雅Python代码！** ✨📝

**相关文档**:
- [02-naming.md](02-naming.md) - 命名约定详解
- [03-documentation.md](03-documentation.md) - 文档字符串

**最后更新**: 2025年10月28日
