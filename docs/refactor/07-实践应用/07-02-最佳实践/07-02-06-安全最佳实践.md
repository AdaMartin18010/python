# å®‰å…¨æœ€ä½³å®è·µ

## ğŸ“‹ æ¦‚è¿°

å®‰å…¨æ˜¯è½¯ä»¶å·¥ç¨‹çš„æ ¸å¿ƒè¦ç´ ï¼Œæ¶‰åŠè®¤è¯æˆæƒã€æ•°æ®åŠ å¯†ã€æ¼æ´é˜²æŠ¤ç­‰æŠ€æœ¯ã€‚æœ¬æ–‡æ¡£æä¾›å®‰å…¨çš„å½¢å¼åŒ–å®šä¹‰ã€æŠ€æœ¯æ¶æ„å’Œæœ€ä½³å®è·µã€‚

## 1. å½¢å¼åŒ–å®šä¹‰

### 1.1 å®‰å…¨ç³»ç»Ÿå®šä¹‰

**å®šä¹‰ 1.1** (å®‰å…¨ç³»ç»Ÿ)
å®‰å…¨ç³»ç»Ÿæ˜¯ä¸€ä¸ªå…­å…ƒç»„ $\mathcal{S} = (A, E, I, V, M, R)$ï¼Œå…¶ä¸­ï¼š

- $A$ æ˜¯è®¤è¯æˆæƒï¼Œ$A = (I, P, T)$
- $E$ æ˜¯åŠ å¯†ç³»ç»Ÿï¼Œ$E = (K, A, M)$
- $I$ æ˜¯è¾“å…¥éªŒè¯ï¼Œ$I = (S, V, F)$
- $V$ æ˜¯æ¼æ´é˜²æŠ¤ï¼Œ$V = (S, P, D)$
- $M$ æ˜¯ç›‘æ§å®¡è®¡ï¼Œ$M = (L, A, T)$
- $R$ æ˜¯é£é™©è¯„ä¼°ï¼Œ$R = (T, I, M)$

**å®šä¹‰ 1.2** (å®‰å…¨å¨èƒ)
å®‰å…¨å¨èƒæ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ $\mathcal{T} = (V, I, I)$ï¼Œå…¶ä¸­ï¼š

- $V$ æ˜¯æ¼æ´ç±»å‹ï¼Œ$V \in \{SQLæ³¨å…¥, XSS, CSRF, æƒé™æå‡\}$
- $I$ æ˜¯å½±å“ç¨‹åº¦ï¼Œ$I \in \{ä½, ä¸­, é«˜, ä¸¥é‡\}$
- $I$ æ˜¯æ”»å‡»å‘é‡ï¼Œ$I = (M, P, T)$

## 2. æŠ€æœ¯å®ç°

### 2.1 è®¤è¯æˆæƒç³»ç»Ÿ

```python
import hashlib
import hmac
import secrets
import jwt
import bcrypt
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Any
from dataclasses import dataclass
from enum import Enum

class Permission(Enum):
    READ = "read"
    WRITE = "write"
    DELETE = "delete"
    ADMIN = "admin"

@dataclass
class User:
    id: str
    username: str
    email: str
    password_hash: str
    permissions: List[Permission]
    created_at: datetime
    last_login: Optional[datetime] = None

class AuthenticationManager:
    def __init__(self, secret_key: str):
        self.secret_key = secret_key
        self.users: Dict[str, User] = {}
        self.sessions: Dict[str, Dict] = {}
    
    def register_user(self, username: str, email: str, password: str, 
                     permissions: List[Permission] = None) -> str:
        """æ³¨å†Œç”¨æˆ·"""
        user_id = secrets.token_urlsafe(16)
        password_hash = self._hash_password(password)
        
        user = User(
            id=user_id,
            username=username,
            email=email,
            password_hash=password_hash,
            permissions=permissions or [Permission.READ],
            created_at=datetime.now()
        )
        
        self.users[user_id] = user
        return user_id
    
    def authenticate(self, username: str, password: str) -> Optional[str]:
        """ç”¨æˆ·è®¤è¯"""
        for user in self.users.values():
            if user.username == username and self._verify_password(password, user.password_hash):
                user.last_login = datetime.now()
                return user.id
        return None
    
    def create_session(self, user_id: str) -> str:
        """åˆ›å»ºä¼šè¯"""
        session_token = secrets.token_urlsafe(32)
        self.sessions[session_token] = {
            "user_id": user_id,
            "created_at": datetime.now(),
            "expires_at": datetime.now() + timedelta(hours=24)
        }
        return session_token
    
    def validate_session(self, session_token: str) -> Optional[str]:
        """éªŒè¯ä¼šè¯"""
        session = self.sessions.get(session_token)
        if session and session["expires_at"] > datetime.now():
            return session["user_id"]
        return None
    
    def _hash_password(self, password: str) -> str:
        """å¯†ç å“ˆå¸Œ"""
        return bcrypt.hashpw(password.encode(), bcrypt.gensalt()).decode()
    
    def _verify_password(self, password: str, password_hash: str) -> bool:
        """éªŒè¯å¯†ç """
        return bcrypt.checkpw(password.encode(), password_hash.encode())

class AuthorizationManager:
    def __init__(self):
        self.resource_permissions: Dict[str, Dict[str, List[Permission]]] = {}
    
    def add_permission(self, resource: str, user_id: str, permission: Permission):
        """æ·»åŠ æƒé™"""
        if resource not in self.resource_permissions:
            self.resource_permissions[resource] = {}
        if user_id not in self.resource_permissions[resource]:
            self.resource_permissions[resource][user_id] = []
        self.resource_permissions[resource][user_id].append(permission)
    
    def check_permission(self, resource: str, user_id: str, permission: Permission) -> bool:
        """æ£€æŸ¥æƒé™"""
        user_permissions = self.resource_permissions.get(resource, {}).get(user_id, [])
        return permission in user_permissions or Permission.ADMIN in user_permissions
```

### 2.2 åŠ å¯†ç³»ç»Ÿ

```python
from cryptography.fernet import Fernet
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC
import base64

class EncryptionManager:
    def __init__(self, master_key: str):
        self.master_key = master_key.encode()
        self.fernet = self._create_fernet()
    
    def _create_fernet(self) -> Fernet:
        """åˆ›å»ºFernetå®ä¾‹"""
        kdf = PBKDF2HMAC(
            algorithm=hashes.SHA256(),
            length=32,
            salt=b'static_salt',  # ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨éšæœºsalt
            iterations=100000,
        )
        key = base64.urlsafe_b64encode(kdf.derive(self.master_key))
        return Fernet(key)
    
    def encrypt(self, data: str) -> str:
        """åŠ å¯†æ•°æ®"""
        return self.fernet.encrypt(data.encode()).decode()
    
    def decrypt(self, encrypted_data: str) -> str:
        """è§£å¯†æ•°æ®"""
        return self.fernet.decrypt(encrypted_data.encode()).decode()

class InputValidator:
    def __init__(self):
        self.validation_rules = {
            "email": r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$',
            "phone": r'^\+?1?\d{9,15}$',
            "username": r'^[a-zA-Z0-9_]{3,20}$'
        }
    
    def validate_input(self, input_data: str, input_type: str) -> bool:
        """éªŒè¯è¾“å…¥"""
        import re
        pattern = self.validation_rules.get(input_type)
        if pattern:
            return bool(re.match(pattern, input_data))
        return True
    
    def sanitize_input(self, input_data: str) -> str:
        """æ¸…ç†è¾“å…¥"""
        import html
        return html.escape(input_data)
```

### 2.3 å®‰å…¨ç›‘æ§ç³»ç»Ÿ

```python
class SecurityMonitor:
    def __init__(self):
        self.security_events: List[Dict] = []
        self.threat_patterns: Dict[str, str] = {
            "sql_injection": r"(\b(union|select|insert|delete|update|drop|create)\b)",
            "xss": r"(<script|javascript:|on\w+\s*=)",
            "path_traversal": r"(\.\./|\.\.\\)",
            "command_injection": r"(\b(cat|ls|rm|chmod|wget|curl)\b)"
        }
    
    def log_security_event(self, event_type: str, details: str, severity: str = "medium"):
        """è®°å½•å®‰å…¨äº‹ä»¶"""
        event = {
            "timestamp": datetime.now(),
            "type": event_type,
            "details": details,
            "severity": severity
        }
        self.security_events.append(event)
    
    def detect_threats(self, input_data: str) -> List[str]:
        """æ£€æµ‹å¨èƒ"""
        detected_threats = []
        for threat_type, pattern in self.threat_patterns.items():
            if re.search(pattern, input_data, re.IGNORECASE):
                detected_threats.append(threat_type)
        return detected_threats
```

## 3. å®é™…åº”ç”¨ç¤ºä¾‹

### 3.1 å®‰å…¨Webåº”ç”¨

```python
from flask import Flask, request, jsonify, session
from functools import wraps

app = Flask(__name__)
app.secret_key = secrets.token_urlsafe(32)

auth_manager = AuthenticationManager("your-secret-key")
authz_manager = AuthorizationManager()
encryption_manager = EncryptionManager("your-master-key")
input_validator = InputValidator()
security_monitor = SecurityMonitor()

def require_auth(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        session_token = request.headers.get('Authorization')
        if not session_token:
            return jsonify({"error": "Unauthorized"}), 401
        
        user_id = auth_manager.validate_session(session_token)
        if not user_id:
            return jsonify({"error": "Invalid session"}), 401
        
        request.user_id = user_id
        return f(*args, **kwargs)
    return decorated_function

def require_permission(permission: Permission):
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if not authz_manager.check_permission("api", request.user_id, permission):
                return jsonify({"error": "Insufficient permissions"}), 403
            return f(*args, **kwargs)
        return decorated_function
    return decorator

@app.route('/register', methods=['POST'])
def register():
    data = request.get_json()
    
    # è¾“å…¥éªŒè¯
    if not input_validator.validate_input(data['username'], 'username'):
        return jsonify({"error": "Invalid username"}), 400
    
    if not input_validator.validate_input(data['email'], 'email'):
        return jsonify({"error": "Invalid email"}), 400
    
    # å¨èƒæ£€æµ‹
    threats = security_monitor.detect_threats(data['username'] + data['email'])
    if threats:
        security_monitor.log_security_event("threat_detected", f"Threats: {threats}", "high")
        return jsonify({"error": "Suspicious input detected"}), 400
    
    user_id = auth_manager.register_user(
        data['username'], 
        data['email'], 
        data['password']
    )
    
    return jsonify({"user_id": user_id}), 201

@app.route('/login', methods=['POST'])
def login():
    data = request.get_json()
    
    user_id = auth_manager.authenticate(data['username'], data['password'])
    if not user_id:
        security_monitor.log_security_event("failed_login", f"Username: {data['username']}", "medium")
        return jsonify({"error": "Invalid credentials"}), 401
    
    session_token = auth_manager.create_session(user_id)
    return jsonify({"session_token": session_token})

@app.route('/secure-data', methods=['GET'])
@require_auth
@require_permission(Permission.READ)
def get_secure_data():
    # åŠ å¯†æ•æ„Ÿæ•°æ®
    sensitive_data = "This is sensitive information"
    encrypted_data = encryption_manager.encrypt(sensitive_data)
    
    return jsonify({"encrypted_data": encrypted_data})

if __name__ == '__main__':
    app.run(debug=False)
```

## 4. æ€»ç»“

### 4.1 æŠ€æœ¯è¦ç‚¹

1. **è®¤è¯æˆæƒ**: ç”¨æˆ·èº«ä»½éªŒè¯å’Œæƒé™æ§åˆ¶
2. **æ•°æ®åŠ å¯†**: æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨å’Œä¼ è¾“
3. **è¾“å…¥éªŒè¯**: é˜²æ­¢æ¶æ„è¾“å…¥å’Œæ³¨å…¥æ”»å‡»
4. **å¨èƒæ£€æµ‹**: å®æ—¶å®‰å…¨å¨èƒç›‘æ§
5. **å®‰å…¨å®¡è®¡**: å®‰å…¨äº‹ä»¶è®°å½•å’Œåˆ†æ

### 4.2 æœ€ä½³å®è·µ

1. **æœ€å°æƒé™åŸåˆ™**: åªæˆäºˆå¿…è¦æƒé™
2. **æ·±åº¦é˜²å¾¡**: å¤šå±‚å®‰å…¨é˜²æŠ¤
3. **å®‰å…¨ç¼–ç **: å®‰å…¨çš„ç¼–ç¨‹å®è·µ
4. **å®šæœŸå®¡è®¡**: å®šæœŸå®‰å…¨æ£€æŸ¥å’Œè¯„ä¼°
5. **å®‰å…¨åŸ¹è®­**: å›¢é˜Ÿå®‰å…¨æ„è¯†åŸ¹è®­

### 4.3 æ‰©å±•æ–¹å‘

1. **é›¶ä¿¡ä»»æ¶æ„**: ä¸ä¿¡ä»»ä»»ä½•å®ä½“çš„å®‰å…¨æ¨¡å‹
2. **å®‰å…¨è‡ªåŠ¨åŒ–**: è‡ªåŠ¨åŒ–å®‰å…¨æ£€æµ‹å’Œå“åº”
3. **å¨èƒæƒ…æŠ¥**: å®æ—¶å¨èƒæƒ…æŠ¥å…±äº«
4. **å®‰å…¨åˆè§„**: æ»¡è¶³å„ç§å®‰å…¨æ ‡å‡†
5. **éšç§ä¿æŠ¤**: æ•°æ®éšç§å’ŒGDPRåˆè§„

---

**ç›¸å…³æ–‡æ¡£**:
- [APIè®¾è®¡æœ€ä½³å®è·µ](./07-02-01-APIè®¾è®¡æœ€ä½³å®è·µ.md)
- [ä»£ç è´¨é‡æœ€ä½³å®è·µ](./07-02-02-ä»£ç è´¨é‡æœ€ä½³å®è·µ.md)
- [æµ‹è¯•æœ€ä½³å®è·µ](./07-02-03-æµ‹è¯•æœ€ä½³å®è·µ.md) 