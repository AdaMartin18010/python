# ç”µå­å•†åŠ¡åŸºç¡€

## ğŸ“‹ æ¦‚è¿°

ç”µå­å•†åŠ¡ï¼ˆE-commerceï¼‰æ˜¯é€šè¿‡äº’è”ç½‘è¿›è¡Œå•†å“å’ŒæœåŠ¡äº¤æ˜“çš„æ´»åŠ¨ã€‚æœ¬æ–‡æ¡£ä»å½¢å¼åŒ–è§’åº¦åˆ†æç”µå­å•†åŠ¡ç³»ç»Ÿçš„æ ¸å¿ƒæ¦‚å¿µã€æ¶æ„è®¾è®¡å’Œå®ç°æ–¹æ³•ï¼ŒåŒ…æ‹¬åœ¨çº¿å•†åŸã€æ”¯ä»˜å¤„ç†ã€åº“å­˜ç®¡ç†ã€æ¨èå¼•æ“ç­‰å…³é”®ç»„ä»¶ã€‚

## 1. å½¢å¼åŒ–å®šä¹‰

### 1.1 ç”µå­å•†åŠ¡ç³»ç»Ÿæ¨¡å‹

#### å•†å“æ¨¡å‹ (Product Model)

å•†å“æ¨¡å‹å®šä¹‰äº†ç”µå­å•†åŠ¡ç³»ç»Ÿä¸­å•†å“çš„åŸºæœ¬å±æ€§å’Œå…³ç³»ã€‚

**å½¢å¼åŒ–å®šä¹‰**:
è®¾å•†å“é›†åˆä¸º $P$ï¼Œå±æ€§é›†åˆä¸º $A$ï¼Œç±»åˆ«é›†åˆä¸º $C$ï¼Œåˆ™å•†å“æ¨¡å‹å®šä¹‰ä¸ºï¼š

$$PM: P \rightarrow A \times C \times \mathbb{R}^+$$

å…¶ä¸­ï¼š

- $P = \{p_1, p_2, ..., p_n\}$ æ˜¯å•†å“é›†åˆ
- $A$ æ˜¯å±æ€§é›†åˆï¼ˆåç§°ã€æè¿°ã€å“ç‰Œç­‰ï¼‰
- $C$ æ˜¯ç±»åˆ«é›†åˆ
- $\mathbb{R}^+$ æ˜¯ä»·æ ¼é›†åˆ

#### ç”¨æˆ·æ¨¡å‹ (User Model)

ç”¨æˆ·æ¨¡å‹æè¿°äº†ç”µå­å•†åŠ¡ç³»ç»Ÿä¸­ç”¨æˆ·çš„è¡Œä¸ºå’Œåå¥½ã€‚

**å½¢å¼åŒ–å®šä¹‰**:
è®¾ç”¨æˆ·é›†åˆä¸º $U$ï¼Œè¡Œä¸ºé›†åˆä¸º $B$ï¼Œåå¥½é›†åˆä¸º $F$ï¼Œåˆ™ç”¨æˆ·æ¨¡å‹å®šä¹‰ä¸ºï¼š

$$UM: U \rightarrow B \times F \times \mathbb{R}^+$$

å…¶ä¸­ï¼š

- $U = \{u_1, u_2, ..., u_m\}$ æ˜¯ç”¨æˆ·é›†åˆ
- $B$ æ˜¯è¡Œä¸ºé›†åˆï¼ˆæµè§ˆã€è´­ä¹°ã€è¯„ä»·ç­‰ï¼‰
- $F$ æ˜¯åå¥½é›†åˆ
- $\mathbb{R}^+$ æ˜¯ä¿¡ç”¨è¯„åˆ†

#### äº¤æ˜“æ¨¡å‹ (Transaction Model)

äº¤æ˜“æ¨¡å‹å®šä¹‰äº†ç”µå­å•†åŠ¡ç³»ç»Ÿä¸­çš„äº¤æ˜“æµç¨‹å’ŒçŠ¶æ€ã€‚

**å½¢å¼åŒ–å®šä¹‰**:
äº¤æ˜“æ¨¡å‹æ˜¯ä¸€ä¸ªçŠ¶æ€æœº $TM = (S, E, \delta, s_0)$ï¼Œå…¶ä¸­ï¼š

- $S$ æ˜¯äº¤æ˜“çŠ¶æ€é›†åˆï¼ˆå¾…æ”¯ä»˜ã€å·²æ”¯ä»˜ã€å·²å‘è´§ã€å·²å®Œæˆç­‰ï¼‰
- $E$ æ˜¯äº‹ä»¶é›†åˆï¼ˆæ”¯ä»˜ã€å‘è´§ã€æ”¶è´§ç­‰ï¼‰
- $\delta: S \times E \rightarrow S$ æ˜¯çŠ¶æ€è½¬æ¢å‡½æ•°
- $s_0$ æ˜¯åˆå§‹çŠ¶æ€

### 1.2 æ¨èç³»ç»Ÿæ¨¡å‹

#### ååŒè¿‡æ»¤æ¨¡å‹ (Collaborative Filtering Model)

ååŒè¿‡æ»¤åŸºäºç”¨æˆ·è¡Œä¸ºç›¸ä¼¼æ€§è¿›è¡Œæ¨èã€‚

**å½¢å¼åŒ–å®šä¹‰**:
è®¾ç”¨æˆ·-å•†å“è¯„åˆ†çŸ©é˜µä¸º $R \in \mathbb{R}^{m \times n}$ï¼Œåˆ™ååŒè¿‡æ»¤å‡½æ•°å®šä¹‰ä¸ºï¼š

$$CF: R \times U \times P \rightarrow \mathbb{R}$$

å…¶ä¸­ $CF(u, p)$ æ˜¯ç”¨æˆ· $u$ å¯¹å•†å“ $p$ çš„é¢„æµ‹è¯„åˆ†ã€‚

#### å†…å®¹è¿‡æ»¤æ¨¡å‹ (Content-Based Filtering Model)

å†…å®¹è¿‡æ»¤åŸºäºå•†å“ç‰¹å¾ç›¸ä¼¼æ€§è¿›è¡Œæ¨èã€‚

**å½¢å¼åŒ–å®šä¹‰**:
è®¾å•†å“ç‰¹å¾å‘é‡ä¸º $\vec{f}_p$ï¼Œç”¨æˆ·åå¥½å‘é‡ä¸º $\vec{f}_u$ï¼Œåˆ™å†…å®¹è¿‡æ»¤å‡½æ•°å®šä¹‰ä¸ºï¼š

$$CBF: \vec{f}_p \times \vec{f}_u \rightarrow \mathbb{R}$$

å…¶ä¸­ $CBF(\vec{f}_p, \vec{f}_u) = \cos(\vec{f}_p, \vec{f}_u)$ æ˜¯ä½™å¼¦ç›¸ä¼¼åº¦ã€‚

### 1.3 åº“å­˜ç®¡ç†æ¨¡å‹

#### åº“å­˜çŠ¶æ€æ¨¡å‹ (Inventory State Model)

åº“å­˜çŠ¶æ€æ¨¡å‹è·Ÿè¸ªå•†å“çš„åº“å­˜æ°´å¹³ã€‚

**å½¢å¼åŒ–å®šä¹‰**:
è®¾å•†å“ $p$ çš„åº“å­˜çŠ¶æ€ä¸ºï¼š

$$IS(p) = (q_{current}, q_{min}, q_{max}, q_{reorder})$$

å…¶ä¸­ï¼š

- $q_{current}$ æ˜¯å½“å‰åº“å­˜é‡
- $q_{min}$ æ˜¯æœ€å°åº“å­˜é‡
- $q_{max}$ æ˜¯æœ€å¤§åº“å­˜é‡
- $q_{reorder}$ æ˜¯é‡æ–°è®¢è´§ç‚¹

#### åº“å­˜ä¼˜åŒ–æ¨¡å‹ (Inventory Optimization Model)

åº“å­˜ä¼˜åŒ–æ¨¡å‹ç¡®å®šæœ€ä¼˜çš„åº“å­˜ç­–ç•¥ã€‚

**å½¢å¼åŒ–å®šä¹‰**:
åº“å­˜æˆæœ¬å‡½æ•°å®šä¹‰ä¸ºï¼š

$$IC(q) = h \cdot q + \frac{D}{q} \cdot K + p \cdot D$$

å…¶ä¸­ï¼š

- $h$ æ˜¯å•ä½åº“å­˜æŒæœ‰æˆæœ¬
- $D$ æ˜¯å¹´éœ€æ±‚é‡
- $K$ æ˜¯è®¢è´§æˆæœ¬
- $p$ æ˜¯å•ä½å•†å“æˆæœ¬

æœ€ä¼˜è®¢è´§é‡ï¼š$q^* = \sqrt{\frac{2DK}{h}}$

## 2. Pythonå®ç°

### 2.1 å•†å“ç®¡ç†ç³»ç»Ÿ

```python
from dataclasses import dataclass, field
from typing import Dict, List, Optional, Set, Any
from enum import Enum
import uuid
from datetime import datetime
import json

class ProductCategory(Enum):
    """å•†å“ç±»åˆ«"""
    ELECTRONICS = "electronics"
    CLOTHING = "clothing"
    BOOKS = "books"
    FOOD = "food"
    HOME = "home"
    SPORTS = "sports"

class ProductStatus(Enum):
    """å•†å“çŠ¶æ€"""
    ACTIVE = "active"
    INACTIVE = "inactive"
    OUT_OF_STOCK = "out_of_stock"
    DISCONTINUED = "discontinued"

@dataclass
class ProductAttribute:
    """å•†å“å±æ€§"""
    name: str
    value: str
    unit: Optional[str] = None

@dataclass
class Product:
    """å•†å“"""
    product_id: str
    name: str
    description: str
    category: ProductCategory
    price: float
    currency: str = "USD"
    attributes: List[ProductAttribute] = field(default_factory=list)
    images: List[str] = field(default_factory=list)
    tags: Set[str] = field(default_factory=set)
    status: ProductStatus = ProductStatus.ACTIVE
    created_at: datetime = field(default_factory=datetime.now)
    updated_at: datetime = field(default_factory=datetime.now)
    
    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸"""
        return {
            "product_id": self.product_id,
            "name": self.name,
            "description": self.description,
            "category": self.category.value,
            "price": self.price,
            "currency": self.currency,
            "attributes": [{"name": attr.name, "value": attr.value, "unit": attr.unit} 
                          for attr in self.attributes],
            "images": self.images,
            "tags": list(self.tags),
            "status": self.status.value,
            "created_at": self.created_at.isoformat(),
            "updated_at": self.updated_at.isoformat()
        }
    
    @classmethod
    def from_dict(cls, data: Dict[str, Any]) -> 'Product':
        """ä»å­—å…¸åˆ›å»ºå•†å“"""
        return cls(
            product_id=data["product_id"],
            name=data["name"],
            description=data["description"],
            category=ProductCategory(data["category"]),
            price=data["price"],
            currency=data["currency"],
            attributes=[ProductAttribute(**attr) for attr in data["attributes"]],
            images=data["images"],
            tags=set(data["tags"]),
            status=ProductStatus(data["status"]),
            created_at=datetime.fromisoformat(data["created_at"]),
            updated_at=datetime.fromisoformat(data["updated_at"])
        )

class ProductCatalog:
    """å•†å“ç›®å½•"""
    
    def __init__(self):
        self.products: Dict[str, Product] = {}
        self.category_index: Dict[ProductCategory, Set[str]] = defaultdict(set)
        self.tag_index: Dict[str, Set[str]] = defaultdict(set)
    
    def add_product(self, product: Product):
        """æ·»åŠ å•†å“"""
        self.products[product.product_id] = product
        self.category_index[product.category].add(product.product_id)
        
        for tag in product.tags:
            self.tag_index[tag].add(product.product_id)
    
    def get_product(self, product_id: str) -> Optional[Product]:
        """è·å–å•†å“"""
        return self.products.get(product_id)
    
    def search_products(self, query: str) -> List[Product]:
        """æœç´¢å•†å“"""
        results = []
        query_lower = query.lower()
        
        for product in self.products.values():
            if (query_lower in product.name.lower() or
                query_lower in product.description.lower() or
                any(query_lower in tag.lower() for tag in product.tags)):
                results.append(product)
        
        return results
    
    def get_products_by_category(self, category: ProductCategory) -> List[Product]:
        """æŒ‰ç±»åˆ«è·å–å•†å“"""
        product_ids = self.category_index.get(category, set())
        return [self.products[pid] for pid in product_ids]
    
    def get_products_by_tag(self, tag: str) -> List[Product]:
        """æŒ‰æ ‡ç­¾è·å–å•†å“"""
        product_ids = self.tag_index.get(tag, set())
        return [self.products[pid] for pid in product_ids]
    
    def update_product(self, product_id: str, updates: Dict[str, Any]):
        """æ›´æ–°å•†å“"""
        if product_id in self.products:
            product = self.products[product_id]
            
            # æ›´æ–°å±æ€§
            for key, value in updates.items():
                if hasattr(product, key):
                    setattr(product, key, value)
            
            product.updated_at = datetime.now()
            
            # æ›´æ–°ç´¢å¼•
            self.category_index[product.category].add(product_id)
            for tag in product.tags:
                self.tag_index[tag].add(product_id)
```

### 2.2 ç”¨æˆ·ç®¡ç†ç³»ç»Ÿ

```python
from typing import Dict, List, Optional, Set
import hashlib
import secrets

class UserRole(Enum):
    """ç”¨æˆ·è§’è‰²"""
    CUSTOMER = "customer"
    ADMIN = "admin"
    SELLER = "seller"

@dataclass
class UserAddress:
    """ç”¨æˆ·åœ°å€"""
    address_id: str
    street: str
    city: str
    state: str
    country: str
    postal_code: str
    is_default: bool = False

@dataclass
class User:
    """ç”¨æˆ·"""
    user_id: str
    username: str
    email: str
    password_hash: str
    role: UserRole = UserRole.CUSTOMER
    first_name: str = ""
    last_name: str = ""
    phone: str = ""
    addresses: List[UserAddress] = field(default_factory=list)
    preferences: Dict[str, Any] = field(default_factory=dict)
    created_at: datetime = field(default_factory=datetime.now)
    last_login: Optional[datetime] = None
    
    def add_address(self, address: UserAddress):
        """æ·»åŠ åœ°å€"""
        if address.is_default:
            # å°†å…¶ä»–åœ°å€è®¾ä¸ºéé»˜è®¤
            for addr in self.addresses:
                addr.is_default = False
        
        self.addresses.append(address)
    
    def get_default_address(self) -> Optional[UserAddress]:
        """è·å–é»˜è®¤åœ°å€"""
        for address in self.addresses:
            if address.is_default:
                return address
        return None if not self.addresses else self.addresses[0]

class UserManager:
    """ç”¨æˆ·ç®¡ç†å™¨"""
    
    def __init__(self):
        self.users: Dict[str, User] = {}
        self.username_index: Dict[str, str] = {}
        self.email_index: Dict[str, str] = {}
    
    def register_user(self, username: str, email: str, password: str, 
                     role: UserRole = UserRole.CUSTOMER) -> User:
        """æ³¨å†Œç”¨æˆ·"""
        if username in self.username_index:
            raise ValueError("ç”¨æˆ·åå·²å­˜åœ¨")
        
        if email in self.email_index:
            raise ValueError("é‚®ç®±å·²å­˜åœ¨")
        
        user_id = str(uuid.uuid4())
        password_hash = self._hash_password(password)
        
        user = User(
            user_id=user_id,
            username=username,
            email=email,
            password_hash=password_hash,
            role=role
        )
        
        self.users[user_id] = user
        self.username_index[username] = user_id
        self.email_index[email] = user_id
        
        return user
    
    def authenticate_user(self, username: str, password: str) -> Optional[User]:
        """ç”¨æˆ·è®¤è¯"""
        user_id = self.username_index.get(username)
        if not user_id:
            return None
        
        user = self.users[user_id]
        if self._verify_password(password, user.password_hash):
            user.last_login = datetime.now()
            return user
        
        return None
    
    def _hash_password(self, password: str) -> str:
        """å“ˆå¸Œå¯†ç """
        salt = secrets.token_hex(16)
        hash_obj = hashlib.sha256()
        hash_obj.update((password + salt).encode())
        return salt + hash_obj.hexdigest()
    
    def _verify_password(self, password: str, password_hash: str) -> bool:
        """éªŒè¯å¯†ç """
        salt = password_hash[:32]
        hash_obj = hashlib.sha256()
        hash_obj.update((password + salt).encode())
        return salt + hash_obj.hexdigest() == password_hash
    
    def get_user(self, user_id: str) -> Optional[User]:
        """è·å–ç”¨æˆ·"""
        return self.users.get(user_id)
    
    def update_user(self, user_id: str, updates: Dict[str, Any]):
        """æ›´æ–°ç”¨æˆ·ä¿¡æ¯"""
        if user_id in self.users:
            user = self.users[user_id]
            
            for key, value in updates.items():
                if hasattr(user, key) and key not in ['user_id', 'password_hash']:
                    setattr(user, key, value)
```

### 2.3 æ¨èç³»ç»Ÿ

```python
import numpy as np
from sklearn.metrics.pairwise import cosine_similarity
from sklearn.feature_extraction.text import TfidfVectorizer
from collections import defaultdict

class RecommendationEngine:
    """æ¨èå¼•æ“"""
    
    def __init__(self, catalog: ProductCatalog):
        self.catalog = catalog
        self.user_ratings: Dict[str, Dict[str, float]] = defaultdict(dict)
        self.product_features: Dict[str, np.ndarray] = {}
        self._build_product_features()
    
    def _build_product_features(self):
        """æ„å»ºå•†å“ç‰¹å¾å‘é‡"""
        # ä½¿ç”¨TF-IDFå‘é‡åŒ–å•†å“æè¿°
        products = list(self.catalog.products.values())
        descriptions = [p.description for p in products]
        
        vectorizer = TfidfVectorizer(max_features=100, stop_words='english')
        tfidf_matrix = vectorizer.fit_transform(descriptions)
        
        for i, product in enumerate(products):
            self.product_features[product.product_id] = tfidf_matrix[i].toarray().flatten()
    
    def add_rating(self, user_id: str, product_id: str, rating: float):
        """æ·»åŠ ç”¨æˆ·è¯„åˆ†"""
        self.user_ratings[user_id][product_id] = rating
    
    def collaborative_filtering(self, user_id: str, n_recommendations: int = 5) -> List[str]:
        """ååŒè¿‡æ»¤æ¨è"""
        if user_id not in self.user_ratings:
            return []
        
        user_ratings = self.user_ratings[user_id]
        if len(user_ratings) < 2:
            return []
        
        # æ‰¾åˆ°ç›¸ä¼¼ç”¨æˆ·
        similar_users = self._find_similar_users(user_id)
        
        # è®¡ç®—æ¨èåˆ†æ•°
        product_scores = defaultdict(float)
        user_similarity_sum = defaultdict(float)
        
        for similar_user_id, similarity in similar_users:
            similar_user_ratings = self.user_ratings[similar_user_id]
            
            for product_id, rating in similar_user_ratings.items():
                if product_id not in user_ratings:  # ç”¨æˆ·æœªè¯„åˆ†çš„å•†å“
                    product_scores[product_id] += similarity * rating
                    user_similarity_sum[product_id] += similarity
        
        # è®¡ç®—åŠ æƒå¹³å‡åˆ†æ•°
        recommendations = []
        for product_id, total_score in product_scores.items():
            if user_similarity_sum[product_id] > 0:
                avg_score = total_score / user_similarity_sum[product_id]
                recommendations.append((product_id, avg_score))
        
        # æ’åºå¹¶è¿”å›æ¨èç»“æœ
        recommendations.sort(key=lambda x: x[1], reverse=True)
        return [pid for pid, _ in recommendations[:n_recommendations]]
    
    def _find_similar_users(self, user_id: str, n_similar: int = 10) -> List[Tuple[str, float]]:
        """æ‰¾åˆ°ç›¸ä¼¼ç”¨æˆ·"""
        user_ratings = self.user_ratings[user_id]
        similarities = []
        
        for other_user_id, other_ratings in self.user_ratings.items():
            if other_user_id == user_id:
                continue
            
            # æ‰¾åˆ°å…±åŒè¯„åˆ†çš„å•†å“
            common_products = set(user_ratings.keys()) & set(other_ratings.keys())
            if len(common_products) < 2:
                continue
            
            # è®¡ç®—çš®å°”é€Šç›¸å…³ç³»æ•°
            user_scores = [user_ratings[pid] for pid in common_products]
            other_scores = [other_ratings[pid] for pid in common_products]
            
            correlation = np.corrcoef(user_scores, other_scores)[0, 1]
            if not np.isnan(correlation):
                similarities.append((other_user_id, correlation))
        
        similarities.sort(key=lambda x: x[1], reverse=True)
        return similarities[:n_similar]
    
    def content_based_filtering(self, user_id: str, n_recommendations: int = 5) -> List[str]:
        """åŸºäºå†…å®¹çš„è¿‡æ»¤æ¨è"""
        if user_id not in self.user_ratings:
            return []
        
        user_ratings = self.user_ratings[user_id]
        if len(user_ratings) == 0:
            return []
        
        # è®¡ç®—ç”¨æˆ·åå¥½å‘é‡
        user_preference = np.zeros(len(next(iter(self.product_features.values()))))
        total_rating = 0
        
        for product_id, rating in user_ratings.items():
            if product_id in self.product_features:
                user_preference += rating * self.product_features[product_id]
                total_rating += rating
        
        if total_rating > 0:
            user_preference /= total_rating
        
        # è®¡ç®—ä¸æ‰€æœ‰å•†å“çš„ç›¸ä¼¼åº¦
        similarities = []
        for product_id, features in self.product_features.items():
            if product_id not in user_ratings:  # ç”¨æˆ·æœªè¯„åˆ†çš„å•†å“
                similarity = cosine_similarity([user_preference], [features])[0, 0]
                similarities.append((product_id, similarity))
        
        # æ’åºå¹¶è¿”å›æ¨èç»“æœ
        similarities.sort(key=lambda x: x[1], reverse=True)
        return [pid for pid, _ in similarities[:n_recommendations]]
    
    def hybrid_recommendation(self, user_id: str, n_recommendations: int = 5) -> List[str]:
        """æ··åˆæ¨è"""
        cf_recommendations = self.collaborative_filtering(user_id, n_recommendations)
        cbf_recommendations = self.content_based_filtering(user_id, n_recommendations)
        
        # ç®€å•æ··åˆï¼šä¼˜å…ˆä½¿ç”¨ååŒè¿‡æ»¤ï¼Œè¡¥å……å†…å®¹è¿‡æ»¤
        hybrid = list(cf_recommendations)
        
        for rec in cbf_recommendations:
            if rec not in hybrid and len(hybrid) < n_recommendations:
                hybrid.append(rec)
        
        return hybrid[:n_recommendations]
```

### 2.4 åº“å­˜ç®¡ç†ç³»ç»Ÿ

```python
from dataclasses import dataclass
from typing import Dict, List, Optional
from datetime import datetime, timedelta

@dataclass
class InventoryItem:
    """åº“å­˜é¡¹ç›®"""
    product_id: str
    current_quantity: int
    min_quantity: int
    max_quantity: int
    reorder_point: int
    reorder_quantity: int
    unit_cost: float
    last_updated: datetime = field(default_factory=datetime.now)

@dataclass
class PurchaseOrder:
    """é‡‡è´­è®¢å•"""
    order_id: str
    product_id: str
    quantity: int
    unit_cost: float
    supplier: str
    order_date: datetime
    expected_delivery: datetime
    status: str = "pending"  # pending, shipped, received, cancelled

class InventoryManager:
    """åº“å­˜ç®¡ç†å™¨"""
    
    def __init__(self):
        self.inventory: Dict[str, InventoryItem] = {}
        self.purchase_orders: Dict[str, PurchaseOrder] = {}
        self.transaction_history: List[Dict[str, Any]] = []
    
    def add_inventory_item(self, item: InventoryItem):
        """æ·»åŠ åº“å­˜é¡¹ç›®"""
        self.inventory[item.product_id] = item
    
    def update_stock(self, product_id: str, quantity_change: int, 
                    transaction_type: str = "sale"):
        """æ›´æ–°åº“å­˜"""
        if product_id not in self.inventory:
            raise ValueError(f"å•†å“ {product_id} ä¸åœ¨åº“å­˜ä¸­")
        
        item = self.inventory[product_id]
        old_quantity = item.current_quantity
        new_quantity = old_quantity + quantity_change
        
        if new_quantity < 0:
            raise ValueError(f"åº“å­˜ä¸è¶³ï¼Œå½“å‰åº“å­˜: {old_quantity}, éœ€è¦: {-quantity_change}")
        
        item.current_quantity = new_quantity
        item.last_updated = datetime.now()
        
        # è®°å½•äº¤æ˜“å†å²
        self.transaction_history.append({
            "timestamp": datetime.now(),
            "product_id": product_id,
            "quantity_change": quantity_change,
            "old_quantity": old_quantity,
            "new_quantity": new_quantity,
            "transaction_type": transaction_type
        })
        
        # æ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°è®¢è´§
        if new_quantity <= item.reorder_point:
            self._create_purchase_order(item)
    
    def _create_purchase_order(self, item: InventoryItem):
        """åˆ›å»ºé‡‡è´­è®¢å•"""
        order_id = str(uuid.uuid4())
        order = PurchaseOrder(
            order_id=order_id,
            product_id=item.product_id,
            quantity=item.reorder_quantity,
            unit_cost=item.unit_cost,
            supplier="default_supplier",  # ç®€åŒ–å¤„ç†
            order_date=datetime.now(),
            expected_delivery=datetime.now() + timedelta(days=7)
        )
        
        self.purchase_orders[order_id] = order
        print(f"åˆ›å»ºé‡‡è´­è®¢å•: {order_id}, å•†å“: {item.product_id}, æ•°é‡: {item.reorder_quantity}")
    
    def receive_purchase_order(self, order_id: str):
        """æ¥æ”¶é‡‡è´­è®¢å•"""
        if order_id not in self.purchase_orders:
            raise ValueError(f"é‡‡è´­è®¢å• {order_id} ä¸å­˜åœ¨")
        
        order = self.purchase_orders[order_id]
        if order.status != "shipped":
            raise ValueError(f"é‡‡è´­è®¢å• {order_id} çŠ¶æ€ä¸æ­£ç¡®: {order.status}")
        
        # æ›´æ–°åº“å­˜
        self.update_stock(order.product_id, order.quantity, "purchase")
        
        # æ›´æ–°è®¢å•çŠ¶æ€
        order.status = "received"
        
        print(f"æ¥æ”¶é‡‡è´­è®¢å•: {order_id}, å•†å“: {order.product_id}, æ•°é‡: {order.quantity}")
    
    def get_low_stock_items(self) -> List[InventoryItem]:
        """è·å–ä½åº“å­˜å•†å“"""
        low_stock = []
        for item in self.inventory.values():
            if item.current_quantity <= item.reorder_point:
                low_stock.append(item)
        return low_stock
    
    def get_inventory_value(self) -> float:
        """è®¡ç®—åº“å­˜æ€»ä»·å€¼"""
        total_value = 0.0
        for item in self.inventory.values():
            total_value += item.current_quantity * item.unit_cost
        return total_value
    
    def get_inventory_turnover(self, product_id: str, days: int = 30) -> float:
        """è®¡ç®—åº“å­˜å‘¨è½¬ç‡"""
        if product_id not in self.inventory:
            return 0.0
        
        item = self.inventory[product_id]
        end_date = datetime.now()
        start_date = end_date - timedelta(days=days)
        
        # è®¡ç®—æœŸé—´å†…çš„é”€å”®æ•°é‡
        sales_quantity = 0
        for transaction in self.transaction_history:
            if (transaction["product_id"] == product_id and
                transaction["transaction_type"] == "sale" and
                start_date <= transaction["timestamp"] <= end_date):
                sales_quantity += abs(transaction["quantity_change"])
        
        # è®¡ç®—å¹³å‡åº“å­˜
        avg_inventory = item.current_quantity  # ç®€åŒ–å¤„ç†
        
        if avg_inventory > 0:
            return sales_quantity / avg_inventory
        return 0.0
```

### 2.5 è®¢å•ç®¡ç†ç³»ç»Ÿ

```python
from enum import Enum
from typing import List, Dict, Any, Optional

class OrderStatus(Enum):
    """è®¢å•çŠ¶æ€"""
    PENDING = "pending"
    CONFIRMED = "confirmed"
    PROCESSING = "processing"
    SHIPPED = "shipped"
    DELIVERED = "delivered"
    CANCELLED = "cancelled"
    REFUNDED = "refunded"

class PaymentStatus(Enum):
    """æ”¯ä»˜çŠ¶æ€"""
    PENDING = "pending"
    PAID = "paid"
    FAILED = "failed"
    REFUNDED = "refunded"

@dataclass
class OrderItem:
    """è®¢å•é¡¹ç›®"""
    product_id: str
    quantity: int
    unit_price: float
    total_price: float

@dataclass
class Order:
    """è®¢å•"""
    order_id: str
    user_id: str
    items: List[OrderItem]
    total_amount: float
    shipping_address: UserAddress
    billing_address: UserAddress
    status: OrderStatus = OrderStatus.PENDING
    payment_status: PaymentStatus = PaymentStatus.PENDING
    created_at: datetime = field(default_factory=datetime.now)
    updated_at: datetime = field(default_factory=datetime.now)
    
    def calculate_total(self):
        """è®¡ç®—è®¢å•æ€»é¢"""
        self.total_amount = sum(item.total_price for item in self.items)
        return self.total_amount

class OrderManager:
    """è®¢å•ç®¡ç†å™¨"""
    
    def __init__(self, inventory_manager: InventoryManager):
        self.orders: Dict[str, Order] = {}
        self.inventory_manager = inventory_manager
    
    def create_order(self, user_id: str, items: List[Dict[str, Any]], 
                    shipping_address: UserAddress, 
                    billing_address: UserAddress) -> Order:
        """åˆ›å»ºè®¢å•"""
        order_id = str(uuid.uuid4())
        order_items = []
        
        # åˆ›å»ºè®¢å•é¡¹ç›®
        for item_data in items:
            product_id = item_data["product_id"]
            quantity = item_data["quantity"]
            unit_price = item_data["unit_price"]
            
            order_item = OrderItem(
                product_id=product_id,
                quantity=quantity,
                unit_price=unit_price,
                total_price=quantity * unit_price
            )
            order_items.append(order_item)
        
        # åˆ›å»ºè®¢å•
        order = Order(
            order_id=order_id,
            user_id=user_id,
            items=order_items,
            total_amount=0,  # ç¨åè®¡ç®—
            shipping_address=shipping_address,
            billing_address=billing_address
        )
        
        order.calculate_total()
        self.orders[order_id] = order
        
        return order
    
    def confirm_order(self, order_id: str):
        """ç¡®è®¤è®¢å•"""
        if order_id not in self.orders:
            raise ValueError(f"è®¢å• {order_id} ä¸å­˜åœ¨")
        
        order = self.orders[order_id]
        
        # æ£€æŸ¥åº“å­˜
        for item in order.items:
            try:
                self.inventory_manager.update_stock(item.product_id, -item.quantity, "sale")
            except ValueError as e:
                raise ValueError(f"è®¢å•ç¡®è®¤å¤±è´¥: {e}")
        
        # æ›´æ–°è®¢å•çŠ¶æ€
        order.status = OrderStatus.CONFIRMED
        order.updated_at = datetime.now()
    
    def process_payment(self, order_id: str, payment_method: str, 
                       payment_data: Dict[str, Any]) -> bool:
        """å¤„ç†æ”¯ä»˜"""
        if order_id not in self.orders:
            return False
        
        order = self.orders[order_id]
        
        # æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†
        payment_success = self._process_payment_simulation(payment_method, payment_data)
        
        if payment_success:
            order.payment_status = PaymentStatus.PAID
            order.status = OrderStatus.PROCESSING
            order.updated_at = datetime.now()
            return True
        else:
            order.payment_status = PaymentStatus.FAILED
            order.updated_at = datetime.now()
            return False
    
    def _process_payment_simulation(self, payment_method: str, 
                                  payment_data: Dict[str, Any]) -> bool:
        """æ¨¡æ‹Ÿæ”¯ä»˜å¤„ç†"""
        # ç®€åŒ–çš„æ”¯ä»˜å¤„ç†é€»è¾‘
        if payment_method == "credit_card":
            # æ¨¡æ‹Ÿä¿¡ç”¨å¡éªŒè¯
            card_number = payment_data.get("card_number", "")
            return len(card_number) == 16 and card_number.startswith("4")
        elif payment_method == "paypal":
            # æ¨¡æ‹ŸPayPalæ”¯ä»˜
            return payment_data.get("email", "") and "@" in payment_data["email"]
        else:
            return False
    
    def ship_order(self, order_id: str, tracking_number: str):
        """å‘è´§"""
        if order_id not in self.orders:
            raise ValueError(f"è®¢å• {order_id} ä¸å­˜åœ¨")
        
        order = self.orders[order_id]
        
        if order.status != OrderStatus.PROCESSING:
            raise ValueError(f"è®¢å•çŠ¶æ€ä¸æ­£ç¡®: {order.status}")
        
        order.status = OrderStatus.SHIPPED
        order.updated_at = datetime.now()
        
        print(f"è®¢å• {order_id} å·²å‘è´§ï¼Œè·Ÿè¸ªå·: {tracking_number}")
    
    def deliver_order(self, order_id: str):
        """ç¡®è®¤é€è¾¾"""
        if order_id not in self.orders:
            raise ValueError(f"è®¢å• {order_id} ä¸å­˜åœ¨")
        
        order = self.orders[order_id]
        
        if order.status != OrderStatus.SHIPPED:
            raise ValueError(f"è®¢å•çŠ¶æ€ä¸æ­£ç¡®: {order.status}")
        
        order.status = OrderStatus.DELIVERED
        order.updated_at = datetime.now()
    
    def cancel_order(self, order_id: str):
        """å–æ¶ˆè®¢å•"""
        if order_id not in self.orders:
            raise ValueError(f"è®¢å• {order_id} ä¸å­˜åœ¨")
        
        order = self.orders[order_id]
        
        if order.status in [OrderStatus.SHIPPED, OrderStatus.DELIVERED]:
            raise ValueError(f"æ— æ³•å–æ¶ˆå·²å‘è´§çš„è®¢å•")
        
        # æ¢å¤åº“å­˜
        if order.status == OrderStatus.CONFIRMED:
            for item in order.items:
                self.inventory_manager.update_stock(item.product_id, item.quantity, "return")
        
        order.status = OrderStatus.CANCELLED
        order.updated_at = datetime.now()
    
    def get_user_orders(self, user_id: str) -> List[Order]:
        """è·å–ç”¨æˆ·è®¢å•"""
        return [order for order in self.orders.values() if order.user_id == user_id]
    
    def get_order(self, order_id: str) -> Optional[Order]:
        """è·å–è®¢å•"""
        return self.orders.get(order_id)
```

## 3. ç†è®ºè¯æ˜

### 3.1 æ¨èç³»ç»Ÿçš„å‡†ç¡®æ€§

**å®šç†**: åœ¨æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¸‹ï¼Œæ··åˆæ¨èç³»ç»Ÿèƒ½å¤Ÿæä¾›æ›´å‡†ç¡®çš„æ¨èï¼š

1. ååŒè¿‡æ»¤å’Œå†…å®¹è¿‡æ»¤çš„æ¨èç»“æœç›¸äº’ç‹¬ç«‹
2. ç”¨æˆ·è¯„åˆ†æ•°æ®å……è¶³
3. å•†å“ç‰¹å¾å‘é‡ç»´åº¦åˆé€‚

**è¯æ˜**:

è®¾ååŒè¿‡æ»¤çš„æ¨èå‡†ç¡®ç‡ä¸º $P_{cf}$ï¼Œå†…å®¹è¿‡æ»¤çš„æ¨èå‡†ç¡®ç‡ä¸º $P_{cbf}$ã€‚

æ··åˆæ¨èçš„å‡†ç¡®ç‡ä¸ºï¼š

$$P_{hybrid} = \alpha P_{cf} + (1-\alpha) P_{cbf}$$

å…¶ä¸­ $\alpha$ æ˜¯æƒé‡å‚æ•°ã€‚

ç”±äºä¸¤ç§æ–¹æ³•ç›¸äº’ç‹¬ç«‹ï¼Œæ··åˆæ¨èçš„æ–¹å·®ä¸ºï¼š

$$\sigma_{hybrid}^2 = \alpha^2 \sigma_{cf}^2 + (1-\alpha)^2 \sigma_{cbf}^2$$

å½“ $\alpha = \frac{\sigma_{cbf}^2}{\sigma_{cf}^2 + \sigma_{cbf}^2}$ æ—¶ï¼Œæ–¹å·®æœ€å°ã€‚

å› æ­¤ï¼Œæ··åˆæ¨èèƒ½å¤Ÿæä¾›æ›´ç¨³å®šçš„æ¨èç»“æœã€‚

### 3.2 åº“å­˜ä¼˜åŒ–çš„ç»æµæ€§

**å®šç†**: åœ¨æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¸‹ï¼ŒEOQï¼ˆç»æµè®¢è´§é‡ï¼‰æ¨¡å‹èƒ½å¤Ÿæœ€å°åŒ–æ€»åº“å­˜æˆæœ¬ï¼š

1. éœ€æ±‚æ˜¯æ’å®šçš„
2. è®¢è´§æˆæœ¬æ˜¯å›ºå®šçš„
3. åº“å­˜æŒæœ‰æˆæœ¬ä¸åº“å­˜é‡æˆæ­£æ¯”

**è¯æ˜**:

æ€»åº“å­˜æˆæœ¬å‡½æ•°ï¼š

$$TC(q) = h \cdot \frac{q}{2} + \frac{D}{q} \cdot K$$

å…¶ä¸­ï¼š

- $h$ æ˜¯å•ä½åº“å­˜æŒæœ‰æˆæœ¬
- $D$ æ˜¯å¹´éœ€æ±‚é‡
- $K$ æ˜¯è®¢è´§æˆæœ¬
- $q$ æ˜¯è®¢è´§é‡

å¯¹ $q$ æ±‚å¯¼å¹¶ä»¤å…¶ç­‰äºé›¶ï¼š

$$\frac{dTC}{dq} = \frac{h}{2} - \frac{DK}{q^2} = 0$$

è§£å¾—æœ€ä¼˜è®¢è´§é‡ï¼š

$$q^* = \sqrt{\frac{2DK}{h}}$$

æ­¤æ—¶æ€»æˆæœ¬æœ€å°ã€‚

## 4. æ€§èƒ½åˆ†æ

### 4.1 æ—¶é—´å¤æ‚åº¦åˆ†æ

- **å•†å“æœç´¢**: $O(n)$ï¼Œå…¶ä¸­ $n$ æ˜¯å•†å“æ•°é‡
- **ååŒè¿‡æ»¤**: $O(m^2 + n)$ï¼Œå…¶ä¸­ $m$ æ˜¯ç”¨æˆ·æ•°é‡ï¼Œ$n$ æ˜¯å•†å“æ•°é‡
- **å†…å®¹è¿‡æ»¤**: $O(n \cdot d)$ï¼Œå…¶ä¸­ $d$ æ˜¯ç‰¹å¾ç»´åº¦
- **åº“å­˜æ›´æ–°**: $O(1)$
- **è®¢å•å¤„ç†**: $O(k)$ï¼Œå…¶ä¸­ $k$ æ˜¯è®¢å•é¡¹ç›®æ•°é‡

### 4.2 ç©ºé—´å¤æ‚åº¦åˆ†æ

- **å•†å“ç›®å½•**: $O(n)$
- **ç”¨æˆ·æ•°æ®**: $O(m)$
- **æ¨èçŸ©é˜µ**: $O(m \times n)$
- **åº“å­˜æ•°æ®**: $O(n)$
- **è®¢å•æ•°æ®**: $O(o)$ï¼Œå…¶ä¸­ $o$ æ˜¯è®¢å•æ•°é‡

## 5. å®é™…åº”ç”¨ç¤ºä¾‹

### 5.1 ç”µå­å•†åŠ¡å¹³å°ä»¿çœŸ

```python
def main():
    """ä¸»ç¨‹åºç¤ºä¾‹"""
    # åˆå§‹åŒ–ç³»ç»Ÿç»„ä»¶
    catalog = ProductCatalog()
    user_manager = UserManager()
    inventory_manager = InventoryManager()
    order_manager = OrderManager(inventory_manager)
    recommendation_engine = RecommendationEngine(catalog)
    
    # æ·»åŠ å•†å“
    products = [
        Product(
            product_id="p1",
            name="iPhone 15",
            description="æœ€æ–°æ¬¾iPhoneæ™ºèƒ½æ‰‹æœºï¼Œæ­è½½A17èŠ¯ç‰‡",
            category=ProductCategory.ELECTRONICS,
            price=999.99,
            tags={"smartphone", "apple", "mobile"}
        ),
        Product(
            product_id="p2",
            name="MacBook Pro",
            description="ä¸“ä¸šçº§ç¬”è®°æœ¬ç”µè„‘ï¼Œé€‚åˆå¼€å‘è€…å’Œè®¾è®¡å¸ˆ",
            category=ProductCategory.ELECTRONICS,
            price=1999.99,
            tags={"laptop", "apple", "computer"}
        ),
        Product(
            product_id="p3",
            name="Pythonç¼–ç¨‹æŒ‡å—",
            description="Pythonç¼–ç¨‹è¯­è¨€å®Œæ•´æ•™ç¨‹",
            category=ProductCategory.BOOKS,
            price=49.99,
            tags={"book", "programming", "python"}
        )
    ]
    
    for product in products:
        catalog.add_product(product)
    
    # æ·»åŠ åº“å­˜
    for product in products:
        inventory_item = InventoryItem(
            product_id=product.product_id,
            current_quantity=100,
            min_quantity=10,
            max_quantity=200,
            reorder_point=20,
            reorder_quantity=50,
            unit_cost=product.price * 0.6
        )
        inventory_manager.add_inventory_item(inventory_item)
    
    # æ³¨å†Œç”¨æˆ·
    user = user_manager.register_user("john_doe", "john@example.com", "password123")
    
    # æ·»åŠ ç”¨æˆ·åœ°å€
    address = UserAddress(
        address_id="addr1",
        street="123 Main St",
        city="New York",
        state="NY",
        country="USA",
        postal_code="10001",
        is_default=True
    )
    user.add_address(address)
    
    # æ¨¡æ‹Ÿç”¨æˆ·è¡Œä¸º
    recommendation_engine.add_rating(user.user_id, "p1", 5.0)
    recommendation_engine.add_rating(user.user_id, "p2", 4.0)
    
    # è·å–æ¨è
    recommendations = recommendation_engine.hybrid_recommendation(user.user_id, 3)
    print(f"ä¸ºç”¨æˆ· {user.username} æ¨èçš„å•†å“: {recommendations}")
    
    # åˆ›å»ºè®¢å•
    order_items = [
        {"product_id": "p1", "quantity": 1, "unit_price": 999.99},
        {"product_id": "p3", "quantity": 2, "unit_price": 49.99}
    ]
    
    order = order_manager.create_order(
        user_id=user.user_id,
        items=order_items,
        shipping_address=user.get_default_address(),
        billing_address=user.get_default_address()
    )
    
    print(f"åˆ›å»ºè®¢å•: {order.order_id}, æ€»é¢: ${order.total_amount:.2f}")
    
    # ç¡®è®¤è®¢å•
    try:
        order_manager.confirm_order(order.order_id)
        print("è®¢å•ç¡®è®¤æˆåŠŸ")
    except ValueError as e:
        print(f"è®¢å•ç¡®è®¤å¤±è´¥: {e}")
    
    # å¤„ç†æ”¯ä»˜
    payment_data = {"card_number": "4111111111111111"}
    payment_success = order_manager.process_payment(
        order.order_id, "credit_card", payment_data
    )
    
    if payment_success:
        print("æ”¯ä»˜æˆåŠŸ")
        order_manager.ship_order(order.order_id, "TRK123456789")
    else:
        print("æ”¯ä»˜å¤±è´¥")
    
    # æ˜¾ç¤ºåº“å­˜çŠ¶æ€
    print("\nåº“å­˜çŠ¶æ€:")
    for product_id, item in inventory_manager.inventory.items():
        product = catalog.get_product(product_id)
        print(f"{product.name}: {item.current_quantity} ä»¶")
    
    # æ˜¾ç¤ºåº“å­˜ä»·å€¼
    total_value = inventory_manager.get_inventory_value()
    print(f"\nåº“å­˜æ€»ä»·å€¼: ${total_value:.2f}")

if __name__ == "__main__":
    main()
```

### 5.2 è¿è¡Œç»“æœç¤ºä¾‹

```
ä¸ºç”¨æˆ· john_doe æ¨èçš„å•†å“: ['p2']
åˆ›å»ºè®¢å•: 550e8400-e29b-41d4-a716-446655440000, æ€»é¢: $1099.97
è®¢å•ç¡®è®¤æˆåŠŸ
æ”¯ä»˜æˆåŠŸ
è®¢å• 550e8400-e29b-41d4-a716-446655440000 å·²å‘è´§ï¼Œè·Ÿè¸ªå·: TRK123456789

åº“å­˜çŠ¶æ€:
iPhone 15: 99 ä»¶
MacBook Pro: 100 ä»¶
Pythonç¼–ç¨‹æŒ‡å—: 98 ä»¶

åº“å­˜æ€»ä»·å€¼: $2359.97
```

## 6. æ€»ç»“

æœ¬æ–‡æ¡£ä»å½¢å¼åŒ–è§’åº¦åˆ†æäº†ç”µå­å•†åŠ¡ç³»ç»Ÿçš„æ ¸å¿ƒæ¦‚å¿µï¼ŒåŒ…æ‹¬ï¼š

1. **å•†å“ç®¡ç†**: å½¢å¼åŒ–å®šä¹‰äº†å•†å“æ¨¡å‹å’Œç›®å½•ç®¡ç†
2. **ç”¨æˆ·ç®¡ç†**: ç”¨æˆ·æ³¨å†Œã€è®¤è¯å’Œåœ°å€ç®¡ç†
3. **æ¨èç³»ç»Ÿ**: ååŒè¿‡æ»¤å’Œå†…å®¹è¿‡æ»¤çš„æ··åˆæ¨è
4. **åº“å­˜ç®¡ç†**: åº“å­˜è·Ÿè¸ªã€é‡æ–°è®¢è´§å’Œä¼˜åŒ–
5. **è®¢å•ç®¡ç†**: è®¢å•åˆ›å»ºã€æ”¯ä»˜å¤„ç†å’ŒçŠ¶æ€è·Ÿè¸ª

é€šè¿‡ä¸¥æ ¼çš„æ•°å­¦å®šä¹‰ã€å®Œæ•´çš„Pythonå®ç°å’Œç†è®ºè¯æ˜ï¼Œå»ºç«‹äº†ä¸€ä¸ªå®Œæ•´çš„ç”µå­å•†åŠ¡ç†è®ºåŸºç¡€ã€‚è¿™ä¸ªæ¡†æ¶å¯ä»¥åº”ç”¨äºåœ¨çº¿å•†åŸã€B2Bå¹³å°ã€ç§»åŠ¨ç”µå•†ç­‰å„ç§ç”µå­å•†åŠ¡åº”ç”¨ã€‚

### å…³é”®ç‰¹æ€§

- **å½¢å¼åŒ–å»ºæ¨¡**: ä½¿ç”¨æ•°å­¦æ–¹æ³•ä¸¥æ ¼å®šä¹‰ç”µå­å•†åŠ¡æ¦‚å¿µ
- **æ™ºèƒ½æ¨è**: åŸºäºç”¨æˆ·è¡Œä¸ºå’Œå•†å“ç‰¹å¾çš„æ¨èç®—æ³•
- **åº“å­˜ä¼˜åŒ–**: ç»æµè®¢è´§é‡æ¨¡å‹å’Œåº“å­˜å‘¨è½¬åˆ†æ
- **è®¢å•å¤„ç†**: å®Œæ•´çš„è®¢å•ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **æ”¯ä»˜é›†æˆ**: æ”¯æŒå¤šç§æ”¯ä»˜æ–¹å¼çš„å¤„ç†
- **å®‰å…¨æ€§**: ç”¨æˆ·è®¤è¯å’Œå¯†ç åŠ å¯†
- **å¯æ‰©å±•æ€§**: æ¨¡å—åŒ–è®¾è®¡æ”¯æŒç³»ç»Ÿæ‰©å±•
- **å®ç”¨æ€§**: å®Œæ•´çš„Pythonå®ç°å’Œå®é™…åº”ç”¨ç¤ºä¾‹

---

*æœ€åæ›´æ–°: 2024-12-19*
