# åŒ»ç–—å¥åº·åŸºç¡€

## ğŸ“‹ æ¦‚è¿°

åŒ»ç–—å¥åº·æ˜¯è½¯ä»¶å·¥ç¨‹åœ¨ç”Ÿå‘½ç§‘å­¦é¢†åŸŸçš„é‡è¦åº”ç”¨ï¼Œæ¶‰åŠåŒ»ç–—ä¿¡æ¯ç³»ç»Ÿã€å¥åº·æ•°æ®åˆ†æã€åŒ»ç–—è®¾å¤‡ç®¡ç†ã€æ‚£è€…ç®¡ç†ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚æœ¬æ–‡æ¡£ä»å½¢å¼åŒ–å®šä¹‰å‡ºå‘ï¼Œæ„å»ºå®Œæ•´çš„åŒ»ç–—å¥åº·ç†è®ºä½“ç³»ã€‚

## 1. å½¢å¼åŒ–å®šä¹‰

### 1.1 åŒ»ç–—ç³»ç»Ÿå®šä¹‰

**å®šä¹‰ 1.1** (åŒ»ç–—ç³»ç»Ÿ)
åŒ»ç–—ç³»ç»Ÿæ˜¯ä¸€ä¸ªå…­å…ƒç»„ï¼š
$$\text{MedicalSystem} = (P, D, T, E, R, A)$$

å…¶ä¸­ï¼š

- $P$ æ˜¯æ‚£è€…é›†åˆ
- $D$ æ˜¯åŒ»ç”Ÿé›†åˆ
- $T$ æ˜¯æ²»ç–—é›†åˆ
- $E$ æ˜¯è®¾å¤‡é›†åˆ
- $R$ æ˜¯è®°å½•é›†åˆ
- $A$ æ˜¯ç®—æ³•é›†åˆ

### 1.2 æ‚£è€…è®°å½•å®šä¹‰

**å®šä¹‰ 1.2** (æ‚£è€…è®°å½•)
æ‚£è€…è®°å½•æ˜¯ä¸€ä¸ªäº”å…ƒç»„ï¼š
$$r = (\text{patient\_id}, \text{personal\_info}, \text{medical\_history}, \text{treatments}, \text{vital\_signs})$$

å…¶ä¸­ï¼š

- $\text{patient\_id}$ æ˜¯æ‚£è€…å”¯ä¸€æ ‡è¯†ç¬¦
- $\text{personal\_info}$ æ˜¯ä¸ªäººä¿¡æ¯
- $\text{medical\_history}$ æ˜¯ç—…å²
- $\text{treatments}$ æ˜¯æ²»ç–—æ–¹æ¡ˆ
- $\text{vital\_signs}$ æ˜¯ç”Ÿå‘½ä½“å¾

### 1.3 å¥åº·æ•°æ®å®šä¹‰

**å®šä¹‰ 1.3** (å¥åº·æ•°æ®)
å¥åº·æ•°æ®æ˜¯ä¸€ä¸ªå››å…ƒç»„ï¼š
$$h = (\text{timestamp}, \text{data\_type}, \text{value}, \text{unit})$$

å…¶ä¸­ï¼š

- $\text{timestamp}$ æ˜¯æ—¶é—´æˆ³
- $\text{data\_type}$ æ˜¯æ•°æ®ç±»å‹
- $\text{value}$ æ˜¯æ•°å€¼
- $\text{unit}$ æ˜¯å•ä½

## 2. æ ¸å¿ƒæ¦‚å¿µ

### 2.1 åŒ»ç–—ä¿¡æ¯ç³»ç»Ÿ

#### 2.1.1 ç”µå­å¥åº·è®°å½• (EHR)

**å®šä¹‰ 2.1** (ç”µå­å¥åº·è®°å½•)
EHRæ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ï¼š
$$\text{EHR} = (P, R, T)$$

å…¶ä¸­ï¼š

- $P$ æ˜¯æ‚£è€…ä¿¡æ¯
- $R$ æ˜¯è®°å½•é›†åˆ
- $T$ æ˜¯æ—¶é—´è½´

#### 2.1.2 åŒ»ç–—æ•°æ®æ ‡å‡†

**å®šä¹‰ 2.2** (åŒ»ç–—æ•°æ®æ ‡å‡†)
åŒ»ç–—æ•°æ®æ ‡å‡†æ˜¯ä¸€ä¸ªå››å…ƒç»„ï¼š
$$\text{Standard} = (\text{format}, \text{schema}, \text{protocol}, \text{version})$$

å…¶ä¸­ï¼š

- $\text{format}$ æ˜¯æ•°æ®æ ¼å¼
- $\text{schema}$ æ˜¯æ•°æ®æ¨¡å¼
- $\text{protocol}$ æ˜¯ä¼ è¾“åè®®
- $\text{version}$ æ˜¯ç‰ˆæœ¬å·

### 2.2 å¥åº·æ•°æ®åˆ†æ

#### 2.2.1 ç”Ÿå‘½ä½“å¾åˆ†æ

**å®šä¹‰ 2.3** (ç”Ÿå‘½ä½“å¾)
ç”Ÿå‘½ä½“å¾æ˜¯ä¸€ä¸ªå‘é‡ï¼š
$$V = (HR, BP, Temp, RR, SpO2)$$

å…¶ä¸­ï¼š

- $HR$ æ˜¯å¿ƒç‡
- $BP$ æ˜¯è¡€å‹
- $Temp$ æ˜¯ä½“æ¸©
- $RR$ æ˜¯å‘¼å¸ç‡
- $SpO2$ æ˜¯è¡€æ°§é¥±å’Œåº¦

#### 2.2.2 å¼‚å¸¸æ£€æµ‹

**å®šä¹‰ 2.4** (å¼‚å¸¸æ£€æµ‹)
å¼‚å¸¸æ£€æµ‹å‡½æ•°ï¼š
$$f: \mathbb{R}^n \rightarrow \{0, 1\}$$

å…¶ä¸­ $f(x) = 1$ è¡¨ç¤ºå¼‚å¸¸ï¼Œ$f(x) = 0$ è¡¨ç¤ºæ­£å¸¸ã€‚

### 2.3 åŒ»ç–—è®¾å¤‡ç®¡ç†

#### 2.3.1 è®¾å¤‡çŠ¶æ€

**å®šä¹‰ 2.5** (è®¾å¤‡çŠ¶æ€)
è®¾å¤‡çŠ¶æ€æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„ï¼š
$$S = (\text{status}, \text{performance}, \text{maintenance})$$

å…¶ä¸­ï¼š

- $\text{status}$ æ˜¯è¿è¡ŒçŠ¶æ€
- $\text{performance}$ æ˜¯æ€§èƒ½æŒ‡æ ‡
- $\text{maintenance}$ æ˜¯ç»´æŠ¤ä¿¡æ¯

## 3. Pythonå®ç°

### 3.1 åŸºç¡€æ•°æ®ç»“æ„

```python
from typing import List, Dict, Optional, Any, Tuple
from dataclasses import dataclass, field
from abc import ABC, abstractmethod
import time
import json
import uuid
from datetime import datetime, timedelta
from collections import defaultdict
from enum import Enum
import numpy as np
import pandas as pd
from dataclasses_json import dataclass_json

class Gender(Enum):
    """æ€§åˆ«æšä¸¾"""
    MALE = "male"
    FEMALE = "female"
    OTHER = "other"

class BloodType(Enum):
    """è¡€å‹æšä¸¾"""
    A_POSITIVE = "A+"
    A_NEGATIVE = "A-"
    B_POSITIVE = "B+"
    B_NEGATIVE = "B-"
    AB_POSITIVE = "AB+"
    AB_NEGATIVE = "AB-"
    O_POSITIVE = "O+"
    O_NEGATIVE = "O-"

class VitalSigns:
    """ç”Ÿå‘½ä½“å¾"""
    
    def __init__(self):
        self.heart_rate = 0.0  # å¿ƒç‡ (bpm)
        self.systolic_bp = 0.0  # æ”¶ç¼©å‹ (mmHg)
        self.diastolic_bp = 0.0  # èˆ’å¼ å‹ (mmHg)
        self.temperature = 0.0  # ä½“æ¸© (Â°C)
        self.respiratory_rate = 0.0  # å‘¼å¸ç‡ (breaths/min)
        self.oxygen_saturation = 0.0  # è¡€æ°§é¥±å’Œåº¦ (%)
        self.timestamp = datetime.now()
    
    def is_normal(self) -> Dict[str, bool]:
        """æ£€æŸ¥æ˜¯å¦æ­£å¸¸"""
        return {
            'heart_rate': 60 <= self.heart_rate <= 100,
            'systolic_bp': 90 <= self.systolic_bp <= 140,
            'diastolic_bp': 60 <= self.diastolic_bp <= 90,
            'temperature': 36.1 <= self.temperature <= 37.2,
            'respiratory_rate': 12 <= self.respiratory_rate <= 20,
            'oxygen_saturation': self.oxygen_saturation >= 95
        }
    
    def to_dict(self) -> Dict[str, Any]:
        """è½¬æ¢ä¸ºå­—å…¸"""
        return {
            'heart_rate': self.heart_rate,
            'systolic_bp': self.systolic_bp,
            'diastolic_bp': self.diastolic_bp,
            'temperature': self.temperature,
            'respiratory_rate': self.respiratory_rate,
            'oxygen_saturation': self.oxygen_saturation,
            'timestamp': self.timestamp.isoformat()
        }

@dataclass
class PersonalInfo:
    """ä¸ªäººä¿¡æ¯"""
    first_name: str
    last_name: str
    date_of_birth: datetime
    gender: Gender
    blood_type: BloodType
    height: float  # cm
    weight: float  # kg
    contact_number: str
    email: str
    address: str
    
    def calculate_bmi(self) -> float:
        """è®¡ç®—BMI"""
        height_m = self.height / 100
        return self.weight / (height_m * height_m)
    
    def get_age(self) -> int:
        """è·å–å¹´é¾„"""
        today = datetime.now()
        return today.year - self.date_of_birth.year - (
            (today.month, today.day) < (self.date_of_birth.month, self.date_of_birth.day)
        )

@dataclass
class MedicalHistory:
    """ç—…å²"""
    allergies: List[str] = field(default_factory=list)
    chronic_conditions: List[str] = field(default_factory=list)
    surgeries: List[Dict[str, Any]] = field(default_factory=list)
    medications: List[Dict[str, Any]] = field(default_factory=list)
    family_history: Dict[str, List[str]] = field(default_factory=dict)
    
    def add_allergy(self, allergy: str) -> None:
        """æ·»åŠ è¿‡æ•å²"""
        if allergy not in self.allergies:
            self.allergies.append(allergy)
    
    def add_chronic_condition(self, condition: str) -> None:
        """æ·»åŠ æ…¢æ€§ç—…"""
        if condition not in self.chronic_conditions:
            self.chronic_conditions.append(condition)
    
    def add_surgery(self, surgery_date: datetime, procedure: str, 
                   hospital: str, surgeon: str) -> None:
        """æ·»åŠ æ‰‹æœ¯å²"""
        surgery = {
            'date': surgery_date.isoformat(),
            'procedure': procedure,
            'hospital': hospital,
            'surgeon': surgeon
        }
        self.surgeries.append(surgery)
    
    def add_medication(self, name: str, dosage: str, frequency: str, 
                      start_date: datetime, end_date: Optional[datetime] = None) -> None:
        """æ·»åŠ è¯ç‰©"""
        medication = {
            'name': name,
            'dosage': dosage,
            'frequency': frequency,
            'start_date': start_date.isoformat(),
            'end_date': end_date.isoformat() if end_date else None
        }
        self.medications.append(medication)

@dataclass
class Treatment:
    """æ²»ç–—æ–¹æ¡ˆ"""
    treatment_id: str
    diagnosis: str
    treatment_type: str
    start_date: datetime
    end_date: Optional[datetime]
    doctor_id: str
    medications: List[Dict[str, Any]]
    procedures: List[Dict[str, Any]]
    notes: str
    status: str = "active"
    
    def is_active(self) -> bool:
        """æ£€æŸ¥æ˜¯å¦æ´»è·ƒ"""
        if self.status != "active":
            return False
        if self.end_date and datetime.now() > self.end_date:
            return False
        return True

class Patient:
    """æ‚£è€…ç±»"""
    
    def __init__(self, patient_id: str, personal_info: PersonalInfo):
        self.patient_id = patient_id
        self.personal_info = personal_info
        self.medical_history = MedicalHistory()
        self.treatments: List[Treatment] = []
        self.vital_signs_history: List[VitalSigns] = []
        self.appointments: List['Appointment'] = []
        self.insurance_info: Optional[Dict[str, Any]] = None
    
    def add_vital_signs(self, vital_signs: VitalSigns) -> None:
        """æ·»åŠ ç”Ÿå‘½ä½“å¾"""
        self.vital_signs_history.append(vital_signs)
    
    def get_latest_vital_signs(self) -> Optional[VitalSigns]:
        """è·å–æœ€æ–°ç”Ÿå‘½ä½“å¾"""
        if self.vital_signs_history:
            return self.vital_signs_history[-1]
        return None
    
    def add_treatment(self, treatment: Treatment) -> None:
        """æ·»åŠ æ²»ç–—æ–¹æ¡ˆ"""
        self.treatments.append(treatment)
    
    def get_active_treatments(self) -> List[Treatment]:
        """è·å–æ´»è·ƒæ²»ç–—æ–¹æ¡ˆ"""
        return [treatment for treatment in self.treatments if treatment.is_active()]
    
    def add_appointment(self, appointment: 'Appointment') -> None:
        """æ·»åŠ é¢„çº¦"""
        self.appointments.append(appointment)
    
    def get_upcoming_appointments(self) -> List['Appointment']:
        """è·å–å³å°†åˆ°æ¥çš„é¢„çº¦"""
        now = datetime.now()
        return [appointment for appointment in self.appointments 
                if appointment.appointment_time > now]

class Doctor:
    """åŒ»ç”Ÿç±»"""
    
    def __init__(self, doctor_id: str, name: str, specialization: str, 
                 license_number: str):
        self.doctor_id = doctor_id
        self.name = name
        self.specialization = specialization
        self.license_number = license_number
        self.patients: List[str] = []  # æ‚£è€…IDåˆ—è¡¨
        self.schedule: List['Appointment'] = []
        self.availability: Dict[str, List[Tuple[datetime, datetime]]] = defaultdict(list)
    
    def add_patient(self, patient_id: str) -> None:
        """æ·»åŠ æ‚£è€…"""
        if patient_id not in self.patients:
            self.patients.append(patient_id)
    
    def remove_patient(self, patient_id: str) -> None:
        """ç§»é™¤æ‚£è€…"""
        if patient_id in self.patients:
            self.patients.remove(patient_id)
    
    def add_appointment(self, appointment: 'Appointment') -> None:
        """æ·»åŠ é¢„çº¦"""
        self.schedule.append(appointment)
    
    def is_available(self, date_time: datetime) -> bool:
        """æ£€æŸ¥æ˜¯å¦å¯ç”¨"""
        # æ£€æŸ¥æ˜¯å¦åœ¨å¯ç”¨æ—¶é—´å†…
        day_of_week = date_time.strftime('%A').lower()
        if day_of_week not in self.availability:
            return False
        
        for start_time, end_time in self.availability[day_of_week]:
            if start_time <= date_time.time() <= end_time:
                # æ£€æŸ¥æ˜¯å¦æœ‰å†²çªçš„é¢„çº¦
                for appointment in self.schedule:
                    if appointment.appointment_time == date_time:
                        return False
                return True
        return False

@dataclass
class Appointment:
    """é¢„çº¦"""
    appointment_id: str
    patient_id: str
    doctor_id: str
    appointment_time: datetime
    duration: int = 30  # åˆ†é’Ÿ
    reason: str = ""
    status: str = "scheduled"
    notes: str = ""

class MedicalDevice:
    """åŒ»ç–—è®¾å¤‡"""
    
    def __init__(self, device_id: str, device_name: str, device_type: str):
        self.device_id = device_id
        self.device_name = device_name
        self.device_type = device_type
        self.status = "available"  # available, in_use, maintenance, offline
        self.current_patient_id: Optional[str] = None
        self.last_maintenance: Optional[datetime] = None
        self.next_maintenance: Optional[datetime] = None
        self.usage_hours = 0
        self.calibration_data: Dict[str, Any] = {}
    
    def start_use(self, patient_id: str) -> bool:
        """å¼€å§‹ä½¿ç”¨"""
        if self.status == "available":
            self.status = "in_use"
            self.current_patient_id = patient_id
            return True
        return False
    
    def end_use(self) -> None:
        """ç»“æŸä½¿ç”¨"""
        if self.status == "in_use":
            self.status = "available"
            self.current_patient_id = None
            self.usage_hours += 0.5  # å‡è®¾æ¯æ¬¡ä½¿ç”¨0.5å°æ—¶
    
    def schedule_maintenance(self, maintenance_date: datetime) -> None:
        """å®‰æ’ç»´æŠ¤"""
        self.next_maintenance = maintenance_date
    
    def perform_maintenance(self) -> None:
        """æ‰§è¡Œç»´æŠ¤"""
        self.last_maintenance = datetime.now()
        self.status = "available"
        self.usage_hours = 0

class HealthDataAnalyzer:
    """å¥åº·æ•°æ®åˆ†æå™¨"""
    
    def __init__(self):
        self.anomaly_thresholds = {
            'heart_rate': {'min': 60, 'max': 100},
            'systolic_bp': {'min': 90, 'max': 140},
            'diastolic_bp': {'min': 60, 'max': 90},
            'temperature': {'min': 36.1, 'max': 37.2},
            'respiratory_rate': {'min': 12, 'max': 20},
            'oxygen_saturation': {'min': 95, 'max': 100}
        }
    
    def detect_anomalies(self, vital_signs: VitalSigns) -> Dict[str, bool]:
        """æ£€æµ‹å¼‚å¸¸"""
        anomalies = {}
        normal_ranges = vital_signs.is_normal()
        
        for metric, is_normal in normal_ranges.items():
            anomalies[metric] = not is_normal
        
        return anomalies
    
    def analyze_trend(self, vital_signs_history: List[VitalSigns], 
                     metric: str, window_size: int = 10) -> Dict[str, Any]:
        """åˆ†æè¶‹åŠ¿"""
        if len(vital_signs_history) < window_size:
            return {'trend': 'insufficient_data', 'slope': 0, 'volatility': 0}
        
        # è·å–æœ€è¿‘çš„æ•°å€¼
        recent_data = []
        for vs in vital_signs_history[-window_size:]:
            if hasattr(vs, metric):
                recent_data.append(getattr(vs, metric))
        
        if len(recent_data) < 2:
            return {'trend': 'insufficient_data', 'slope': 0, 'volatility': 0}
        
        # è®¡ç®—è¶‹åŠ¿
        x = np.arange(len(recent_data))
        slope, intercept = np.polyfit(x, recent_data, 1)
        
        # è®¡ç®—æ³¢åŠ¨æ€§
        volatility = np.std(recent_data)
        
        # åˆ¤æ–­è¶‹åŠ¿
        if slope > 0.1:
            trend = "increasing"
        elif slope < -0.1:
            trend = "decreasing"
        else:
            trend = "stable"
        
        return {
            'trend': trend,
            'slope': slope,
            'volatility': volatility,
            'current_value': recent_data[-1],
            'average_value': np.mean(recent_data)
        }
    
    def predict_health_risk(self, patient: Patient) -> Dict[str, float]:
        """é¢„æµ‹å¥åº·é£é™©"""
        risk_scores = {}
        
        # åŸºäºç”Ÿå‘½ä½“å¾çš„é£é™©è¯„åˆ†
        latest_vs = patient.get_latest_vital_signs()
        if latest_vs:
            anomalies = self.detect_anomalies(latest_vs)
            risk_scores['vital_signs'] = sum(anomalies.values()) / len(anomalies)
        
        # åŸºäºç—…å²çš„é£é™©è¯„åˆ†
        risk_scores['medical_history'] = len(patient.medical_history.chronic_conditions) * 0.1
        
        # åŸºäºå¹´é¾„çš„é£é™©è¯„åˆ†
        age = patient.personal_info.get_age()
        if age > 65:
            risk_scores['age'] = 0.3
        elif age > 50:
            risk_scores['age'] = 0.2
        else:
            risk_scores['age'] = 0.1
        
        # åŸºäºBMIçš„é£é™©è¯„åˆ†
        bmi = patient.personal_info.calculate_bmi()
        if bmi > 30:
            risk_scores['bmi'] = 0.3
        elif bmi > 25:
            risk_scores['bmi'] = 0.2
        else:
            risk_scores['bmi'] = 0.1
        
        # è®¡ç®—æ€»ä½“é£é™©
        total_risk = sum(risk_scores.values()) / len(risk_scores)
        
        return {
            'total_risk': total_risk,
            'component_risks': risk_scores
        }

class ElectronicHealthRecord:
    """ç”µå­å¥åº·è®°å½•"""
    
    def __init__(self):
        self.patients: Dict[str, Patient] = {}
        self.doctors: Dict[str, Doctor] = {}
        self.devices: Dict[str, MedicalDevice] = {}
        self.appointments: Dict[str, Appointment] = {}
        self.data_analyzer = HealthDataAnalyzer()
    
    def add_patient(self, patient: Patient) -> None:
        """æ·»åŠ æ‚£è€…"""
        self.patients[patient.patient_id] = patient
    
    def add_doctor(self, doctor: Doctor) -> None:
        """æ·»åŠ åŒ»ç”Ÿ"""
        self.doctors[doctor.doctor_id] = doctor
    
    def add_device(self, device: MedicalDevice) -> None:
        """æ·»åŠ è®¾å¤‡"""
        self.devices[device.device_id] = device
    
    def create_appointment(self, patient_id: str, doctor_id: str, 
                          appointment_time: datetime, duration: int = 30) -> Optional[Appointment]:
        """åˆ›å»ºé¢„çº¦"""
        if patient_id not in self.patients or doctor_id not in self.doctors:
            return None
        
        doctor = self.doctors[doctor_id]
        if not doctor.is_available(appointment_time):
            return None
        
        appointment_id = str(uuid.uuid4())
        appointment = Appointment(
            appointment_id=appointment_id,
            patient_id=patient_id,
            doctor_id=doctor_id,
            appointment_time=appointment_time,
            duration=duration
        )
        
        self.appointments[appointment_id] = appointment
        doctor.add_appointment(appointment)
        self.patients[patient_id].add_appointment(appointment)
        
        return appointment
    
    def record_vital_signs(self, patient_id: str, vital_signs: VitalSigns) -> None:
        """è®°å½•ç”Ÿå‘½ä½“å¾"""
        if patient_id in self.patients:
            self.patients[patient_id].add_vital_signs(vital_signs)
    
    def get_patient_summary(self, patient_id: str) -> Dict[str, Any]:
        """è·å–æ‚£è€…æ‘˜è¦"""
        if patient_id not in self.patients:
            return {}
        
        patient = self.patients[patient_id]
        latest_vs = patient.get_latest_vital_signs()
        
        summary = {
            'patient_id': patient_id,
            'name': f"{patient.personal_info.first_name} {patient.personal_info.last_name}",
            'age': patient.personal_info.get_age(),
            'bmi': patient.personal_info.calculate_bmi(),
            'active_treatments': len(patient.get_active_treatments()),
            'upcoming_appointments': len(patient.get_upcoming_appointments())
        }
        
        if latest_vs:
            summary['latest_vital_signs'] = latest_vs.to_dict()
            summary['vital_signs_anomalies'] = self.data_analyzer.detect_anomalies(latest_vs)
        
        return summary
    
    def generate_health_report(self, patient_id: str) -> Dict[str, Any]:
        """ç”Ÿæˆå¥åº·æŠ¥å‘Š"""
        if patient_id not in self.patients:
            return {}
        
        patient = self.patients[patient_id]
        risk_assessment = self.data_analyzer.predict_health_risk(patient)
        
        report = {
            'patient_info': {
                'name': f"{patient.personal_info.first_name} {patient.personal_info.last_name}",
                'age': patient.personal_info.get_age(),
                'gender': patient.personal_info.gender.value,
                'blood_type': patient.personal_info.blood_type.value,
                'bmi': patient.personal_info.calculate_bmi()
            },
            'medical_history': {
                'allergies': patient.medical_history.allergies,
                'chronic_conditions': patient.medical_history.chronic_conditions,
                'surgeries': len(patient.medical_history.surgeries),
                'current_medications': len([m for m in patient.medical_history.medications 
                                          if m['end_date'] is None])
            },
            'current_status': {
                'active_treatments': len(patient.get_active_treatments()),
                'upcoming_appointments': len(patient.get_upcoming_appointments())
            },
            'risk_assessment': risk_assessment
        }
        
        # æ·»åŠ ç”Ÿå‘½ä½“å¾è¶‹åŠ¿åˆ†æ
        if patient.vital_signs_history:
            trends = {}
            for metric in ['heart_rate', 'systolic_bp', 'temperature']:
                trends[metric] = self.data_analyzer.analyze_trend(
                    patient.vital_signs_history, metric
                )
            report['vital_signs_trends'] = trends
        
        return report
```

### 3.2 åŒ»ç–—è®¾å¤‡ç®¡ç†ç³»ç»Ÿ

```python
class MedicalDeviceManager:
    """åŒ»ç–—è®¾å¤‡ç®¡ç†å™¨"""
    
    def __init__(self):
        self.devices: Dict[str, MedicalDevice] = {}
        self.maintenance_schedule: Dict[str, List[datetime]] = defaultdict(list)
        self.usage_logs: List[Dict[str, Any]] = []
    
    def add_device(self, device: MedicalDevice) -> None:
        """æ·»åŠ è®¾å¤‡"""
        self.devices[device.device_id] = device
    
    def remove_device(self, device_id: str) -> None:
        """ç§»é™¤è®¾å¤‡"""
        if device_id in self.devices:
            del self.devices[device_id]
    
    def get_available_devices(self, device_type: Optional[str] = None) -> List[MedicalDevice]:
        """è·å–å¯ç”¨è®¾å¤‡"""
        available = []
        for device in self.devices.values():
            if device.status == "available":
                if device_type is None or device.device_type == device_type:
                    available.append(device)
        return available
    
    def assign_device(self, device_id: str, patient_id: str) -> bool:
        """åˆ†é…è®¾å¤‡"""
        if device_id in self.devices:
            device = self.devices[device_id]
            if device.start_use(patient_id):
                self.usage_logs.append({
                    'device_id': device_id,
                    'patient_id': patient_id,
                    'start_time': datetime.now(),
                    'action': 'assigned'
                })
                return True
        return False
    
    def release_device(self, device_id: str) -> None:
        """é‡Šæ”¾è®¾å¤‡"""
        if device_id in self.devices:
            device = self.devices[device_id]
            device.end_use()
            self.usage_logs.append({
                'device_id': device_id,
                'patient_id': device.current_patient_id,
                'end_time': datetime.now(),
                'action': 'released'
            })
    
    def schedule_maintenance(self, device_id: str, maintenance_date: datetime) -> None:
        """å®‰æ’ç»´æŠ¤"""
        if device_id in self.devices:
            device = self.devices[device_id]
            device.schedule_maintenance(maintenance_date)
            self.maintenance_schedule[device_id].append(maintenance_date)
    
    def get_maintenance_alerts(self) -> List[Dict[str, Any]]:
        """è·å–ç»´æŠ¤è­¦æŠ¥"""
        alerts = []
        for device_id, device in self.devices.items():
            if device.next_maintenance and device.next_maintenance <= datetime.now():
                alerts.append({
                    'device_id': device_id,
                    'device_name': device.device_name,
                    'maintenance_date': device.next_maintenance,
                    'urgency': 'high' if device.next_maintenance < datetime.now() else 'medium'
                })
        return alerts
    
    def get_device_utilization(self, device_id: str, days: int = 30) -> float:
        """è·å–è®¾å¤‡åˆ©ç”¨ç‡"""
        if device_id not in self.devices:
            return 0.0
        
        device = self.devices[device_id]
        end_date = datetime.now()
        start_date = end_date - timedelta(days=days)
        
        # è®¡ç®—ä½¿ç”¨æ—¶é—´
        usage_time = 0
        for log in self.usage_logs:
            if log['device_id'] == device_id and 'start_time' in log and 'end_time' in log:
                if start_date <= log['start_time'] <= end_date:
                    duration = log['end_time'] - log['start_time']
                    usage_time += duration.total_seconds() / 3600  # è½¬æ¢ä¸ºå°æ—¶
        
        total_time = days * 24  # æ€»æ—¶é—´ï¼ˆå°æ—¶ï¼‰
        return usage_time / total_time if total_time > 0 else 0.0

class HealthDataProcessor:
    """å¥åº·æ•°æ®å¤„ç†å™¨"""
    
    def __init__(self):
        self.data_cache: Dict[str, List[Dict[str, Any]]] = defaultdict(list)
        self.processors: Dict[str, 'DataProcessor'] = {}
    
    def add_data(self, patient_id: str, data_type: str, value: Any, 
                 timestamp: Optional[datetime] = None) -> None:
        """æ·»åŠ æ•°æ®"""
        if timestamp is None:
            timestamp = datetime.now()
        
        data_point = {
            'patient_id': patient_id,
            'data_type': data_type,
            'value': value,
            'timestamp': timestamp
        }
        
        self.data_cache[patient_id].append(data_point)
    
    def get_patient_data(self, patient_id: str, data_type: Optional[str] = None,
                        start_time: Optional[datetime] = None,
                        end_time: Optional[datetime] = None) -> List[Dict[str, Any]]:
        """è·å–æ‚£è€…æ•°æ®"""
        if patient_id not in self.data_cache:
            return []
        
        data = self.data_cache[patient_id]
        
        # è¿‡æ»¤æ•°æ®ç±»å‹
        if data_type:
            data = [d for d in data if d['data_type'] == data_type]
        
        # è¿‡æ»¤æ—¶é—´èŒƒå›´
        if start_time:
            data = [d for d in data if d['timestamp'] >= start_time]
        if end_time:
            data = [d for d in data if d['timestamp'] <= end_time]
        
        return sorted(data, key=lambda x: x['timestamp'])
    
    def register_processor(self, data_type: str, processor: 'DataProcessor') -> None:
        """æ³¨å†Œæ•°æ®å¤„ç†å™¨"""
        self.processors[data_type] = processor
    
    def process_data(self, patient_id: str, data_type: str) -> Optional[Dict[str, Any]]:
        """å¤„ç†æ•°æ®"""
        if data_type not in self.processors:
            return None
        
        data = self.get_patient_data(patient_id, data_type)
        if not data:
            return None
        
        processor = self.processors[data_type]
        return processor.process(data)

class DataProcessor(ABC):
    """æ•°æ®å¤„ç†å™¨æŠ½è±¡åŸºç±»"""
    
    @abstractmethod
    def process(self, data: List[Dict[str, Any]]) -> Dict[str, Any]:
        """å¤„ç†æ•°æ®"""
        pass

class VitalSignsProcessor(DataProcessor):
    """ç”Ÿå‘½ä½“å¾å¤„ç†å™¨"""
    
    def process(self, data: List[Dict[str, Any]]) -> Dict[str, Any]:
        """å¤„ç†ç”Ÿå‘½ä½“å¾æ•°æ®"""
        if not data:
            return {}
        
        # æŒ‰æ•°æ®ç±»å‹åˆ†ç»„
        grouped_data = defaultdict(list)
        for point in data:
            grouped_data[point['data_type']].append(point['value'])
        
        result = {}
        for data_type, values in grouped_data.items():
            result[data_type] = {
                'count': len(values),
                'mean': np.mean(values),
                'std': np.std(values),
                'min': np.min(values),
                'max': np.max(values),
                'latest': values[-1] if values else None
            }
        
        return result

class MedicationProcessor(DataProcessor):
    """è¯ç‰©å¤„ç†å™¨"""
    
    def process(self, data: List[Dict[str, Any]]) -> Dict[str, Any]:
        """å¤„ç†è¯ç‰©æ•°æ®"""
        if not data:
            return {}
        
        # ç»Ÿè®¡è¯ç‰©ä½¿ç”¨æƒ…å†µ
        medication_count = defaultdict(int)
        for point in data:
            medication_name = point.get('medication_name', 'unknown')
            medication_count[medication_name] += 1
        
        return {
            'total_medications': len(data),
            'unique_medications': len(medication_count),
            'medication_frequency': dict(medication_count),
            'most_used': max(medication_count.items(), key=lambda x: x[1])[0] if medication_count else None
        }
```

## 4. ç†è®ºè¯æ˜

### 4.1 æ•°æ®å®Œæ•´æ€§

**å®šç† 4.1** (æ•°æ®å®Œæ•´æ€§)
å¦‚æœåŒ»ç–—æ•°æ®ä½¿ç”¨æ•°å­—ç­¾åè¿›è¡Œä¿æŠ¤ï¼Œåˆ™æ•°æ®çš„å®Œæ•´æ€§å¾—åˆ°ä¿è¯ã€‚

**è¯æ˜**:
è®¾åŸå§‹æ•°æ®ä¸º $m$ï¼Œæ•°å­—ç­¾åä¸º $\sigma = \text{Sign}(sk, H(m))$ã€‚
éªŒè¯æ—¶è®¡ç®— $\text{Verify}(pk, m, \sigma)$ï¼Œå¦‚æœæ•°æ®è¢«ç¯¡æ”¹ï¼Œå“ˆå¸Œå€¼ä¼šæ”¹å˜ï¼ŒéªŒè¯å°†å¤±è´¥ã€‚

### 4.2 éšç§ä¿æŠ¤

**å®šç† 4.2** (éšç§ä¿æŠ¤)
å¦‚æœä½¿ç”¨åŒæ€åŠ å¯†å¯¹åŒ»ç–—æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œåˆ™å¯ä»¥åœ¨ä¸è§£å¯†çš„æƒ…å†µä¸‹è¿›è¡ŒæŸäº›è®¡ç®—ã€‚

**è¯æ˜**:
åŒæ€åŠ å¯†æ»¡è¶³ï¼š
$$E(m_1) \oplus E(m_2) = E(m_1 + m_2)$$

å› æ­¤å¯ä»¥åœ¨åŠ å¯†åŸŸä¸­è¿›è¡ŒåŠ æ³•è¿ç®—ã€‚

### 4.3 å¼‚å¸¸æ£€æµ‹å‡†ç¡®æ€§

**å®šç† 4.3** (å¼‚å¸¸æ£€æµ‹)
åŸºäºç»Ÿè®¡æ–¹æ³•çš„å¼‚å¸¸æ£€æµ‹èƒ½å¤Ÿè¯†åˆ«åç¦»æ­£å¸¸èŒƒå›´çš„å¥åº·æ•°æ®ã€‚

**è¯æ˜**:
è®¾æ­£å¸¸æ•°æ®åˆ†å¸ƒä¸º $N(\mu, \sigma^2)$ï¼Œåˆ™å¼‚å¸¸æ£€æµ‹é˜ˆå€¼å¯ä»¥è®¾ç½®ä¸ºï¼š
$$\mu \pm k\sigma$$

å…¶ä¸­ $k$ æ˜¯ç½®ä¿¡åº¦å‚æ•°ï¼Œé€šå¸¸å– $k = 2$ æˆ– $k = 3$ã€‚

## 5. æ€§èƒ½åˆ†æ

### 5.1 æ•°æ®å¤„ç†æ€§èƒ½

- **æ•°æ®å­˜å‚¨**: $O(n)$ å…¶ä¸­ $n$ æ˜¯æ•°æ®ç‚¹æ•°é‡
- **æ•°æ®æŸ¥è¯¢**: $O(\log n)$ ä½¿ç”¨ç´¢å¼•
- **æ•°æ®åˆ†æ**: $O(m \cdot n)$ å…¶ä¸­ $m$ æ˜¯åˆ†æç®—æ³•å¤æ‚åº¦

### 5.2 ç³»ç»Ÿå“åº”æ€§èƒ½

- **æ‚£è€…æŸ¥è¯¢**: $O(1)$ ä½¿ç”¨å“ˆå¸Œè¡¨
- **é¢„çº¦è°ƒåº¦**: $O(\log n)$ ä½¿ç”¨ä¼˜å…ˆé˜Ÿåˆ—
- **è®¾å¤‡åˆ†é…**: $O(k)$ å…¶ä¸­ $k$ æ˜¯å¯ç”¨è®¾å¤‡æ•°é‡

### 5.3 å­˜å‚¨æ€§èƒ½

- **æ‚£è€…è®°å½•**: $O(p \cdot r)$ å…¶ä¸­ $p$ æ˜¯æ‚£è€…æ•°é‡ï¼Œ$r$ æ˜¯è®°å½•æ•°é‡
- **è®¾å¤‡çŠ¶æ€**: $O(d)$ å…¶ä¸­ $d$ æ˜¯è®¾å¤‡æ•°é‡
- **å®¡è®¡æ—¥å¿—**: $O(l)$ å…¶ä¸­ $l$ æ˜¯æ—¥å¿—æ¡ç›®æ•°é‡

## 6. åº”ç”¨ç¤ºä¾‹

### 6.1 åŒ»ç–—ä¿¡æ¯ç³»ç»Ÿ

```python
def create_medical_system():
    """åˆ›å»ºåŒ»ç–—ä¿¡æ¯ç³»ç»Ÿ"""
    # åˆ›å»ºEHRç³»ç»Ÿ
    ehr = ElectronicHealthRecord()
    
    # æ·»åŠ åŒ»ç”Ÿ
    doctor = Doctor("doc001", "Dr. Smith", "Cardiology", "MD123456")
    ehr.add_doctor(doctor)
    
    # æ·»åŠ æ‚£è€…
    personal_info = PersonalInfo(
        first_name="John",
        last_name="Doe",
        date_of_birth=datetime(1980, 5, 15),
        gender=Gender.MALE,
        blood_type=BloodType.A_POSITIVE,
        height=175,
        weight=70,
        contact_number="123-456-7890",
        email="john.doe@email.com",
        address="123 Main St"
    )
    patient = Patient("pat001", personal_info)
    ehr.add_patient(patient)
    
    # è®°å½•ç”Ÿå‘½ä½“å¾
    vital_signs = VitalSigns()
    vital_signs.heart_rate = 75
    vital_signs.systolic_bp = 120
    vital_signs.diastolic_bp = 80
    vital_signs.temperature = 36.8
    vital_signs.respiratory_rate = 16
    vital_signs.oxygen_saturation = 98
    
    ehr.record_vital_signs("pat001", vital_signs)
    
    # åˆ›å»ºé¢„çº¦
    appointment_time = datetime.now() + timedelta(days=7)
    appointment = ehr.create_appointment("pat001", "doc001", appointment_time)
    
    # ç”Ÿæˆæ‚£è€…æ‘˜è¦
    summary = ehr.get_patient_summary("pat001")
    print(f"æ‚£è€…æ‘˜è¦: {summary}")
    
    return ehr

def create_device_management_system():
    """åˆ›å»ºè®¾å¤‡ç®¡ç†ç³»ç»Ÿ"""
    # åˆ›å»ºè®¾å¤‡ç®¡ç†å™¨
    device_manager = MedicalDeviceManager()
    
    # æ·»åŠ è®¾å¤‡
    device1 = MedicalDevice("dev001", "ECG Machine", "ECG")
    device2 = MedicalDevice("dev002", "Blood Pressure Monitor", "BP")
    device3 = MedicalDevice("dev003", "X-Ray Machine", "Imaging")
    
    device_manager.add_device(device1)
    device_manager.add_device(device2)
    device_manager.add_device(device3)
    
    # åˆ†é…è®¾å¤‡
    device_manager.assign_device("dev001", "pat001")
    
    # æ£€æŸ¥å¯ç”¨è®¾å¤‡
    available_devices = device_manager.get_available_devices()
    print(f"å¯ç”¨è®¾å¤‡æ•°é‡: {len(available_devices)}")
    
    # å®‰æ’ç»´æŠ¤
    maintenance_date = datetime.now() + timedelta(days=30)
    device_manager.schedule_maintenance("dev003", maintenance_date)
    
    return device_manager

def create_health_data_analysis():
    """åˆ›å»ºå¥åº·æ•°æ®åˆ†æ"""
    # åˆ›å»ºæ•°æ®å¤„ç†å™¨
    data_processor = HealthDataProcessor()
    
    # æ³¨å†Œå¤„ç†å™¨
    vital_signs_processor = VitalSignsProcessor()
    data_processor.register_processor("vital_signs", vital_signs_processor)
    
    # æ·»åŠ æ•°æ®
    for i in range(10):
        timestamp = datetime.now() - timedelta(hours=i)
        data_processor.add_data("pat001", "heart_rate", 70 + np.random.normal(0, 5), timestamp)
        data_processor.add_data("pat001", "blood_pressure", 120 + np.random.normal(0, 10), timestamp)
    
    # å¤„ç†æ•°æ®
    result = data_processor.process_data("pat001", "vital_signs")
    print(f"æ•°æ®åˆ†æç»“æœ: {result}")
    
    return data_processor
```

### 6.2 æ€§èƒ½æµ‹è¯•

```python
def performance_test():
    """æ€§èƒ½æµ‹è¯•"""
    import time
    
    # åˆ›å»ºEHRç³»ç»Ÿ
    ehr = ElectronicHealthRecord()
    
    # æ·»åŠ å¤§é‡æ‚£è€…
    start_time = time.time()
    for i in range(1000):
        personal_info = PersonalInfo(
            first_name=f"Patient{i}",
            last_name="Test",
            date_of_birth=datetime(1980, 1, 1),
            gender=Gender.MALE,
            blood_type=BloodType.A_POSITIVE,
            height=170,
            weight=70,
            contact_number=f"123-456-{i:04d}",
            email=f"patient{i}@test.com",
            address=f"Address {i}"
        )
        patient = Patient(f"pat{i:04d}", personal_info)
        ehr.add_patient(patient)
    add_patients_time = time.time() - start_time
    
    # æµ‹è¯•æŸ¥è¯¢æ€§èƒ½
    start_time = time.time()
    for i in range(100):
        summary = ehr.get_patient_summary(f"pat{i:04d}")
    query_time = time.time() - start_time
    
    print(f"æ·»åŠ 1000ä¸ªæ‚£è€…è€—æ—¶: {add_patients_time:.4f}ç§’")
    print(f"æŸ¥è¯¢100ä¸ªæ‚£è€…æ‘˜è¦è€—æ—¶: {query_time:.4f}ç§’")
    print(f"å¹³å‡æŸ¥è¯¢æ—¶é—´: {query_time/100:.6f}ç§’")

if __name__ == "__main__":
    # è¿è¡Œç¤ºä¾‹
    print("=== åŒ»ç–—å¥åº·åŸºç¡€ç¤ºä¾‹ ===")
    
    # åˆ›å»ºåŒ»ç–—ä¿¡æ¯ç³»ç»Ÿ
    print("\n1. åŒ»ç–—ä¿¡æ¯ç³»ç»Ÿ")
    ehr = create_medical_system()
    
    # åˆ›å»ºè®¾å¤‡ç®¡ç†ç³»ç»Ÿ
    print("\n2. è®¾å¤‡ç®¡ç†ç³»ç»Ÿ")
    device_manager = create_device_management_system()
    
    # åˆ›å»ºå¥åº·æ•°æ®åˆ†æ
    print("\n3. å¥åº·æ•°æ®åˆ†æ")
    data_processor = create_health_data_analysis()
    
    # æ€§èƒ½æµ‹è¯•
    print("\n4. æ€§èƒ½æµ‹è¯•")
    performance_test()
```

## 7. æ€»ç»“

æœ¬æ–‡æ¡£æ„å»ºäº†å®Œæ•´çš„åŒ»ç–—å¥åº·ç†è®ºåŸºç¡€ï¼ŒåŒ…æ‹¬ï¼š

1. **å½¢å¼åŒ–å®šä¹‰**: åŒ»ç–—ç³»ç»Ÿã€æ‚£è€…è®°å½•ã€å¥åº·æ•°æ®çš„ä¸¥æ ¼æ•°å­¦å®šä¹‰
2. **æ ¸å¿ƒæ¦‚å¿µ**: ç”µå­å¥åº·è®°å½•ã€å¥åº·æ•°æ®åˆ†æã€åŒ»ç–—è®¾å¤‡ç®¡ç†
3. **Pythonå®ç°**: å®Œæ•´çš„åŒ»ç–—ä¿¡æ¯ç³»ç»Ÿå®ç°
4. **ç†è®ºè¯æ˜**: æ•°æ®å®Œæ•´æ€§ã€éšç§ä¿æŠ¤ã€å¼‚å¸¸æ£€æµ‹çš„æ•°å­¦è¯æ˜
5. **æ€§èƒ½åˆ†æ**: æ•°æ®å¤„ç†ã€ç³»ç»Ÿå“åº”ã€å­˜å‚¨å¤æ‚åº¦åˆ†æ
6. **åº”ç”¨ç¤ºä¾‹**: åŒ»ç–—ä¿¡æ¯ç³»ç»Ÿã€è®¾å¤‡ç®¡ç†ç³»ç»Ÿã€å¥åº·æ•°æ®åˆ†æ

åŒ»ç–—å¥åº·ç³»ç»Ÿé€šè¿‡ä¿¡æ¯æŠ€æœ¯æé«˜åŒ»ç–—æœåŠ¡è´¨é‡ï¼Œæ”¹å–„æ‚£è€…ä½“éªŒï¼Œé™ä½åŒ»ç–—æˆæœ¬ï¼Œæ˜¯ç°ä»£åŒ»ç–—ä½“ç³»çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚

---

*æœ€åæ›´æ–°: 2024-12-19*
*ä¸‹æ¬¡æ›´æ–°: å®Œæˆæ•™è‚²ç§‘æŠ€é¢†åŸŸæ–‡æ¡£*
