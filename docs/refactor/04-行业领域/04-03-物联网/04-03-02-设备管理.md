# 04-03-02 è®¾å¤‡ç®¡ç†

## ğŸ“‹ ç›®å½•

- [04-03-02 è®¾å¤‡ç®¡ç†](#04-03-02-è®¾å¤‡ç®¡ç†)
  - [ğŸ“‹ ç›®å½•](#-ç›®å½•)
  - [ğŸ¯ æ¦‚è¿°](#-æ¦‚è¿°)
  - [ğŸ”¬ æ¦‚å¿µå®šä¹‰](#-æ¦‚å¿µå®šä¹‰)
    - [å®šä¹‰ 2.1 (è®¾å¤‡ç®¡ç†)](#å®šä¹‰-21-è®¾å¤‡ç®¡ç†)
    - [å®šä¹‰ 2.2 (è®¾å¤‡çŠ¶æ€)](#å®šä¹‰-22-è®¾å¤‡çŠ¶æ€)
    - [å®šä¹‰ 2.3 (è®¾å¤‡å¥åº·åº¦)](#å®šä¹‰-23-è®¾å¤‡å¥åº·åº¦)
  - [ğŸ“ æ•°å­¦å½¢å¼åŒ–](#-æ•°å­¦å½¢å¼åŒ–)
    - [å®šç† 2.1 (è®¾å¤‡å¯ç”¨æ€§)](#å®šç†-21-è®¾å¤‡å¯ç”¨æ€§)
    - [å®šç† 2.2 (è®¾å¤‡è´Ÿè½½å‡è¡¡)](#å®šç†-22-è®¾å¤‡è´Ÿè½½å‡è¡¡)
  - [ğŸ Pythonå®ç°](#-pythonå®ç°)
    - [1. è®¾å¤‡æ³¨å†Œç®¡ç†](#1-è®¾å¤‡æ³¨å†Œç®¡ç†)
    - [2. è®¾å¤‡ç›‘æ§ç³»ç»Ÿ](#2-è®¾å¤‡ç›‘æ§ç³»ç»Ÿ)
    - [3. è®¾å¤‡é…ç½®ç®¡ç†](#3-è®¾å¤‡é…ç½®ç®¡ç†)
    - [4. è®¾å¤‡æ›´æ–°ç®¡ç†](#4-è®¾å¤‡æ›´æ–°ç®¡ç†)
  - [ğŸ“Š ç®¡ç†ç­–ç•¥](#-ç®¡ç†ç­–ç•¥)
    - [è®¾å¤‡ç®¡ç†ç­–ç•¥å¯¹æ¯”](#è®¾å¤‡ç®¡ç†ç­–ç•¥å¯¹æ¯”)
  - [ğŸ”„ å·¥ä½œæµç¨‹](#-å·¥ä½œæµç¨‹)
    - [è®¾å¤‡ç®¡ç†å·¥ä½œæµç¨‹](#è®¾å¤‡ç®¡ç†å·¥ä½œæµç¨‹)
  - [ğŸ“ˆ åº”ç”¨æ¡ˆä¾‹](#-åº”ç”¨æ¡ˆä¾‹)
    - [æ¡ˆä¾‹1ï¼šæ™ºèƒ½å·¥å‚è®¾å¤‡ç®¡ç†](#æ¡ˆä¾‹1æ™ºèƒ½å·¥å‚è®¾å¤‡ç®¡ç†)
  - [ğŸ”— ç›¸å…³é“¾æ¥](#-ç›¸å…³é“¾æ¥)

## ğŸ¯ æ¦‚è¿°

IoTè®¾å¤‡ç®¡ç†æ˜¯ç‰©è”ç½‘ç³»ç»Ÿçš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£è®¾å¤‡çš„æ³¨å†Œã€ç›‘æ§ã€é…ç½®ã€æ›´æ–°å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚æœ¬æ–‡æ¡£ä»å½¢å¼åŒ–å®šä¹‰ã€æ•°å­¦åŸºç¡€ã€Pythonå®ç°ç­‰å¤šä¸ªç»´åº¦å…¨é¢é˜è¿°è®¾å¤‡ç®¡ç†ç†è®ºã€‚

## ğŸ”¬ æ¦‚å¿µå®šä¹‰

### å®šä¹‰ 2.1 (è®¾å¤‡ç®¡ç†)

è®¾å¤‡ç®¡ç†æ˜¯IoTè®¾å¤‡å…¨ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ç³»ç»Ÿï¼š

$$DM = (R, M, C, U, L)$$

å…¶ä¸­ï¼š

- $R$ æ˜¯è®¾å¤‡æ³¨å†Œ
- $M$ æ˜¯è®¾å¤‡ç›‘æ§
- $C$ æ˜¯è®¾å¤‡é…ç½®
- $U$ æ˜¯è®¾å¤‡æ›´æ–°
- $L$ æ˜¯ç”Ÿå‘½å‘¨æœŸç®¡ç†

### å®šä¹‰ 2.2 (è®¾å¤‡çŠ¶æ€)

è®¾å¤‡çŠ¶æ€æœºå®šä¹‰ï¼š

$$S = \{offline, online, error, maintenance, updating\}$$

çŠ¶æ€è½¬æ¢å‡½æ•°ï¼š$T: S \times E \rightarrow S$

### å®šä¹‰ 2.3 (è®¾å¤‡å¥åº·åº¦)

è®¾å¤‡å¥åº·åº¦æ¨¡å‹ï¼š

$$H = \frac{\sum_{i=1}^{n} w_i \cdot h_i}{\sum_{i=1}^{n} w_i}$$

å…¶ä¸­ $h_i$ æ˜¯ç¬¬ $i$ ä¸ªå¥åº·æŒ‡æ ‡ï¼Œ$w_i$ æ˜¯æƒé‡ã€‚

## ğŸ“ æ•°å­¦å½¢å¼åŒ–

### å®šç† 2.1 (è®¾å¤‡å¯ç”¨æ€§)

è®¾å¤‡å¯ç”¨æ€§è®¡ç®—ï¼š

$$A = \frac{MTBF}{MTBF + MTTR}$$

å…¶ä¸­ï¼š

- $MTBF$ æ˜¯å¹³å‡æ•…éšœé—´éš”æ—¶é—´
- $MTTR$ æ˜¯å¹³å‡ä¿®å¤æ—¶é—´

### å®šç† 2.2 (è®¾å¤‡è´Ÿè½½å‡è¡¡)

è´Ÿè½½å‡è¡¡ç®—æ³•å¤æ‚åº¦ï¼š

$$O(LB_{round\_robin}) = O(1)$$
$$O(LB_{least\_connections}) = O(n)$$

## ğŸ Pythonå®ç°

### 1. è®¾å¤‡æ³¨å†Œç®¡ç†

```python
import uuid
import time
from typing import Dict, List, Optional
from dataclasses import dataclass
from enum import Enum

class DeviceStatus(Enum):
    OFFLINE = "offline"
    ONLINE = "online"
    ERROR = "error"
    MAINTENANCE = "maintenance"
    UPDATING = "updating"

@dataclass
class DeviceInfo:
    device_id: str
    device_type: str
    location: str
    capabilities: List[str]
    firmware_version: str
    registration_time: float
    last_seen: float

class DeviceRegistry:
    """è®¾å¤‡æ³¨å†Œè¡¨"""
    
    def __init__(self):
        self.devices = {}
        self.device_groups = {}
    
    def register_device(self, device_info: DeviceInfo) -> bool:
        """æ³¨å†Œè®¾å¤‡"""
        try:
            self.devices[device_info.device_id] = device_info
            print(f"è®¾å¤‡ {device_info.device_id} æ³¨å†ŒæˆåŠŸ")
            return True
        except Exception as e:
            print(f"è®¾å¤‡æ³¨å†Œå¤±è´¥: {e}")
            return False
    
    def unregister_device(self, device_id: str) -> bool:
        """æ³¨é”€è®¾å¤‡"""
        if device_id in self.devices:
            del self.devices[device_id]
            print(f"è®¾å¤‡ {device_id} æ³¨é”€æˆåŠŸ")
            return True
        return False
    
    def get_device(self, device_id: str) -> Optional[DeviceInfo]:
        """è·å–è®¾å¤‡ä¿¡æ¯"""
        return self.devices.get(device_id)
    
    def list_devices(self) -> List[DeviceInfo]:
        """åˆ—å‡ºæ‰€æœ‰è®¾å¤‡"""
        return list(self.devices.values())
    
    def search_devices(self, criteria: Dict[str, str]) -> List[DeviceInfo]:
        """æœç´¢è®¾å¤‡"""
        results = []
        for device in self.devices.values():
            match = True
            for key, value in criteria.items():
                if hasattr(device, key):
                    if getattr(device, key) != value:
                        match = False
                        break
                else:
                    match = False
                    break
            if match:
                results.append(device)
        return results
```

### 2. è®¾å¤‡ç›‘æ§ç³»ç»Ÿ

```python
class DeviceMonitor:
    """è®¾å¤‡ç›‘æ§å™¨"""
    
    def __init__(self):
        self.device_status = {}
        self.health_metrics = {}
        self.alert_rules = {}
    
    def update_device_status(self, device_id: str, status: DeviceStatus):
        """æ›´æ–°è®¾å¤‡çŠ¶æ€"""
        self.device_status[device_id] = {
            "status": status,
            "timestamp": time.time()
        }
    
    def get_device_status(self, device_id: str) -> Optional[Dict]:
        """è·å–è®¾å¤‡çŠ¶æ€"""
        return self.device_status.get(device_id)
    
    def add_health_metric(self, device_id: str, metric_name: str, value: float):
        """æ·»åŠ å¥åº·æŒ‡æ ‡"""
        if device_id not in self.health_metrics:
            self.health_metrics[device_id] = {}
        
        if metric_name not in self.health_metrics[device_id]:
            self.health_metrics[device_id][metric_name] = []
        
        self.health_metrics[device_id][metric_name].append({
            "value": value,
            "timestamp": time.time()
        })
    
    def calculate_health_score(self, device_id: str) -> float:
        """è®¡ç®—å¥åº·åˆ†æ•°"""
        if device_id not in self.health_metrics:
            return 0.0
        
        metrics = self.health_metrics[device_id]
        total_score = 0.0
        total_weight = 0.0
        
        # å®šä¹‰æŒ‡æ ‡æƒé‡
        weights = {
            "cpu_usage": 0.3,
            "memory_usage": 0.3,
            "network_latency": 0.2,
            "error_rate": 0.2
        }
        
        for metric_name, weight in weights.items():
            if metric_name in metrics and metrics[metric_name]:
                latest_value = metrics[metric_name][-1]["value"]
                
                # æ ¹æ®æŒ‡æ ‡ç±»å‹è®¡ç®—åˆ†æ•°
                if metric_name in ["cpu_usage", "memory_usage"]:
                    score = max(0, 100 - latest_value)
                elif metric_name == "network_latency":
                    score = max(0, 100 - latest_value * 10)
                elif metric_name == "error_rate":
                    score = max(0, 100 - latest_value * 100)
                else:
                    score = 100
                
                total_score += score * weight
                total_weight += weight
        
        return total_score / total_weight if total_weight > 0 else 0.0
    
    def add_alert_rule(self, rule_name: str, condition_func):
        """æ·»åŠ å‘Šè­¦è§„åˆ™"""
        self.alert_rules[rule_name] = condition_func
    
    def check_alerts(self) -> List[Dict]:
        """æ£€æŸ¥å‘Šè­¦"""
        alerts = []
        for rule_name, condition_func in self.alert_rules.items():
            try:
                if condition_func(self):
                    alerts.append({
                        "rule": rule_name,
                        "timestamp": time.time(),
                        "severity": "warning"
                    })
            except Exception as e:
                print(f"å‘Šè­¦è§„åˆ™æ‰§è¡Œé”™è¯¯: {e}")
        return alerts
```

### 3. è®¾å¤‡é…ç½®ç®¡ç†

```python
class DeviceConfiguration:
    """è®¾å¤‡é…ç½®ç®¡ç†"""
    
    def __init__(self):
        self.configs = {}
        self.config_templates = {}
        self.config_history = {}
    
    def set_config(self, device_id: str, config: Dict[str, Any]):
        """è®¾ç½®è®¾å¤‡é…ç½®"""
        if device_id not in self.config_history:
            self.config_history[device_id] = []
        
        # ä¿å­˜é…ç½®å†å²
        self.config_history[device_id].append({
            "config": self.configs.get(device_id, {}).copy(),
            "timestamp": time.time()
        })
        
        self.configs[device_id] = config
        print(f"è®¾å¤‡ {device_id} é…ç½®å·²æ›´æ–°")
    
    def get_config(self, device_id: str) -> Dict[str, Any]:
        """è·å–è®¾å¤‡é…ç½®"""
        return self.configs.get(device_id, {})
    
    def create_template(self, template_name: str, config_template: Dict[str, Any]):
        """åˆ›å»ºé…ç½®æ¨¡æ¿"""
        self.config_templates[template_name] = config_template
    
    def apply_template(self, device_id: str, template_name: str) -> bool:
        """åº”ç”¨é…ç½®æ¨¡æ¿"""
        if template_name not in self.config_templates:
            return False
        
        template = self.config_templates[template_name]
        self.set_config(device_id, template.copy())
        return True
    
    def rollback_config(self, device_id: str) -> bool:
        """å›æ»šé…ç½®"""
        if device_id in self.config_history and self.config_history[device_id]:
            previous_config = self.config_history[device_id][-1]["config"]
            self.configs[device_id] = previous_config
            self.config_history[device_id].pop()
            return True
        return False
```

### 4. è®¾å¤‡æ›´æ–°ç®¡ç†

```python
class DeviceUpdateManager:
    """è®¾å¤‡æ›´æ–°ç®¡ç†å™¨"""
    
    def __init__(self):
        self.update_queue = []
        self.update_history = {}
        self.firmware_repository = {}
    
    def add_firmware(self, version: str, firmware_data: bytes, device_types: List[str]):
        """æ·»åŠ å›ºä»¶"""
        self.firmware_repository[version] = {
            "data": firmware_data,
            "device_types": device_types,
            "timestamp": time.time()
        }
    
    def schedule_update(self, device_id: str, firmware_version: str, priority: int = 1):
        """è°ƒåº¦æ›´æ–°"""
        update_task = {
            "device_id": device_id,
            "firmware_version": firmware_version,
            "priority": priority,
            "status": "pending",
            "timestamp": time.time()
        }
        self.update_queue.append(update_task)
        self.update_queue.sort(key=lambda x: x["priority"], reverse=True)
    
    def process_updates(self) -> List[Dict]:
        """å¤„ç†æ›´æ–°é˜Ÿåˆ—"""
        completed_updates = []
        
        for update_task in self.update_queue[:]:
            if update_task["status"] == "pending":
                result = self._perform_update(update_task)
                if result:
                    update_task["status"] = "completed"
                    completed_updates.append(update_task)
                    self.update_queue.remove(update_task)
                else:
                    update_task["status"] = "failed"
        
        return completed_updates
    
    def _perform_update(self, update_task: Dict) -> bool:
        """æ‰§è¡Œæ›´æ–°"""
        device_id = update_task["device_id"]
        firmware_version = update_task["firmware_version"]
        
        try:
            # æ¨¡æ‹Ÿå›ºä»¶æ›´æ–°è¿‡ç¨‹
            print(f"æ­£åœ¨æ›´æ–°è®¾å¤‡ {device_id} åˆ°å›ºä»¶ç‰ˆæœ¬ {firmware_version}")
            time.sleep(2)  # æ¨¡æ‹Ÿæ›´æ–°æ—¶é—´
            
            # è®°å½•æ›´æ–°å†å²
            if device_id not in self.update_history:
                self.update_history[device_id] = []
            
            self.update_history[device_id].append({
                "firmware_version": firmware_version,
                "timestamp": time.time(),
                "status": "success"
            })
            
            return True
        except Exception as e:
            print(f"è®¾å¤‡ {device_id} æ›´æ–°å¤±è´¥: {e}")
            return False
    
    def get_update_history(self, device_id: str) -> List[Dict]:
        """è·å–æ›´æ–°å†å²"""
        return self.update_history.get(device_id, [])
```

## ğŸ“Š ç®¡ç†ç­–ç•¥

### è®¾å¤‡ç®¡ç†ç­–ç•¥å¯¹æ¯”

| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ | å¤æ‚åº¦ |
|------|----------|------|------|--------|
| é›†ä¸­å¼ç®¡ç† | å°å‹ç½‘ç»œ | ç®€å•ã€ç»Ÿä¸€ | å•ç‚¹æ•…éšœ | ä½ |
| åˆ†å¸ƒå¼ç®¡ç† | å¤§å‹ç½‘ç»œ | é«˜å¯ç”¨ã€å¯æ‰©å±• | ä¸€è‡´æ€§éš¾ä¿è¯ | é«˜ |
| åˆ†å±‚ç®¡ç† | ä¸­ç­‰è§„æ¨¡ | å¹³è¡¡æ€§èƒ½å’Œå¤æ‚åº¦ | ç®¡ç†å¤æ‚ | ä¸­ |
| è‡ªæ²»ç®¡ç† | è¾¹ç¼˜è®¾å¤‡ | ä½å»¶è¿Ÿã€ç‹¬ç«‹ | åè°ƒå›°éš¾ | ä¸­ |

## ğŸ”„ å·¥ä½œæµç¨‹

### è®¾å¤‡ç®¡ç†å·¥ä½œæµç¨‹

```python
def device_management_workflow():
    """è®¾å¤‡ç®¡ç†å®Œæ•´å·¥ä½œæµç¨‹"""
    
    # 1. åˆ›å»ºè®¾å¤‡æ³¨å†Œè¡¨
    registry = DeviceRegistry()
    
    # 2. åˆ›å»ºè®¾å¤‡ç›‘æ§å™¨
    monitor = DeviceMonitor()
    
    # 3. åˆ›å»ºè®¾å¤‡é…ç½®ç®¡ç†å™¨
    config_manager = DeviceConfiguration()
    
    # 4. åˆ›å»ºè®¾å¤‡æ›´æ–°ç®¡ç†å™¨
    update_manager = DeviceUpdateManager()
    
    # 5. æ³¨å†Œè®¾å¤‡
    device_info = DeviceInfo(
        device_id="sensor_001",
        device_type="temperature_sensor",
        location="room_101",
        capabilities=["temperature_reading"],
        firmware_version="1.0.0",
        registration_time=time.time(),
        last_seen=time.time()
    )
    
    registry.register_device(device_info)
    
    # 6. è®¾ç½®è®¾å¤‡é…ç½®
    config = {
        "sampling_rate": 30,
        "threshold": 25.0,
        "alert_enabled": True
    }
    config_manager.set_config("sensor_001", config)
    
    # 7. ç›‘æ§è®¾å¤‡çŠ¶æ€
    monitor.update_device_status("sensor_001", DeviceStatus.ONLINE)
    monitor.add_health_metric("sensor_001", "cpu_usage", 15.5)
    monitor.add_health_metric("sensor_001", "memory_usage", 45.2)
    
    # 8. æ£€æŸ¥è®¾å¤‡å¥åº·åº¦
    health_score = monitor.calculate_health_score("sensor_001")
    print(f"è®¾å¤‡å¥åº·åº¦: {health_score:.2f}")
    
    # 9. è°ƒåº¦å›ºä»¶æ›´æ–°
    update_manager.schedule_update("sensor_001", "1.1.0", priority=2)
    
    # 10. å¤„ç†æ›´æ–°
    completed_updates = update_manager.process_updates()
    print(f"å®Œæˆçš„æ›´æ–°: {len(completed_updates)}")
    
    return {
        "registry": registry,
        "monitor": monitor,
        "config_manager": config_manager,
        "update_manager": update_manager
    }
```

## ğŸ“ˆ åº”ç”¨æ¡ˆä¾‹

### æ¡ˆä¾‹1ï¼šæ™ºèƒ½å·¥å‚è®¾å¤‡ç®¡ç†

```python
def smart_factory_device_management():
    """æ™ºèƒ½å·¥å‚è®¾å¤‡ç®¡ç†ç¤ºä¾‹"""
    
    # åˆ›å»ºè®¾å¤‡ç®¡ç†ç»„ä»¶
    registry = DeviceRegistry()
    monitor = DeviceMonitor()
    config_manager = DeviceConfiguration()
    
    # æ³¨å†Œå·¥å‚è®¾å¤‡
    factory_devices = [
        DeviceInfo("robot_001", "industrial_robot", "assembly_line_1", ["pick_place", "welding"], "2.1.0", time.time(), time.time()),
        DeviceInfo("sensor_001", "pressure_sensor", "pipeline_1", ["pressure_reading"], "1.5.0", time.time(), time.time()),
        DeviceInfo("camera_001", "vision_camera", "quality_check", ["image_capture", "defect_detection"], "3.0.0", time.time(), time.time())
    ]
    
    for device in factory_devices:
        registry.register_device(device)
    
    # è®¾ç½®è®¾å¤‡é…ç½®
    robot_config = {
        "speed": 0.8,
        "precision": 0.01,
        "safety_mode": "enabled"
    }
    config_manager.set_config("robot_001", robot_config)
    
    # ç›‘æ§è®¾å¤‡çŠ¶æ€
    for device in factory_devices:
        monitor.update_device_status(device.device_id, DeviceStatus.ONLINE)
        monitor.add_health_metric(device.device_id, "cpu_usage", random.uniform(10, 80))
        monitor.add_health_metric(device.device_id, "memory_usage", random.uniform(20, 90))
    
    # æ£€æŸ¥æ‰€æœ‰è®¾å¤‡å¥åº·åº¦
    for device in factory_devices:
        health_score = monitor.calculate_health_score(device.device_id)
        print(f"{device.device_id} å¥åº·åº¦: {health_score:.2f}")
    
    return {
        "registry": registry,
        "monitor": monitor,
        "config_manager": config_manager
    }
```

## ğŸ”— ç›¸å…³é“¾æ¥

- [04-03-01-IoTåŸºç¡€](./04-03-01-IoTåŸºç¡€.md)
- [04-03-03-è¾¹ç¼˜è®¡ç®—](./04-03-03-è¾¹ç¼˜è®¡ç®—.md)
- [05-æ¶æ„é¢†åŸŸ/05-01-ç³»ç»Ÿæ¶æ„/05-01-01-æ¶æ„åŸºç¡€](../05-æ¶æ„é¢†åŸŸ/05-01-ç³»ç»Ÿæ¶æ„/05-01-01-æ¶æ„åŸºç¡€.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0  
**æœ€åæ›´æ–°**ï¼š2024å¹´  
**ç»´æŠ¤è€…**ï¼šAIåŠ©æ‰‹
