# 03-01-01 åˆ›å»ºå‹æ¨¡å¼

## ğŸ“‹ æ¦‚è¿°

åˆ›å»ºå‹æ¨¡å¼å¤„ç†å¯¹è±¡çš„åˆ›å»ºæœºåˆ¶ï¼Œè¯•å›¾åœ¨é€‚åˆç‰¹å®šæƒ…å†µçš„åœºæ™¯ä¸‹åˆ›å»ºå¯¹è±¡ã€‚æœ¬æ–‡æ¡£ä»å½¢å¼åŒ–è§’åº¦æ·±å…¥åˆ†æåˆ›å»ºå‹æ¨¡å¼çš„ç†è®ºåŸºç¡€ã€æ•°å­¦å®šä¹‰å’ŒPythonå®ç°ï¼Œä¸ºå¯¹è±¡åˆ›å»ºæä¾›ç³»ç»Ÿæ€§çš„æŒ‡å¯¼ã€‚

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µ

### 1. å•ä¾‹æ¨¡å¼ (Singleton Pattern)

#### 1.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰ 1.1** (å•ä¾‹æ¨¡å¼)
å•ä¾‹æ¨¡å¼ç¡®ä¿ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹ï¼Œå¹¶æä¾›ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹ã€‚å½¢å¼åŒ–å®šä¹‰ä¸ºï¼š
$$\forall x, y \in \text{Instance}(C) \Rightarrow x = y$$

å…¶ä¸­ $C$ ä¸ºå•ä¾‹ç±»ï¼Œ$\text{Instance}(C)$ ä¸º $C$ çš„æ‰€æœ‰å®ä¾‹é›†åˆã€‚

**å®šä¹‰ 1.2** (å•ä¾‹å”¯ä¸€æ€§)
å•ä¾‹æ¨¡å¼çš„å”¯ä¸€æ€§å®šä¹‰ä¸ºï¼š
$$\text{Singleton}(C) \Leftrightarrow |\text{Instance}(C)| = 1$$

#### 1.2 Pythonå®ç°

```python
import threading
from abc import ABC, abstractmethod
from typing import Dict, Any, Optional, Type, TypeVar
from dataclasses import dataclass
from enum import Enum
import time

T = TypeVar('T')

class SingletonType(type):
    """å•ä¾‹å…ƒç±»"""
    
    _instances: Dict[Type, Any] = {}
    _lock: threading.Lock = threading.Lock()
    
    def __call__(cls: Type[T], *args, **kwargs) -> T:
        if cls not in cls._instances:
            with cls._lock:
                if cls not in cls._instances:
                    cls._instances[cls] = super().__call__(*args, **kwargs)
        return cls._instances[cls]

class Singleton(metaclass=SingletonType):
    """å•ä¾‹åŸºç±»"""
    
    def __new__(cls, *args, **kwargs):
        if not hasattr(cls, '_instance'):
            cls._instance = super().__new__(cls)
        return cls._instance
    
    def __init__(self):
        if not hasattr(self, '_initialized'):
            self._initialized = True
            self._init_singleton()
    
    def _init_singleton(self):
        """åˆå§‹åŒ–å•ä¾‹"""
        pass

class DatabaseConnection(Singleton):
    """æ•°æ®åº“è¿æ¥å•ä¾‹"""
    
    def _init_singleton(self):
        self.connection_string = "default_connection"
        self.is_connected = False
        self.created_at = time.time()
    
    def connect(self, connection_string: str) -> bool:
        """è¿æ¥æ•°æ®åº“"""
        self.connection_string = connection_string
        self.is_connected = True
        return True
    
    def disconnect(self) -> bool:
        """æ–­å¼€è¿æ¥"""
        self.is_connected = False
        return True
    
    def execute_query(self, query: str) -> str:
        """æ‰§è¡ŒæŸ¥è¯¢"""
        if not self.is_connected:
            raise RuntimeError("æ•°æ®åº“æœªè¿æ¥")
        return f"æ‰§è¡ŒæŸ¥è¯¢: {query}"
    
    def __str__(self):
        return f"DatabaseConnection(è¿æ¥: {self.is_connected}, åˆ›å»ºæ—¶é—´: {self.created_at})"

class Logger(Singleton):
    """æ—¥å¿—è®°å½•å™¨å•ä¾‹"""
    
    def _init_singleton(self):
        self.log_level = "INFO"
        self.log_file = "app.log"
        self.log_count = 0
    
    def set_level(self, level: str) -> None:
        """è®¾ç½®æ—¥å¿—çº§åˆ«"""
        self.log_level = level
    
    def log(self, message: str, level: str = "INFO") -> None:
        """è®°å½•æ—¥å¿—"""
        if level >= self.log_level:
            self.log_count += 1
            timestamp = time.strftime("%Y-%m-%d %H:%M:%S")
            log_entry = f"[{timestamp}] [{level}] {message}"
            print(log_entry)
    
    def get_stats(self) -> Dict[str, Any]:
        """è·å–ç»Ÿè®¡ä¿¡æ¯"""
        return {
            "log_count": self.log_count,
            "log_level": self.log_level,
            "log_file": self.log_file
        }

# ä½¿ç”¨ç¤ºä¾‹
def demonstrate_singleton_pattern():
    """æ¼”ç¤ºå•ä¾‹æ¨¡å¼"""
    
    print("=== å•ä¾‹æ¨¡å¼æ¼”ç¤º ===")
    
    # åˆ›å»ºæ•°æ®åº“è¿æ¥å®ä¾‹
    db1 = DatabaseConnection()
    db2 = DatabaseConnection()
    
    print(f"db1: {db1}")
    print(f"db2: {db2}")
    print(f"db1 is db2: {db1 is db2}")
    
    # è¿æ¥æ•°æ®åº“
    db1.connect("mysql://localhost:3306/mydb")
    print(f"db1 è¿æ¥çŠ¶æ€: {db1.is_connected}")
    print(f"db2 è¿æ¥çŠ¶æ€: {db2.is_connected}")
    
    # æ‰§è¡ŒæŸ¥è¯¢
    result = db1.execute_query("SELECT * FROM users")
    print(f"æŸ¥è¯¢ç»“æœ: {result}")
    
    # åˆ›å»ºæ—¥å¿—è®°å½•å™¨
    logger1 = Logger()
    logger2 = Logger()
    
    print(f"logger1 is logger2: {logger1 is logger2}")
    
    # è®°å½•æ—¥å¿—
    logger1.log("åº”ç”¨å¯åŠ¨", "INFO")
    logger2.log("ç”¨æˆ·ç™»å½•", "DEBUG")
    logger1.log("æ•°æ®å¤„ç†å®Œæˆ", "INFO")
    
    # è·å–ç»Ÿè®¡ä¿¡æ¯
    stats = logger1.get_stats()
    print(f"æ—¥å¿—ç»Ÿè®¡: {stats}")

if __name__ == "__main__":
    demonstrate_singleton_pattern()
```

### 2. å·¥å‚æ–¹æ³•æ¨¡å¼ (Factory Method Pattern)

#### 2.1 å½¢å¼åŒ–å®šä¹‰

**å®šä¹‰ 2.1** (å·¥å‚æ–¹æ³•æ¨¡å¼)
å·¥å‚æ–¹æ³•æ¨¡å¼å®šä¹‰ä¸€ä¸ªç”¨äºåˆ›å»ºå¯¹è±¡çš„æ¥å£ï¼Œè®©å­ç±»å†³å®šå®ä¾‹åŒ–å“ªä¸€ä¸ªç±»ã€‚å½¢å¼åŒ–å®šä¹‰ä¸ºï¼š
$$F: \text{ProductType} \rightarrow \text{Product}$$

å…¶ä¸­ $F$ ä¸ºå·¥å‚æ–¹æ³•ï¼Œ$\text{ProductType}$ ä¸ºäº§å“ç±»å‹é›†åˆï¼Œ$\text{Product}$ ä¸ºäº§å“é›†åˆã€‚

**å®šä¹‰ 2.2** (å·¥å‚æ–¹æ³•ä¸€è‡´æ€§)
å·¥å‚æ–¹æ³•çš„ä¸€è‡´æ€§å®šä¹‰ä¸ºï¼š
$$\forall t_1, t_2 \in \text{ProductType}: t_1 = t_2 \Rightarrow F(t_1) = F(t_2)$$

#### 2.2 Pythonå®ç°

```python
from abc import ABC, abstractmethod
from typing import Dict, List, Any, Optional
from dataclasses import dataclass
from enum import Enum

class VehicleType(Enum):
    """è½¦è¾†ç±»å‹"""
    CAR = "car"
    TRUCK = "truck"
    MOTORCYCLE = "motorcycle"
    BUS = "bus"

@dataclass
class Vehicle:
    """è½¦è¾†åŸºç±»"""
    brand: str
    model: str
    year: int
    price: float
    
    def start_engine(self) -> str:
        """å¯åŠ¨å¼•æ“"""
        return f"{self.brand} {self.model} å¼•æ“å¯åŠ¨"
    
    def stop_engine(self) -> str:
        """åœæ­¢å¼•æ“"""
        return f"{self.brand} {self.model} å¼•æ“åœæ­¢"
    
    def get_info(self) -> str:
        """è·å–è½¦è¾†ä¿¡æ¯"""
        return f"{self.brand} {self.model} ({self.year}) - ${self.price}"

class Car(Vehicle):
    """æ±½è½¦ç±»"""
    
    def __init__(self, brand: str, model: str, year: int, price: float):
        super().__init__(brand, model, year, price)
        self.doors = 4
    
    def start_engine(self) -> str:
        return f"æ±½è½¦ {super().start_engine()}"
    
    def get_info(self) -> str:
        return f"{super().get_info()} - {self.doors}é—¨"

class Truck(Vehicle):
    """å¡è½¦ç±»"""
    
    def __init__(self, brand: str, model: str, year: int, price: float):
        super().__init__(brand, model, year, price)
        self.capacity = "10å¨"
    
    def start_engine(self) -> str:
        return f"å¡è½¦ {super().start_engine()}"
    
    def get_info(self) -> str:
        return f"{super().get_info()} - è½½é‡{self.capacity}"

class Motorcycle(Vehicle):
    """æ‘©æ‰˜è½¦ç±»"""
    
    def __init__(self, brand: str, model: str, year: int, price: float):
        super().__init__(brand, model, year, price)
        self.engine_size = "250cc"
    
    def start_engine(self) -> str:
        return f"æ‘©æ‰˜è½¦ {super().start_engine()}"
    
    def get_info(self) -> str:
        return f"{super().get_info()} - {self.engine_size}"

class Bus(Vehicle):
    """å…¬äº¤è½¦ç±»"""
    
    def __init__(self, brand: str, model: str, year: int, price: float):
        super().__init__(brand, model, year, price)
        self.seats = 40
    
    def start_engine(self) -> str:
        return f"å…¬äº¤è½¦ {super().start_engine()}"
    
    def get_info(self) -> str:
        return f"{super().get_info()} - {self.seats}åº§"

class VehicleFactory(ABC):
    """è½¦è¾†å·¥å‚æŠ½è±¡ç±»"""
    
    @abstractmethod
    def create_vehicle(self, vehicle_type: VehicleType, **kwargs) -> Vehicle:
        """åˆ›å»ºè½¦è¾†"""
        pass
    
    def get_available_types(self) -> List[VehicleType]:
        """è·å–å¯ç”¨ç±»å‹"""
        return list(VehicleType)

class StandardVehicleFactory(VehicleFactory):
    """æ ‡å‡†è½¦è¾†å·¥å‚"""
    
    def create_vehicle(self, vehicle_type: VehicleType, **kwargs) -> Vehicle:
        """åˆ›å»ºè½¦è¾†"""
        brand = kwargs.get('brand', 'Unknown')
        model = kwargs.get('model', 'Standard')
        year = kwargs.get('year', 2024)
        price = kwargs.get('price', 0.0)
        
        if vehicle_type == VehicleType.CAR:
            return Car(brand, model, year, price)
        elif vehicle_type == VehicleType.TRUCK:
            return Truck(brand, model, year, price)
        elif vehicle_type == VehicleType.MOTORCYCLE:
            return Motorcycle(brand, model, year, price)
        elif vehicle_type == VehicleType.BUS:
            return Bus(brand, model, year, price)
        else:
            raise ValueError(f"ä¸æ”¯æŒçš„è½¦è¾†ç±»å‹: {vehicle_type}")

class LuxuryVehicleFactory(VehicleFactory):
    """è±ªåè½¦è¾†å·¥å‚"""
    
    def create_vehicle(self, vehicle_type: VehicleType, **kwargs) -> Vehicle:
        """åˆ›å»ºè±ªåè½¦è¾†"""
        brand = kwargs.get('brand', 'Luxury')
        model = kwargs.get('model', 'Premium')
        year = kwargs.get('year', 2024)
        price = kwargs.get('price', 100000.0)  # è±ªåè½¦é»˜è®¤é«˜ä»·
        
        if vehicle_type == VehicleType.CAR:
            return Car(brand, model, year, price * 2)
        elif vehicle_type == VehicleType.TRUCK:
            return Truck(brand, model, year, price * 1.5)
        elif vehicle_type == VehicleType.MOTORCYCLE:
            return Motorcycle(brand, model, year, price * 3)
        elif vehicle_type == VehicleType.BUS:
            return Bus(brand, model, year, price * 1.8)
        else:
            raise ValueError(f"ä¸æ”¯æŒçš„è½¦è¾†ç±»å‹: {vehicle_type}")

# ä½¿ç”¨ç¤ºä¾‹
def demonstrate_factory_method_pattern():
    """æ¼”ç¤ºå·¥å‚æ–¹æ³•æ¨¡å¼"""
    
    print("=== å·¥å‚æ–¹æ³•æ¨¡å¼æ¼”ç¤º ===")
    
    # åˆ›å»ºæ ‡å‡†å·¥å‚
    standard_factory = StandardVehicleFactory()
    
    # åˆ›å»ºä¸åŒç±»å‹çš„è½¦è¾†
    vehicles = []
    
    vehicles.append(standard_factory.create_vehicle(
        VehicleType.CAR, brand="Toyota", model="Camry", year=2023, price=25000
    ))
    
    vehicles.append(standard_factory.create_vehicle(
        VehicleType.TRUCK, brand="Ford", model="F-150", year=2023, price=35000
    ))
    
    vehicles.append(standard_factory.create_vehicle(
        VehicleType.MOTORCYCLE, brand="Honda", model="CBR600RR", year=2023, price=12000
    ))
    
    vehicles.append(standard_factory.create_vehicle(
        VehicleType.BUS, brand="Mercedes", model="Sprinter", year=2023, price=45000
    ))
    
    print("æ ‡å‡†å·¥å‚åˆ›å»ºçš„è½¦è¾†:")
    for vehicle in vehicles:
        print(f"  {vehicle.get_info()}")
        print(f"    {vehicle.start_engine()}")
    
    # åˆ›å»ºè±ªåå·¥å‚
    luxury_factory = LuxuryVehicleFactory()
    
    luxury_vehicles = []
    luxury_vehicles.append(luxury_factory.create_vehicle(
        VehicleType.CAR, brand="BMW", model="7 Series", year=2024, price=80000
    ))
    
    luxury_vehicles.append(luxury_factory.create_vehicle(
        VehicleType.MOTORCYCLE, brand="Ducati", model="Panigale V4", year=2024, price=25000
    ))
    
    print("\nè±ªåå·¥å‚åˆ›å»ºçš„è½¦è¾†:")
    for vehicle in luxury_vehicles:
        print(f"  {vehicle.get_info()}")
        print(f"    {vehicle.start_engine()}")

if __name__ == "__main__":
    demonstrate_factory_method_pattern()
```

## ğŸ“Š ç†è®ºè¯æ˜

### å®šç† 1.1 (å•ä¾‹å”¯ä¸€æ€§)

å¦‚æœç±» $C$ æ­£ç¡®å®ç°å•ä¾‹æ¨¡å¼ï¼Œåˆ™ $C$ çš„æ‰€æœ‰å®ä¾‹éƒ½ç›¸ç­‰ã€‚

**è¯æ˜**:

1. è®¾ $x, y$ æ˜¯ $C$ çš„ä»»æ„ä¸¤ä¸ªå®ä¾‹
2. æ ¹æ®å•ä¾‹æ¨¡å¼çš„å®ç°ï¼Œ$x$ å’Œ $y$ æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡
3. å› æ­¤ $x = y$
4. æ‰€ä»¥å•ä¾‹æ¨¡å¼ä¿è¯äº†å®ä¾‹çš„å”¯ä¸€æ€§

### å®šç† 1.2 (å·¥å‚æ–¹æ³•ä¸€è‡´æ€§)

å·¥å‚æ–¹æ³• $F$ å¯¹äºç›¸åŒç±»å‹çš„äº§å“æ€»æ˜¯è¿”å›ç›¸åŒçš„äº§å“å®ä¾‹ã€‚

**è¯æ˜**:

1. è®¾ $t_1, t_2 \in \text{ProductType}$ ä¸” $t_1 = t_2$
2. æ ¹æ®å·¥å‚æ–¹æ³•çš„å®ç°ï¼Œ$F(t_1)$ å’Œ $F(t_2)$ ä½¿ç”¨ç›¸åŒçš„åˆ›å»ºé€»è¾‘
3. å› æ­¤ $F(t_1) = F(t_2)$
4. æ‰€ä»¥å·¥å‚æ–¹æ³•ä¿è¯äº†ä¸€è‡´æ€§

## ğŸ¯ åº”ç”¨å®ä¾‹

### 1. å•ä¾‹æ¨¡å¼åº”ç”¨

- æ•°æ®åº“è¿æ¥ç®¡ç†
- æ—¥å¿—è®°å½•å™¨
- é…ç½®ç®¡ç†å™¨
- ç¼“å­˜ç®¡ç†å™¨

### 2. å·¥å‚æ–¹æ³•æ¨¡å¼åº”ç”¨

- å›¾å½¢ç•Œé¢ç»„ä»¶åˆ›å»º
- æ–‡æ¡£ç¼–è¾‘å™¨æ’ä»¶
- æ¸¸æˆå¯¹è±¡åˆ›å»º
- ç½‘ç»œåè®®å¤„ç†å™¨

## ğŸ”— ç›¸å…³é“¾æ¥

- [ç»“æ„å‹æ¨¡å¼](03-01-02-ç»“æ„å‹æ¨¡å¼.md)
- [è¡Œä¸ºå‹æ¨¡å¼](03-01-03-è¡Œä¸ºå‹æ¨¡å¼.md)
- [è½¯ä»¶æ¶æ„](../03-02-è½¯ä»¶æ¶æ„/README.md)
- [è®¾è®¡æ¨¡å¼å®ç°](../../06-ç»„ä»¶ç®—æ³•/06-01-è®¾è®¡æ¨¡å¼å®ç°/README.md)

---

*åˆ›å»ºå‹æ¨¡å¼ä¸ºå¯¹è±¡åˆ›å»ºæä¾›äº†çµæ´»è€Œå¼ºå¤§çš„æœºåˆ¶ï¼Œé€šè¿‡å½¢å¼åŒ–çš„å®šä¹‰å’Œä¸¥æ ¼çš„å®ç°ï¼Œç¡®ä¿äº†å¯¹è±¡åˆ›å»ºçš„ä¸€è‡´æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚è¿™äº›æ¨¡å¼ä¸ºè½¯ä»¶è®¾è®¡æä¾›äº†é‡è¦çš„åŸºç¡€ï¼Œä½¿å¾—ç³»ç»Ÿæ›´åŠ çµæ´»å’Œå¯æ‰©å±•ã€‚*
