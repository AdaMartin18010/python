# åˆ†å±‚æ¶æ„ (Layered Architecture)

## ğŸ“‹ æ¦‚è¿°

åˆ†å±‚æ¶æ„æ˜¯ä¸€ç§å°†è½¯ä»¶ç³»ç»Ÿç»„ç»‡ä¸ºä¸€ç³»åˆ—å±‚çš„æ¶æ„æ¨¡å¼ï¼Œæ¯ä¸€å±‚éƒ½æä¾›ç‰¹å®šçš„åŠŸèƒ½ï¼Œå¹¶ä¸”åªä¸ç›¸é‚»çš„å±‚è¿›è¡Œäº¤äº’ã€‚è¿™ç§æ¶æ„æ¨¡å¼æä¾›äº†è‰¯å¥½çš„å…³æ³¨ç‚¹åˆ†ç¦»å’Œæ¨¡å—åŒ–è®¾è®¡ã€‚

## 1. å½¢å¼åŒ–å®šä¹‰

### 1.1 åˆ†å±‚æ¶æ„çš„åŸºæœ¬æ¦‚å¿µ

**å®šä¹‰ 1.1** (åˆ†å±‚æ¶æ„)
åˆ†å±‚æ¶æ„æ˜¯ä¸€ä¸ªäº”å…ƒç»„ $\mathcal{L} = (L, \mathcal{H}, \mathcal{D}, \mathcal{I}, \mathcal{C})$ï¼Œå…¶ä¸­ï¼š

- $L = \{l_1, l_2, ..., l_n\}$ æ˜¯å±‚é›†åˆ
- $\mathcal{H}: L \times L \rightarrow \{0, 1\}$ æ˜¯å±‚æ¬¡å…³ç³»å‡½æ•°
- $\mathcal{D}: L \times L \rightarrow \{0, 1\}$ æ˜¯ä¾èµ–å…³ç³»å‡½æ•°
- $\mathcal{I}: L \rightarrow 2^I$ æ˜¯æ¥å£æ˜ å°„å‡½æ•°
- $\mathcal{C}: L \rightarrow 2^C$ æ˜¯ç»„ä»¶æ˜ å°„å‡½æ•°

**å®šä¹‰ 1.2** (å±‚æ¬¡å…³ç³»)
å¯¹äºä»»æ„ä¸¤å±‚ $l_i, l_j \in L$ï¼Œå±‚æ¬¡å…³ç³»å®šä¹‰ä¸ºï¼š
$$\mathcal{H}(l_i, l_j) = 1 \Leftrightarrow l_i \text{ åœ¨ } l_j \text{ ä¹‹ä¸Š}$$

**å®šä¹‰ 1.3** (ä¾èµ–å…³ç³»)
ä¾èµ–å…³ç³»æ»¡è¶³ä»¥ä¸‹æ€§è´¨ï¼š

1. **ä¼ é€’æ€§**: $\mathcal{D}(l_i, l_j) = 1 \land \mathcal{D}(l_j, l_k) = 1 \Rightarrow \mathcal{D}(l_i, l_k) = 1$
2. **åå¯¹ç§°æ€§**: $\mathcal{D}(l_i, l_j) = 1 \Rightarrow \mathcal{D}(l_j, l_i) = 0$
3. **å±‚æ¬¡ä¸€è‡´æ€§**: $\mathcal{H}(l_i, l_j) = 1 \Rightarrow \mathcal{D}(l_i, l_j) = 1$

### 1.2 åˆ†å±‚æ¶æ„çš„ç±»å‹

**å®šä¹‰ 1.4** (ä¸¥æ ¼åˆ†å±‚)
ä¸¥æ ¼åˆ†å±‚æ¶æ„æ»¡è¶³ï¼š
$$\forall l_i, l_j \in L: \mathcal{D}(l_i, l_j) = 1 \Rightarrow |i - j| = 1$$

**å®šä¹‰ 1.5** (æ¾æ•£åˆ†å±‚)
æ¾æ•£åˆ†å±‚æ¶æ„å…è®¸è·¨å±‚ä¾èµ–ï¼š
$$\exists l_i, l_j \in L: \mathcal{D}(l_i, l_j) = 1 \land |i - j| > 1$$

### 1.3 åˆ†å±‚æ¶æ„çš„æ€§è´¨

**å®šç† 1.1** (åˆ†å±‚æ¶æ„çš„å±‚æ¬¡æ€§)
åˆ†å±‚æ¶æ„ä¸­çš„å±‚å½¢æˆååºå…³ç³»ï¼š
$$(L, \mathcal{H}) \text{ æ˜¯ååºé›†}$$

**è¯æ˜**:

1. **è‡ªåæ€§**: $\forall l \in L: \mathcal{H}(l, l) = 1$
2. **åå¯¹ç§°æ€§**: $\mathcal{H}(l_i, l_j) = 1 \land \mathcal{H}(l_j, l_i) = 1 \Rightarrow l_i = l_j$
3. **ä¼ é€’æ€§**: $\mathcal{H}(l_i, l_j) = 1 \land \mathcal{H}(l_j, l_k) = 1 \Rightarrow \mathcal{H}(l_i, l_k) = 1$

å› æ­¤ï¼Œ$(L, \mathcal{H})$ æ˜¯ååºé›†ã€‚$\square$

**å®šç† 1.2** (ä¾èµ–å…³ç³»çš„ä¼ é€’é—­åŒ…)
ä¾èµ–å…³ç³»çš„ä¼ é€’é—­åŒ…ç­‰äºå±‚æ¬¡å…³ç³»ï¼š
$$\mathcal{D}^* = \mathcal{H}$$

**è¯æ˜**:
æ ¹æ®å®šä¹‰1.3ï¼Œä¾èµ–å…³ç³»æ»¡è¶³ä¼ é€’æ€§å’Œå±‚æ¬¡ä¸€è‡´æ€§ï¼Œå› æ­¤ä¼ é€’é—­åŒ…ç­‰äºå±‚æ¬¡å…³ç³»ã€‚$\square$

## 2. å¸¸è§åˆ†å±‚æ¨¡å¼

### 2.1 ä¸‰å±‚æ¶æ„

**å®šä¹‰ 2.1** (ä¸‰å±‚æ¶æ„)
ä¸‰å±‚æ¶æ„æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„åˆ†å±‚æ¶æ„ï¼Œå…¶ä¸­ $|L| = 3$ï¼š

- $l_1$: è¡¨ç¤ºå±‚ (Presentation Layer)
- $l_2$: ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic Layer)
- $l_3$: æ•°æ®è®¿é—®å±‚ (Data Access Layer)

**å®šç† 2.1** (ä¸‰å±‚æ¶æ„çš„ä¾èµ–å…³ç³»)
åœ¨ä¸‰å±‚æ¶æ„ä¸­ï¼Œä¾èµ–å…³ç³»æ»¡è¶³ï¼š
$$\mathcal{D}(l_1, l_2) = 1, \mathcal{D}(l_2, l_3) = 1, \mathcal{D}(l_1, l_3) = 0$$

### 2.2 å››å±‚æ¶æ„

**å®šä¹‰ 2.2** (å››å±‚æ¶æ„)
å››å±‚æ¶æ„åŒ…å«ï¼š

- $l_1$: è¡¨ç¤ºå±‚ (Presentation Layer)
- $l_2$: ä¸šåŠ¡é€»è¾‘å±‚ (Business Logic Layer)
- $l_3$: æ•°æ®è®¿é—®å±‚ (Data Access Layer)
- $l_4$: åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)

## 3. Pythonå®ç°

### 3.1 åŸºç¡€åˆ†å±‚æ¡†æ¶

```python
from abc import ABC, abstractmethod
from typing import Dict, List, Any, Optional, Set, Protocol
from dataclasses import dataclass, field
from enum import Enum
import uuid
from datetime import datetime

class LayerType(Enum):
    """å±‚ç±»å‹"""
    PRESENTATION = "presentation"
    BUSINESS = "business"
    DATA_ACCESS = "data_access"
    INFRASTRUCTURE = "infrastructure"
    DOMAIN = "domain"
    APPLICATION = "application"

class LayerLevel(Enum):
    """å±‚çº§åˆ«"""
    LEVEL_1 = 1
    LEVEL_2 = 2
    LEVEL_3 = 3
    LEVEL_4 = 4
    LEVEL_5 = 5

@dataclass
class Layer:
    """å±‚å®šä¹‰"""
    id: str = field(default_factory=lambda: str(uuid.uuid4()))
    name: str = ""
    type: LayerType = LayerType.PRESENTATION
    level: LayerLevel = LayerLevel.LEVEL_1
    components: List[str] = field(default_factory=list)
    interfaces: List[str] = field(default_factory=list)
    dependencies: Set[str] = field(default_factory=set)
    
    def add_component(self, component_id: str) -> None:
        """æ·»åŠ ç»„ä»¶"""
        if component_id not in self.components:
            self.components.append(component_id)
    
    def add_interface(self, interface_id: str) -> None:
        """æ·»åŠ æ¥å£"""
        if interface_id not in self.interfaces:
            self.interfaces.append(interface_id)
    
    def add_dependency(self, layer_id: str) -> None:
        """æ·»åŠ ä¾èµ–"""
        self.dependencies.add(layer_id)

@dataclass
class LayerInterface:
    """å±‚æ¥å£"""
    id: str = field(default_factory=lambda: str(uuid.uuid4()))
    name: str = ""
    layer_id: str = ""
    methods: List[str] = field(default_factory=list)
    is_public: bool = True

class LayeredArchitecture:
    """åˆ†å±‚æ¶æ„"""
    
    def __init__(self, name: str):
        self.name = name
        self.layers: Dict[str, Layer] = {}
        self.interfaces: Dict[str, LayerInterface] = {}
        self.components: Dict[str, Any] = {}
        self.layer_order: List[str] = []
    
    def add_layer(self, layer: Layer) -> None:
        """æ·»åŠ å±‚"""
        self.layers[layer.id] = layer
        self.layer_order.append(layer.id)
    
    def add_interface(self, interface: LayerInterface) -> None:
        """æ·»åŠ æ¥å£"""
        self.interfaces[interface.id] = interface
        if interface.layer_id in self.layers:
            self.layers[interface.layer_id].add_interface(interface.id)
    
    def add_component(self, component_id: str, component: Any) -> None:
        """æ·»åŠ ç»„ä»¶"""
        self.components[component_id] = component
    
    def assign_component_to_layer(self, component_id: str, layer_id: str) -> None:
        """å°†ç»„ä»¶åˆ†é…åˆ°å±‚"""
        if layer_id in self.layers and component_id in self.components:
            self.layers[layer_id].add_component(component_id)
    
    def add_layer_dependency(self, from_layer_id: str, to_layer_id: str) -> None:
        """æ·»åŠ å±‚ä¾èµ–"""
        if from_layer_id in self.layers and to_layer_id in self.layers:
            self.layers[from_layer_id].add_dependency(to_layer_id)
    
    def validate_architecture(self) -> List[str]:
        """éªŒè¯æ¶æ„"""
        errors = []
        
        # æ£€æŸ¥å±‚ä¾èµ–
        for layer_id, layer in self.layers.items():
            for dep_id in layer.dependencies:
                if dep_id not in self.layers:
                    errors.append(f"Layer {layer_id} depends on non-existent layer {dep_id}")
        
        # æ£€æŸ¥å±‚æ¬¡ä¸€è‡´æ€§
        for layer_id, layer in self.layers.items():
            for dep_id in layer.dependencies:
                dep_layer = self.layers[dep_id]
                if layer.level.value <= dep_layer.level.value:
                    errors.append(f"Layer {layer_id} (level {layer.level.value}) cannot depend on layer {dep_id} (level {dep_layer.level.value})")
        
        return errors
    
    def get_layer_hierarchy(self) -> Dict[str, List[str]]:
        """è·å–å±‚å±‚æ¬¡ç»“æ„"""
        hierarchy = {}
        for layer_id, layer in self.layers.items():
            hierarchy[layer_id] = list(layer.dependencies)
        return hierarchy

class LayeredArchitectureBuilder:
    """åˆ†å±‚æ¶æ„æ„å»ºå™¨"""
    
    def __init__(self):
        self.architecture = LayeredArchitecture("")
    
    def set_name(self, name: str) -> 'LayeredArchitectureBuilder':
        """è®¾ç½®æ¶æ„åç§°"""
        self.architecture.name = name
        return self
    
    def add_layer(self, name: str, layer_type: LayerType, level: LayerLevel) -> str:
        """æ·»åŠ å±‚"""
        layer = Layer(name=name, type=layer_type, level=level)
        self.architecture.add_layer(layer)
        return layer.id
    
    def add_layer_dependency(self, from_layer_id: str, to_layer_id: str) -> 'LayeredArchitectureBuilder':
        """æ·»åŠ å±‚ä¾èµ–"""
        self.architecture.add_layer_dependency(from_layer_id, to_layer_id)
        return self
    
    def build(self) -> LayeredArchitecture:
        """æ„å»ºæ¶æ„"""
        return self.architecture

# ä½¿ç”¨ç¤ºä¾‹
def layered_architecture_example():
    """åˆ†å±‚æ¶æ„ç¤ºä¾‹"""
    # åˆ›å»ºä¸‰å±‚æ¶æ„
    builder = LayeredArchitectureBuilder()
    builder.set_name("Three-Tier Architecture")
    
    # æ·»åŠ å±‚
    presentation_id = builder.add_layer("Presentation", LayerType.PRESENTATION, LayerLevel.LEVEL_1)
    business_id = builder.add_layer("Business Logic", LayerType.BUSINESS, LayerLevel.LEVEL_2)
    data_id = builder.add_layer("Data Access", LayerType.DATA_ACCESS, LayerLevel.LEVEL_3)
    
    # æ·»åŠ ä¾èµ–
    builder.add_layer_dependency(presentation_id, business_id)
    builder.add_layer_dependency(business_id, data_id)
    
    # æ„å»ºæ¶æ„
    architecture = builder.build()
    
    # éªŒè¯æ¶æ„
    errors = architecture.validate_architecture()
    if errors:
        print("Architecture validation errors:")
        for error in errors:
            print(f"  - {error}")
    else:
        print("Architecture is valid")
    
    # æ˜¾ç¤ºå±‚æ¬¡ç»“æ„
    hierarchy = architecture.get_layer_hierarchy()
    print("\nLayer hierarchy:")
    for layer_id, dependencies in hierarchy.items():
        layer = architecture.layers[layer_id]
        print(f"  {layer.name} (Level {layer.level.value}): {[architecture.layers[dep_id].name for dep_id in dependencies]}")

if __name__ == "__main__":
    layered_architecture_example()
```

### 3.2 ä¸‰å±‚æ¶æ„å®ç°

```python
class ThreeTierArchitecture:
    """ä¸‰å±‚æ¶æ„å®ç°"""
    
    def __init__(self):
        self.presentation_layer = PresentationLayer()
        self.business_layer = BusinessLayer()
        self.data_layer = DataLayer()
    
    def process_request(self, request: Dict[str, Any]) -> Dict[str, Any]:
        """å¤„ç†è¯·æ±‚"""
        # è¡¨ç¤ºå±‚å¤„ç†
        processed_request = self.presentation_layer.process(request)
        
        # ä¸šåŠ¡é€»è¾‘å±‚å¤„ç†
        business_result = self.business_layer.process(processed_request)
        
        # æ•°æ®å±‚å¤„ç†
        data_result = self.data_layer.process(business_result)
        
        # è¿”å›ç»“æœ
        return self.presentation_layer.format_response(data_result)

class PresentationLayer:
    """è¡¨ç¤ºå±‚"""
    
    def process(self, request: Dict[str, Any]) -> Dict[str, Any]:
        """å¤„ç†è¯·æ±‚"""
        # éªŒè¯è¾“å…¥
        if not self._validate_input(request):
            raise ValueError("Invalid input")
        
        # æ ¼å¼åŒ–è¯·æ±‚
        return self._format_request(request)
    
    def format_response(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """æ ¼å¼åŒ–å“åº”"""
        return {
            "status": "success",
            "data": data,
            "timestamp": datetime.now().isoformat()
        }
    
    def _validate_input(self, request: Dict[str, Any]) -> bool:
        """éªŒè¯è¾“å…¥"""
        required_fields = ["action", "data"]
        return all(field in request for field in required_fields)
    
    def _format_request(self, request: Dict[str, Any]) -> Dict[str, Any]:
        """æ ¼å¼åŒ–è¯·æ±‚"""
        return {
            "action": request["action"],
            "parameters": request.get("data", {}),
            "metadata": {
                "source": "presentation_layer",
                "timestamp": datetime.now().isoformat()
            }
        }

class BusinessLayer:
    """ä¸šåŠ¡é€»è¾‘å±‚"""
    
    def __init__(self):
        self.business_rules = {
            "create_user": self._create_user_rule,
            "update_user": self._update_user_rule,
            "delete_user": self._delete_user_rule
        }
    
    def process(self, request: Dict[str, Any]) -> Dict[str, Any]:
        """å¤„ç†ä¸šåŠ¡é€»è¾‘"""
        action = request["action"]
        
        if action not in self.business_rules:
            raise ValueError(f"Unknown action: {action}")
        
        # åº”ç”¨ä¸šåŠ¡è§„åˆ™
        result = self.business_rules[action](request["parameters"])
        
        return {
            "action": action,
            "result": result,
            "business_logic_applied": True
        }
    
    def _create_user_rule(self, parameters: Dict[str, Any]) -> Dict[str, Any]:
        """åˆ›å»ºç”¨æˆ·ä¸šåŠ¡è§„åˆ™"""
        # éªŒè¯ä¸šåŠ¡è§„åˆ™
        if not parameters.get("email"):
            raise ValueError("Email is required")
        
        if not parameters.get("password"):
            raise ValueError("Password is required")
        
        # åº”ç”¨ä¸šåŠ¡é€»è¾‘
        return {
            "user_id": str(uuid.uuid4()),
            "email": parameters["email"],
            "status": "active",
            "created_at": datetime.now().isoformat()
        }
    
    def _update_user_rule(self, parameters: Dict[str, Any]) -> Dict[str, Any]:
        """æ›´æ–°ç”¨æˆ·ä¸šåŠ¡è§„åˆ™"""
        if not parameters.get("user_id"):
            raise ValueError("User ID is required")
        
        return {
            "user_id": parameters["user_id"],
            "updated_at": datetime.now().isoformat()
        }
    
    def _delete_user_rule(self, parameters: Dict[str, Any]) -> Dict[str, Any]:
        """åˆ é™¤ç”¨æˆ·ä¸šåŠ¡è§„åˆ™"""
        if not parameters.get("user_id"):
            raise ValueError("User ID is required")
        
        return {
            "user_id": parameters["user_id"],
            "deleted_at": datetime.now().isoformat()
        }

class DataLayer:
    """æ•°æ®è®¿é—®å±‚"""
    
    def __init__(self):
        self.data_store: Dict[str, Dict[str, Any]] = {}
    
    def process(self, request: Dict[str, Any]) -> Dict[str, Any]:
        """å¤„ç†æ•°æ®è®¿é—®"""
        action = request["action"]
        result = request["result"]
        
        if action == "create_user":
            return self._create_user(result)
        elif action == "update_user":
            return self._update_user(result)
        elif action == "delete_user":
            return self._delete_user(result)
        else:
            raise ValueError(f"Unknown action: {action}")
    
    def _create_user(self, user_data: Dict[str, Any]) -> Dict[str, Any]:
        """åˆ›å»ºç”¨æˆ·"""
        user_id = user_data["user_id"]
        self.data_store[user_id] = user_data
        return {"created": True, "user_id": user_id}
    
    def _update_user(self, user_data: Dict[str, Any]) -> Dict[str, Any]:
        """æ›´æ–°ç”¨æˆ·"""
        user_id = user_data["user_id"]
        if user_id in self.data_store:
            self.data_store[user_id].update(user_data)
            return {"updated": True, "user_id": user_id}
        else:
            raise ValueError(f"User {user_id} not found")
    
    def _delete_user(self, user_data: Dict[str, Any]) -> Dict[str, Any]:
        """åˆ é™¤ç”¨æˆ·"""
        user_id = user_data["user_id"]
        if user_id in self.data_store:
            del self.data_store[user_id]
            return {"deleted": True, "user_id": user_id}
        else:
            raise ValueError(f"User {user_id} not found")

# ä½¿ç”¨ç¤ºä¾‹
def three_tier_example():
    """ä¸‰å±‚æ¶æ„ç¤ºä¾‹"""
    # åˆ›å»ºä¸‰å±‚æ¶æ„
    architecture = ThreeTierArchitecture()
    
    # æµ‹è¯•åˆ›å»ºç”¨æˆ·
    create_request = {
        "action": "create_user",
        "data": {
            "email": "user@example.com",
            "password": "password123"
        }
    }
    
    try:
        result = architecture.process_request(create_request)
        print("Create user result:", result)
    except Exception as e:
        print(f"Error: {e}")
    
    # æµ‹è¯•æ›´æ–°ç”¨æˆ·
    update_request = {
        "action": "update_user",
        "data": {
            "user_id": "test-user-id"
        }
    }
    
    try:
        result = architecture.process_request(update_request)
        print("Update user result:", result)
    except Exception as e:
        print(f"Error: {e}")

if __name__ == "__main__":
    three_tier_example()
```

### 3.3 å››å±‚æ¶æ„å®ç°

```python
class FourTierArchitecture:
    """å››å±‚æ¶æ„å®ç°"""
    
    def __init__(self):
        self.presentation_layer = PresentationLayer()
        self.business_layer = BusinessLayer()
        self.data_layer = DataLayer()
        self.infrastructure_layer = InfrastructureLayer()
    
    def process_request(self, request: Dict[str, Any]) -> Dict[str, Any]:
        """å¤„ç†è¯·æ±‚"""
        # åŸºç¡€è®¾æ–½å±‚å¤„ç†
        infrastructure_result = self.infrastructure_layer.process(request)
        
        # è¡¨ç¤ºå±‚å¤„ç†
        presentation_result = self.presentation_layer.process(infrastructure_result)
        
        # ä¸šåŠ¡é€»è¾‘å±‚å¤„ç†
        business_result = self.business_layer.process(presentation_result)
        
        # æ•°æ®å±‚å¤„ç†
        data_result = self.data_layer.process(business_result)
        
        # è¿”å›ç»“æœ
        return self.infrastructure_layer.format_response(data_result)

class InfrastructureLayer:
    """åŸºç¡€è®¾æ–½å±‚"""
    
    def __init__(self):
        self.logger = Logger()
        self.security = Security()
        self.cache = Cache()
    
    def process(self, request: Dict[str, Any]) -> Dict[str, Any]:
        """å¤„ç†åŸºç¡€è®¾æ–½"""
        # å®‰å…¨æ£€æŸ¥
        if not self.security.validate(request):
            raise SecurityException("Security validation failed")
        
        # æ—¥å¿—è®°å½•
        self.logger.log("request_received", request)
        
        # ç¼“å­˜æ£€æŸ¥
        cached_result = self.cache.get(request.get("cache_key"))
        if cached_result:
            return cached_result
        
        return request
    
    def format_response(self, data: Dict[str, Any]) -> Dict[str, Any]:
        """æ ¼å¼åŒ–å“åº”"""
        response = {
            "status": "success",
            "data": data,
            "timestamp": datetime.now().isoformat()
        }
        
        # ç¼“å­˜ç»“æœ
        self.cache.set("response_key", response)
        
        # æ—¥å¿—è®°å½•
        self.logger.log("response_sent", response)
        
        return response

class Logger:
    """æ—¥å¿—è®°å½•å™¨"""
    
    def log(self, event: str, data: Dict[str, Any]) -> None:
        """è®°å½•æ—¥å¿—"""
        print(f"[LOG] {event}: {data}")

class Security:
    """å®‰å…¨æ£€æŸ¥"""
    
    def validate(self, request: Dict[str, Any]) -> bool:
        """éªŒè¯è¯·æ±‚"""
        # ç®€åŒ–çš„å®‰å…¨æ£€æŸ¥
        return "token" in request or "api_key" in request

class Cache:
    """ç¼“å­˜"""
    
    def __init__(self):
        self._cache: Dict[str, Any] = {}
    
    def get(self, key: str) -> Optional[Any]:
        """è·å–ç¼“å­˜"""
        return self._cache.get(key)
    
    def set(self, key: str, value: Any) -> None:
        """è®¾ç½®ç¼“å­˜"""
        self._cache[key] = value

class SecurityException(Exception):
    """å®‰å…¨å¼‚å¸¸"""
    pass

# ä½¿ç”¨ç¤ºä¾‹
def four_tier_example():
    """å››å±‚æ¶æ„ç¤ºä¾‹"""
    # åˆ›å»ºå››å±‚æ¶æ„
    architecture = FourTierArchitecture()
    
    # æµ‹è¯•è¯·æ±‚
    request = {
        "action": "create_user",
        "data": {
            "email": "user@example.com",
            "password": "password123"
        },
        "token": "valid_token"
    }
    
    try:
        result = architecture.process_request(request)
        print("Four-tier result:", result)
    except Exception as e:
        print(f"Error: {e}")

if __name__ == "__main__":
    four_tier_example()
```

## 4. æ€§èƒ½åˆ†æ

### 4.1 åˆ†å±‚æ¶æ„æ€§èƒ½æ¨¡å‹

**å®šä¹‰ 4.1** (åˆ†å±‚æ€§èƒ½æ¨¡å‹)
åˆ†å±‚æ¶æ„çš„æ€§èƒ½æ¨¡å‹å®šä¹‰ä¸ºï¼š
$$T_{total} = \sum_{i=1}^{n} T_i + \sum_{i=1}^{n-1} T_{i,i+1}$$

å…¶ä¸­ï¼š

- $T_i$ æ˜¯ç¬¬ $i$ å±‚çš„å¤„ç†æ—¶é—´
- $T_{i,i+1}$ æ˜¯ç¬¬ $i$ å±‚åˆ°ç¬¬ $i+1$ å±‚çš„é€šä¿¡æ—¶é—´

**å®šç† 4.1** (æ€§èƒ½ç“¶é¢ˆ)
åœ¨åˆ†å±‚æ¶æ„ä¸­ï¼Œæ€§èƒ½ç“¶é¢ˆé€šå¸¸å‡ºç°åœ¨ï¼š

1. æ•°æ®è®¿é—®å±‚ (I/O æ“ä½œ)
2. å±‚é—´é€šä¿¡ (åºåˆ—åŒ–/ååºåˆ—åŒ–)
3. ä¸šåŠ¡é€»è¾‘å±‚ (å¤æ‚è®¡ç®—)

### 4.2 å¯æ‰©å±•æ€§åˆ†æ

**å®šä¹‰ 4.2** (åˆ†å±‚å¯æ‰©å±•æ€§)
åˆ†å±‚æ¶æ„çš„å¯æ‰©å±•æ€§å®šä¹‰ä¸ºï¼š
$$S = \frac{\Delta T_{total}}{\Delta R}$$

å…¶ä¸­ $\Delta R$ æ˜¯èµ„æºå¢é‡ã€‚

**å®šç† 4.2** (æ°´å¹³æ‰©å±•)
åˆ†å±‚æ¶æ„æ”¯æŒæ°´å¹³æ‰©å±•ï¼š

- è¡¨ç¤ºå±‚ï¼šè´Ÿè½½å‡è¡¡
- ä¸šåŠ¡é€»è¾‘å±‚ï¼šæ— çŠ¶æ€æœåŠ¡
- æ•°æ®è®¿é—®å±‚ï¼šè¯»å†™åˆ†ç¦»
- åŸºç¡€è®¾æ–½å±‚ï¼šåˆ†å¸ƒå¼ç¼“å­˜

## 5. è´¨é‡å±æ€§

### 5.1 å¯ç»´æŠ¤æ€§

**å®šä¹‰ 5.1** (å¯ç»´æŠ¤æ€§)
å¯ç»´æŠ¤æ€§ $M$ å®šä¹‰ä¸ºï¼š
$$M = \frac{1}{\sum_{i=1}^{n} C_i}$$

å…¶ä¸­ $C_i$ æ˜¯ç¬¬ $i$ å±‚çš„å¤æ‚åº¦ã€‚

**å®šç† 5.1** (åˆ†å±‚å¯ç»´æŠ¤æ€§)
åˆ†å±‚æ¶æ„æé«˜äº†å¯ç»´æŠ¤æ€§ï¼š
$$M_{layered} > M_{monolithic}$$

### 5.2 å¯æµ‹è¯•æ€§

**å®šä¹‰ 5.2** (å¯æµ‹è¯•æ€§)
å¯æµ‹è¯•æ€§ $T$ å®šä¹‰ä¸ºï¼š
$$T = \frac{\sum_{i=1}^{n} T_i}{n}$$

å…¶ä¸­ $T_i$ æ˜¯ç¬¬ $i$ å±‚çš„æµ‹è¯•è¦†ç›–ç‡ã€‚

**å®šç† 5.2** (åˆ†å±‚å¯æµ‹è¯•æ€§)
åˆ†å±‚æ¶æ„æé«˜äº†å¯æµ‹è¯•æ€§ï¼š
$$T_{layered} > T_{monolithic}$$

## 6. æœ€ä½³å®è·µ

### 6.1 è®¾è®¡åŸåˆ™

1. **å•ä¸€èŒè´£åŸåˆ™**: æ¯ä¸€å±‚åªè´Ÿè´£ç‰¹å®šçš„åŠŸèƒ½
2. **å¼€é—­åŸåˆ™**: å±‚åº”è¯¥å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­
3. **ä¾èµ–å€’ç½®åŸåˆ™**: é«˜å±‚ä¸åº”è¯¥ä¾èµ–ä½å±‚ï¼Œéƒ½åº”è¯¥ä¾èµ–æŠ½è±¡
4. **æ¥å£éš”ç¦»åŸåˆ™**: å±‚é—´æ¥å£åº”è¯¥å°è€Œç²¾ç¡®

### 6.2 å®ç°æŒ‡å—

```python
class LayeredArchitectureGuidelines:
    """åˆ†å±‚æ¶æ„å®ç°æŒ‡å—"""
    
    @staticmethod
    def validate_layer_separation(architecture: LayeredArchitecture) -> List[str]:
        """éªŒè¯å±‚åˆ†ç¦»"""
        errors = []
        
        for layer_id, layer in architecture.layers.items():
            for dep_id in layer.dependencies:
                dep_layer = architecture.layers[dep_id]
                
                # æ£€æŸ¥å±‚é—´ä¾èµ–
                if layer.level.value <= dep_layer.level.value:
                    errors.append(f"Invalid dependency: {layer.name} -> {dep_layer.name}")
                
                # æ£€æŸ¥è·¨å±‚ä¾èµ–
                if layer.level.value - dep_layer.level.value > 1:
                    errors.append(f"Cross-layer dependency: {layer.name} -> {dep_layer.name}")
        
        return errors
    
    @staticmethod
    def optimize_performance(architecture: LayeredArchitecture) -> Dict[str, Any]:
        """æ€§èƒ½ä¼˜åŒ–å»ºè®®"""
        suggestions = {
            "caching": [],
            "connection_pooling": [],
            "async_processing": [],
            "load_balancing": []
        }
        
        # åˆ†æå„å±‚æ€§èƒ½ç“¶é¢ˆ
        for layer_id, layer in architecture.layers.items():
            if layer.type == LayerType.DATA_ACCESS:
                suggestions["connection_pooling"].append(layer_id)
            elif layer.type == LayerType.BUSINESS:
                suggestions["async_processing"].append(layer_id)
            elif layer.type == LayerType.PRESENTATION:
                suggestions["load_balancing"].append(layer_id)
        
        return suggestions
```

## 7. æ€»ç»“

åˆ†å±‚æ¶æ„æ˜¯ä¸€ç§ç»å…¸ä¸”æœ‰æ•ˆçš„è½¯ä»¶æ¶æ„æ¨¡å¼ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. **æ¸…æ™°çš„å…³æ³¨ç‚¹åˆ†ç¦»**: æ¯ä¸€å±‚éƒ½æœ‰æ˜ç¡®çš„èŒè´£
2. **è‰¯å¥½çš„å¯ç»´æŠ¤æ€§**: ä¿®æ”¹ä¸€å±‚ä¸ä¼šå½±å“å…¶ä»–å±‚
3. **é«˜åº¦çš„å¯æµ‹è¯•æ€§**: æ¯ä¸€å±‚éƒ½å¯ä»¥ç‹¬ç«‹æµ‹è¯•
4. **çµæ´»çš„å¯æ‰©å±•æ€§**: æ”¯æŒæ°´å¹³å’Œå‚ç›´æ‰©å±•

é€šè¿‡ä¸¥æ ¼çš„å½¢å¼åŒ–å®šä¹‰å’Œå®Œæ•´çš„Pythonå®ç°ï¼Œæœ¬æ–‡æ¡£ä¸ºæ„å»ºé«˜è´¨é‡çš„åˆ†å±‚æ¶æ„æä¾›äº†ç†è®ºåŸºç¡€å’Œå®è·µæŒ‡å¯¼ã€‚

---

*æœ€åæ›´æ–°: 2024-12-19*
*æ–‡æ¡£çŠ¶æ€: å®Œæˆ*
